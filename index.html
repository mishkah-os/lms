<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">NIES LMS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark-dimmed.min.css" integrity="sha512-s47Yi4XxLg9VOYpsnCnshunwXcyPOYCDf1lo7Ebwv78mU8WMT4DgoeK3Q4qZagcAca4V86sCy1yuh/zOwAQFHA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-rp+ljW6ds/MEUjAm4Xy1I8BvOSJ5YZg+C2iFoAvf/TfYChvKKSJ3o8FcqDg2+/2pJB+SBYzo0O66sVDxv0Ij+w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Arabic:wght@400;600;700&display=swap');
        :root {
            --font-en: 'Inter', sans-serif;
            --font-ar: 'Noto Sans Arabic', sans-serif;
            --primary-blue: #2563eb; /* Updated Primary Blue */
            --secondary-blue: #60a5fa;
            --primary-dark: #1f2937; /* Dark mode primary background */
            --secondary-dark: #374151; /* Dark mode secondary background */
            --subject-color: var(--primary-blue); /* لون افتراضي أزرق داكن */
        }
        html.dark {
            --primary-blue: #60a5fa; /* Lighter blue for dark mode */
            --secondary-blue: #3b82f6;
            color-scheme: dark;
        }
        body {
            font-family: var(--font-en);
            min-height: 100vh;
            margin: 0;
            color: #111827;
            background: radial-gradient(circle at 0% 0%, rgba(96, 165, 250, 0.25), transparent 55%),
                        radial-gradient(circle at 100% 100%, rgba(37, 99, 235, 0.18), transparent 55%),
                        linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            background-attachment: fixed;
            transition: background 0.5s ease, color 0.5s ease;
        }
        body::before,
        body::after {
            content: "";
            position: fixed;
            width: 480px;
            height: 480px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            filter: blur(140px);
            opacity: 0.35;
            transition: opacity 0.5s ease;
        }
        body::before {
            top: -160px;
            left: -120px;
            background: rgba(96, 165, 250, 0.45);
        }
        body::after {
            bottom: -200px;
            right: -160px;
            background: rgba(59, 130, 246, 0.3);
        }
        html.dark body {
            color: #e5e7eb;
            background: radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.2), transparent 55%),
                        radial-gradient(circle at 100% 100%, rgba(14, 116, 144, 0.25), transparent 55%),
                        linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        html.dark body::before {
            background: rgba(37, 99, 235, 0.45);
            opacity: 0.45;
        }
        html.dark body::after {
            background: rgba(6, 182, 212, 0.22);
            opacity: 0.4;
        }
        nav, main, footer {
            position: relative;
            z-index: 1;
        }
        .ar-mode {
            direction: rtl;
            text-align: right;
            font-family: var(--font-ar);
        }
        .en-mode {
            direction: ltr;
            text-align: left;
            font-family: var(--font-en);
        }
        /* تنسيقات مخصصة لمحتوى الدرس */
        .lesson-content h3 {
            @apply text-2xl font-bold mt-6 mb-3 text-[var(--subject-color)];
        }
        .lesson-content p, .lesson-content li {
            @apply text-base text-gray-700 dark:text-gray-300 mb-3 leading-relaxed;
        }
        .lesson-content ul {
             @apply list-disc;
             @apply rtl:list-disc rtl:mr-6 ltr:list-disc ltr:ml-6;
        }
        .lesson-content .example-box {
            @apply bg-blue-50 dark:bg-blue-900/50 border-blue-400 dark:border-blue-600 text-blue-700 dark:text-blue-200 p-4 rounded-lg my-4;
             @apply rtl:border-r-4 ltr:border-l-4;
        }
        .lesson-content .vocab-box {
            @apply bg-yellow-50 dark:bg-yellow-900/50 border-yellow-400 dark:border-yellow-600 text-yellow-800 dark:text-yellow-200 p-4 rounded-lg my-4;
             @apply rtl:border-r-4 ltr:border-l-4;
        }
        .exercise-card {
            @apply bg-white dark:bg-secondary-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mb-3;
        }
        .exercise-card p {
            @apply text-gray-800 dark:text-gray-200 font-medium;
        }

        .dashboard-hero,
        .section-hero {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(239, 246, 255, 0.9) 100%);
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 25px 55px rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(18px);
        }
        html.dark .dashboard-hero,
        html.dark .section-hero {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(30, 64, 175, 0.35) 100%);
            border-color: rgba(59, 130, 246, 0.25);
            box-shadow: 0 25px 70px rgba(6, 11, 26, 0.55);
        }
        .card-surface {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.92) 0%, rgba(239, 246, 255, 0.88) 100%);
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 0 16px 38px rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(14px);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        html.dark .card-surface {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.92) 0%, rgba(30, 64, 175, 0.45) 100%);
            border-color: rgba(59, 130, 246, 0.28);
            box-shadow: 0 24px 45px rgba(6, 11, 26, 0.55);
        }
        .subject-card > div.card-surface:hover,
        .card-surface:hover {
            transform: translateY(-6px);
            box-shadow: 0 28px 60px rgba(37, 99, 235, 0.25);
            border-color: rgba(37, 99, 235, 0.4);
        }
        .floating-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.85rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #1d4ed8;
            background: rgba(191, 219, 254, 0.45);
            border: 1px solid rgba(59, 130, 246, 0.25);
        }
        html.dark .floating-chip {
            color: #bfdbfe;
            background: rgba(37, 99, 235, 0.25);
            border-color: rgba(147, 197, 253, 0.35);
        }

        /* تنسيقات الـ Modal (مستخدمة للفيديو/الاختبار الخاص بالدرس و لـ PDF) */
        #modal-container iframe {
            @apply w-full h-full border-0;
        }
        #modal-container video {
             @apply w-full h-full;
        }
        #modal-container {
             @apply bg-white dark:bg-gray-800; /* Dark mode for modal */
             background: rgba(255, 255, 255, 0.97);
             border: 1px solid rgba(148, 163, 184, 0.2);
             box-shadow: 0 32px 80px rgba(15, 23, 42, 0.35);
             backdrop-filter: blur(20px);
        }
        html.dark #modal-container {
             background: rgba(17, 24, 39, 0.94);
             border-color: rgba(37, 99, 235, 0.35);
             box-shadow: 0 40px 85px rgba(2, 6, 23, 0.7);
        }
        #modal-overlay {
            @apply bg-black/70 dark:bg-black/80;
        }

        /* تنسيقات الاختبار */
        .quiz-question {
            @apply mb-5 pb-5 border-b border-gray-200 dark:border-gray-700;
        }
        .quiz-question-header {
             @apply flex justify-between items-center mb-2;
        }
        .quiz-question-header p {
             @apply text-lg font-semibold text-gray-800 dark:text-gray-100;
        }
        .quiz-question-header span {
             @apply text-sm font-medium text-gray-500 dark:text-gray-400;
        }
        .quiz-options label {
            @apply block p-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg cursor-pointer mb-2 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-600;
        }
        .quiz-options input {
            @apply mr-2 accent-primary-blue dark:accent-secondary-blue;
             @apply rtl:ml-2 rtl:mr-0;
        }
         /* تنسيقات مراجعة نتائج الاختبار */
        .quiz-review-item {
            @apply p-4 rounded-lg border mb-4;
        }
        .quiz-review-item p {
            @apply text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3;
        }
        .quiz-review-item .user-answer {
             @apply block p-2 rounded-md;
        }
         .quiz-review-item .user-answer.correct {
             @apply bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 border border-green-300 dark:border-green-700;
         }
         .quiz-review-item .user-answer.incorrect {
             @apply bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 border border-red-300 dark:border-red-700;
         }
         .quiz-review-item .correct-answer {
             @apply mt-2 text-sm text-gray-600 dark:text-gray-300;
         }

        .quiz-tab-btn {
            @apply px-4 py-2 rounded-full font-semibold text-sm transition duration-200;
            background: rgba(226, 232, 240, 0.6);
            color: #1e3a8a;
        }
        .quiz-tab-btn.active {
            background: #1e40af;
            color: #f8fafc;
            box-shadow: 0 10px 30px rgba(30, 64, 175, 0.35);
        }
        html.dark .quiz-tab-btn {
            background: rgba(30, 64, 175, 0.25);
            color: #dbeafe;
        }
        html.dark .quiz-tab-btn.active {
            background: #60a5fa;
            color: #0b1120;
        }
        .quiz-stat-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.85rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(37, 99, 235, 0.12);
            color: #1e3a8a;
        }
        html.dark .quiz-stat-pill {
            background: rgba(96, 165, 250, 0.2);
            color: #e0f2fe;
        }
        .quiz-preview-item {
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 1rem;
            padding: 1.5rem;
            background: rgba(248, 250, 252, 0.85);
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
        }
        html.dark .quiz-preview-item {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(59, 130, 246, 0.25);
            box-shadow: 0 20px 50px rgba(2, 6, 23, 0.55);
        }
        .quiz-preview-item ul {
            margin-top: 0.75rem;
            padding-left: 1rem;
        }

        /* تنسيقات إضافية للوضع الليلي */
        .subject-card > div:hover {
            @apply dark:bg-gray-700;
        }
        header {
            @apply bg-white dark:bg-secondary-dark border-gray-200 dark:border-gray-700;
        }
        nav {
             @apply bg-white dark:bg-secondary-dark border-b border-gray-200 dark:border-gray-700;
        }
        input[type="text"] {
             @apply dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white;
        }
        button, a {
            @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue dark:focus:ring-offset-primary-dark;
        }
        #modal-close-btn {
            @apply dark:focus:ring-offset-gray-800;
        }

        /* Markdown viewer styling */
        .markdown-body {
            font-family: var(--font-en);
            font-size: 1rem;
            line-height: 1.7;
            color: inherit;
        }
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4,
        .markdown-body h5,
        .markdown-body h6 {
            font-weight: 700;
            color: var(--subject-color);
            margin-top: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body p {
            margin-bottom: 1em;
        }
        .markdown-body a {
            color: var(--primary-blue);
            text-decoration: underline;
            text-decoration-thickness: 2px;
            text-underline-offset: 4px;
        }
        html.dark .markdown-body a {
            color: var(--secondary-blue);
        }
        .markdown-body ul,
        .markdown-body ol {
            margin: 1em 0;
            padding-inline-start: 1.5em;
        }
        .markdown-body li + li {
            margin-top: 0.35em;
        }
        .markdown-body code {
            background: rgba(148, 163, 184, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 0.35rem;
            font-size: 0.95em;
        }
        .markdown-body pre {
            background: rgba(15, 23, 42, 0.85);
            color: #f8fafc;
            padding: 1.25rem;
            border-radius: 0.75rem;
            overflow: auto;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.2);
        }
        .markdown-body pre code {
            background: transparent;
            padding: 0;
        }
        .markdown-body hr {
            border: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.4), transparent);
            margin: 2rem 0;
        }
        .markdown-body img,
        .markdown-body iframe {
            max-width: 100%;
            border-radius: 1rem;
            margin: 1.5rem 0;
            box-shadow: 0 14px 28px rgba(15, 23, 42, 0.15);
        }
        .markdown-body blockquote {
            border-inline-start: 4px solid var(--subject-color);
            padding-inline-start: 1rem;
            margin: 1.5rem 0;
            color: inherit;
            font-style: italic;
            background: rgba(37, 99, 235, 0.08);
            border-radius: 0 1rem 1rem 0;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            border-radius: 1rem;
            overflow: hidden;
        }
        .markdown-body th,
        .markdown-body td {
            border: 1px solid rgba(148, 163, 184, 0.3);
            padding: 0.75rem 1rem;
            text-align: start;
        }
        .markdown-body tr:nth-child(even) {
            background: rgba(226, 232, 240, 0.45);
        }
        html.dark .markdown-body tr:nth-child(even) {
            background: rgba(30, 64, 175, 0.2);
        }
        .ar-mode .markdown-body {
            font-family: var(--font-ar);
            direction: rtl;
            text-align: right;
        }
        .ar-mode .markdown-body blockquote {
            border-inline-start: 0;
            border-inline-end: 4px solid var(--subject-color);
            padding-inline-start: 0;
            padding-inline-end: 1rem;
            border-radius: 1rem 0 0 1rem;
        }

        /* Markdown Studio panel */
        #markdown-cms-overlay {
            @apply fixed inset-0 bg-black/60 z-50 hidden;
        }
        #markdown-cms-overlay:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        #markdown-cms-panel {
            @apply relative w-full md:w-auto md:mx-auto bg-white dark:bg-secondary-dark rounded-3xl shadow-2xl border border-white/30 dark:border-white/10;
            width: min(1100px, 95vw);
            max-height: 90vh;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }
        #markdown-cms-panel header {
            @apply px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex flex-col md:flex-row md:items-center md:justify-between gap-3;
        }
        #markdown-cms-panel .studio-body {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            overflow: auto;
        }
        @media (min-width: 1024px) {
            #markdown-cms-panel .studio-body {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        #markdown-editor {
            @apply w-full h-full min-h-[260px] border border-gray-200 dark:border-gray-700 rounded-2xl bg-white dark:bg-primary-dark text-gray-800 dark:text-gray-100 p-4 focus:outline-none focus:ring-2 focus:ring-primary-blue;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            resize: none;
        }
        #markdown-preview {
            @apply h-full min-h-[260px] overflow-auto rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/70 p-6;
        }
        .studio-toolbar {
            @apply flex flex-wrap gap-3;
        }
        .studio-toolbar button {
            @apply px-4 py-2 rounded-full text-sm font-semibold transition shadow-sm bg-primary-blue text-white hover:bg-blue-600 dark:bg-secondary-blue dark:hover:bg-blue-400;
        }
        .studio-toolbar button.secondary {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600;
        }
        .studio-toolbar button.danger {
            @apply bg-red-500 text-white hover:bg-red-600;
        }

    </style>
    <script>
        tailwind.config = {
             darkMode: 'class', // تفعيل الوضع الليلي بناءً على فئة في عنصر html
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#2563eb',
                        'secondary-blue': '#60a5fa',
                        'light-bg': '#f3f4f6', // Not used directly, prefer Tailwind defaults
                        'card-bg': '#ffffff', // Not used directly, prefer Tailwind defaults
                        'primary-dark': '#1f2937',
                        'secondary-dark': '#374151',
                    },
                     fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        arabic: ['Noto Sans Arabic', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="en-mode min-h-screen">

    <nav class="sticky top-0 z-20 bg-white/80 dark:bg-secondary-dark/80 backdrop-blur-xl border-b border-white/40 dark:border-white/10 shadow-xl py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center px-4 sm:px-6 lg:px-8">
            <button id="back-button" class="hidden text-gray-600 dark:text-gray-300 hover:text-primary-blue dark:hover:text-secondary-blue transition duration-200 flex items-center space-x-2 rtl:space-x-reverse" onclick="goBack()">
                <svg class="w-6 h-6 transform rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span id="back-text" data-i18n="nav.back">Back</span>
            </button>

            <div id="app-title-container" class="flex items-center space-x-2 rtl:space-x-reverse">
                <svg class="w-8 h-8 text-primary-blue dark:text-secondary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.468 9.244 5 7.5 5 5.225 5 3 6.571 3 8.857v10.286c0 1.956 2.057 3.57 4.5 3.57h9c2.443 0 4.5-1.614 4.5-3.57V8.857C21 6.571 18.775 5 16.5 5c-1.744 0-3.332.468-4.5 1.253z"></path></svg>
                <span class="text-xl font-bold text-gray-800 dark:text-gray-100" data-i18n="nav.title">NIES LMS</span>
            </div>

            <div class="flex items-center space-x-3 rtl:space-x-reverse ml-auto">
                <button id="theme-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-200">
                    <svg id="theme-icon-light" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <button id="lang-toggle" class="px-3 py-1 bg-secondary-blue text-white text-sm font-semibold rounded-full hover:bg-primary-blue dark:hover:bg-blue-500 transition duration-200 shadow">
                    <span>AR</span>
                </button>
                <a href="index2.html" id="logout-link" class="p-2 text-gray-600 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 transition duration-200" data-i18n-title="nav.logoutTitle" aria-label="Log Out" title="Log Out">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </a>
            </div>
        </div>
    </nav>

    <main class="relative z-10 max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <div id="dashboard-view">
            <header class="dashboard-hero text-center py-12 px-6 rounded-3xl shadow-2xl mb-10 border border-transparent relative overflow-hidden">
                <span class="floating-chip mb-4" data-i18n="hero.badge">Personalized for Grade 6</span>
                <h1 class="text-4xl sm:text-5xl font-extrabold text-primary-blue dark:text-secondary-blue mb-4" data-i18n="hero.title">Welcome, Student!</h1>
                <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-200 max-w-2xl mx-auto" data-i18n="hero.subtitle">Choose a subject to continue your Grade 6 learning journey:</p>
            </header>
            <div id="subject-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
        </div>

        <div id="blocks-view" class="hidden">
            <header id="subject-header-blocks" class="section-hero text-center py-10 px-6 rounded-3xl shadow-2xl mb-10 border-t-4 border-primary-blue dark:border-secondary-blue">
                <div id="subject-icon-blocks" class="text-7xl mb-4"></div>
                <h1 id="subject-title-blocks" class="text-4xl font-extrabold text-primary-blue dark:text-secondary-blue mb-2"></h1>
                <p id="subject-description-blocks" class="text-lg text-gray-600 dark:text-gray-300"></p>
                <div class="mt-6 max-w-lg mx-auto px-4">
                    <div class="relative">
                        <input type="text" id="blocks-search" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Search Blocks..." data-i18n-placeholder="blocks.searchPlaceholder" oninput="filterBlocks()">
                        <div class="absolute inset-y-0 flex items-center pointer-events-none rtl:right-3 ltr:left-3">
                             <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </header>

            <div id="blocks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            <div id="no-blocks-results" class="hidden text-center p-8 bg-white dark:bg-secondary-dark rounded-xl shadow-lg mt-8 text-gray-500 dark:text-gray-400">
                <p data-i18n="blocks.noResults">No blocks matched your search criteria.</p>
            </div>
        </div>

        <div id="lessons-view" class="hidden">
            <header id="block-header-lessons" class="section-hero text-center py-10 px-6 rounded-3xl shadow-2xl mb-10 border-t-4 border-primary-blue dark:border-secondary-blue">
                <div id="block-subject-icon-lessons" class="text-5xl mb-2"></div>
                <h2 id="block-title-lessons" class="text-3xl font-extrabold text-primary-blue dark:text-secondary-blue mb-1"></h2>
                <p id="block-brief-lessons" class="text-lg text-gray-600 dark:text-gray-300"></p>

                <div id="block-resources-button-container" class="mt-4"></div>
                <div class="mt-6 max-w-lg mx-auto px-4">
                    <div class="relative">
                        <input type="text" id="lessons-search" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Search Lessons..." data-i18n-placeholder="lessons.searchPlaceholder" oninput="filterLessons()">
                        <div class="absolute inset-y-0 flex items-center pointer-events-none rtl:right-3 ltr:left-3">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </header>

            <div id="lessons-list" class="space-y-4">
                </div>
            <div id="no-lessons-results" class="hidden text-center p-8 bg-white dark:bg-secondary-dark rounded-xl shadow-lg mt-8 text-gray-500 dark:text-gray-400">
                <p data-i18n="lessons.noResults">No lessons matched your search criteria.</p>
            </div>
        </div>

        <div id="lesson-content-view" class="hidden">
            <header id="lesson-content-header" class="text-center py-10 bg-white dark:bg-secondary-dark rounded-xl shadow-lg mb-8 border-t-4 border-primary-blue dark:border-secondary-blue">
                <h1 id="lesson-content-title" class="text-4xl font-extrabold text-primary-blue dark:text-secondary-blue mb-2"></h1>
                <p id="lesson-content-brief" class="text-lg text-gray-600 dark:text-gray-300"></p>
            </header>

            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <button id="markdown-cms-trigger" class="hidden px-5 py-2.5 rounded-full bg-primary-blue text-white font-semibold shadow-lg hover:bg-blue-600 transition" data-i18n="lesson.openMarkdownStudio" onclick="openMarkdownCMS()">
                    Markdown Studio
                </button>
            </div>

            <div id="lesson-resources" class="card-surface p-4 rounded-2xl mb-8 flex flex-wrap gap-4 justify-center border border-transparent">
                </div>

            <div id="lesson-content-theory" class="lesson-content card-surface p-6 md:p-8 rounded-2xl mb-8 border border-transparent">
                </div>

            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-4" data-i18n="lesson.exercises">Exercises</h2>
                <div id="lesson-content-exercises" class="space-y-4">
                    </div>
            </div>
        </div>

        <div id="block-sheets-view" class="hidden">
            <header id="block-sheets-header" class="section-hero text-center py-10 px-6 rounded-3xl shadow-2xl mb-10 border-t-4 border-primary-blue dark:border-secondary-blue">
                <div id="block-sheets-icon" class="text-5xl mb-2"></div>
                <h2 id="block-sheets-title" class="text-3xl font-extrabold text-primary-blue dark:text-secondary-blue mb-1"></h2>
                <p id="block-sheets-description" class="text-lg text-gray-600 dark:text-gray-300 px-4" data-i18n="blockSheets.description">Select a sheet to view:</p>

                <div id="block-sheets-extra-resources" class="mt-4 flex flex-wrap gap-4 justify-center">
                    </div>
                </header>

            <div id="block-sheets-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>

        </div>

    </main>

    <footer class="relative z-10 mt-12 mx-auto max-w-4xl p-6 text-center text-sm text-gray-500 dark:text-gray-400 bg-white/80 dark:bg-secondary-dark/70 backdrop-blur-xl rounded-3xl shadow-lg border border-white/40 dark:border-white/10">
        <p data-i18n="footer.copy">NIES Learning Management System &copy; 2025</p>
    </footer>

    <div id="markdown-cms-overlay" class="hidden" onclick="closeMarkdownCMS(event)">
        <div id="markdown-cms-panel" role="dialog" aria-modal="true" aria-labelledby="markdown-cms-title" onclick="event.stopPropagation()">
            <header>
                <div>
                    <h2 id="markdown-cms-title" class="text-2xl font-bold text-primary-blue dark:text-secondary-blue" data-i18n="lesson.cmsTitle">Markdown Studio</h2>
                    <p id="markdown-cms-context" class="text-sm text-gray-600 dark:text-gray-300"></p>
                </div>
                <div class="studio-toolbar">
                    <button type="button" class="secondary" onclick="syncLessonMarkdown()" data-i18n="lesson.cmsSync">Sync lesson</button>
                    <button type="button" onclick="copyMarkdownFromEditor()" data-i18n="lesson.cmsCopy">Copy Markdown</button>
                    <button type="button" class="secondary" onclick="downloadMarkdownFromEditor()" data-i18n="lesson.cmsDownload">Download .md</button>
                    <button type="button" class="danger" onclick="closeMarkdownCMS()" data-i18n="lesson.cmsClose">Close</button>
                </div>
            </header>
            <div class="studio-body">
                <div class="flex flex-col gap-3">
                    <label for="markdown-editor" class="text-sm font-semibold text-gray-700 dark:text-gray-200" data-i18n="lesson.cmsEditorLabel">Markdown input</label>
                    <textarea id="markdown-editor" placeholder="# Start writing..." data-i18n-placeholder="lesson.cmsEditorPlaceholder" oninput="updateMarkdownPreview()"></textarea>
                    <p class="text-xs text-gray-500 dark:text-gray-400" data-i18n="lesson.cmsHelper">Use Markdown syntax to structure your lesson content. Changes are not saved automatically.</p>
                </div>
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200" data-i18n="lesson.cmsPreviewLabel">Live preview</span>
                        <span id="markdown-preview-meta" class="text-xs text-gray-500 dark:text-gray-400"></span>
                    </div>
                    <div id="markdown-preview" class="markdown-body"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/70 dark:bg-black/80 z-40 transition-opacity duration-300" onclick="closeModal()"></div>
    <div id="modal-container" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 h-5/6 md:w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow-2xl z-50 p-4 flex flex-col transition-transform duration-300 scale-95">
        <button id="modal-close-btn" onclick="closeModal()" class="absolute -top-3 -right-3 rtl:-left-3 rtl:-right-auto bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg font-bold shadow-lg hover:bg-red-700 z-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
            &times;
        </button>
        <div id="modal-content" class="w-full h-full overflow-auto rounded">
            </div>
    </div>
<script src="s-data.js"></script>
    <script>
        // ====================================================================
        // بيانات المواد التعليمية (كائن JSON مركزي)
        // ====================================================================

        if (typeof marked !== 'undefined') {
            marked.setOptions({
                gfm: true,
                breaks: true,
                highlight(code, lang) {
                    if (window.hljs) {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return hljs.highlightAuto(code).value;
                    }
                    return code;
                }
            });
        }

        const SUPPORTED_LANGUAGES = ['en', 'ar'];
        const FALLBACK_LANGUAGE = 'en';
        const NEXT_LANGUAGE_LABEL = { en: 'AR', ar: 'EN' };

        const TRANSLATIONS = {
            en: {
                'nav.back': 'Back',
                'nav.title': 'NIES LMS',
                'nav.logout': 'Log Out',
                'nav.logoutTitle': 'Log Out',
                'hero.badge': 'Personalized for Grade 6',
                'hero.title': 'Welcome, Student!',
                'hero.subtitle': 'Choose a subject to continue your Grade 6 learning journey:',
                'page.dashboardTitle': 'NIES LMS Dashboard',
                'blocks.searchPlaceholder': 'Search Blocks...',
                'blocks.noResults': 'No blocks matched your search criteria.',
                'blocks.lessonCountLabel': 'Lessons',
                'lessons.searchPlaceholder': 'Search Lessons...',
                'lessons.noResults': 'No lessons matched your search criteria.',
                'lessons.emptyState': 'This block does not contain any lessons yet.',
                'lesson.exercises': 'Exercises',
                'lesson.openMarkdownStudio': 'Open Markdown Studio',
                'lesson.cmsTitle': 'Markdown Studio',
                'lesson.cmsSync': 'Sync lesson',
                'lesson.cmsCopy': 'Copy Markdown',
                'lesson.cmsDownload': 'Download .md',
                'lesson.cmsClose': 'Close',
                'lesson.cmsEditorLabel': 'Markdown input',
                'lesson.cmsEditorPlaceholder': '# Start writing...',
                'lesson.cmsHelper': 'Use Markdown syntax to structure your lesson content. Changes are not saved automatically.',
                'lesson.cmsPreviewLabel': 'Live preview',
                'lesson.cmsMetaLanguage': 'Language',
                'lesson.cmsMetaLines': 'Lines',
                'lesson.cmsMetaWords': 'Words',
                'lesson.cmsSynced': 'In sync with lesson content',
                'lesson.cmsUnsynced': 'Unsynced changes',
                'lesson.contentUnavailable': 'Lesson content is not available yet.',
                'blockSheets.description': 'Select a sheet to view:',
                'footer.copy': 'NIES Learning Management System © 2025',
                'language.switchToArabic': 'Switch to Arabic',
                'language.switchToEnglish': 'Switch to English',
                'quiz.noQuestions': 'No quiz questions available.',
                'quiz.title': 'Interactive Quiz',
                'quiz.questionLabel': 'Question',
                'quiz.submit': 'Submit Answers',
                'quiz.resultTitle': 'Quiz Result',
                'quiz.scoreLabel': 'You scored:',
                'quiz.reviewTitle': 'Answers Review',
                'quiz.yourAnswer': 'Your answer:',
                'quiz.correctAnswer': 'Correct answer:',
                'quiz.unanswered': 'You did not answer this question.',
                'quiz.retake': 'Retake Quiz',
                'quiz.review': 'Review Questions',
                'quiz.startLesson': 'Start Quiz',
                'quiz.score': 'Score',
                'quiz.centerHeading': 'Quiz Center',
                'quiz.centerDescription': 'Preview the questions, start the quiz, or revisit your progress.',
                'quiz.questionsLabel': 'Questions',
                'quiz.lastScore': 'Last Score',
                'quiz.overviewTab': 'Overview',
                'quiz.previewTab': 'Preview',
                'quiz.takeTab': 'Take Quiz',
                'quiz.overviewTitle': 'Get ready to ace this quiz!',
                'quiz.overviewDescription': 'Take a quick look at the essentials before you begin.',
                'quiz.overviewTip1': 'Preview the questions to prepare your strategy.',
                'quiz.overviewTip2': 'Answer each question carefully and review before submitting.',
                'quiz.overviewTip3': 'Return anytime to improve your score.',
                'quiz.overviewStart': 'Start the Quiz',
                'quiz.correctAnswerShort': 'Correct answer',
                'quiz.previewMode': 'Preview mode',
                'common.close': 'Close',
                'common.couldNotLoad': 'Could not load content.',
                'video.loadError': 'Could not load video.',
                'video.unsupportedTag': 'Your browser does not support the video tag.',
                'resource.invalidDrive': 'Invalid Google Drive link.',
                'blockSheets.title': 'Block Sheets',
                'blockSheets.startQuiz': 'Start Block Quiz',
                'blockSheets.noPdfs': 'No PDF sheets found for this block.',
                'media.watchVideo': 'Watch Video',
                'media.pdfFile': 'PDF File',
                'media.video': 'Video'
            },
            ar: {
                'nav.back': 'عودة',
                'nav.title': 'نظام NIES التعليمي',
                'nav.logout': 'تسجيل الخروج',
                'nav.logoutTitle': 'تسجيل الخروج',
                'hero.badge': 'مصمم خصيصًا للصف السادس',
                'hero.title': 'مرحباً بك، أيها الطالب/الطالبة!',
                'hero.subtitle': 'اختر مادة لمتابعة رحلتك التعليمية للصف السادس:',
                'page.dashboardTitle': 'لوحة تحكم نظام NIES التعليمي',
                'blocks.searchPlaceholder': 'البحث في البلوكات...',
                'blocks.noResults': 'لا توجد بلوكات مطابقة لمعايير البحث.',
                'blocks.lessonCountLabel': 'درس/دروس',
                'lessons.searchPlaceholder': 'البحث في الدروس...',
                'lessons.noResults': 'لا توجد دروس مطابقة لمعايير البحث.',
                'lessons.emptyState': 'هذه الوحدة لا تحتوي على أي دروس حالياً.',
                'lesson.exercises': 'التمارين',
                'lesson.openMarkdownStudio': 'فتح محرر Markdown',
                'lesson.cmsTitle': 'استوديو Markdown',
                'lesson.cmsSync': 'مزامنة مع الدرس',
                'lesson.cmsCopy': 'نسخ Markdown',
                'lesson.cmsDownload': 'تنزيل ملف .md',
                'lesson.cmsClose': 'إغلاق',
                'lesson.cmsEditorLabel': 'محرر Markdown',
                'lesson.cmsEditorPlaceholder': '# ابدأ بالكتابة...',
                'lesson.cmsHelper': 'استخدم صيغة Markdown لتنظيم محتوى الدرس. لا يتم حفظ التغييرات تلقائياً.',
                'lesson.cmsPreviewLabel': 'معاينة مباشرة',
                'lesson.cmsMetaLanguage': 'اللغة',
                'lesson.cmsMetaLines': 'الأسطر',
                'lesson.cmsMetaWords': 'الكلمات',
                'lesson.cmsSynced': 'المحتوى متوافق مع بيانات الدرس',
                'lesson.cmsUnsynced': 'تغييرات غير محفوظة',
                'lesson.contentUnavailable': 'محتوى الدرس غير متوفر حالياً.',
                'blockSheets.description': 'اختر ملفاً لعرضه:',
                'footer.copy': 'نظام NIES لإدارة التعلم © 2025',
                'language.switchToArabic': 'التبديل إلى العربية',
                'language.switchToEnglish': 'التبديل إلى الإنجليزية',
                'quiz.noQuestions': 'لا توجد أسئلة اختبار متاحة.',
                'quiz.title': 'اختبار تفاعلي',
                'quiz.questionLabel': 'السؤال',
                'quiz.submit': 'إرسال الإجابات',
                'quiz.resultTitle': 'نتيجة الاختبار',
                'quiz.scoreLabel': 'نتيجتك هي:',
                'quiz.reviewTitle': 'مراجعة الإجابات',
                'quiz.yourAnswer': 'إجابتك:',
                'quiz.correctAnswer': 'الإجابة الصحيحة:',
                'quiz.unanswered': 'لم تجب على هذا السؤال.',
                'quiz.retake': 'إعادة الاختبار',
                'quiz.review': 'مراجعة الأسئلة',
                'quiz.startLesson': 'ابدأ الاختبار',
                'quiz.score': 'النتيجة',
                'quiz.centerHeading': 'مركز الاختبار',
                'quiz.centerDescription': 'استعرض الأسئلة، ابدأ الاختبار، أو راجع تقدمك.',
                'quiz.questionsLabel': 'الأسئلة',
                'quiz.lastScore': 'آخر نتيجة',
                'quiz.overviewTab': 'نظرة عامة',
                'quiz.previewTab': 'استعراض',
                'quiz.takeTab': 'حل الاختبار',
                'quiz.overviewTitle': 'استعد للتفوق في هذا الاختبار!',
                'quiz.overviewDescription': 'ألقِ نظرة سريعة على أهم التفاصيل قبل البدء.',
                'quiz.overviewTip1': 'استعرض الأسئلة مسبقًا لتحضير استراتيجيتك.',
                'quiz.overviewTip2': 'أجب عن كل سؤال بعناية وراجع إجاباتك قبل الإرسال.',
                'quiz.overviewTip3': 'عد في أي وقت لتحسين نتيجتك.',
                'quiz.overviewStart': 'ابدأ الاختبار الآن',
                'quiz.correctAnswerShort': 'الإجابة الصحيحة',
                'quiz.previewMode': 'وضع المعاينة',
                'common.close': 'إغلاق',
                'common.couldNotLoad': 'لم نتمكن من تحميل المحتوى.',
                'video.loadError': 'لم نتمكن من تحميل الفيديو.',
                'video.unsupportedTag': 'متصفحك لا يدعم عرض الفيديو.',
                'resource.invalidDrive': 'رابط جوجل درايف غير صالح.',
                'blockSheets.title': 'ملفات الوحدة',
                'blockSheets.startQuiz': 'ابدأ اختبار الوحدة',
                'blockSheets.noPdfs': 'لا توجد ملفات PDF لهذه الوحدة.',
                'media.watchVideo': 'مشاهدة الفيديو',
                'media.pdfFile': 'ملف PDF',
                'media.video': 'فيديو'
            }
        };

        let currentLang = FALLBACK_LANGUAGE;

        function resolveLanguage(lang) {
            if (!lang) return FALLBACK_LANGUAGE;
            const normalized = lang.toLowerCase();
            return SUPPORTED_LANGUAGES.includes(normalized) ? normalized : FALLBACK_LANGUAGE;
        }

        function t(key, langOverride) {
            const activeLang = resolveLanguage(langOverride || currentLang);
            const translation = TRANSLATIONS[activeLang]?.[key];
            if (translation) return translation;
            const fallbackTranslation = TRANSLATIONS[FALLBACK_LANGUAGE]?.[key];
            return fallbackTranslation || key;
        }

        // ====================================================================
        // متغيرات الحالة العالمية والتاريخ
        // ====================================================================
        const langToggle = document.getElementById('lang-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const htmlElement = document.documentElement;
        const backButton = document.getElementById('back-button');
        const appTitleContainer = document.getElementById('app-title-container');
        const logoutLink = document.getElementById('logout-link');
        const markdownOverlay = document.getElementById('markdown-cms-overlay');
        const markdownEditor = document.getElementById('markdown-editor');
        const markdownPreview = document.getElementById('markdown-preview');
        const markdownPreviewMeta = document.getElementById('markdown-preview-meta');
        const markdownCMSTrigger = document.getElementById('markdown-cms-trigger');
        const markdownCMSContext = document.getElementById('markdown-cms-context');

        // [مهم] استخدام الكوكيز بدلاً من localStorage
        let currentTheme = getCookie('appTheme') || 'light';

        let stateHistory = []; // لتخزين تاريخ التنقل بين المراحل
        let currentState = { view: 'dashboard', subjectId: null, blockId: null, lessonId: null };
        let currentQuizData = null;
        let currentLessonMarkdown = '';
        let currentLessonTitle = '';
        let currentLessonLanguage = FALLBACK_LANGUAGE;
        let currentLessonContext = null;
        let markdownDirty = false;

        // ====================================================================
        // وظائف إدارة الكوكيز
        // ====================================================================
         function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function detectInitialLanguage() {
            const savedLang = getCookie('appLang');
            if (savedLang) {
                return resolveLanguage(savedLang);
            }

            const browserLang = (navigator.language || navigator.userLanguage || '').toLowerCase();
            if (browserLang.startsWith('ar')) {
                return 'ar';
            }

            return FALLBACK_LANGUAGE;
        }

        currentLang = detectInitialLanguage();

        // ====================================================================
        // وظائف إدارة الثيم (الوضع الليلي/النهاري)
        // ====================================================================
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');

        function setTheme(theme) {
            currentTheme = theme;
            setCookie('appTheme', theme, 365);

            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            } else {
                htmlElement.classList.remove('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            }
        }

        function toggleTheme() {
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        }


        // ====================================================================
        // وظائف التحميل والعرض (مع تعديلات للثيم واللغة)
        // ====================================================================

        /**
         * وظيفة ذكية لاسترجاع المحتوى النصي بلغة معينة، مع آلية Fallback
         */
        function getLocalizedText(contentObj, preferredLang) {
            if (!contentObj) return '[...]';
            if (typeof contentObj === 'string') return contentObj;

            const fallbackLang = preferredLang === 'en' ? 'ar' : 'en';

            return contentObj[preferredLang] || contentObj[fallbackLang] || contentObj.en || contentObj.ar || '[...]';
        }

        /**
         * تبديل المحتوى النصي بناءً على اللغة المختارة وحفظها في الكوكيز
         */
        function switchLanguage(lang) {
            const resolvedLang = resolveLanguage(lang);
            currentLang = resolvedLang;
            setCookie('appLang', resolvedLang, 365);

            // 1. تبديل وضع الجسم (Directionality & Font)
            if (resolvedLang === 'ar') {
                body.classList.remove('en-mode');
                body.classList.add('ar-mode');
                htmlElement.lang = 'ar';
                htmlElement.dir = 'rtl';
            } else {
                body.classList.remove('ar-mode');
                body.classList.add('en-mode');
                htmlElement.lang = 'en';
                htmlElement.dir = 'ltr';
            }

            // 2. تحديث جميع العناصر الثابتة التي تحتوي على مفاتيح الترجمة
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.dataset.i18n;
                if (key) {
                    element.textContent = t(key, resolvedLang);
                }
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.dataset.i18nPlaceholder;
                if (key) {
                    element.setAttribute('placeholder', t(key, resolvedLang));
                }
            });

            document.querySelectorAll('[data-i18n-title]').forEach(element => {
                const key = element.dataset.i18nTitle;
                if (key) {
                    element.setAttribute('title', t(key, resolvedLang));
                }
            });

            const ariaLabel = resolvedLang === 'en' ? t('language.switchToArabic', resolvedLang) : t('language.switchToEnglish', resolvedLang);
            if (langToggle) {
                const nextLabel = NEXT_LANGUAGE_LABEL[resolvedLang] || NEXT_LANGUAGE_LABEL[FALLBACK_LANGUAGE];
                langToggle.querySelector('span').textContent = nextLabel;
                langToggle.setAttribute('aria-label', ariaLabel);
                langToggle.setAttribute('title', ariaLabel);
            }

            if (logoutLink) {
                logoutLink.setAttribute('aria-label', t('nav.logout', resolvedLang));
                logoutLink.setAttribute('title', t('nav.logoutTitle', resolvedLang));
            }

            // 3. إعادة رسم المحتوى الديناميكي الحالي لضمان تطبيق اللغة الصحيحة
            changeView(currentState.view, currentState.subjectId, currentState.blockId, currentState.lessonId, false);

            if (!markdownOverlay?.classList.contains('hidden')) {
                updateMarkdownPreview();
            }
        }

        function renderMarkdown(markdownText = '') {
            if (!markdownText) return '';
            if (typeof marked !== 'undefined') {
                return marked.parse(markdownText);
            }
            return markdownText.replace(/\n/g, '<br>');
        }

        function highlightMarkdown(container) {
            if (!container || !window.hljs) return;
            container.querySelectorAll('pre code').forEach(codeBlock => {
                hljs.highlightElement(codeBlock);
            });
        }

        function updateMarkdownMeta(markdownText) {
            if (!markdownPreviewMeta) return;
            const text = markdownText || '';
            const lines = text ? text.split(/\r?\n/).length : 0;
            const words = text ? (text.trim().split(/\s+/).filter(Boolean).length) : 0;
            const metaParts = [
                `${t('lesson.cmsMetaLanguage')}: ${currentLessonLanguage.toUpperCase()}`,
                `${t('lesson.cmsMetaLines')}: ${lines}`,
                `${t('lesson.cmsMetaWords')}: ${words}`,
                markdownDirty ? t('lesson.cmsUnsynced') : t('lesson.cmsSynced')
            ];
            markdownPreviewMeta.textContent = metaParts.join(' • ');
        }

        function updateMarkdownPreview() {
            if (!markdownEditor || !markdownPreview) return;
            const markdownText = markdownEditor.value || '';
            const html = renderMarkdown(markdownText);
            markdownPreview.innerHTML = `<article class="markdown-body">${html}</article>`;
            highlightMarkdown(markdownPreview);
            markdownDirty = markdownText !== (currentLessonMarkdown || '');
            updateMarkdownMeta(markdownText);
        }

        function syncLessonMarkdown() {
            if (!markdownEditor) return;
            markdownEditor.value = currentLessonMarkdown || '';
            markdownDirty = false;
            updateMarkdownPreview();
        }

        function openMarkdownCMS() {
            if (!markdownOverlay) return;
            markdownOverlay.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            syncLessonMarkdown();
        }

        function closeMarkdownCMS(event) {
            if (event && event.type === 'click' && event.target !== markdownOverlay) {
                return;
            }
            if (!markdownOverlay) return;
            markdownOverlay.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        function copyMarkdownFromEditor() {
            if (!markdownEditor) return;
            const value = markdownEditor.value || '';
            if (navigator.clipboard?.writeText) {
                navigator.clipboard.writeText(value).then(() => {
                    markdownDirty = value !== (currentLessonMarkdown || '');
                    updateMarkdownMeta(value);
                }).catch(err => console.warn('Clipboard copy failed', err));
                return;
            }
            const tempArea = document.createElement('textarea');
            tempArea.value = value;
            tempArea.setAttribute('readonly', '');
            tempArea.style.position = 'absolute';
            tempArea.style.left = '-9999px';
            document.body.appendChild(tempArea);
            tempArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.warn('Legacy clipboard copy failed', err);
            }
            document.body.removeChild(tempArea);
            markdownDirty = value !== (currentLessonMarkdown || '');
            updateMarkdownMeta(value);
        }

        function downloadMarkdownFromEditor() {
            if (!markdownEditor) return;
            const blob = new Blob([markdownEditor.value || ''], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const lessonName = currentLessonTitle ? currentLessonTitle.replace(/[^\w\u0600-\u06FF-]+/g, '-').replace(/-{2,}/g, '-').replace(/^-|-$/g, '') : 'lesson';
            const contextSuffix = currentLessonContext ? `${currentLessonContext.subjectId || 'subject'}-${currentLessonContext.blockId || 'block'}-${currentLessonContext.lessonId || 'lesson'}` : 'lesson';
            const baseName = lessonName || contextSuffix;
            link.href = url;
            link.download = `${baseName || 'lesson'}.${currentLessonLanguage || 'en'}.md`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * يتحكم في عرض المراحل المختلفة وتحديث الحالة
         */
        function changeView(view, subjectId = null, blockId = null, lessonId = null, updateHistory = true) {

            if (updateHistory && JSON.stringify(currentState) !== JSON.stringify({ view, subjectId, blockId, lessonId })) {
                 if (currentState.view !== 'dashboard') {
                    stateHistory.push({...currentState});
                 }
            }

            currentState = { view, subjectId, blockId, lessonId };

            // إخفاء جميع العروض
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('blocks-view').classList.add('hidden');
            document.getElementById('lessons-view').classList.add('hidden');
            document.getElementById('lesson-content-view').classList.add('hidden');
            if (markdownCMSTrigger) {
                markdownCMSTrigger.classList.add('hidden');
            }
            if (view !== 'lesson-content' && markdownOverlay && !markdownOverlay.classList.contains('hidden')) {
                closeMarkdownCMS();
            }
            // ===================================
            // [!!!] START OF MODIFICATION [!!!]
            // ===================================
            document.getElementById('block-sheets-view').classList.add('hidden'); // [جديد] إخفاء الصفحة الجديدة
            // ===================================
            // [!!!] END OF MODIFICATION [!!!]
            // ===================================

            // إعدادات شريط التنقل (زر العودة وعنوان التطبيق)
            const isDashboard = (view === 'dashboard');
            backButton.classList.toggle('hidden', isDashboard);
            appTitleContainer.classList.toggle('hidden', !isDashboard);

            // تحديث العرض المطلوب ورسم المحتوى
            try {
                if (view === 'dashboard') {
                    document.getElementById('dashboard-view').classList.remove('hidden');
                    renderDashboard();
                } else if (view === 'blocks' && subjectId) {
                    document.getElementById('blocks-view').classList.remove('hidden');
                    renderBlocksView(subjectId);
                } else if (view === 'lessons' && subjectId && blockId) {
                    document.getElementById('lessons-view').classList.remove('hidden');
                    renderLessonsView(subjectId, blockId);
                } else if (view === 'lesson-content' && subjectId && blockId && lessonId) {
                    document.getElementById('lesson-content-view').classList.remove('hidden');
                    renderLessonContentView(subjectId, blockId, lessonId);
                // ===================================
                // [!!!] START OF MODIFICATION [!!!]
                // ===================================
                } else if (view === 'block-sheets' && subjectId && blockId) { // [جديد] حالة الصفحة الجديدة
                    document.getElementById('block-sheets-view').classList.remove('hidden');
                    renderBlockSheetsView(subjectId, blockId);
                // ===================================
                // [!!!] END OF MODIFICATION [!!!]
                // ===================================
                } else {
                     console.error("Invalid view state:", currentState);
                     changeView('dashboard');
                }
            } catch (error) {
                console.error("Error rendering view:", view, error);
                changeView('dashboard');
            }

            window.scrollTo(0, 0);
        }

        /**
         * العودة إلى الحالة السابقة في تاريخ التنقل
         */
        function goBack() {
            if (stateHistory.length > 0) {
                const previousState = stateHistory.pop();
                changeView(previousState.view, previousState.subjectId, previousState.blockId, previousState.lessonId, false);
            } else {
                changeView('dashboard', null, null, null, false);
            }
        }

        /**
         * بناء وعرض شبكة المواد الرئيسية
         */
        function renderDashboard() {
            const subjectGrid = document.getElementById('subject-grid');
            subjectGrid.innerHTML = '';

            Object.keys(SUBJECT_DATA).forEach(id => {
                const subject = SUBJECT_DATA[id];
                const titleText = getLocalizedText(subject.title, currentLang);

                const card = document.createElement('div');
                card.onclick = () => changeView('blocks', id);
                card.className = 'subject-card group cursor-pointer transition duration-300 ease-in-out';

                card.innerHTML = `
                    <div class="p-6 h-full bg-white dark:bg-secondary-dark rounded-xl shadow-md hover:shadow-lg dark:hover:shadow-blue-900/50 transition-all duration-300 transform hover:-translate-y-1 border-b-4" style="border-color: ${subject.color || 'var(--primary-blue)'};">
                        <div class="flex flex-col items-center justify-center h-full text-center">
                            <span class="text-5xl mb-4 transition duration-300 group-hover:scale-110">${subject.icon}</span>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${titleText}</h3>
                        </div>
                    </div>
                `;
                subjectGrid.appendChild(card);
            });

            const dashboardTitle = t('page.dashboardTitle');
            document.getElementById('page-title').textContent = dashboardTitle;
            document.title = dashboardTitle;
        }

        /**
         * بناء وعرض شاشة تفاصيل المادة والبلوكات
         */
        function renderBlocksView(subjectId) {
            const subjectData = SUBJECT_DATA[subjectId];
            if (!subjectData) return changeView('dashboard');

            const subjectColor = subjectData.color || 'var(--primary-blue)';
            document.documentElement.style.setProperty('--subject-color', subjectColor);
            document.getElementById('subject-header-blocks').style.borderTopColor = subjectColor;

            const titleText = getLocalizedText(subjectData.title, currentLang);
            const descriptionText = getLocalizedText(subjectData.description, currentLang);

            document.getElementById('page-title').textContent = titleText;
            document.getElementById('subject-icon-blocks').textContent = subjectData.icon;
            document.getElementById('subject-title-blocks').textContent = titleText;
            document.getElementById('subject-description-blocks').textContent = descriptionText;

            document.getElementById('blocks-search').placeholder = t('blocks.searchPlaceholder');
            document.getElementById('blocks-search').value = '';

            filterBlocks();
        }

        /**
         * تصفية وعرض البلوكات بناءً على مدخلات البحث
         */
        function filterBlocks() {
            const subjectId = currentState.subjectId;
            if (!subjectId || !SUBJECT_DATA[subjectId]) return;
            const subjectData = SUBJECT_DATA[subjectId];

            const searchTerm = document.getElementById('blocks-search').value.toLowerCase();
            const blocksGrid = document.getElementById('blocks-grid');
            blocksGrid.innerHTML = '';

            let resultsCount = 0;

            subjectData.blocks.forEach(block => {
                const blockTitle = getLocalizedText(block.title, currentLang).toLowerCase();
                const blockBrief = getLocalizedText(block.brief, currentLang).toLowerCase();

                if (blockTitle.includes(searchTerm) || blockBrief.includes(searchTerm)) {
                    resultsCount++;
                    const blockCard = document.createElement('div');
                    // [مُعدل] البطاقة بأكملها تنقلك إلى قائمة الدروس
                    blockCard.onclick = () => changeView('lessons', subjectId, block.id);
                    blockCard.className = 'subject-card group cursor-pointer transition duration-300 ease-in-out';

                    blockCard.innerHTML = `
                        <div class="card-surface p-6 h-full rounded-2xl transition-all duration-300 transform hover:-translate-y-1 border-b-4 border-[var(--subject-color)] flex flex-col">
                            <span class="text-3xl mb-2 font-semibold text-[var(--subject-color)]">#${block.id}</span>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">${getLocalizedText(block.title, currentLang)}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 flex-grow">${getLocalizedText(block.brief, currentLang)}</p>
                        <span class="mt-4 text-sm font-semibold text-gray-500 dark:text-gray-400">${(block.lessons || []).length} ${t('blocks.lessonCountLabel')}</span>
                        </div>
                    `;
                    blocksGrid.appendChild(blockCard);
                }
            });

            document.getElementById('no-blocks-results').classList.toggle('hidden', resultsCount > 0);
        }

        /**
         * بناء وعرض شاشة تفاصيل البلوك والدروس
         */
        function renderLessonsView(subjectId, blockId) {
            const subjectData = SUBJECT_DATA[subjectId];
            if (!subjectData) return changeView('blocks', subjectId);
            const block = subjectData.blocks.find(b => b.id === blockId);
            if (!block) return changeView('blocks', subjectId);

            const subjectColor = subjectData.color || 'var(--primary-blue)';
            document.documentElement.style.setProperty('--subject-color', subjectColor);
            document.getElementById('block-header-lessons').style.borderTopColor = subjectColor;

            // تحديث محتوى الترويسة
            const blockTitleText = getLocalizedText(block.title, currentLang);
            const subjectTitleText = getLocalizedText(subjectData.title, currentLang);
            document.getElementById('page-title').textContent = `${blockTitleText} | ${subjectTitleText}`;
            document.getElementById('block-subject-icon-lessons').textContent = subjectData.icon;
            document.getElementById('block-title-lessons').textContent = blockTitleText;
            document.getElementById('block-brief-lessons').textContent = getLocalizedText(block.brief, currentLang);

            // [مُعدل] إضافة زر موارد البلوك إلى الترويسة
            const buttonContainer = document.getElementById('block-resources-button-container');
            buttonContainer.innerHTML = ''; // إفراغ الحاوية
             // Check specifically for pdfs to decide if the button should show
            if (hasPdfResources(block.block_resources)) {
                const buttonText = getLocalizedText({en: `View Block ${block.id} Sheets`, ar: `عرض ملفات الوحدة ${block.id}`}, currentLang);
                buttonContainer.innerHTML = `
                    <button onclick="changeView('block-sheets', '${subjectId}', ${block.id})"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition duration-200 focus:ring-purple-500">
                        📄 ${buttonText}
                    </button>
                `;
            }


            document.getElementById('lessons-search').placeholder = t('lessons.searchPlaceholder');
            document.getElementById('lessons-search').value = '';

            filterLessons();
        }

        /**
         * تصفية وعرض الدروس بناءً على مدخلات البحث
         */
        function filterLessons() {
            const subjectId = currentState.subjectId;
            const blockId = currentState.blockId;
            if (!subjectId || !blockId || !SUBJECT_DATA[subjectId]) return;
            const subjectData = SUBJECT_DATA[subjectId];
            const block = subjectData.blocks.find(b => b.id === blockId);
            if (!block) return;

            const searchTerm = document.getElementById('lessons-search').value.toLowerCase();
            const lessonsList = document.getElementById('lessons-list');
            lessonsList.innerHTML = '';

            let resultsCount = 0;
            const lessons = block.lessons || [];

            lessons.forEach(lesson => {
                const lessonTitle = getLocalizedText(lesson.title, currentLang).toLowerCase();
                const lessonBrief = getLocalizedText(lesson.brief, currentLang).toLowerCase();

                if (lessonTitle.includes(searchTerm) || lessonBrief.includes(searchTerm)) {
                    resultsCount++;
                    const lessonCard = document.createElement('div');
                    lessonCard.onclick = () => changeView('lesson-content', subjectId, blockId, lesson.id);
                    lessonCard.className = 'card-surface p-5 rounded-2xl transition duration-300 border-l-4 rtl:border-l-0 rtl:border-r-4 border-[var(--subject-color)] cursor-pointer hover:-translate-y-1';
                    lessonCard.innerHTML = `
                        <h4 class="text-lg font-bold text-gray-800 dark:text-gray-100">${getLocalizedText(lesson.title, currentLang)}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${getLocalizedText(lesson.brief, currentLang)}</p>
                    `;
                    lessonsList.appendChild(lessonCard);
                }
            });

            document.getElementById('no-lessons-results').classList.toggle('hidden', resultsCount > 0 || lessons.length === 0);

            if (lessons.length === 0 && resultsCount === 0) {
                 lessonsList.innerHTML = `
                    <div class="text-center p-8 bg-white dark:bg-secondary-dark rounded-xl shadow-lg mt-4 text-gray-500 dark:text-gray-400">
                        <p>${t('lessons.emptyState')}</p>
                    </div>
                 `;
                  document.getElementById('no-lessons-results').classList.add('hidden');
            }
        }

        /**
         * بناء وعرض شاشة محتوى الدرس
         */
        function renderLessonContentView(subjectId, blockId, lessonId) {
            const subjectData = SUBJECT_DATA[subjectId];
            if (!subjectData) return changeView('lessons', subjectId, blockId);
            const block = subjectData.blocks.find(b => b.id === blockId);
            if (!block) return changeView('lessons', subjectId, blockId);
            const lesson = block.lessons.find(l => l.id === lessonId);
            if (!lesson) return changeView('lessons', subjectId, blockId);

            const subjectColor = subjectData.color || 'var(--primary-blue)';
            document.documentElement.style.setProperty('--subject-color', subjectColor);
            document.getElementById('lesson-content-header').style.borderTopColor = subjectColor;

            // 1. إعدادات الترويسة
            const lessonTitle = getLocalizedText(lesson.title, currentLang);
            document.getElementById('page-title').textContent = lessonTitle;
            document.getElementById('lesson-content-title').textContent = lessonTitle;
            document.getElementById('lesson-content-brief').textContent = getLocalizedText(lesson.brief, currentLang);
            currentLessonTitle = lessonTitle;
            currentLessonLanguage = currentLang;
            currentLessonContext = { subjectId, blockId, lessonId };
            if (markdownCMSContext) {
                const subjectTitle = getLocalizedText(subjectData.title, currentLang);
                const blockTitle = getLocalizedText(block.title, currentLang);
                markdownCMSContext.textContent = `${subjectTitle} › ${blockTitle} › ${lessonTitle}`;
            }
            if (markdownCMSTrigger) {
                markdownCMSTrigger.classList.remove('hidden');
            }

            // 2. عرض أزرار الموارد
            renderLessonResources(subjectId, blockId, lessonId, lesson.resources);

            // 3. عرض المحتوى النظري (HTML)
            const theoryContainer = document.getElementById('lesson-content-theory');
            if (lesson.content && lesson.content.theory) {
                const theoryMarkdown = getLocalizedText(lesson.content.theory, currentLang);
                currentLessonMarkdown = theoryMarkdown || '';
                if (theoryMarkdown) {
                    const theoryHtml = renderMarkdown(theoryMarkdown);
                    theoryContainer.innerHTML = `<article class="markdown-body">${theoryHtml}</article>`;
                    highlightMarkdown(theoryContainer);
                } else {
                    theoryContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400">${t('lesson.contentUnavailable')}</p>`;
                }
            } else {
                currentLessonMarkdown = '';
                theoryContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400">${t('lesson.contentUnavailable')}</p>`;
            }
            markdownDirty = false;
            updateMarkdownMeta(currentLessonMarkdown);
            if (markdownOverlay && !markdownOverlay.classList.contains('hidden')) {
                syncLessonMarkdown();
            }

            // 4. عرض التمارين (إذا وجدت)
            const exercisesContainer = document.getElementById('lesson-content-exercises');
            exercisesContainer.innerHTML = '';
            const exercises = lesson.content ? (lesson.content.exercises || []) : [];

            if (exercises.length > 0) {
                 exercisesContainer.previousElementSibling.classList.remove('hidden');

                exercises.forEach(ex => {
                    const exerciseCard = document.createElement('div');
                    exerciseCard.className = 'exercise-card';
                    exerciseCard.innerHTML = `
                        <p><span class="font-bold">${ex.id}.</span> ${getLocalizedText(ex.question, currentLang)}</p>
                    `;
                    exercisesContainer.appendChild(exerciseCard);
                });
            } else {
                 exercisesContainer.previousElementSibling.classList.add('hidden');
                 exercisesContainer.innerHTML = '';
            }
        }

        /**
         * بناء أزرار الموارد للدرس الحالي
         */
        function hasPdfResources(resourceSet) {
            if (!resourceSet) return false;
            const pdfSource = resourceSet.pdfs ?? resourceSet.pdf;
            if (Array.isArray(pdfSource)) {
                return pdfSource.some(item => {
                    if (!item) return false;
                    if (typeof item === 'string') return item.trim() !== '';
                    if (typeof item === 'object') return !!item.url;
                    return false;
                });
            }
            if (pdfSource && typeof pdfSource === 'object') {
                return Object.values(pdfSource).some(value => {
                    if (!value) return false;
                    if (typeof value === 'string') return value.trim() !== '';
                    if (typeof value === 'object') return !!value.url;
                    return false;
                });
            }
            if (typeof pdfSource === 'string') {
                return pdfSource.trim() !== '';
            }
            return false;
        }

        function resolveQuizData(resources) {
            if (!resources) return [];
            if (Array.isArray(resources.quiz) && resources.quiz.length) {
                return resources.quiz;
            }
            if (typeof resources.quizScript === 'string' && resources.quizScript.trim()) {
                try {
                    const fn = new Function(`return (${resources.quizScript})`);
                    const data = fn();
                    if (Array.isArray(data)) return data;
                } catch (error) {
                    console.warn('Unable to parse quiz script:', error);
                }
            }
            return [];
        }

        function renderLessonResources(subjectId, blockId, lessonId, resources) {
            const container = document.getElementById('lesson-resources');
            container.innerHTML = '';

            if (!resources || Object.keys(resources).length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            const pdfItems = Array.isArray(resources.pdfs)
                ? resources.pdfs
                : resources.pdfs && typeof resources.pdfs === 'object'
                    ? Object.entries(resources.pdfs).map(([key, value]) => ({
                        url: value,
                        name: { en: key.toUpperCase(), ar: key.toUpperCase() }
                    }))
                    : [];

            pdfItems.forEach(pdf => {
                if (!pdf || !pdf.url) return;
                const labelSource = pdf.name || pdf.title || { en: t('media.pdfFile', 'en'), ar: t('media.pdfFile', 'ar') };
                createResourceButton(
                    container,
                    'pdf',
                    pdf.url,
                    `📄 PDF: ${getLocalizedText(labelSource, currentLang)}`,
                    'bg-red-600 hover:bg-red-700'
                );
            });

            const videoItems = Array.isArray(resources.videos)
                ? resources.videos
                : resources.video
                    ? [{ url: resources.video, title: { en: t('media.video', 'en'), ar: t('media.video', 'ar') } }]
                    : [];

            videoItems.forEach(video => {
                if (!video || !video.url) return;
                const videoLabel = video.title ? getLocalizedText(video.title, currentLang) : t('media.watchVideo');
                createResourceButton(
                    container,
                    'video',
                    video.url,
                    `▶️ ${videoLabel}`,
                    'bg-blue-600 hover:bg-blue-700'
                );
            });

            const quizData = resolveQuizData(resources);
            if (quizData.length > 0) {
                const storageKey = `quizScore-${subjectId}-${blockId}-${lessonId}`;
                const savedScore = localStorage.getItem(storageKey);
                let quizButtonText = `📝 ${t('quiz.startLesson')}`;
                if (savedScore) {
                    quizButtonText += ` (${t('quiz.score')}: ${savedScore})`;
                }
                currentQuizData = quizData;
                createResourceButton(
                    container,
                    'quiz',
                    { subjectId, blockId, lessonId },
                    quizButtonText,
                    'bg-green-600 hover:bg-green-700'
                );
            }

            if (container.childElementCount === 0) {
                container.classList.add('hidden');
            }
        }

        /**
         * دالة مساعدة لإنشاء زر مورد
         */
         function createResourceButton(container, type, data, text, styleClasses) {
             const btn = document.createElement('button');
             btn.className = `text-white px-5 py-3 rounded-xl font-semibold shadow-lg transition duration-200 ${styleClasses}`;
             btn.innerHTML = text;
             if (type === 'quiz') {
                // Pass lesson-specific quiz data
                const lessonQuizData = data.lessonQuizData || currentQuizData; // Use specific if passed, else fallback
                btn.onclick = () => {
                    currentQuizData = lessonQuizData; // Ensure correct quiz data is set before opening modal
                    openModal(type, data.subjectId, data.blockId, data.lessonId);
                }
             } else {
                 btn.onclick = () => openModal(type, data); // PDF and Video open in modal
             }
             container.appendChild(btn);
         }


        // ====================================================================
        // وظائف الـ Modal (النافذة المنبثقة)
        // ====================================================================

        const modalOverlay = document.getElementById('modal-overlay');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');

        /**
         * فتح النافذة المنبثقة مع تأثير
         */
        function openModal(type, ...args) {
            modalContent.innerHTML = '';

            try {
                 if (type === 'pdf') {
                    const url = args[0];
                     if (!url || typeof url !== 'string') throw new Error("Invalid PDF URL");
                    // PDF يفتح الآن في Modal
                    modalContent.innerHTML = `<iframe src="${url}" class="w-full h-full border-0 rounded"></iframe>`;
                }
                else if (type === 'video') {
                    const videoUrl = args[0];
                     if (!videoUrl || typeof videoUrl !== 'string') throw new Error("Invalid video URL");
                    modalContent.innerHTML = getVideoEmbedHtml(videoUrl);
                }
                else if (type === 'quiz') {
                    const [subjectId, blockId, lessonId] = args;
                    if (!currentQuizData) {
                         throw new Error("Quiz data not loaded or set before opening modal.");
                    }
                    openQuizModal(currentQuizData, subjectId, blockId, lessonId);
                }
                else {
                     throw new Error(`Unsupported modal type: ${type}`);
                }

                 // إظهار الـ Modal بتأثير
                modalOverlay.classList.remove('hidden');
                 modalContainer.classList.remove('hidden');
                 setTimeout(() => {
                     modalOverlay.classList.add('opacity-100');
                     modalContainer.classList.add('scale-100');
                 }, 10);

            } catch (error) {
                 console.error("Error opening modal:", error);
                 modalContent.innerHTML = `<p class="p-4 text-red-600 dark:text-red-400">${t('common.couldNotLoad')}</p>`;
                 modalOverlay.classList.remove('hidden');
                 modalContainer.classList.remove('hidden');
                 setTimeout(() => {
                     modalOverlay.classList.add('opacity-100');
                     modalContainer.classList.add('scale-100');
                 }, 10);
            }
        }

        function openQuizModal(quizData, subjectId, blockId, lessonId) {
            const totalQuestions = quizData.length;
            const heading = t('quiz.centerHeading');
            const description = t('quiz.centerDescription');
            const questionsLabel = t('quiz.questionsLabel');
            const lastScoreLabel = t('quiz.lastScore');
            const overviewLabel = t('quiz.overviewTab');
            const previewLabel = t('quiz.previewTab');
            const takeLabel = t('quiz.takeTab');

            const storageKey = `quizScore-${subjectId}-${blockId}-${lessonId}`;
            const savedScore = localStorage.getItem(storageKey);

            const statsHtml = [`<span class="quiz-stat-pill">${questionsLabel}: ${totalQuestions}</span>`];
            if (savedScore) {
                statsHtml.push(`<span class="quiz-stat-pill">${lastScoreLabel}: ${savedScore}</span>`);
            }

            modalContent.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="px-6 pt-6 pb-4 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100">${heading}</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-2">${description}</p>
                        <div class="flex flex-wrap gap-2 mt-4">
                            ${statsHtml.join('')}
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 px-6 py-4" id="quiz-mode-tabs">
                        <button class="quiz-tab-btn" data-quiz-mode="overview">${overviewLabel}</button>
                        <button class="quiz-tab-btn" data-quiz-mode="preview">${previewLabel}</button>
                        <button class="quiz-tab-btn" data-quiz-mode="take">${takeLabel}</button>
                    </div>
                    <div id="quiz-dynamic-section" class="flex-1 overflow-auto px-6 pb-6"></div>
                </div>
            `;

            modalContent.querySelectorAll('.quiz-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.quizMode;
                    renderQuizSection(mode, subjectId, blockId, lessonId);
                });
            });

            renderQuizSection('overview', subjectId, blockId, lessonId);
        }

        function renderQuizSection(mode, subjectId, blockId, lessonId) {
            if (!currentQuizData) return;
            const section = document.getElementById('quiz-dynamic-section');
            if (!section) return;

            const tabButtons = modalContent.querySelectorAll('.quiz-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.quizMode === mode);
            });

            if (mode === 'overview') {
                const introTitle = t('quiz.overviewTitle');
                const introDescription = t('quiz.overviewDescription');
                const tips = [
                    t('quiz.overviewTip1'),
                    t('quiz.overviewTip2'),
                    t('quiz.overviewTip3')
                ];
                const startLabel = t('quiz.overviewStart');

                section.innerHTML = `
                    <div class="card-surface p-6 md:p-8 rounded-2xl border border-transparent space-y-5">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">${introTitle}</h3>
                        <p class="text-gray-600 dark:text-gray-300">${introDescription}</p>
                        <ul class="list-disc rtl:list-disc rtl:mr-6 ltr:list-disc ltr:ml-6 space-y-2 text-gray-600 dark:text-gray-300">
                            ${tips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                        <button data-action="start-quiz" class="mt-4 inline-flex items-center justify-center bg-green-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:bg-green-700 transition duration-200 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
                            ${startLabel}
                        </button>
                    </div>
                `;

                const startButton = section.querySelector('[data-action="start-quiz"]');
                if (startButton) {
                    startButton.addEventListener('click', () => renderQuizSection('take', subjectId, blockId, lessonId));
                }
                return;
            }

            if (mode === 'preview') {
                const questionLabel = t('quiz.questionLabel');
                const correctLabel = t('quiz.correctAnswerShort');

                let previewHtml = '<div class="space-y-5">';
                currentQuizData.forEach((q, index) => {
                    previewHtml += `
                        <div class="quiz-preview-item">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-semibold uppercase tracking-wide text-[var(--subject-color)]">${questionLabel} ${index + 1}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${t('quiz.previewMode')}</span>
                            </div>
                            <p class="text-base text-gray-700 dark:text-gray-200 mb-3">${getLocalizedText(q.q, currentLang)}</p>
                            <ul class="list-disc rtl:list-disc rtl:mr-5 ltr:list-disc ltr:ml-5 space-y-1 text-sm text-gray-600 dark:text-gray-300">
                                ${q.options.map(option => {
                                    const isCorrect = option === q.answer;
                                    return `<li class="${isCorrect ? 'font-semibold text-green-700 dark:text-green-300' : ''}">${option}${isCorrect ? ` — ${correctLabel}` : ''}</li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                });
                previewHtml += '</div>';
                section.innerHTML = previewHtml;
                return;
            }

            // Default to take mode
            buildQuizHTML(currentQuizData, subjectId, blockId, lessonId, 'quiz-dynamic-section');
        }

        /**
         * إغلاق النافذة المنبثقة مع تأثير
         */
        function closeModal() {
            modalOverlay.classList.remove('opacity-100');
            modalContainer.classList.remove('scale-100');
             setTimeout(() => {
                 modalOverlay.classList.add('hidden');
                 modalContainer.classList.add('hidden');
                 modalContent.innerHTML = '';
                 currentQuizData = null; // Clear quiz data on close
             }, 300);
        }

        /**
         * دالة ذكية لتحديد وعرض كود الفيديو المناسب
         */
        function getVideoEmbedHtml(videoUrl) {
            let embedHtml = '';
            const errorText = t('video.loadError');

            try {
                if (!videoUrl) throw new Error("Video URL is empty");

                if (videoUrl.includes('youtube.com/embed/')) {
                    embedHtml = `<iframe src="${videoUrl}" class="w-full h-full border-0 rounded" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else if (videoUrl.endsWith('.mp4')) {
                    const errorTag = t('video.unsupportedTag');
                    embedHtml = `<video controls class="w-full h-full bg-black rounded"><source src="${videoUrl}" type="video/mp4">${errorTag}</video>`;
                } else if (videoUrl.includes('drive.google.com/file/d/')) {
                    const match = videoUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        const fileId = match[1];
                        const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                        embedHtml = `<iframe src="${embedUrl}" class="w-full h-full border-0 rounded" frameborder="0"></iframe>`;
                    } else {
                         embedHtml = `<p class="p-4 text-red-500">${t('resource.invalidDrive')}</p>`;
                    }
                } else {
                    console.warn("Unknown video URL type, attempting generic iframe embed:", videoUrl);
                    embedHtml = `<iframe src="${videoUrl}" class="w-full h-full border-0 rounded" frameborder="0" allowfullscreen></iframe>`;
                }
            } catch (e) {
                console.error("Error parsing video URL:", videoUrl, e);
                embedHtml = `<p class="p-4 text-red-500">${errorText}</p>`;
            }

            return embedHtml;
        }


        // ===================================
        // [!!!] START OF MODIFICATION [!!!]
        // ===================================
        /**
         * [مُعدل] بناء عارض ملفات البلوك (صفحة كاملة مع "أزرار كبيرة")
         */
        function renderBlockSheetsView(subjectId, blockId) {
            const subjectData = SUBJECT_DATA[subjectId];
            if (!subjectData) return changeView('lessons', subjectId, blockId);

            const block = subjectData.blocks.find(b => b.id === blockId);
            if (!block) return changeView('lessons', subjectId, blockId);

            const resources = block.block_resources || {};

            const subjectColor = subjectData.color || 'var(--primary-blue)';
            document.getElementById('block-sheets-header').style.borderTopColor = subjectColor;
            document.getElementById('block-sheets-icon').textContent = subjectData.icon;

            const blockTitleText = getLocalizedText(block.title, currentLang);
            const pageTitle = `${t('blockSheets.title')}: ${blockTitleText}`;
            document.getElementById('block-sheets-title').textContent = pageTitle;
            document.getElementById('page-title').textContent = pageTitle;

            const grid = document.getElementById('block-sheets-grid');
            const extraResourcesContainer = document.getElementById('block-sheets-extra-resources');
            grid.innerHTML = '';
            extraResourcesContainer.innerHTML = '';

            const videoItems = Array.isArray(resources.videos)
                ? resources.videos
                : resources.video
                    ? [{ url: resources.video, title: { en: t('media.watchVideo', 'en'), ar: t('media.watchVideo', 'ar') } }]
                    : [];

            videoItems.forEach(video => {
                if (!video || !video.url) return;
                createResourceButton(
                    extraResourcesContainer,
                    'video',
                    video.url,
                    `▶️ ${video.title ? getLocalizedText(video.title, currentLang) : t('media.watchVideo')}`,
                    'bg-blue-600 hover:bg-blue-700'
                );
            });

            const blockQuizData = resolveQuizData(resources);
            if (blockQuizData.length > 0) {
                const blockQuizId = `block_${blockId}`;
                const storageKey = `quizScore-${subjectId}-${blockId}-${blockQuizId}`;
                const savedScore = localStorage.getItem(storageKey);

                let quizButtonText = `📝 ${t('blockSheets.startQuiz')}`;
                if (savedScore) {
                    quizButtonText += ` (${t('quiz.score')}: ${savedScore})`;
                }

                createResourceButton(
                    extraResourcesContainer,
                    'quiz',
                    { subjectId, blockId, lessonId: blockQuizId, lessonQuizData: blockQuizData },
                    quizButtonText,
                    'bg-green-600 hover:bg-green-700'
                );
            }

            let pdfItems = [];
            if (Array.isArray(resources.pdfs)) {
                pdfItems = resources.pdfs.map(item =>
                    typeof item === 'string'
                        ? { url: item }
                        : { url: item?.url, name: item?.name || item?.title }
                );
            } else if (resources.pdfs && typeof resources.pdfs === 'object') {
                pdfItems = Object.entries(resources.pdfs).map(([key, value]) => ({
                    url: typeof value === 'string' ? value : value?.url,
                    name: value?.name || { en: key.toUpperCase(), ar: key.toUpperCase() }
                }));
            } else if (Array.isArray(resources.pdf)) {
                pdfItems = resources.pdf.map(url => ({ url }));
            } else if (typeof resources.pdf === 'string') {
                pdfItems = [{ url: resources.pdf }];
            }

            pdfItems = pdfItems.filter(pdf => pdf && pdf.url);

            if (!pdfItems.length) {
                grid.innerHTML = `<p class="p-4 text-gray-500 col-span-full text-center">${t('blockSheets.noPdfs')}</p>`;
                return;
            }

            pdfItems.forEach((pdf, index) => {
                const cardTitle = getLocalizedText(pdf.name || pdf.title || { en: `PDF ${index + 1}`, ar: `ملف ${index + 1}` }, currentLang);

                const card = document.createElement('div');
                card.className = 'subject-card group cursor-pointer transition duration-300 ease-in-out';
                card.onclick = () => openModal('pdf', pdf.url);

                card.innerHTML = `
                        <div class="card-surface p-6 h-full rounded-2xl transition-all duration-300 transform hover:-translate-y-1 border-b-4" style="border-color: ${subjectColor};">
                            <div class="flex flex-col items-center justify-center h-full text-center">
                                <span class="text-5xl mb-4 transition duration-300 group-hover:scale-110">📄</span>
                                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${cardTitle}</h3>
                            </div>
                        </div>
                    `;
                grid.appendChild(card);
            });
        }
        // ===================================
        // [!!!] END OF MODIFICATION [!!!]
        // ===================================


        /**
         * بناء الاختبار (Quiz) داخل الـ Modal
         */
        function buildQuizHTML(quizData, subjectId, blockId, lessonId, containerId) {
             const container = document.getElementById(containerId);
             if (!container) {
                 console.error("Quiz container not found:", containerId);
                 return;
             }

             if (!quizData || quizData.length === 0) {
                 container.innerHTML = `<p class="p-4 text-gray-500">${t('quiz.noQuestions')}</p>`;
                 return;
             }

            container.classList.add('overflow-auto');

            let html = `<div class="p-4 md:p-6"><h2 class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100">${t('quiz.title')}</h2>`;
            html += `<form id="quiz-form">`;

            quizData.forEach((q, index) => {
                html += `<div class="quiz-question">`;
                html += `<div class="quiz-question-header">
                            <p>${getLocalizedText(q.q, currentLang)}</p>
                            <span class="flex-shrink-0 ml-4 rtl:mr-4 rtl:ml-0">${t('quiz.questionLabel')} ${index + 1}/${quizData.length}</span>
                         </div>`;
                html += `<div class="quiz-options mt-3 space-y-2">`;

                const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);
                shuffledOptions.forEach((option, i) => {
                    const optionId = `q${index}_option${i}`;
                    html += `
                        <label for="${optionId}" class="flex items-center">
                            <input type="radio" name="question_${index}" id="${optionId}" value="${option}" class="w-4 h-4">
                            <span class="ml-2 rtl:mr-2 rtl:ml-0">${option}</span>
                        </label>
                    `;
                });
                html += `</div></div>`;
            });

            // Ensure lessonId is passed as a string if it's potentially non-numeric (like 'block_1')
            const lessonIdParam = typeof lessonId === 'number' ? lessonId : `'${lessonId}'`;

            html += `<button type="button" onclick="submitQuiz('${subjectId}', ${blockId}, ${lessonIdParam})" class="mt-8 w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 focus:ring-green-500">
                ${t('quiz.submit')}
            </button>`;

            html += `</form></div>`;

            container.innerHTML = html;
        }


        /**
         * تصحيح الاختبار وحفظ النتيجة وعرض مراجعة تفصيلية
         */
        function submitQuiz(subjectId, blockId, lessonId) {
            // Use currentQuizData which should be set correctly before opening the modal
             if (!currentQuizData) {
                 console.error("Quiz data is missing on submit (currentQuizData is null).");
                 closeModal();
                 return;
             }
             const quizDataToUse = currentQuizData; // Use the globally set quiz data

            const form = document.getElementById('quiz-form');
             if (!form) {
                 console.error("Quiz form not found.");
                 return;
             }

            let score = 0;
            let results = [];

            quizDataToUse.forEach((q, index) => {
                const selectedRadio = form.querySelector(`input[name="question_${index}"]:checked`);
                const selectedValue = selectedRadio ? selectedRadio.value : null;
                const isCorrect = (selectedValue === q.answer);

                if (isCorrect) {
                    score++;
                }

                results.push({
                    q: getLocalizedText(q.q, currentLang),
                    selected: selectedValue,
                    answer: q.answer,
                    isCorrect: isCorrect
                });
            });

            const total = quizDataToUse.length;
            const scorePercentage = total > 0 ? ((score / total) * 100).toFixed(0) : 0;

            // 1. حفظ النتيجة في LocalStorage using the correct lessonId (number or string like 'block_1')
            const storageKey = `quizScore-${subjectId}-${blockId}-${lessonId}`;
            const scoreString = `${score}/${total}`;
            localStorage.setItem(storageKey, scoreString);

            // 2. تحديث زر الاختبار في واجهة الدرس (فقط إذا كان الاختبار خاصاً بدرس)
            // التأكد من أن lessonId هو رقم قبل محاولة إعادة الرسم
            if (!isNaN(parseFloat(lessonId)) && isFinite(lessonId)) {
                renderLessonResources(subjectId, blockId, lessonId, SUBJECT_DATA[subjectId]?.blocks.find(b=>b.id===blockId)?.lessons.find(l=>l.id===lessonId)?.resources);
            }
             // [!!!] START OF MODIFICATION [!!!]
             // Update the button on the Block Sheets page if it was a block quiz
             else if (typeof lessonId === 'string' && lessonId.startsWith('block_')) {
                  renderBlockSheetsView(subjectId, blockId); // Re-render to update the button text
             }
             // [!!!] END OF MODIFICATION [!!!]

            // 3. بناء وعرض شاشة النتائج التفصيلية في Modal
            const container = document.getElementById('modal-content');

            let resultHtml = `
                <div class="text-center p-6 md:p-8 overflow-auto h-full">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800 dark:text-gray-100">${t('quiz.resultTitle')}</h2>
                    <p class="text-xl mb-2 text-gray-600 dark:text-gray-300">${t('quiz.scoreLabel')}</p>
                    <p class="text-6xl font-extrabold text-[var(--subject-color)] my-4">${score} / ${total}</p>
                    <p class="text-2xl font-semibold text-gray-700 dark:text-gray-200">${scorePercentage}%</p>

                    <hr class="my-6 border-gray-200 dark:border-gray-700">

                    <h3 class="text-2xl font-bold mb-4 text-left rtl:text-right text-gray-800 dark:text-gray-100">${t('quiz.reviewTitle')}</h3>
                    <div class="text-left rtl:text-right space-y-4">
            `;

            results.forEach((res, index) => {
                resultHtml += `<div class="quiz-review-item ${res.isCorrect ? 'border-green-300 dark:border-green-700' : 'border-red-300 dark:border-red-700'}">`;
                resultHtml += `<p>${index + 1}. ${res.q}</p>`;

                if (res.selected) {
                    if (res.isCorrect) {
                        resultHtml += `<span class="user-answer correct">
                            ${t('quiz.yourAnswer')} ${res.selected} (Correct)
                        </span>`;
                    } else {
                        resultHtml += `<span class="user-answer incorrect">
                            ${t('quiz.yourAnswer')} ${res.selected} (Incorrect)
                        </span>`;
                        resultHtml += `<div class="correct-answer">
                            ${t('quiz.correctAnswer')} ${res.answer}
                        </div>`;
                    }
                } else {
                     resultHtml += `<span class="user-answer incorrect">
                        ${t('quiz.unanswered')}
                     </span>`;
                     resultHtml += `<div class="correct-answer">
                        ${t('quiz.correctAnswer')} ${res.answer}
                     </div>`;
                }
                resultHtml += `</div>`;
            });

            const retakeLabel = t('quiz.retake');
            const reviewLabel = t('quiz.review');
            const closeLabel = t('common.close');

            resultHtml += `
                    <div class="mt-8 flex flex-wrap gap-3 justify-center">
                        <button data-action="retake" class="bg-green-600 text-white px-6 py-2 rounded-xl font-semibold hover:bg-green-700 transition duration-200 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">${retakeLabel}</button>
                        <button data-action="preview" class="bg-primary-blue text-white px-6 py-2 rounded-xl font-semibold hover:bg-blue-700 transition duration-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">${reviewLabel}</button>
                        <button data-action="close" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-6 py-2 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200 focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 dark:focus:ring-offset-gray-900">${closeLabel}</button>
                    </div>
                </div>
            </div>`;

            container.innerHTML = resultHtml;
            container.scrollTop = 0;

            const retakeBtn = container.querySelector('[data-action="retake"]');
            if (retakeBtn) {
                retakeBtn.addEventListener('click', () => {
                    openQuizModal(currentQuizData, subjectId, blockId, lessonId);
                    renderQuizSection('take', subjectId, blockId, lessonId);
                });
            }
            const reviewBtn = container.querySelector('[data-action="preview"]');
            if (reviewBtn) {
                reviewBtn.addEventListener('click', () => {
                    openQuizModal(currentQuizData, subjectId, blockId, lessonId);
                    renderQuizSection('preview', subjectId, blockId, lessonId);
                });
            }
            const closeBtn = container.querySelector('[data-action="close"]');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => closeModal());
            }
        }


        // ====================================================================
        // نقطة دخول (Initialization)
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
             setTheme(currentTheme);
             switchLanguage(currentLang);
        });

        langToggle.addEventListener('click', () => {
            const newLang = currentLang === 'en' ? 'ar' : 'en';
            switchLanguage(newLang);
        });

        themeToggle.addEventListener('click', toggleTheme);

    </script>
</body>
</html>