<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ø§Ù„ÙƒØªØ¨  Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-bg: #334155;
            --hover-bg: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --editor-font-size: 14px;
        }

        [data-theme="light"] {
            --primary-bg: #ffffff;
            --secondary-bg: #f8fafc;
            --accent-bg: #e2e8f0;
            --hover-bg: #cbd5e1;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
        }

        [data-theme="dark"] {
            --primary-bg: #000000;
            --secondary-bg: #111827;
            --accent-bg: #1f2937;
            --hover-bg: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-bg) var(--secondary-bg);
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb {
            background: var(--accent-bg);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: var(--hover-bg);
        }

        body {
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
#viewer{

    overflow: auto;
}
#editor{

    overflow: auto;
}
        .tree-item {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 2px 0;
            cursor: grab;
        }

        .tree-item-chapter {
            background: linear-gradient(135deg, #1e3a8a, #000000);
            border-left: 4px solid #3b82f6;
            color: #e0e7ff;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tree-item-chapter:hover {
            background: linear-gradient(135deg, #1e40af, #2563eb);
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .tree-item-section {
            background: linear-gradient(135deg, #374151, #4b5563);
            border-left: 4px solid #6b7280;
            color: #f3f4f6;
            font-weight: 600;
            position: relative;
        }

        .tree-item-section::before {
            content: 'â–¼';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .tree-item-section.collapsed::before {
            transform: translateY(-50%) rotate(-90deg);
        }

        .tree-item-section:hover {
            background: linear-gradient(135deg, #4b5563, #6b7280);
            transform: translateX(-2px);
        }

        .chapters-container {
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chapters-container.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .chapters-container.expanded {
         
            opacity: 1;
        }

        .tree-item:active {
            cursor: grabbing;
        }

        .tree-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .tree-item.drag-over {
            border: 2px dashed var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
        }

        .tree-item[draggable="true"] {
            cursor: grab;
        }

        .tree-item[draggable="true"]:hover {
            background: var(--hover-bg);
            transform: translateX(-2px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .drop-indicator {
            height: 2px;
            background: var(--accent-color);
            margin: 2px 0;
            border-radius: 1px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .drop-indicator.active {
            opacity: 1;
        }

        .chapter-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .chapter-controls select,
        .chapter-controls input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .chapter-controls label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chapter-controls-section {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .chapter-select {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            min-width: 120px;
            flex: 1;
        }

        .chapter-select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .chapter-sort-input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            width: 60px;
            text-align: center;
        }

        .chapter-sort-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .move-chapter-btn {
            background: var(--accent-color);
            border: 1px solid var(--accent-color);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 32px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .move-chapter-btn:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .move-chapter-btn:active {
            transform: translateY(0);
        }

        .tree-item:hover {
            background: var(--hover-bg);
            transform: translateX(-2px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .tree-item-active {
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .editor-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1px;
            background: var(--border-color);
        }

        .sidebar {
            background: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
        }

        .main-content {
            background: var(--primary-bg);
            overflow: hidden;
        }

        .controls-panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
           
        }

        .controls-hidden {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            display: none;
        }

        .controls-visible {
            opacity: 1;
        }

        .tab-button {
            color: var(--text-muted);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .tab-button:hover {
            color: var(--text-primary);
            background: var(--hover-bg);
        }

        .tab-active-main {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: var(--accent-bg);
        }

        .tab-active-main::before {
            opacity: 0.1;
        }

        .markdown-editor {
            background: var(--editor-bg, var(--secondary-bg));
            color: var(--editor-text, var(--text-primary));
            border: none;
            border-radius: 0;
            transition: all 0.3s ease;
            font-family: var(--editor-font, 'Consolas'), 'Monaco', 'Courier New', monospace;
            line-height: 1.6;
            resize: none;
            font-size: var(--editor-font-size, 14px);
            padding: 12px;
            flex: 1;
            min-height: 0;
            outline: none;
        }

        .markdown-editor:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .markdown-toolbar {
            background: linear-gradient(135deg, var(--accent-bg), var(--secondary-bg));
            border-bottom: 1px solid var(--border-color);
            padding: 6px 8px;
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            min-height: 40px;
        }

        .toolbar-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0);
        }

        .split-view {
            display: flex;
            flex-direction: row;
            gap: 16px;
            height: calc(100vh - 120px);
            width: 100%;
        }

        .editor-panel {
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            min-width: 0;
        }

        .preview-panel {
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            min-width: 0;
        }

        .editor-toolbar-combined {
            background: linear-gradient(135deg, var(--accent-bg), var(--secondary-bg));
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 60px;
            border-radius: 8px 8px 0 0;
        }

        .chapter-controls-section {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-color);
            border-radius: 6px;
            flex-shrink: 0;
            min-width: 200px;
        }

        .chapter-select {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            min-width: 100px;
            flex: 1;
        }

        .chapter-select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .chapter-sort-input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            width: 50px;
            text-align: center;
        }

        .chapter-sort-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .move-chapter-btn {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .move-chapter-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .editor-title-section {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 350px;
        }

        .editor-title-input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
            min-width: 300px;
        }

        .editor-title-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .font-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            background: rgba(34, 197, 94, 0.1);
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .font-select {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 11px;
            min-width: 90px;
        }

        .control-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .font-size-display {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }

        .color-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            background: rgba(168, 85, 247, 0.1);
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-direction: column;
        }

        .color-picker {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            padding: 0;
        }

        .color-label {
            font-size: 9px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: bold;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--accent-bg), var(--secondary-bg));
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .viewer-content-prose {
            line-height: 1.8;
            color: var(--text-primary);
        }

        .viewer-content-prose h1,
        .viewer-content-prose h2,
        .viewer-content-prose h3,
        .viewer-content-prose h4,
        .viewer-content-prose h5,
        .viewer-content-prose h6 {
            color: var(--text-primary);
            margin-top: 2em;
            margin-bottom: 1em;
            font-weight: 700;
            line-height: 1.3;
        }

        .viewer-content-prose h1 {
            font-size: 2.25em;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 0.5em;
        }

        .viewer-content-prose h2 {
            font-size: 1.875em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        .viewer-content-prose h3 {
            font-size: 1.5em;
            color: var(--accent-color);
        }

        .viewer-content-prose blockquote {
            border-right: 4px solid var(--accent-color);
            padding: 16px 20px;
            margin: 20px 0;
            background: var(--accent-bg);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .viewer-content-prose code {
            background: var(--accent-bg);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--warning-color);
        }

        .viewer-content-prose pre {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            margin: 20px 0;
        }

        .viewer-content-prose pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .viewer-content-prose ul,
        .viewer-content-prose ol {
            padding-right: 24px;
            margin: 16px 0;
        }

        .viewer-content-prose li {
            margin: 8px 0;
        }

        .viewer-content-prose a {
            color: var(--accent-color);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .viewer-content-prose a:hover {
            border-bottom-color: var(--accent-color);
        }

        .viewer-content-prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--secondary-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .viewer-content-prose th,
        .viewer-content-prose td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .viewer-content-prose th {
            background: var(--accent-bg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .viewer-content-prose tr:hover {
            background: var(--hover-bg);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #0891b2, #0e7490);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
        }

        .content-editor-block {
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
        }

        .content-editor-block:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
        }

        .block-header {
            background: var(--accent-bg);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            border-radius: 10px 10px 0 0;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-block-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-block-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .search-input {
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .section-sort-item {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-sort-item:active {
            cursor: grabbing;
        }

        .section-sort-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .section-sort-item.drag-over {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
        }

        .section-sort-item:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .section-sort-input {
            width: 60px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }

        .section-sort-name {
            flex: 1;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
        }

        .drag-handle {
            color: var(--text-muted);
            cursor: grab;
            padding: 4px;
        }

        .drag-handle:hover {
            color: var(--text-primary);
        }

        .theme-controls {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .theme-controls-sidebar {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 16px;
            padding: 8px;
            background: var(--accent-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .theme-controls-sidebar .theme-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .theme-controls-sidebar .theme-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .theme-controls-sidebar .theme-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .theme-controls-sidebar .theme-btn i {
            font-size: 14px;
        }

        .theme-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .theme-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .theme-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .editable-content {
            transition: all 0.2s ease;
        }
        
        .editable-content:hover {
            background-color: rgba(59, 130, 246, 0.05) !important;
        }
        
        .editable-content:focus {
            outline: none;
        }
        
        mark {
            background-color: #fbbf24;
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .editor-controls {
            background: var(--accent-bg);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }



        .layout-controls {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            background: rgba(245, 158, 11, 0.1);
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .full-editor .split-view {
            grid-template-columns: 1fr;
        }

        .full-editor .preview-panel {
            display: none;
        }

        .full-editor .editor-panel {
            width: 100%;
        }



        @media (max-width: 1024px) {
            .editor-toolbar-combined {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
                padding: 8px;
            }
            
            .chapter-controls-section,
            .editor-title-section,
            .font-controls,
            .color-controls,
            .layout-controls {
                justify-content: center;
                min-width: auto;
            }
            
            .editor-title-input {
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .split-view {
                flex-direction: column;
                height: calc(100vh - 140px);
            }
            
            .chapter-controls-section {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            
            .chapter-select {
                min-width: auto;
            }
            
            .chapter-sort-input {
                width: 100%;
            }
        }

        /* Theme-specific styles for language selector */
        [data-theme="light"] select#language-select{background-color:#ffffff;color:#111827;border:1px solid #d1d5db;}
        [data-theme="light"] select#language-select option{background-color:#ffffff;color:#111827;}
        [data-theme="standard"] select#language-select{background-color:#1f2937;color:#e5e7eb;border:1px solid #374151;}
        [data-theme="standard"] select#language-select option{background-color:#1f2937;color:#e5e7eb;}
        [data-theme="dark"] select#language-select{background-color:#111827;color:#e5e7eb;border:1px solid #374151;}
        [data-theme="dark"] select#language-select option{background-color:#111827;color:#e5e7eb;}
    
	#ai-tools-slot{margin-inline-start:8px}
.ai-bar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;background:var(--secondary-bg);border:1px solid var(--border-color);border-radius:8px;padding:6px 8px}
.ai-bar .select,.ai-bar input,.ai-bar textarea{background:var(--secondary-bg);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;padding:6px 8px}
.ai-bar input[type="password"]{min-width:160px}
.ai-bar textarea{min-width:220px;min-height:38px;display:none}
.ai-bar .group{display:flex;gap:8px;align-items:center}
.ai-bar label{color:var(--text-secondary);font-size:12px;display:inline-flex;align-items:center;gap:4px}
.ai-bar .btn{height:32px}
[data-theme="light"] .ai-bar{background:var(--secondary-bg);border-color:var(--border-color)}

	</style>
</head>
<body class="bg-gray-900 text-white">
    <div class="editor-container">
        <div class="sidebar p-4 flex flex-col overflow-y-auto">
            <div class="theme-controls-sidebar">
                <button class="theme-btn active" data-theme="light" onclick="setTheme('light')">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="theme-btn" data-theme="standard" onclick="setTheme('standard')">
                    <i class="fas fa-adjust"></i>
                </button>
                <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">
                    <i class="fas fa-moon"></i>
                </button>
            </div>

            <div class="mb-4 space-y-3">
                <div>
                    <label for="book-switcher" class="block text-sm font-semibold text-gray-300 mb-1">ğŸ“š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªØ¨</label>
                    <select id="book-switcher" class="w-full search-input bg-gray-800 border-gray-700"></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="new-book-btn" class="btn btn-secondary text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-plus"></i> ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                    <button id="clone-book-btn" class="btn btn-secondary text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-copy"></i> Ø§Ø³ØªÙ†Ø³Ø§Ø®
                    </button>
                    <button id="rename-book-btn" class="btn btn-warning text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-pen"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©
                    </button>
                    <button id="delete-book-btn" class="btn btn-danger text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                    </button>
                </div>
                <button id="export-bundle-btn" class="w-full btn btn-success flex items-center justify-center gap-2">
                    <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ (s-data.js)
                </button>
            </div>

            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-400">ÙÙ‡Ø±Ø³ Ø§Ù„ÙƒØªØ§Ø¨</h2>
            
            <div class="mb-4 space-y-3">
                <input type="text" id="search-chapters" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙØµÙˆÙ„..." class="w-full search-input">
                <button id="settings-toggle" class="w-full btn btn-primary">
                    <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </button>
            </div>

            <div id="controls-panel" class="controls-panel mb-4 space-y-3 p-4 bg-gray-800 rounded-lg controls-hidden">
                <select id="language-select" class="p-2 border rounded">
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="en">English</option>
                    <option value="fr">FranÃ§ais</option>
                    <option value="tr">TÃ¼rkÃ§e</option>
                    <option value="nl">Nederlands</option>
                    <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                    <option value="ms">Bahasa Melayu</option>
                    <option value="zh">ä¸­æ–‡</option>
                </select>
                <select id="import-method" class="w-full search-input">
                    <option value="auto">ØªÙ‚Ø³ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                    <option value="suggested">ØªÙ‚Ø³ÙŠÙ… Ù…ÙˆØ¶ÙˆØ¹ÙŠ Ù…Ù‚ØªØ±Ø­</option>
                </select>
                <input type="file" id="txt-upload" accept=".txt" class="hidden">
                <button onclick="document.getElementById('txt-upload').click()" class="w-full btn btn-primary">
                    <i class="fas fa-file-import"></i>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Øµ
                </button>
<input type="file" id="json-upload" accept=".json" class="hidden">
<button onclick="document.getElementById('json-upload').click()" class="w-full btn btn-success">ØªØ­Ù…ÙŠÙ„ JSON</button>
<button id="export-txt-btn" onclick="exportPlainText()" class="w-full btn btn-warning">ØªØµØ¯ÙŠØ± Ù†Øµ Ù…Ø®ØªØµØ±</button>
<button id="migrate-data-btn" onclick="migrateOldDataStructure()" class="w-full btn btn-secondary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†ÙŠØ© Ù„Ù„ØºØ§Øª</button>
                <button id="save-json" class="w-full btn btn-warning">
                    <i class="fas fa-save"></i>Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                </button>
				<button id="export-static-site-btn" class="w-full btn btn-success">
    <i class="fas fa-globe"></i> ØªØµØ¯ÙŠØ± Ù…ÙˆÙ‚Ø¹ Ø³ØªØ§ØªÙŠÙƒÙŠ
</button>
<button id="export-all-sections-zip-btn" class="w-full btn btn-success">
  <i class="fas fa-file-archive"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø§Ù‚Ø³Ø§Ù… JSON
</button>



    <button id="export-map-btn" class="w-full btn btn-success">
                        <i class="fas fa-map"></i> Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙØµÙˆÙ„
                    </button>

<button id="export-onepage-btn" class="w-full btn btn-info">ğŸ“„ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© OnePage</button>

<style>
.side-btns .btn{
min-width :48%;
}
</style>

                <div class="flex gap-2 side-btns" >
                    <button id="search-btn" onclick="openAdvancedSearch()" class="btn btn-info" title="Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…">
                        <i class="fas fa-search"></i> Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…
                    </button>
                    <button id="destroy-book-btn" onclick="destroyCurrentBook()" class="btn btn-danger" title="Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨
                    </button>
                </div>
                <div class="flex gap-2 side-btns">

                    <button id="edit-book-info-btn" onclick="editBookInfo()" class="btn btn-secondary">
                        <i class="fas fa-info-circle"></i>  Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                    </button>
                    <button id="show-stats-btn" class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    </button>
                </div>
				 <div class="flex gap-2 side-btns">

				<button id="approve-all-btn" class="w-full btn btn-success">
    <i class="fas fa-check-double"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹
</button>
</div>
                
            </div>
            
            <div id="tree-container" class="space-y-1 flex-grow"></div>
			<div class="mt-3 p-3 bg-gray-700 rounded-lg text-sm">
                    <p class="text-gray-300 mb-2"><i class="fas fa-info-circle text-blue-400"></i> Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª:</p>
                    <ul class="text-gray-400 text-xs space-y-1">
                        <li>â€¢ Ø§Ø³Ø­Ø¨ Ø§Ù„ÙØµÙˆÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§</li>
                        <li>â€¢ Ø§Ø³Ø­Ø¨ ÙØµÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø¢Ø®Ø± Ù„Ù†Ù‚Ù„Ù‡</li>
                        <li>â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</li>
                    </ul>
                </div>
        </div>

        <div id="main-content-area" class="main-content p-6 flex flex-col">
            <div class="flex border-b border-gray-600 mb-6">
                <button id="view-tab-btn" class="tab-button px-6 py-3 text-lg font-semibold">
                    <i class="fas fa-eye mr-2"></i>Ø¹Ø±Ø¶
                </button>
                <button id="edit-tab-btn" class="tab-button px-6 py-3 text-lg font-semibold">
                    <i class="fas fa-edit mr-2"></i>ØªØ­Ø±ÙŠØ±
                </button>
            </div>

            <div id="viewer" class="flex-1 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 id="viewer-title" class="text-3xl font-bold text-yellow-400 border-b-2 border-yellow-500 pb-2">Ø§Ø®ØªØ± ÙØµÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶Ù‡</h1>
                    <button onclick="printCurrentChapter()" class="btn btn-info" id="print-btn" style="display: none;">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                </div>
                <div id="viewer-content" class="text-lg leading-relaxed space-y-4 viewer-content-prose">
                    <p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙØ­ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù† Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ ÙØµÙ„ Ù„Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆØ§Ù‡ Ù‡Ù†Ø§ Ø£Ùˆ ØªØ­Ø±ÙŠØ±Ù‡.</p>
                </div>
            </div>

            <div id="editor" class="hidden flex-1 flex flex-col fade-in">
                <div class="space-y-6 flex-1 flex flex-col">
                   
                    
                  
                    
                              <div class="flex-1 split-view" id="main-split-view">
                        <div class="editor-panel">
                            <div class="editor-toolbar-combined">
                                <div class="chapter-controls-section">
                                    <select id="chapter-section-select" class="chapter-select">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¨</option>
                                    </select>
                                    <input id="chapter-sort-input" class="chapter-sort-input" type="number" placeholder="ØªØ±ØªÙŠØ¨" />
                                    <button onclick="moveChapterFromControls()" class="move-chapter-btn" title="Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button onclick="openActiveChapterResources()" class="move-chapter-btn" title="Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¯Ø±Ø³">
                                        <i class="fas fa-sliders-h"></i>
                                    </button>
                                </div>
 
                                <div class="editor-title-section">
                                    <i class="fas fa-edit"></i>
                                    <input id="editor-title" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„" class="editor-title-input">
                                    <span id="audit-badge" class="mr-2 inline-flex items-center px-2 py-1 rounded text-xs font-bold"></span>

                                </div>
                                
                                <div class="font-controls">
                                    <select id="font-family-select" class="font-select" onchange="changeFontFamily()">
                                        <option value="Consolas">Consolas</option>
                                        <option value="Arial">Arial</option>
                                        <option value="Tahoma">Tahoma</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Georgia">Georgia</option>
                                    </select>
                                    <button class="control-btn" onclick="decreaseFontSize()" title="ØªØµØºÙŠØ± Ø§Ù„Ø®Ø·">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <div class="font-size-display" id="font-size-display">14px</div>
                                    <button class="control-btn" onclick="increaseFontSize()" title="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø·">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>

                                <div class="color-controls">
                                    <div class="color-picker-wrapper">
                                        <span class="color-label">Ø®Ù„ÙÙŠØ©</span>
                                        <input type="color" id="bg-color-picker" class="color-picker" value="#1e293b" onchange="changeEditorBg()">
                                    </div>
                                    <div class="color-picker-wrapper">
                                        <span class="color-label">Ù†Øµ</span>
                                        <input type="color" id="text-color-picker" class="color-picker" value="#f8fafc" onchange="changeEditorText()">
                                    </div>
                                </div>

                                <div class="layout-controls">
                                    <button class="control-btn" onclick="toggleLayout()" id="layout-toggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶">
                                        <i class="fas fa-columns"></i>
                                    </button>
                                </div>
                                <button id="audit-open-btn" class="btn btn-secondary">
  <i class="fas fa-shield-halved"></i> ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
</button>
<button id="revlog-open-btn" class="btn btn-warning">Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
<div id="ai-tools-slot"></div>

                            </div>
                            
                            <div id="markdown-toolbar" class="markdown-toolbar">
                                <button class="toolbar-btn" title="Ø¹Ø±ÙŠØ¶" data-action="bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="toolbar-btn" title="Ù…Ø§Ø¦Ù„" data-action="italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="toolbar-btn" title="Ø¹Ù†ÙˆØ§Ù† Ø±Ø¦ÙŠØ³ÙŠ" data-action="h1">
                                    H1
                                </button>
                                <button class="toolbar-btn" title="Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¹ÙŠ" data-action="h2">
                                    H2
                                </button>
                                <button class="toolbar-btn" title="Ø¹Ù†ÙˆØ§Ù† ØµØºÙŠØ±" data-action="h3">
                                    H3
                                </button>
                                <button class="toolbar-btn" title="Ø§Ù‚ØªØ¨Ø§Ø³" data-action="quote">
                                    <i class="fas fa-quote-right"></i>
                                </button>
                                <button class="toolbar-btn" title="ÙƒÙˆØ¯" data-action="code">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button class="toolbar-btn" title="Ù‚Ø§Ø¦Ù…Ø©" data-action="list">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button class="toolbar-btn" title="Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ù‚Ù…Ø©" data-action="ordered-list">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button class="toolbar-btn" title="Ø±Ø§Ø¨Ø·" data-action="link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="toolbar-btn" title="ØµÙˆØ±Ø©" data-action="image">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="toolbar-btn" title="Ø¬Ø¯ÙˆÙ„" data-action="table">
                                    <i class="fas fa-table"></i>
                                </button>
                            </div>
                            
                            <div class="panel-content p-0" style="flex: 1;">
                                <textarea id="markdown-editor" class="markdown-editor w-full h-full border-0 resize-none" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØµÙ„ Ù‡Ù†Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Markdown..."></textarea>
                            </div>
                        </div>

                        <div class="preview-panel">
                            <div class="panel-header">
                                <i class="fas fa-eye"></i>
                                Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                            </div>
                            <div id="markdown-preview" class="panel-content viewer-content-prose">
                                <p class="text-gray-400">Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ù†Ø§...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="content-buttons-container" class="flex justify-center gap-4 mt-4">
                        <button onclick="addContentBlock('paragraph')" class="btn btn-success">
                            <i class="fas fa-paragraph"></i> Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø±Ø©
                        </button>
                        <button onclick="addContentBlock('image')" class="btn" style="background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white;">
                            <i class="fas fa-image"></i> Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©
                        </button>
                        <button onclick="addContentBlock('table')" class="btn btn-warning">
                            <i class="fas fa-table"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„
                        </button>
                    </div>
                </div>
            </div>

            </div>
        </div>
    </div>

<div id="context-menu" class="hidden absolute w-56 rounded-md shadow-lg bg-slate-800 border border-slate-600 text-white text-sm p-1">
	
	</div>
    
    <div id="stats-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-gray-800 text-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-teal-400">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨</h2>
                <button onclick="document.getElementById('stats-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="stats-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <div id="book-info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300">ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨</h2>
                <button onclick="document.getElementById('book-info-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            
            <div class="space-y-4">
               <div>
    <label class="block text-sm font-medium text-gray-300 mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</label>
    <input type="text" id="book-title-input-ar" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨">
</div>
<div>
    <label class="block text-sm font-medium text-gray-300 mb-2">Book Title (English)</label>
    <input type="text" id="book-title-input-en" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter book title">
</div>

<div class="grid md:grid-cols-2 gap-4">
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">Ø§Ù„Ù…Ø¹Ø±Ù (Subject ID)</label>
        <input type="text" id="book-id-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ù…Ø«Ø§Ù„: math">
        <p class="text-xs text-gray-400 mt-1">ÙŠÙØ³ØªØ®Ø¯Ù… ÙƒÙ…ÙØªØ§Ø­ Ø¯Ø§Ø®Ù„ Ù…Ù„Ù s-data.js (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª).</p>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ©</label>
        <input type="text" id="book-icon-input" maxlength="2" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ù…Ø«Ø§Ù„: ğŸ“˜">
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">Ù„ÙˆÙ† Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <input type="color" id="book-color-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="#2563eb">
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">Ø±Ø§Ø¨Ø· Ø§Ù„ØºÙ„Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="text" id="book-cover-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://...">
    </div>
</div>

               <div>
    <label class="block text-sm font-medium text-gray-300 mb-2">Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„ÙƒØªØ§Ø¨ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</label>
    <textarea id="book-bio-input-ar" rows="10" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„ÙƒØªØ§Ø¨..."></textarea>
</div>
<div>
    <label class="block text-sm font-medium text-gray-300 mb-2">Book Bio (English)</label>
    <textarea id="book-bio-input-en" rows="10" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical" placeholder="Enter book bio..."></textarea>
</div>
<div>
    <label class="block text-sm font-medium text-gray-300 mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± (Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª)</label>
    <input type="text" id="book-alias-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="my-book-name">
</div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</h3>
                    <div id="bio-preview" class="prose prose-invert max-w-none bg-gray-800 p-4 rounded-lg min-h-[100px]"></div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="document.getElementById('book-info-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="saveBookInfo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div id="book-library-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙƒØªØ¨</h2>
                <button onclick="toggleBookLibrary(false)" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div id="book-library-list" class="space-y-3"></div>
            <div class="mt-6 flex flex-wrap gap-2 justify-end">
                <button id="library-create-btn" class="btn btn-secondary"><i class="fas fa-plus"></i> ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                <button onclick="toggleBookLibrary(false)" class="btn btn-secondary">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <div id="section-resources-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300" id="section-resources-title">Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø©</h2>
                <button onclick="toggleSectionResources(false)" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm text-gray-300 mb-2">Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø© (<span id="section-brief-lang">AR</span>)</label>
                    <textarea id="section-brief-input" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">Ù…Ù„ÙØ§Øª PDF</h3>
                        <button class="btn btn-secondary text-sm" onclick="addSectionResource('pdf')"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù</button>
                    </div>
                    <div id="section-pdfs-list" class="space-y-3"></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
                        <button class="btn btn-secondary text-sm" onclick="addSectionResource('video')"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</button>
                    </div>
                    <div id="section-videos-list" class="space-y-3"></div>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (JavaScript / JSON)</label>
                    <textarea id="section-quiz-input" rows="6" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono text-sm" placeholder="Ù…Ø«Ø§Ù„: [ { id: 1, ... } ]"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button class="btn btn-primary text-sm" onclick="testSectionQuizScript()"><i class="fas fa-play"></i> ØªØ¬Ø±Ø¨Ø©</button>
                        <span id="section-quiz-status" class="text-sm"></span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="btn btn-secondary" onclick="toggleSectionResources(false)">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <div id="chapter-resources-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300" id="chapter-resources-title">Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¯Ø±Ø³</h2>
                <button onclick="toggleChapterResources(false)" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm text-gray-300 mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø±Ø³ (<span id="chapter-brief-lang">AR</span>)</label>
                    <textarea id="chapter-brief-input" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">Ù…Ù„ÙØ§Øª PDF</h3>
                        <button class="btn btn-secondary text-sm" onclick="addChapterResource('pdf')"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù</button>
                    </div>
                    <div id="chapter-pdfs-list" class="space-y-3"></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
                        <button class="btn btn-secondary text-sm" onclick="addChapterResource('video')"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</button>
                    </div>
                    <div id="chapter-videos-list" class="space-y-3"></div>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (JavaScript / JSON)</label>
                    <textarea id="chapter-quiz-input" rows="6" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono text-sm" placeholder="Ù…Ø«Ø§Ù„: [ { id: 1, ... } ]"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button class="btn btn-primary text-sm" onclick="testChapterQuizScript()"><i class="fas fa-play"></i> ØªØ¬Ø±Ø¨Ø©</button>
                        <span id="chapter-quiz-status" class="text-sm"></span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="btn btn-secondary" onclick="toggleChapterResources(false)">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <div id="section-sort-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">ØªØ­Ø±ÙŠØ± ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                <button onclick="document.getElementById('section-sort-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="section-sort-content" class="space-y-3">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="document.getElementById('section-sort-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button onclick="saveSectionSort()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨
                </button>
            </div>
        </div>
    </div>

    <div id="advanced-search-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
                <button onclick="closeAdvancedSearch()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex gap-4">
                    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰..." class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                    <button onclick="performAdvancedSearch()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-search"></i> Ø¨Ø­Ø«
                    </button>
                </div>
                
                <div class="flex gap-4">
                    <label class="flex items-center text-white">
                        <input type="checkbox" id="search-titles" checked class="mr-2">
                        Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                    </label>
                    <label class="flex items-center text-white">
                        <input type="checkbox" id="search-content" checked class="mr-2">
                        Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    </label>
                    <label class="flex items-center text-white">
                        <input type="checkbox" id="case-sensitive" class="mr-2">
                        Ø­Ø³Ø§Ø³ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù
                    </label>
                </div>
            </div>
            
            <div id="search-results" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-center">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø¨Ø¯Ø¡</p>
            </div>
        </div>
    </div>
<div id="audit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-white">ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª</h2>
      <button id="audit-close-btn" class="text-gray-400 hover:text-white">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="grid md:grid-cols-3 gap-3 mb-4">
      <div>
        <label class="block text-sm mb-1 text-gray-300">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</label>
        <select id="audit-status-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white">
          <option value="true">ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù†Ø´Ø±</option>
          <option value="false">ÙŠØ­ØªØ§Ø¬ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1 text-gray-300">Ø§Ø³Ù… Ø§Ù„Ù…ÙØ±Ø§Ø¬Ø¹</label>
        <select id="audit-reviewer-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white">
          <option value="admin">admin</option>
          <option value="supervisor">supervisor</option>
        </select>
      </div>
      <div class="md:col-span-3">
        <label class="block text-sm mb-1 text-gray-300">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="audit-notes" rows="3" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white"></textarea>
      </div>
    </div>

    <div class="flex justify-end mb-6">
      <button id="audit-add-btn" class="btn btn-success">
        <i class="fas fa-plus"></i> Ø£Ø¶Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ / Ø§Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
      </button>
    </div>

    <div class="overflow-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-gray-700">
            <th class="text-right p-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="text-right p-2">Ø§Ù„Ù…ÙØ±Ø§Ø¬Ø¹</th>
            <th class="text-right p-2">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
            <th class="text-right p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª</th>
          </tr>
        </thead>
        <tbody id="audit-logs-tbody"></tbody>
      </table>
    </div>
  </div>
</div>



<div id="revlog-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-bold text-white">Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</h3>
      <button id="revlog-close" class="text-gray-400 hover:text-white">âœ•</button>
    </div>
    <div id="revlog-list" class="space-y-2 max-h-[65vh] overflow-y-auto"></div>
  </div>
</div>

    <script>

        let bookData = null;
        let currentBookId = null;
        let bookLibrary = [];
        let activeSectionResourcesIndex = null;
        let activeChapterResourcesPath = { section: null, chapter: null };
        let allLines = [];
        let activePath = { section: null, chapter: null };
        let currentView = 'viewer';
        let markdownEditor = null;
        let markdownPreview = null;
        let currentTheme = 'light';
        let currentFontSize = 14;
        let isFullEditor = false;

        const treeContainer = document.getElementById('tree-container');
        const viewerTitle = document.getElementById('viewer-title');
        const viewerContent = document.getElementById('viewer-content');
        const editorTitleInput = document.getElementById('editor-title');
        const viewerDiv = document.getElementById('viewer');
        const editorDiv = document.getElementById('editor');
        const settingsToggle = document.getElementById('settings-toggle');
        const controlsPanel = document.getElementById('controls-panel');
        const contextMenu = document.getElementById('context-menu');
        const viewTabBtn = document.getElementById('view-tab-btn');
        const editTabBtn = document.getElementById('edit-tab-btn');
        const showStatsBtn = document.getElementById('show-stats-btn');
        const exportMapBtn = document.getElementById('export-map-btn');

let currentLanguage = localStorage.getItem('preferredLang') || 'ar';
function generateUniqueID() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 10; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}
function ensureUniqueIDs(book) {
    if (!book) return;
    if (!book.id) book.id = generateUniqueID();
    if (book.sections && Array.isArray(book.sections)) {
        book.sections.forEach(section => {
            if (!section.id) section.id = generateUniqueID();
            if (section.Chapters && Array.isArray(section.Chapters)) {
                section.Chapters.forEach(chapter => {
                    if (!chapter.id) chapter.id = generateUniqueID();
                });
            }
        });
    }
}
function getLocalizedSectionName(section,lang){return getFromLangArray(section.section_name,lang)}
function setLocalizedSectionName(section,lang,text){section.section_name=setInLangArray(section.section_name,lang,text)}
function getLocalizedBookName(book,lang){return getFromLangArray(book.name,lang)}
function setLocalizedBookName(book,lang,text){book.name=setInLangArray(book.name,lang,text)}

const bookTitleInputEl=document.getElementById('book-title-input');
if(bookTitleInputEl){bookTitleInputEl.addEventListener('input',e=>{if(bookData)setLocalizedBookName(bookData,currentLanguage||'ar',(e.target.value||'').trim())})}


function toLangArray(value) {
    if (Array.isArray(value)) return value;
    if (typeof value === 'string') return [{ ar: value }];
    if (value && typeof value === 'object') {
        const entries = [];
        Object.keys(value).forEach(key => {
            if (typeof value[key] === 'string') {
                entries.push({ [key]: value[key] });
            }
        });
        return entries.length ? entries : [{ ar: '' }];
    }
    return [{ ar: '' }];
}

function langArrayToObject(arr) {
    const obj = {};
    (arr || []).forEach(item => {
        if (item && typeof item === 'object') {
            const key = Object.keys(item)[0];
            if (key) obj[key] = item[key];
        }
    });
    return obj;
}

function slugify(text) {
    if (!text) return '';
    return text
        .toString()
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .toLowerCase();
}

function ensureResourceItem(item) {
    const normalized = item && typeof item === 'object' ? { ...item } : {};
    if (!normalized.id) normalized.id = generateUniqueID();
    if (!normalized.url) normalized.url = normalized.link || '';
    normalized.title = toLangArray(normalized.title || normalized.name || normalized.label || '');
    return normalized;
}

function ensureSectionSchema(section) {
    if (!section) return;
    section.section_name = toLangArray(section.section_name);
    section.brief = toLangArray(section.brief || section.description || '');
    if (!Array.isArray(section.Chapters)) section.Chapters = [];
    if (!section.resources) section.resources = {};
    const res = section.resources;

    if (!Array.isArray(res.pdfs)) {
        if (Array.isArray(res.pdfs)) {
            res.pdfs = res.pdfs.map(ensureResourceItem);
        } else if (section.block_resources && section.block_resources.pdfs) {
            const legacy = section.block_resources.pdfs;
            if (Array.isArray(legacy)) {
                res.pdfs = legacy.map(ensureResourceItem);
            } else {
                res.pdfs = Object.keys(legacy || {}).map(key => ensureResourceItem({
                    id: key,
                    title: toLangArray({ ar: key, en: key }),
                    url: legacy[key]
                }));
            }
        } else {
            res.pdfs = [];
        }
    } else {
        res.pdfs = res.pdfs.map(ensureResourceItem);
    }

    if (!Array.isArray(res.videos)) {
        if (Array.isArray(res.videos)) {
            res.videos = res.videos.map(ensureResourceItem);
        } else if (section.block_resources && section.block_resources.video) {
            const legacyVideo = section.block_resources.video;
            if (Array.isArray(legacyVideo)) {
                res.videos = legacyVideo.map(ensureResourceItem);
            } else {
                res.videos = [ensureResourceItem({
                    id: 'video',
                    title: toLangArray({ ar: 'ÙÙŠØ¯ÙŠÙˆ', en: 'Video' }),
                    url: legacyVideo
                })];
            }
        } else {
            res.videos = [];
        }
    } else {
        res.videos = res.videos.map(ensureResourceItem);
    }

    if (typeof res.quizScript !== 'string') {
        if (res.quizScript && typeof res.quizScript === 'object') {
            try {
                res.quizScript = JSON.stringify(res.quizScript, null, 2);
            } catch (e) {
                res.quizScript = '';
            }
        } else if (section.block_resources && section.block_resources.quiz) {
            try {
                res.quizScript = JSON.stringify(section.block_resources.quiz, null, 2);
            } catch (e) {
                res.quizScript = '';
            }
        } else {
            res.quizScript = res.quizScript || '';
        }
    }

    if (!Array.isArray(res.quizPreview) && Array.isArray(res.quiz)) {
        res.quizPreview = res.quiz;
    }

    section.resources = res;
    section.Chapters.forEach(ensureChapterSchema);
}

function ensureChapterSchema(chapter) {
    if (!chapter) return;
    chapter.title = toLangArray(chapter.title);
    chapter.brief = toLangArray(chapter.brief || chapter.summary || '');
    if (!Array.isArray(chapter.content)) {
        chapter.content = [{ type: 'paragraph', data: toLangArray('') }];
    }
    if (!chapter.resources) chapter.resources = {};
    const res = chapter.resources;
    res.pdfs = Array.isArray(res.pdfs) ? res.pdfs.map(ensureResourceItem) : [];
    res.videos = Array.isArray(res.videos) ? res.videos.map(ensureResourceItem) : [];
    if (typeof res.quizScript !== 'string') {
        if (Array.isArray(res.quiz)) {
            try {
                res.quizScript = JSON.stringify(res.quiz, null, 2);
            } catch (e) {
                res.quizScript = '';
            }
        } else {
            res.quizScript = res.quizScript || '';
        }
    }
    if (!Array.isArray(res.quizPreview) && Array.isArray(res.quiz)) {
        res.quizPreview = res.quiz;
    }
    chapter.resources = res;
}

function ensureBookSchema(book) {
    if (!book) return;
    book.name = toLangArray(book.name || '');
    book.bio = toLangArray(book.bio || '');
    book.icon = book.icon || 'ğŸ“˜';
    book.color = book.color || '#2563eb';
    if (!book.cover) book.cover = book.cover || '';
    if (!book.subjectId) {
        const arName = getFromLangArray(book.name, 'ar') || '';
        const enName = getFromLangArray(book.name, 'en') || arName;
        const generated = slugify(book.alias || enName || arName || 'subject');
        book.subjectId = generated || generateUniqueID();
    }
    if (!Array.isArray(book.sections)) book.sections = [];
    ensureUniqueIDs(book);
    book.sections.forEach(ensureSectionSchema);
}


function normalizeLangArray(v){if(Array.isArray(v))return v;if(typeof v==='string')return[{ar:v}];if(v&&typeof v==='object'){const a=[];Object.keys(v).forEach(k=>a.push({[k]:v[k]}));return a;}return[{ar:''}];}
function getFromLangArray(arr,lang){const a=normalizeLangArray(arr);let val='';for(const o of a){if(Object.prototype.hasOwnProperty.call(o,lang)){val=o[lang];break;}}if(!val){for(const o of a){if(Object.prototype.hasOwnProperty.call(o,'ar')){val=o['ar'];break;}}}if(!val&&a.length>0){const k=Object.keys(a[0])[0];val=a[0][k];}return typeof val==='string'?val:'';}
function setInLangArray(arr,lang,text){let a=normalizeLangArray(arr);let f=false;a=a.map(o=>{const k=Object.keys(o)[0];if(k===lang){f=true;return{[lang]:text};}return o;});if(!f)a.push({[lang]:text});return a;}

function getLocalizedTitle(chapter,lang){return getFromLangArray(chapter.title,lang);}
function setLocalizedTitle(chapter,lang,text){chapter.title=setInLangArray(chapter.title,lang,text);}

function getLocalizedContent(chapter,lang){if(!chapter||!chapter.content||!Array.isArray(chapter.content)||chapter.content.length===0)return'';const block=chapter.content[0];if(!block||typeof block!=='object')return'';const data=block.data;if(typeof data==='string')return data;return getFromLangArray(data,lang);}
function setLocalizedContent(chapter,lang,text){
  if(!chapter.content||!Array.isArray(chapter.content)||chapter.content.length===0){
    chapter.content=[{type:'paragraph',data:setInLangArray([],lang,text||'')}];
    return;
  }
  const block=chapter.content[0];
  if(typeof block.data==='string'){
    const existingText = block.data;
    block.data=setInLangArray([],lang,existingText);
  }
  // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ - ÙÙ‚Ø· Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ÙØ§Ø±Øº ÙˆÙ„ÙŠØ³ Ù…Ø¬Ø±Ø¯ Ù…Ø³Ø§ÙØ§Øª
  // ÙˆØ¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ØªÙ„ÙØ§Ù‹ Ø¹Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
  if(text !== undefined && text !== null && text.trim() !== ''){
    const currentContent = getFromLangArray(block.data, lang);
    if(text.trim() !== currentContent.trim()){
      block.data=setInLangArray(block.data,lang,text);
    }
  }
}

// Ø¯Ø§Ù„Ø© Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ø­Ø°Ù ØºÙŠØ± Ø§Ù„Ù…Ù‚ØµÙˆØ¯
function protectContentFromLoss() {
  if (!bookData || activePath.section === null || activePath.chapter === null) return;
  
  const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
  if (!chapter || !chapter.content) return;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±
  if (markdownEditor && markdownEditor.value && markdownEditor.value.trim() !== '') {
    const editorContent = markdownEditor.value.trim();
    const currentContent = getLocalizedContent(chapter, currentLanguage || 'ar');
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± Ù…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŒ Ø§Ø­ÙØ¸Ù‡
    if (editorContent !== currentContent.trim()) {
      setLocalizedContent(chapter, currentLanguage || 'ar', editorContent);
      console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø­Ù…Ø§ÙŠØªÙ‡ Ù…Ù† Ø§Ù„ÙÙ‚Ø¯Ø§Ù†');
    }
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  if (editorTitleInput && editorTitleInput.value && editorTitleInput.value.trim() !== '') {
    const editorTitle = editorTitleInput.value.trim();
    const currentTitle = getLocalizedTitle(chapter, currentLanguage || 'ar');
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± Ù…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŒ Ø§Ø­ÙØ¸Ù‡
    if (editorTitle !== currentTitle.trim()) {
      setLocalizedTitle(chapter, currentLanguage || 'ar', editorTitle);
      console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø­Ù…Ø§ÙŠØªÙ‡ Ù…Ù† Ø§Ù„ÙÙ‚Ø¯Ø§Ù†');
    }
  }
}

// Ø¯Ø§Ù„Ø© Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙØµÙˆÙ„
function protectContentBeforeSwitch() {
  if (!bookData || activePath.section === null || activePath.chapter === null) return;
  
  const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
  if (!chapter) return;
  
  // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
  if (currentView === 'editor' && markdownEditor) {
    const editorContent = markdownEditor.value || '';
    const currentContent = getLocalizedContent(chapter, currentLanguage || 'ar') || '';
    
    if (editorContent.trim() !== currentContent.trim()) {
      setLocalizedContent(chapter, currentLanguage || 'ar', editorContent);
      console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„');
    }
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
  if (editorTitleInput) {
    const editorTitle = editorTitleInput.value || '';
    const currentTitle = getLocalizedTitle(chapter, currentLanguage || 'ar') || '';
    
    if (editorTitle.trim() !== currentTitle.trim()) {
      setLocalizedTitle(chapter, currentLanguage || 'ar', editorTitle);
      console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„');
    }
  }
}
        function st(range) {
            if (typeof range !== 'string' || !allLines || allLines.length === 0) return '';
            const match = range.match(/\[\[(\d+)(?::(\d+))?\]\]/);
            if (match) {
                const start = parseInt(match[1]);
                const end = match[2] ? parseInt(match[2]) : start;
                if (start < allLines.length && end < allLines.length) {
                   return allLines.slice(start, end + 1).join('\n');
                }
            }
            return '';
        }
        
        function getWordCount(str) { return str.trim().split(/\s+/).filter(Boolean).length; }
        function getCharCount(str) { return str.length; }

        function initializeMarkdownEditor() {
            markdownEditor = document.getElementById('markdown-editor');
            markdownPreview = document.getElementById('markdown-preview');
            
            markdownEditor.addEventListener('input', debounce(updateMarkdownPreview, 300));
            markdownEditor.addEventListener('scroll', syncScroll);
            
            setTheme(currentTheme);
            updateFontSize();
            
            setupMarkdownToolbar();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }



function saveUserPreferences() {
    const preferences = {
        fontSize: editorSettings.fontSize,
        fontFamily: editorSettings.fontFamily,
        bgColor: editorSettings.bgColor,
        textColor: editorSettings.textColor,
        theme: currentTheme,
        layout: document.getElementById('main-split-view').classList.contains('full-editor') ? 'full' : 'split',
        chapterSection: document.getElementById('chapter-section-select').value,
        chapterSort: document.getElementById('chapter-sort-input').value,
        language: currentLanguage
    };
    localStorage.setItem('userPreferences', JSON.stringify(preferences));
    localStorage.setItem('preferredLang', currentLanguage);
}


function loadUserPreferences() {
    const saved = localStorage.getItem('userPreferences');
    if (saved) {
        const preferences = JSON.parse(saved);
        editorSettings.fontSize = preferences.fontSize || 14;
        editorSettings.fontFamily = preferences.fontFamily || 'Consolas';
        editorSettings.bgColor = preferences.bgColor || '#1e293b';
        editorSettings.textColor = preferences.textColor || '#f8fafc';
        currentTheme = preferences.theme || 'light';
        currentLanguage = preferences.language || localStorage.getItem('preferredLang') || currentLanguage || 'ar';
        setTheme(currentTheme);
    }
}
function renderLanguageSelector() {
    const container = document.getElementById('controls-panel') || document.body;
    let select = document.getElementById('language-select');
    if (!select) { 
        select = document.createElement('select');
        select.id = 'language-select';
        select.className = 'p-2 border rounded';
        const langs = [
            { v: 'ar', t: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
            { v: 'en', t: 'English' },
            { v: 'fr', t: 'FranÃ§ais' },
            { v: 'tr', t: 'TÃ¼rkÃ§e' },
            { v: 'nl', t: 'Nederlands' },
            { v: 'hi', t: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€' },
            { v: 'ms', t: 'Bahasa Melayu' },
            { v: 'zh', t: 'ä¸­æ–‡' }
        ];
        langs.forEach(l => {
            const opt = document.createElement('option');
            opt.value = l.v;
            opt.textContent = l.t;
            select.appendChild(opt);
        });
        container.prepend(select);
    }
    select.value = currentLanguage || 'ar';
    select.onchange = () => {
        currentLanguage = select.value || 'ar';
        localStorage.setItem('preferredLang', currentLanguage);
        saveUserPreferences();
        if (bookData && activePath.section !== null && activePath.chapter !== null) {
            const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
            if (editorTitleInput) editorTitleInput.value = getLocalizedTitle(ch, currentLanguage) || '';
            if (markdownEditor) {
                markdownEditor.value = getLocalizedContent(ch, currentLanguage) || '';
                updateMarkdownPreview();
            }
        }
        renderTreeView();
        if (typeof renderViewerContentOnly === 'function') renderViewerContentOnly();
    };

    
select.value=currentLanguage||'ar';
currentLanguage=select.value||'ar';
localStorage.setItem('preferredLang',currentLanguage);
if(bookData&&bookTitleInputEl){bookTitleInputEl.value=getLocalizedBookName(bookData,currentLanguage)||''}
if(bookData&&activePath.section!==null&&activePath.chapter!==null){
const ch=bookData.sections[activePath.section].Chapters[activePath.chapter];
if(editorTitleInput)editorTitleInput.value=getLocalizedTitle(ch,currentLanguage)||'';
if (markdownEditor) markdownEditor.value=getLocalizedContent(ch,currentLanguage)||'';
}
}

        function updateMarkdownPreview() {
            if (!markdownEditor || !markdownPreview) {
                console.warn('Markdown editor or preview not initialized');
                return;
            }
            
            const markdownText = markdownEditor.value || '';
            
            try {
                const htmlContent = marked.parse(markdownText, { 
                    breaks: true,
                    gfm: true,
                    sanitize: false,
                    smartLists: true,
                    smartypants: true
                });
                
                markdownPreview.innerHTML = htmlContent;
                
                markdownPreview.querySelectorAll('pre code').forEach((el) => {
                    hljs.highlightElement(el);
                });
                
                markdownPreview.querySelectorAll('table').forEach((table) => {
                    table.className = 'w-full text-sm text-right text-gray-400 bg-gray-800 rounded-lg border border-gray-600';
                    const thead = table.querySelector('thead');
                    if (thead) {
                        thead.className = 'text-xs text-gray-300 uppercase bg-gray-700';
                        thead.querySelectorAll('th').forEach(th => {
                            th.className = 'px-6 py-3 border border-gray-600';
                        });
                    }
                    const tbody = table.querySelector('tbody');
                    if (tbody) {
                        tbody.querySelectorAll('tr').forEach(tr => {
                            tr.className = 'border-b bg-gray-800 border-gray-700 hover:bg-gray-600';
                            tr.querySelectorAll('td').forEach(td => {
                                td.className = 'px-6 py-4 border border-gray-600';
                            });
                        });
                    }
                });
                
                markdownPreview.querySelectorAll('blockquote').forEach((quote) => {
                    quote.className = 'border-r-4 border-blue-500 bg-gray-800 p-4 my-4 italic text-gray-300';
                });
                
                markdownPreview.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach((heading) => {
                    heading.className = 'font-bold text-yellow-400 mb-3 mt-6';
                    if (heading.tagName === 'H1') heading.className += ' text-3xl';
                    else if (heading.tagName === 'H2') heading.className += ' text-2xl';
                    else if (heading.tagName === 'H3') heading.className += ' text-xl';
                });
                
                markdownPreview.querySelectorAll('ul, ol').forEach((list) => {
                    list.className = 'list-disc list-inside space-y-2 my-4 text-gray-300';
                    if (list.tagName === 'OL') {
                        list.className = 'list-decimal list-inside space-y-2 my-4 text-gray-300';
                    }
                });
                
                markdownPreview.querySelectorAll('p').forEach((p) => {
                    p.className = 'mb-4 leading-relaxed text-gray-300';
                });
                
                markdownPreview.querySelectorAll('code:not(pre code)').forEach((code) => {
                    code.className = 'bg-gray-700 text-yellow-300 px-2 py-1 rounded text-sm';
                });
                
                markdownPreview.querySelectorAll('a').forEach((link) => {
                    link.className = 'text-blue-400 hover:text-blue-300 underline';
                });
                
                markdownPreview.querySelectorAll('strong').forEach((strong) => {
                    strong.className = 'font-bold text-white';
                });
                
                markdownPreview.querySelectorAll('em').forEach((em) => {
                    em.className = 'italic text-yellow-300';
                });

                // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø­Ø°Ø± Ù„ØªØ¬Ù†Ø¨ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©
                if (activePath.section !== null && activePath.chapter !== null && bookData && markdownText.trim() !== '') {
                    protectContentFromLoss();
                    const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
                    setLocalizedContent(ch, currentLanguage || 'ar', markdownText);
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø§Ø±Ø¶ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶
                    if (currentView === 'viewer') {
                        renderViewerContentOnly();
                    }
                }
                
            } catch (error) {
                console.error('Error parsing markdown:', error);
                markdownPreview.innerHTML = `<p class="text-red-400">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Markdown: ${error.message}</p>`;
            }
        }
function migrateOldDataStructure(){
    if(!bookData||!Array.isArray(bookData.sections))return;
    if(typeof bookData.name==='string')bookData.name=[{ar:bookData.name}];else bookData.name=normalizeLangArray(bookData.name);
    for(const sec of bookData.sections){
        if(typeof sec.section_name==='string')sec.section_name=[{ar:sec.section_name}];else sec.section_name=normalizeLangArray(sec.section_name);
        if(Array.isArray(sec.Chapters)){
            for(const ch of sec.Chapters){
                if(typeof ch.title==='string')ch.title=[{ar:ch.title}];else ch.title=normalizeLangArray(ch.title);
                if(Array.isArray(ch.content)){
                    for(const b of ch.content){
                        if(b&&b.type==='paragraph'){
                            if(typeof b.data==='string')b.data=[{ar:b.data}];else b.data=normalizeLangArray(b.data);
                        }
                    }
                }
            }
        }
    }
}
        function syncScroll() {
            if (!markdownEditor || !markdownPreview) return;
            
            const scrollPercentage = markdownEditor.scrollTop / (markdownEditor.scrollHeight - markdownEditor.clientHeight);
            const targetScrollTop = scrollPercentage * (markdownPreview.scrollHeight - markdownPreview.clientHeight);
            markdownPreview.scrollTop = targetScrollTop;
        }

        function setupMarkdownToolbar() {
            const toolbar = document.getElementById('markdown-toolbar');
            
            toolbar.addEventListener('click', (e) => {
                const button = e.target.closest('.toolbar-btn');
                if (!button) return;
                
                const action = button.dataset.action;
                applyMarkdownAction(action);
            });
        }

        function applyMarkdownAction(action) {
            if (!markdownEditor) return;
            
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            const selectedText = markdownEditor.value.substring(start, end);
            const beforeText = markdownEditor.value.substring(0, start);
            const afterText = markdownEditor.value.substring(end);
            
            let newText = '';
            let cursorOffset = 0;
            
            function isAlreadyFormatted(text, prefix, suffix = prefix) {
                return text.startsWith(prefix) && text.endsWith(suffix);
            }
            
            function removeFormatting(text, prefix, suffix = prefix) {
                if (isAlreadyFormatted(text, prefix, suffix)) {
                    return text.substring(prefix.length, text.length - suffix.length);
                }
                return text;
            }
            
            switch (action) {
                case 'bold':
                    if (selectedText && isAlreadyFormatted(selectedText, '**')) {
                        newText = removeFormatting(selectedText, '**');
                        cursorOffset = 0;
                    } else {
                        newText = `**${selectedText}**`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'italic':
                    if (selectedText && isAlreadyFormatted(selectedText, '*') && !isAlreadyFormatted(selectedText, '**')) {
                        newText = removeFormatting(selectedText, '*');
                        cursorOffset = 0;
                    } else {
                        newText = `*${selectedText}*`;
                        cursorOffset = selectedText ? 0 : 1;
                    }
                    break;
                case 'h1':
                    if (selectedText && selectedText.startsWith('# ')) {
                        newText = selectedText.substring(2);
                        cursorOffset = 0;
                    } else {
                        newText = `# ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'h2':
                    if (selectedText && selectedText.startsWith('## ')) {
                        newText = selectedText.substring(3);
                        cursorOffset = 0;
                    } else {
                        newText = `## ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 3;
                    }
                    break;
                case 'h3':
                    if (selectedText && selectedText.startsWith('### ')) {
                        newText = selectedText.substring(4);
                        cursorOffset = 0;
                    } else {
                        newText = `### ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 4;
                    }
                    break;
                case 'quote':
                    if (selectedText && selectedText.startsWith('> ')) {
                        newText = selectedText.substring(2);
                        cursorOffset = 0;
                    } else {
                        newText = `> ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'code':
                    if (selectedText.includes('\n')) {
                        if (isAlreadyFormatted(selectedText, '```\n', '\n```')) {
                            newText = removeFormatting(selectedText, '```\n', '\n```');
                            cursorOffset = 0;
                        } else {
                            newText = `\`\`\`\n${selectedText}\n\`\`\``;
                            cursorOffset = selectedText ? 0 : 4;
                        }
                    } else {
                        if (isAlreadyFormatted(selectedText, '`')) {
                            newText = removeFormatting(selectedText, '`');
                            cursorOffset = 0;
                        } else {
                            newText = `\`${selectedText}\``;
                            cursorOffset = selectedText ? 0 : 1;
                        }
                    }
                    break;
                case 'list':
                    if (selectedText && selectedText.startsWith('- ')) {
                        newText = selectedText.substring(2);
                        cursorOffset = 0;
                    } else {
                        newText = `- ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'ordered-list':
                    if (selectedText && /^\d+\. /.test(selectedText)) {
                        newText = selectedText.replace(/^\d+\. /, '');
                        cursorOffset = 0;
                    } else {
                        newText = `1. ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 3;
                    }
                    break;
                case 'link':
                    const linkPattern = /^\[([^\]]*)\]\([^)]*\)$/;
                    if (selectedText && linkPattern.test(selectedText)) {
                        const match = selectedText.match(/^\[([^\]]*)\]/);
                        newText = match ? match[1] : selectedText;
                        cursorOffset = 0;
                    } else {
                        newText = `[${selectedText || 'Ù†Øµ Ø§Ù„Ø±Ø§Ø¨Ø·'}](https://example.com)`;
                        cursorOffset = selectedText ? newText.length - 20 : 1;
                    }
                    break;
                case 'image':
                    const imagePattern = /^!\[([^\]]*)\]\([^)]*\)$/;
                    if (selectedText && imagePattern.test(selectedText)) {
                        const match = selectedText.match(/^!\[([^\]]*)\]/);
                        newText = match ? match[1] : selectedText;
                        cursorOffset = 0;
                    } else {
                        newText = `![${selectedText || 'ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø©'}](https://example.com/image.jpg)`;
                        cursorOffset = selectedText ? newText.length - 30 : 2;
                    }
                    break;
                case 'table':
                    newText = `| Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ | Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ |\n|-------------|-------------|\n| Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 1 | Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 2 |`;
                    cursorOffset = 0;
                    break;
            }
            
            markdownEditor.value = beforeText + newText + afterText;
            
            const newCursorPos = start + newText.length - cursorOffset;
            markdownEditor.setSelectionRange(newCursorPos, newCursorPos);
            markdownEditor.focus();
            
            updateMarkdownPreview();
        }
function generateBookStructure(allLines, options = { thematic: true }) {
    const chapterStarts = allLines.reduce((acc, line, i) => {
        if (line.trim().startsWith("ÙØµÙ„")) acc.push(i);
        return acc;
    }, []);
    chapterStarts.push(allLines.length);

    const allChapters = [];
    for (let i = 0; i < chapterStarts.length - 1; i++) {
        const start = chapterStarts[i];
        const end = chapterStarts[i + 1];
        const title = (allLines[start] || "").replace(/^ÙØµÙ„\s*[:]?:?\s*/, "").trim();
        const contentString = allLines.slice(start + 1, end).join("\n");
        allChapters.push({
            title,
            content: [{ type: 'paragraph', data: contentString }]
        });
    }

    let finalSections = [];

    if (options.thematic) {
        const thematicMap = [
            {
                section_name: "Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„: Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªÙŠÙ‡",
                chapterIndices: [0, 1, 13, 11, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
            },
            {
                section_name: "Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù‚ÙˆÙŠÙ….. ÙƒÙŠÙ Ù†Ù‚Ø±Ø£ ÙƒÙ„Ø§Ù… Ø±Ø¨Ù†Ø§ØŸ",
                chapterIndices: [24, 25, 27, 65, 94, 95, 26, 49]
            },
            {
                section_name: "Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø§Ù†Ù‚Ù„Ø§Ø¨ Ø§Ù„Ø¹Ø¸ÙŠÙ….. Ù…ØªÙ‰ ÙˆÙƒÙŠÙ Ø¶Ù„Ù‘ Ø§Ù„Ø²Ù…Ø§Ù† ÙˆØ§Ù„Ø¯ÙŠÙ†ØŸ",
                chapterIndices: [12, 28, 29, 30, 31, 32, 36, 33, 34, 35, 40, 37, 38, 39, 41, 42, 43, 48, 51, 52, 53, 55, 56, 57, 50, 44, 59, 58, 60, 61, 46, 45]
            },
            {
                section_name: "Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø¹: ÙŠÙˆØªÙˆØ¨ÙŠØ§ Ø§Ù„Ù…Ø¤Ù…Ù†ÙŠÙ†.. ÙƒÙŠÙ ÙŠÙƒÙˆÙ† Ø´ÙƒÙ„ Ø§Ù„Ø¹Ø§Ù„Ù… Ø­ÙŠÙ† ÙŠØ­ÙƒÙ… Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ØŸ",
                chapterIndices: [68, 69, 70, 67, 71, 87, 88, 47, 74, 75, 76, 72, 73, 90, 91, 89, 92, 93, 82, 83, 78, 79, 80, 81, 77]
            },
            {
                section_name: "Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø®Ø§Ù…Ø³: Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡.. Ø§Ù„Ø®Ø§ØªÙ…Ø© ÙˆØ§Ù„Ø¨Ø¯Ø§ÙŠØ©",
                chapterIndices: [97, 96, 95, 62, 63, 64, 84, 85, 86, 2, 3, 4, 5, 6, 7, 8, 9, 10]
            }
        ];

        thematicMap.forEach((part, index) => {
            const section = {
                section_name: part.section_name,
                sort: index,
                Chapters: []
            };
            part.chapterIndices.forEach(index => {
                if (allChapters[index]) {
                    section.Chapters.push(allChapters[index]);
                }
            });
            finalSections.push(section);
        });

    } else {
        finalSections = [{
            section_name: "ÙØµÙˆÙ„ Ø§Ù„ÙƒØªØ§Ø¨",
            sort: 0,
            Chapters: allChapters
        }];
    }
    
    return {
        name: allLines[0] || "ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯",
        bio: allLines.slice(1, 15).join("\n"),
        sections: finalSections
    };
}


function initializeJsonFromTxt() {
            const importMethod = document.getElementById('import-method').value;
            if (importMethod === 'suggested' && allLines.length > 0) {
                bookData = generateBookStructure(allLines, { thematic: true });
                lastSavedBook = null;
                renderApp();
                return;
            }
            
            const chapterStarts = allLines.reduce((acc, line, i) => {
                if (line.trim().startsWith("ÙØµÙ„")) acc.push(i);
                return acc;
            }, []);
            chapterStarts.push(allLines.length);

            const chapters = [];
            for (let i = 0; i < chapterStarts.length - 1; i++) {
                const start = chapterStarts[i];
                const end = chapterStarts[i + 1];
                const title = (allLines[start] || "").replace(/^ÙØµÙ„\s*[:]?:?\s*/, "").trim();
                const contentString = allLines.slice(start + 1, end).join("\n");
                chapters.push({
                    title,
                    content: [{ type: 'paragraph', data: contentString }]
                });
            }
            
            bookData = {
                name: allLines[0] || "ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯",
                bio: allLines.slice(1, 15).join("\n"),
                sections: [{ section_name: "Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ù…Ù„", sort: 0, Chapters: chapters }]
            };
            lastSavedBook = null;
			ensureUniqueIDs(bookData);
            normalizeAuditDefaults(bookData);
            renderApp();
        }

        function renderApp() {
            if (bookData) ensureBookSchema(bookData);
            renderTreeView();
            if (activePath.section !== null && activePath.chapter !== null) {
                renderContent();
                                ensureChapterAIBar();

            } else {
                switchView('viewer');
                viewerTitle.textContent = "Ø§Ø®ØªØ± ÙØµÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶Ù‡";
                viewerContent.innerHTML = "<p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙØ­ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù† Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ.</p>";
            }
            updateContentButtonsVisibility();
            renderAuditBadge();

            updatePrintButtonVisibility();
			
        }

        function renderTreeView() {
            if (!bookData) return;
            treeContainer.innerHTML = '';
            
            const bookTitle = document.createElement('div');
            bookTitle.className = 'tree-item p-3 rounded-lg cursor-pointer font-bold text-lg border-2 border-blue-500 bg-blue-900 slide-in';
            bookTitle.textContent = getLocalizedBookName(bookData, currentLanguage) || 'ÙƒØªØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
            bookTitle.dataset.type = 'book';
            bookTitle.addEventListener('click', () => {
                activePath = { section: null, chapter: null };
                updateContentButtonsVisibility();
                renderAuditBadge();

                renderApp();
            });
            bookTitle.addEventListener('contextmenu', handleContextMenu);
            treeContainer.appendChild(bookTitle);

            const sortedSections = [...bookData.sections].sort((a, b) => (a.sort || 0) - (b.sort || 0));

            sortedSections.forEach((section, sectionIndex) => {
                const originalIndex = bookData.sections.indexOf(section);
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'tree-item tree-item-section p-2 rounded-lg cursor-pointer mr-4 slide-in';
                sectionDiv.style.animationDelay = `${sectionIndex * 0.1}s`;
                sectionDiv.style.paddingLeft = '24px';
                sectionDiv.textContent = `${sectionIndex + 1}. ${getLocalizedSectionName(section, currentLanguage || 'ar')}`;
                sectionDiv.dataset.type = 'section';
                sectionDiv.dataset.sectionIndex = originalIndex;
                
                if (!section.collapsed) {
                    section.collapsed = false;
                }
                
                if (section.collapsed) {
                    sectionDiv.classList.add('collapsed');
                }
                
                sectionDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    section.collapsed = !section.collapsed;
                    renderTreeView();
                    if (!section.collapsed) {
                        activePath = { section: originalIndex, chapter: null };
                        updateContentButtonsVisibility();
                        renderAuditBadge();

                        renderApp();
                    }
                });
                
                sectionDiv.addEventListener('contextmenu', handleContextMenu);
                sectionDiv.draggable = true;
                sectionDiv.addEventListener('dragstart', handleDragStart);
                sectionDiv.addEventListener('dragover', handleDragOver);
                sectionDiv.addEventListener('drop', handleDrop);
                sectionDiv.addEventListener('dragend', handleDragEnd);
                treeContainer.appendChild(sectionDiv);

                const chaptersContainer = document.createElement('div');
                chaptersContainer.className = `chapters-container ${section.collapsed ? 'collapsed' : 'expanded'}`;
                
                section.Chapters.forEach((chapter, chapterIndex) => {
                    const chapterDiv = document.createElement('div');
                    chapterDiv.className = 'tree-item tree-item-chapter p-2 rounded-lg cursor-pointer mr-6 slide-in';
                    chapterDiv.style.animationDelay = `${(sectionIndex * section.Chapters.length + chapterIndex) * 0.05}s`;
                    chapterDiv.textContent = `${sectionIndex + 1}.${chapterIndex + 1} ${getLocalizedTitle(chapter, currentLanguage || 'ar')}`;
                    chapterDiv.dataset.type = 'chapter';
                    chapterDiv.dataset.sectionIndex = originalIndex;
                    chapterDiv.dataset.chapterIndex = chapterIndex;
                    chapterDiv.addEventListener('click', () => {
                        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ ØªØºÙŠÙŠØ± Ø§Ù„ÙØµÙ„
                        if (currentView === 'editor') {
                            protectContentFromLoss();
                            if (markdownEditor && markdownEditor.value.trim() !== '') {
                                saveCurrentEditorContent();
                            }
                        }
                        activePath = { section: originalIndex, chapter: chapterIndex };
                        
                        if (currentView === 'editor') {
                            renderContent();
                        } else {
                            switchView('viewer');
                            renderApp();
                        }
                    });
                    chapterDiv.addEventListener('contextmenu', handleContextMenu);
                    chapterDiv.draggable = true;
                    chapterDiv.addEventListener('dragstart', handleDragStart);
                    chapterDiv.addEventListener('dragover', handleDragOver);
                    chapterDiv.addEventListener('drop', handleDrop);
                    chapterDiv.addEventListener('dragend', handleDragEnd);
                    chaptersContainer.appendChild(chapterDiv);

                    if (activePath.section === originalIndex && activePath.chapter === chapterIndex) {
                        chapterDiv.classList.add('tree-item-active');
                    }
                });
                
                treeContainer.appendChild(chaptersContainer);

                if (activePath.section === originalIndex && activePath.chapter === null) {
                    sectionDiv.classList.add('tree-item-active');
                }
            });
            
            updateContentButtonsVisibility();
            renderAuditBadge();

        }
        
              function renderContent() {
            if (!bookData || activePath.section === null || activePath.chapter === null) {
                updateContentButtonsVisibility();
                renderAuditBadge();

                return;
            }
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            
            // Ensure content array exists
            if (!chapter.content) {
                chapter.content = [{ type: 'paragraph', data: [{ ar: '' }] }];
            }
            
            renderViewerContentOnly();
            
            editorTitleInput.value = getLocalizedTitle(chapter, currentLanguage || 'ar');
            
            const inlineTitle = document.getElementById('editor-title-inline');
            if (inlineTitle) inlineTitle.value = getLocalizedTitle(chapter, currentLanguage || 'ar');
            
            updateEditorControls();
            updateContentButtonsVisibility();
            renderAuditBadge();

            updatePrintButtonVisibility();
            
            if (markdownEditor) {
                const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                markdownEditor.value = content;
                updateMarkdownPreview();
            }
			
			
        }

        function renderViewerContentOnly() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            viewerTitle.textContent = getLocalizedTitle(chapter, currentLanguage || 'ar');
            viewerContent.innerHTML = '';
            (chapter.content || []).forEach(block => {
    viewerContent.appendChild(renderBlockForViewer(block));
});

        }

        function renderBlockForViewer(block) {
            const container = document.createElement('div');
            container.className = 'content-block-viewer mb-6';
            switch(block.type) {
                case 'paragraph':
                    container.innerHTML = marked.parse(getFromLangArray(block.data, currentLanguage) || '', { breaks: true });
                    container.querySelectorAll('pre code').forEach((el) => {
                        hljs.highlightElement(el);
                    });
                    break;
                case 'image':
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'my-6 text-center';
                    const img = document.createElement('img');
                    img.src = block.data.url;
                    img.alt = block.data.title;
                    img.className = 'max-w-full h-auto mx-auto rounded-lg shadow-lg';
                    imgContainer.appendChild(img);
                    if (block.data.title) {
                        const title = document.createElement('h3');
                        title.className = 'text-lg font-semibold mt-3 text-gray-300';
                        title.textContent = block.data.title;
                        imgContainer.appendChild(title);
                    }
                    if (block.data.caption) {
                        const caption = document.createElement('p');
                        caption.className = 'text-sm text-gray-400 italic mt-2';
                        caption.textContent = block.data.caption;
                        imgContainer.appendChild(caption);
                    }
                    container.appendChild(imgContainer);
                    break;
                case 'table':
                     const tableContainer = document.createElement('div');
                     tableContainer.className = 'overflow-x-auto my-6';
                     if (block.data.title) {
                        const title = document.createElement('h3');
                        title.className = 'text-xl font-bold mb-3 text-center text-gray-200';
                        title.textContent = block.data.title;
                        tableContainer.appendChild(title);
                     }
                     const table = document.createElement('table');
                     table.className = 'w-full text-sm text-right text-gray-400 bg-gray-800 rounded-lg';
                     const rows = (block.data.csv || '').split('\n').filter(row => row.trim() !== '');
                     if (rows.length > 0) {
                        const thead = document.createElement('thead');
                        thead.className = 'text-xs text-gray-300 uppercase bg-gray-700';
                        const headerRow = document.createElement('tr');
                        rows[0].split(',').forEach(headerText => {
                            const th = document.createElement('th');
                            th.scope = 'col';
                            th.className = 'px-6 py-3';
                            th.textContent = headerText.trim();
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        rows.slice(1).forEach(rowText => {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b bg-gray-800 border-gray-700 hover:bg-gray-600';
                            rowText.split(',').forEach(cellText => {
                                const td = document.createElement('td');
                                td.className = 'px-6 py-4';
                                td.textContent = cellText.trim();
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                     }
                     tableContainer.appendChild(table);
                     container.appendChild(tableContainer);
                    break;
            }
            return container;
        }

              function addContentBlock(type) {
            if (activePath.section === null || activePath.chapter === null) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„ÙŠÙ‡.");
                return;
            }
            
            if (!bookData.sections[activePath.section].Chapters[activePath.chapter].content) {
                bookData.sections[activePath.section].Chapters[activePath.chapter].content = [];
            }
            
            let newBlock;
            switch(type) {
                case 'paragraph':
                    newBlock = { type: 'paragraph', data: 'Ù†Øµ Ø¬Ø¯ÙŠØ¯...' };
                    break;
                case 'image':
                    newBlock = { type: 'image', data: { url: '', title: '', caption: '' } };
                    break;
                case 'table':
                    newBlock = { type: 'table', data: { title: '', csv: 'Ø¹Ù…ÙˆØ¯1,Ø¹Ù…ÙˆØ¯2\nØ¨ÙŠØ§Ù†Ø§Øª1,Ø¨ÙŠØ§Ù†Ø§Øª2' } };
                    break;
            }
            
            bookData.sections[activePath.section].Chapters[activePath.chapter].content.push(newBlock);
            
            if (currentView === 'viewer') {
                renderViewerContentOnly();
                const newBlockIndex = bookData.sections[activePath.section].Chapters[activePath.chapter].content.length - 1;
                setTimeout(() => {
                    createInlineEditor(newBlockIndex, type);
                }, 100);
            } else {
                renderContent();
            }
            
            setTimeout(() => {
                saveBookToIndexedDB();
            }, 100);
        }

        function createInlineEditor(blockIndex, blockType) {
            const viewerContent = document.getElementById('viewer-content');
            const blocks = viewerContent.children;
            
            if (blockIndex >= blocks.length) return;
            
            const block = blocks[blockIndex];
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            const contentBlock = chapter.content[blockIndex];
            
            if (blockType === 'paragraph') {
                createParagraphEditor(block, blockIndex, contentBlock);
            } else if (blockType === 'image') {
                createImageEditor(block, blockIndex, contentBlock);
            } else if (blockType === 'table') {
                createTableEditor(block, blockIndex, contentBlock);
            }
        }

        function createParagraphEditor(element, blockIndex, contentBlock) {
    const textarea = document.createElement('textarea');
    let localizedText = '';
    // Use getFromLangArray for compatibility
    if (Array.isArray(contentBlock.data)) {
        localizedText = getFromLangArray(contentBlock.data, currentLanguage);
    } else if (typeof contentBlock.data === 'string') {
        localizedText = contentBlock.data;
    } else {
        localizedText = contentBlock.text || '';
    }
    textarea.value = localizedText;
    textarea.className = 'w-full p-3 border rounded-lg resize-none';
    textarea.style.minHeight = '100px';
    textarea.style.fontFamily = 'inherit';
    textarea.style.fontSize = 'inherit';
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex gap-2 mt-2';
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Ø­ÙØ¸';
    saveBtn.className = 'btn btn-success';
    saveBtn.onclick = () => {
        const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
        const blockToUpdate = chapter.content[blockIndex];
        // Use setInLangArray for compatibility
        if (typeof blockToUpdate.data === 'string') {
            blockToUpdate.data = setInLangArray([], currentLanguage, textarea.value);
        } else {
            blockToUpdate.data = setInLangArray(blockToUpdate.data, currentLanguage, textarea.value);
        }
        blockToUpdate.text = textarea.value;
        saveBlockAndRefresh(blockIndex, blockToUpdate);
    };
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
    cancelBtn.className = 'btn btn-secondary';
    cancelBtn.onclick = () => renderViewerContentOnly();
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Ø­Ø°Ù';
    deleteBtn.className = 'btn btn-danger';
    deleteBtn.onclick = () => deleteContentBlock(blockIndex);
    buttonContainer.appendChild(saveBtn);
    buttonContainer.appendChild(cancelBtn);
    buttonContainer.appendChild(deleteBtn);
    element.innerHTML = '';
    element.appendChild(textarea);
    element.appendChild(buttonContainer);
    textarea.focus();
}

        function createImageEditor(element, blockIndex, contentBlock) {
            const container = document.createElement('div');
            container.className = 'space-y-3';
            // Support both {url, title, caption} and {data: {url, title, caption}}
            let url = contentBlock.url || (contentBlock.data && contentBlock.data.url) || '';
            let title = contentBlock.title || (contentBlock.data && contentBlock.data.title) || '';
            let caption = contentBlock.caption || (contentBlock.data && contentBlock.data.caption) || '';

            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.placeholder = 'Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©';
            urlInput.value = url;
            urlInput.className = 'w-full p-2 border rounded';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.placeholder = 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';
            titleInput.value = title;
            titleInput.className = 'w-full p-2 border rounded';

            const captionInput = document.createElement('textarea');
            captionInput.placeholder = 'ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';
            captionInput.value = caption;
            captionInput.className = 'w-full p-2 border rounded resize-none';
            captionInput.rows = 2;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex gap-2';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Ø­ÙØ¸';
            saveBtn.className = 'btn btn-success';
            saveBtn.onclick = () => saveBlockAndRefresh(blockIndex, {
                type: 'image',
                data: {
                    url: urlInput.value,
                    title: titleInput.value,
                    caption: captionInput.value
                }
            });

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.onclick = () => renderViewerContentOnly();

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Ø­Ø°Ù';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.onclick = () => deleteContentBlock(blockIndex);

            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(deleteBtn);

            container.appendChild(urlInput);
            container.appendChild(titleInput);
            container.appendChild(captionInput);
            container.appendChild(buttonContainer);

            element.innerHTML = '';
            element.appendChild(container);

            urlInput.focus();
        }

        function createTableEditor(element, blockIndex, contentBlock) {
            const container = document.createElement('div');
            container.className = 'space-y-3';
            // Support both {title, csv} and {data: {title, csv}}
            let title = contentBlock.title || (contentBlock.data && contentBlock.data.title) || '';
            let csv = contentBlock.csv || (contentBlock.data && contentBlock.data.csv) || '';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.placeholder = 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';
            titleInput.value = title;
            titleInput.className = 'w-full p-2 border rounded';

            const csvTextarea = document.createElement('textarea');
            csvTextarea.placeholder = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ (CSV - ÙØ§ØµÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©ØŒ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ)';
            csvTextarea.value = csv;
            csvTextarea.className = 'w-full p-2 border rounded resize-none';
            csvTextarea.rows = 6;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex gap-2';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Ø­ÙØ¸';
            saveBtn.className = 'btn btn-success';
            saveBtn.onclick = () => {
                const csvData = csvTextarea.value.trim();
                saveBlockAndRefresh(blockIndex, {
                    type: 'table',
                    data: {
                        title: titleInput.value,
                        csv: csvData
                    }
                });
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.onclick = () => renderViewerContentOnly();

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Ø­Ø°Ù';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.onclick = () => deleteContentBlock(blockIndex);

            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(deleteBtn);

            container.appendChild(titleInput);
            container.appendChild(csvTextarea);
            container.appendChild(buttonContainer);

            element.innerHTML = '';
            element.appendChild(container);

            titleInput.focus();
        }

        function saveBlockAndRefresh(blockIndex, newBlock) {
    if (activePath.section !== null && activePath.chapter !== null) {
        const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
        if (newBlock.type === 'paragraph') {
            const oldBlock = chapter.content[blockIndex];
            // Use setInLangArray for compatibility
            if (typeof oldBlock.data === 'string') {
                oldBlock.data = setInLangArray([], currentLanguage, newBlock.text);
            } else {
                oldBlock.data = setInLangArray(oldBlock.data, currentLanguage, newBlock.text);
            }
            oldBlock.text = newBlock.text;
        } else {
            chapter.content[blockIndex] = newBlock;
        }
        saveBookToIndexedDB();
        renderViewerContentOnly();
    }
}

        function deleteContentBlock(blockIndex) {
            if (activePath.section !== null && activePath.chapter !== null) {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ')) {
                    bookData.sections[activePath.section].Chapters[activePath.chapter].content.splice(blockIndex, 1);
                    saveBookToIndexedDB();
                    renderViewerContentOnly();
                }
            }
        }

        function updateContentButtonsVisibility() {
            const contentButtons = document.getElementById('content-buttons-container');
            const printBtn = document.getElementById('print-btn');
            const hasActiveChapter = activePath.section !== null && activePath.chapter !== null;
            
            if (contentButtons) {
                contentButtons.style.display = hasActiveChapter ? 'block' : 'none';
            }
            
            if (printBtn) {
                printBtn.style.display = hasActiveChapter ? 'inline-block' : 'none';
            }
        }

        function updatePrintButtonVisibility() {
            const printBtn = document.getElementById('print-btn');
            if (printBtn) {
                if (activePath.section !== null && activePath.chapter !== null) {
                    printBtn.style.display = 'block';
                } else {
                    printBtn.style.display = 'none';
                }
            }
        }

// â¬‡ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
function editBookInfo() {
    if (!bookData) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙƒØªØ§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª Ù„Ù„Ø§Ø³Ù…
    document.getElementById('book-title-input-ar').value = getLocalizedBookName(bookData, 'ar') || '';
    document.getElementById('book-title-input-en').value = getLocalizedBookName(bookData, 'en') || '';

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª Ù„Ù„Ù…Ù‚Ø¯Ù…Ø©
    // Ù†Ø³ØªØ®Ø¯Ù… getFromLangArray Ù„Ø£Ù† bio Ø£ØµØ¨Ø­ Ø§Ù„Ø¢Ù† Ø¨Ù†ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('book-bio-input-ar').value = getFromLangArray(bookData.bio, 'ar') || '';
    document.getElementById('book-bio-input-en').value = getFromLangArray(bookData.bio, 'en') || '';

    // Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±
    document.getElementById('book-alias-input').value = bookData.alias || '';
    document.getElementById('book-id-input').value = bookData.subjectId || bookData.alias || '';
    document.getElementById('book-icon-input').value = bookData.icon || 'ğŸ“˜';
    document.getElementById('book-color-input').value = bookData.color || '#2563eb';
    document.getElementById('book-cover-input').value = bookData.cover || '';

    updateBioPreview(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø³ØªØ¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
    document.getElementById('book-info-modal').classList.remove('hidden');
}

// â¬‡ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
function saveBookInfo() {
    if (!bookData) return;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const newTitleAr = document.getElementById('book-title-input-ar').value.trim();
    const newTitleEn = document.getElementById('book-title-input-en').value.trim();
    const newBioAr = document.getElementById('book-bio-input-ar').value;
    const newBioEn = document.getElementById('book-bio-input-en').value;
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨Ù€ -)
    const newAlias = document.getElementById('book-alias-input').value.trim().replace(/\s+/g, '-');
    const newSubjectId = document.getElementById('book-id-input').value.trim();
    const newIcon = document.getElementById('book-icon-input').value.trim() || 'ğŸ“˜';
    const newColor = document.getElementById('book-color-input').value || '#2563eb';
    const newCover = document.getElementById('book-cover-input').value.trim();

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… setInLangArray Ù„ØªØ­Ø¯ÙŠØ« ÙƒØ§Ø¦Ù† Ø§Ù„Ø§Ø³Ù…
    bookData.name = setInLangArray(bookData.name, 'ar', newTitleAr);
    bookData.name = setInLangArray(bookData.name, 'en', newTitleEn);

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… setInLangArray Ù„ØªØ­Ø¯ÙŠØ« ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
    bookData.bio = setInLangArray(bookData.bio, 'ar', newBioAr);
    bookData.bio = setInLangArray(bookData.bio, 'en', newBioEn);

    // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±
    bookData.alias = newAlias;
    bookData.subjectId = slugify(newSubjectId || newAlias || newTitleEn || newTitleAr || 'subject');
    bookData.icon = newIcon;
    bookData.color = newColor;
    bookData.cover = newCover;
    ensureBookSchema(bookData);

    document.getElementById('book-info-modal').classList.add('hidden');
    renderApp(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¬Ø±Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    alert("ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
}
function exportPlainText(){
    if(!bookData)return;
    let parts=[];
    const sectionsSorted=[...bookData.sections].sort((a,b)=>(a.sort||0)-(b.sort||0));
    sectionsSorted.forEach(sec=>{
        if(!Array.isArray(sec.Chapters))return;
        sec.Chapters.forEach(ch=>{
            const t=getLocalizedTitle(ch,currentLanguage||'ar')||'';
            let body='';
            if(Array.isArray(ch.content)){
                for(const block of ch.content){
                    if(block&&block.type==='paragraph'){
                        let v='';
                        if(Array.isArray(block.data))v=getFromLangArray(block.data,currentLanguage||'ar');
                        else if(typeof block.data==='string')v=block.data;
                        else v=getFromLangArray(block.data,currentLanguage||'ar');
                        if(v){
                            // ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„ØªØµØ¯ÙŠØ±
                            v = v.replace(/\\n/g, '\n').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                            body+=v+"\n\n";
                        }
                    }
                }
            }
            const entry=((t?t+"\n":"")+(body||''));
            parts.push(entry.trim());
        });
    });
    const fileContent=parts.join("\n\n");
    const blob=new Blob([fileContent],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a');
    const bookName=(getLocalizedBookName(bookData,currentLanguage||'ar')||'book').replace(/[\\\/:*?"<>|]/g,'_');
    a.href=URL.createObjectURL(blob);
    a.download=bookName+"_plain.txt";
    document.body.appendChild(a);a.click();a.remove();
    URL.revokeObjectURL(a.href);
}
function openChangeLogs(){
  if(!bookData||activePath.section===null||activePath.chapter===null)return;
  const ch=bookData.sections[activePath.section].Chapters[activePath.chapter];
  const logs=Array.isArray(ch.changeLogs)?ch.changeLogs:[];
  let modal=document.getElementById('logs-modal');
  if(!modal){
    modal=document.createElement('div');
    modal.id='logs-modal';
    modal.className='fixed inset-0 z-50 flex items-center justify-center';
    modal.innerHTML='<div class="absolute inset-0 bg-black/50"></div><div class="relative bg-white text-black rounded p-4 max-w-4xl w-full"><h3 class="font-bold mb-3">Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</h3><div id="logs-list" class="space-y-3"></div><div class="mt-4 text-end"><button id="logs-close" class="btn">Ø¥ØºÙ„Ø§Ù‚</button></div></div>';
    document.body.appendChild(modal);
    modal.querySelector('#logs-close').onclick=()=>modal.classList.add('hidden');
  }
  const esc=s=>String(s||'').replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  const list=modal.querySelector('#logs-list');
  list.innerHTML=logs.map(l=>`<div class="border rounded p-2"><div class="flex items-center justify-between"><div><b>${l.type}</b> â€” ${l.lang} â€” ${l.provider||''} ${l.model||''}</div><div class="text-sm text-gray-500">${l.at}</div></div><details class="mt-2"><summary>Ù‚Ø¨Ù„</summary><pre class="whitespace-pre-wrap">${esc(l.before)}</pre></details><details class="mt-2"><summary>Ø¨Ø¹Ø¯</summary><pre class="whitespace-pre-wrap">${esc(l.after)}</pre></details></div>`).join('')||'<div class="text-gray-500">Ù„Ø§ Ø³Ø¬Ù„Ø§Øª</div>';
  modal.classList.remove('hidden');
}

function printCurrentChapter() {
    if (activePath.section === null || activePath.chapter === null) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØµÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
        return;
    }
    
    const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
    const bookTitleTxt = getLocalizedBookName(bookData, currentLanguage || 'ar') || 'Ù…Ø­Ø±Ø± Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…';
    const sectionName = getLocalizedSectionName(bookData.sections[activePath.section], currentLanguage || 'ar') || '';
    const chapterTitleTxt = getLocalizedTitle(chapter, currentLanguage || 'ar');
    const chapterNumber = activePath.chapter + 1;
    const printWindow = window.open('', '_blank');
    
    let printContent = `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>${chapterTitleTxt}</title>
            <style>
                @page {
                    size: A4;
                    margin: 2cm 1.5cm 2.5cm 1.5cm;
                    @top-center {
                        content: "${bookTitleTxt} - ${chapterTitleTxt}";
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 10pt;
                        color: #666;
                        border-bottom: 1px solid #ddd;
                        padding-bottom: 5px;
                    }
                    @bottom-center {
                        content: "Ø·ÙØ¨Ø¹ Ø¨Ù†Ø¸Ø§Ù… Ù…Ø­Ø±Ø± Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…";
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 8pt;
                        color: #999;
                        font-style: italic;
                        border-top: 1px solid #eee;
                        padding-top: 5px;
                    }
                    @bottom-right {
                        content: "ØµÙØ­Ø© " counter(page);
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 9pt;
                        color: #666;
                    }
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    direction: rtl;
                    margin: 0;
                    padding: 0;
                    line-height: 1.8;
                    color: #333;
                    background: white;
                }
                
                .print-header {
                    text-align: center;
                    border-bottom: 3px double #333;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                    page-break-inside: avoid;
                }
                
                .book-title {
                    font-size: 18pt;
                    font-weight: bold;
                    color: #2c3e50;
                    margin-bottom: 8px;
                    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                }
                
                .chapter-info {
                    font-size: 14pt;
                    color: #34495e;
                    margin-bottom: 5px;
                }
                
                .chapter-number {
                    font-size: 12pt;
                    color: #7f8c8d;
                    font-weight: normal;
                }
                
                .content {
                    margin: 0;
                    font-size: 12pt;
                    text-align: justify;
                }
                
                .content h1, .content h2, .content h3 {
                    color: #2c3e50;
                    margin: 25px 0 15px 0;
                    page-break-after: avoid;
                }
                
                .content h1 {
                    font-size: 16pt;
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 5px;
                }
                
                .content h2 {
                    font-size: 14pt;
                    border-bottom: 1px solid #bdc3c7;
                    padding-bottom: 3px;
                }
                
                .content h3 {
                    font-size: 13pt;
                }
                
                .image {
                    text-align: center;
                    margin: 25px 0;
                    page-break-inside: avoid;
                    border: 1px solid #ecf0f1;
                    padding: 15px;
                    background: #fafafa;
                }
                
                .image img {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #ddd;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                .image h3 {
                    margin: 10px 0 5px 0;
                    font-size: 11pt;
                    color: #2c3e50;
                }
                
                .image p {
                    margin: 5px 0;
                    font-size: 10pt;
                    color: #7f8c8d;
                    font-style: italic;
                }
                
                .table {
                    margin: 25px 0;
                    page-break-inside: avoid;
                }
                
                .table h3 {
                    margin-bottom: 10px;
                    font-size: 12pt;
                    color: #2c3e50;
                }
                
                .table table {
                    width: 100%;
                    border-collapse: collapse;
                    border: 2px solid #34495e;
                    background: white;
                }
                
                .table th {
                    background: linear-gradient(135deg, #34495e, #2c3e50);
                    color: white;
                    padding: 12px 8px;
                    text-align: center;
                    font-weight: bold;
                    border: 1px solid #2c3e50;
                }
                
                .table td {
                    border: 1px solid #bdc3c7;
                    padding: 10px 8px;
                    text-align: right;
                    background: #fdfdfd;
                }
                
                .table tr:nth-child(even) td {
                    background: #f8f9fa;
                }
                
                .table tr:hover td {
                    background: #e8f4fd;
                }
                
                .decorative-border {
                    border: 2px solid #3498db;
                    border-radius: 8px;
                    padding: 20px;
                    margin: 20px 0;
                    background: linear-gradient(135deg, #ffffff, #f8f9fa);
                    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
                }
                
                @media print {
                    body {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                    }
                    
                    .page-break {
                        page-break-before: always;
                    }
                    
                    .no-break {
                        page-break-inside: avoid;
                    }
                }
            </style>
        </head>
        <body>
            <div class="decorative-border">
                <div class="print-header">
                    <div class="book-title">${bookTitleTxt}</div>
                    <div class="chapter-info">${chapterTitleTxt}</div>
                    <div class="chapter-number">Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… ${chapterNumber} - ${sectionName}</div>
                </div>
                
                <div class="content">
    `;
    
    if (chapter.content && chapter.content.length > 0) {
        chapter.content.forEach(block => {
            if (block.type === 'paragraph') {
                let text = '';
                if (Array.isArray(block.data)) {
                    text = getFromLangArray(block.data, currentLanguage || 'ar');
                } else if (typeof block.data === 'string') {
                    text = block.data;
                } else {
                    text = block.text || '';
                }
                
                // ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                if (text) {
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø®Ø§ØµØ© ÙˆØªØ­ÙˆÙŠÙ„ \n Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø©
                    text = text
                        .replace(/\\n/g, '\n')  // ØªØ­ÙˆÙŠÙ„ \n Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©
                        .replace(/\r\n/g, '\n')
                        .replace(/\r/g, '\n')
                        .replace(/\n\s*\n\s*\n/g, '\n\n');
                    
                    // ØªØ­ÙˆÙŠÙ„ Markdown Ø¥Ù„Ù‰ HTML
                    try {
                        const html = marked.parse(text, { breaks: true });
                        printContent += html;
                    } catch (error) {
                        // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ ØªØ­ÙˆÙŠÙ„ MarkdownØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù…Ø¹ ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ø§Ø³ÙŠ
                        const simpleHtml = text
                            .replace(/\n/g, '<br>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>');
                        printContent += `<p>${simpleHtml}</p>`;
                    }
                } else {
                    printContent += '<p>[Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº]</p>';
                }
            } else if (block.type === 'image') {
                let url = block.url || (block.data && block.data.url) || '';
                let title = block.title || (block.data && block.data.title) || '';
                let caption = block.caption || (block.data && block.data.caption) || '';
                printContent += `
                    <div class="image no-break">
                        <img src="${url}" alt="${title || ''}" />
                        ${title ? `<h3>${title}</h3>` : ''}
                        ${caption ? `<p>${caption}</p>` : ''}
                    </div>
                `;
            } else if (block.type === 'table') {
                let title = block.title || (block.data && block.data.title) || '';
                let csv = block.csv || (block.data && block.data.csv) || '';
                let rows = csv.split('\n').filter(row => row.trim() !== '');
                printContent += `
                    <div class="table no-break">
                        ${title ? `<h3>${title}</h3>` : ''}
                        <table>
                            ${rows.length > 0 ?
                                rows.map((row, index) => {
                                    const cells = row.split(',');
                                    return `<tr>${cells.map(cell => index === 0 ? `<th>${cell.trim()}</th>` : `<td>${cell.trim()}</td>`).join('')}</tr>`;
                                }).join('') :
                                '<tr><td>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>'
                            }
                        </table>
                    </div>
                `;
            }
        });
    } else {
        printContent += '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„.</p>';
    }
    
    printContent += `
                </div>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }, 500);
    };
}
        function switchView(viewName) {
            // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶
            if (currentView === 'editor' && viewName !== 'editor') {
                protectContentFromLoss();
                if (markdownEditor && markdownEditor.value.trim() !== '') {
                    saveCurrentEditorContent();
                }
            }
            currentView = viewName;

            viewTabBtn.classList.remove('tab-active-main');
            editTabBtn.classList.remove('tab-active-main');
            
            if (viewName === 'viewer') {
                viewerDiv.classList.remove('hidden');
                editorDiv.classList.add('hidden');
                viewTabBtn.classList.add('tab-active-main');
                if (activePath.section !== null && activePath.chapter !== null) renderContent();
            } else {
                if (activePath.section === null || activePath.chapter === null) {
                    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ­Ø±ÙŠØ±.");
                    switchView('viewer');
                    return;
                }
                viewerDiv.classList.add('hidden');
                editorDiv.classList.remove('hidden');
                editTabBtn.classList.add('tab-active-main');
                
                if (!markdownEditor) {
                    setTimeout(() => {
                        initializeMarkdownEditor();
                        setTheme(currentTheme);
                        updateFontSize();
                        renderContent();
                    }, 100);
                } else {
                    renderContent();
                }
            }
        }
        
        function saveCurrentEditorContent() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            if (!chapter) return;

            if (!chapter.content) {
                chapter.content = [{ type: 'paragraph', data: [{ ar: '' }] }];
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø£Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            if (editorTitleInput && editorTitleInput.value !== undefined) {
                const newTitle = (editorTitleInput.value || '').trim();
                const currentTitle = getLocalizedTitle(chapter, currentLanguage || 'ar') || '';
                
                // Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ØªÙ„ÙØ§Ù‹ ÙˆÙ„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø®Ø§ØµØ© Ø¶Ø§Ø±Ø©
                if (newTitle !== currentTitle && newTitle.length <= 500) {
                    try {
                        setLocalizedTitle(chapter, currentLanguage || 'ar', newTitle);
                        console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­:', newTitle);
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', error);
                    }
                }
            }

            // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø£Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ§Ù„Ø­Ø¬Ù…
            if (markdownEditor && markdownEditor.value !== undefined) {
                const newContent = markdownEditor.value || '';
                const currentContent = getLocalizedContent(chapter, currentLanguage || 'ar') || '';
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ØªÙ„ÙØ§Ù‹ ÙˆÙ„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ ÙˆØ¶Ù…Ù† Ø­Ø¯ Ù…Ø¹Ù‚ÙˆÙ„
                if (newContent.trim() !== '' && 
                    newContent !== currentContent && 
                    newContent.length <= 1000000) { // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 1 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
                    try {
                        setLocalizedContent(chapter, currentLanguage || 'ar', newContent);
                        console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø§Ù„Ø­Ø¬Ù…:', newContent.length, 'Ø­Ø±Ù');
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰:', error);
                        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù‚ØªØ·Ø¹Ø©
                        try {
                            const truncatedContent = newContent.substring(0, 500000);
                            setLocalizedContent(chapter, currentLanguage || 'ar', truncatedContent);
                            console.warn('ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù‚ØªØ·Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
                        } catch (fallbackError) {
                            console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø·ÙŠØ¹:', fallbackError);
                        }
                    }
                }
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø£Ù…Ø§Ù†
            try {
                renderTreeView();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            }
        }

      function handleContextMenu(event) {
            event.preventDefault();
            contextMenu.innerHTML = '';
            const { type, sectionIndex, chapterIndex } = event.target.dataset;
            let items = [];

            if (type === 'book') {
                items.push({ label: 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯', action: addSection });
                items.push({ label: 'ØªØ­Ø±ÙŠØ± ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…', action: showSectionSortDialog });
                items.push({ label: 'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨ ÙƒÙ„Ù‡', action: printEntireBook });
                items.push({ label: 'ØªØµØ¯ÙŠØ± Ù„Ø£Ù‚Ø³Ø§Ù… json', action: exportAllSectionsAsZip });

            } else if (type === 'section') {
                items.push({ label: 'Ø¥Ø¶Ø§ÙØ© ÙØµÙ„ Ø¬Ø¯ÙŠØ¯', action: () => addChapter(parseInt(sectionIndex)) });
                                items.push({ label: 'Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…', action: () => deleteSection(parseInt(sectionIndex)) });
                items.push({ label: 'Ø®ØµØ§Ø¦Øµ Ø§Ù„ÙˆØ­Ø¯Ø©', action: () => openSectionResources(parseInt(sectionIndex)) });
                items.push({ label: 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', action: null, separator: true });
                items.push({ label: 'ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… ÙƒÙ€ JSON', action: () => exportSectionAsJSON(parseInt(sectionIndex)) });
                items.push({ label: 'ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… ÙƒÙ€ TXT', action: () => exportSectionAsTXT(parseInt(sectionIndex)) });
                items.push({ label: 'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø³Ù…', action: () => printSection(parseInt(sectionIndex)) });

            } else if (type === 'chapter') {
                items.push({ label: 'Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø¢Ø®Ø±', action: () => showMoveChapterDialog(parseInt(sectionIndex), parseInt(chapterIndex)) });
                items.push({ label: 'Ø­Ø°Ù Ø§Ù„ÙØµÙ„', action: () => deleteChapter(parseInt(sectionIndex), parseInt(chapterIndex)) });
                items.push({ label: 'Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¯Ø±Ø³', action: () => openChapterResources(parseInt(sectionIndex), parseInt(chapterIndex)) });
            }
            
            items.forEach(item => {
                const menuItem = document.createElement('div');
                if (item.separator) {
                    menuItem.className = 'px-4 py-1 text-gray-400 text-center border-t border-gray-600 mt-1 pt-2';
                    menuItem.textContent = item.label;
                } else {
                    menuItem.className = 'px-4 py-2 hover:bg-gray-600 cursor-pointer rounded';
                    menuItem.textContent = item.label;
                    if (item.action) {
                        menuItem.onclick = () => {
                            item.action();
                            contextMenu.classList.add('hidden');
                        };
                    }
                }
                contextMenu.appendChild(menuItem);
            });

            if (items.length > 0) {
                // --- â¬‡ï¸ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ â¬‡ï¸ ---

                // 1. Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³ ÙˆÙ„ÙƒÙ† Ù…Ø®ÙÙŠØ©
                contextMenu.style.visibility = 'hidden';
                contextMenu.classList.remove('hidden'); // ÙŠØºÙŠØ± display Ø¥Ù„Ù‰ block

                // 2. Ù‚Ù… Ø¨Ù‚ÙŠØ§Ø³ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const menuHeight = contextMenu.offsetHeight;
                const menuWidth = contextMenu.offsetWidth;

                // 3. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø± (Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø©)
                const clickY = event.pageY;
                const clickX = event.pageX;

                // 4. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø´Ø§Ø´Ø© (Viewport)
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // 5. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± (Scroll)
                const scrollY = window.scrollY;
                const scrollX = window.scrollX;

                // 6. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (Top)
                let finalTop = clickY;
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø³ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø³ÙŠØªØ¬Ø§ÙˆØ² Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©
                if (clickY + menuHeight > scrollY + viewportHeight) {
                    finalTop = clickY - menuHeight; // Ø§Ø¹Ø±Ø¶Ù‡Ø§ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø´Ø±
                }
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ù„Ø§ ØªØ®Ø±Ø¬ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
                if (finalTop < scrollY) {
                    finalTop = scrollY; // Ø£Ù„ØµÙ‚Ù‡Ø§ Ø¨Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
                }


                // 7. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ (Left)
                let finalLeft = clickX;
                 // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠÙ…ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø³ÙŠØªØ¬Ø§ÙˆØ² ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø©
                if (clickX + menuWidth > scrollX + viewportWidth) {
                    finalLeft = clickX - menuWidth; // Ø§Ø¹Ø±Ø¶Ù‡Ø§ ÙŠØ³Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø±
                }
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ù„Ø§ ØªØ®Ø±Ø¬ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©
                if (finalLeft < scrollX) {
                    finalLeft = scrollX; 
                }

                // 8. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                contextMenu.style.top = `${finalTop}px`;
                contextMenu.style.left = `${finalLeft}px`;
                contextMenu.style.right = 'auto'; // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø³Ø§Ø¨Ù‚
                contextMenu.style.visibility = 'visible'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                
                // --- â¬†ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ â¬†ï¸ ---
            }
        }

        function exportSectionAsJSON(sectionIndex) {
            if (!bookData || !bookData.sections[sectionIndex]) {
                alert('Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            const section = bookData.sections[sectionIndex];
            const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
            
            const exportData = {
                section_name: section.section_name,
                sort: section.sort,
                chapters: section.Chapters.map(chapter => ({
                    title: chapter.title,
                    content: chapter.content
                }))
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sectionName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… "${sectionName}" ÙƒÙ…Ù„Ù JSON`);
        }

        function exportSectionAsTXT(sectionIndex) {
            if (!bookData || !bookData.sections[sectionIndex]) {
                alert('Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            const section = bookData.sections[sectionIndex];
            const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
            
            let txtContent = `${sectionName}\n`;
            txtContent += '='.repeat(sectionName.length) + '\n\n';
            
            section.Chapters.forEach((chapter, index) => {
                const title = getLocalizedTitle(chapter, currentLanguage || 'ar');
                const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                
                txtContent += `${index + 1}. ${title}\n`;
                txtContent += '-'.repeat(title.length + 3) + '\n';
                
                if (content) {
                    const processedContent = content.replace(/\[\[(\d+(?::\d+)?)\]\]/g, (match, range) => {
                        return st(match) || match;
                    });
                    
                    const markdownToText = processedContent
                        .replace(/\\n/g, '\n')  // ØªØ­ÙˆÙŠÙ„ \n Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©
                        .replace(/#{1,6}\s+/g, '')
                        .replace(/\*\*(.*?)\*\*/g, '$1')
                        .replace(/\*(.*?)\*/g, '$1')
                        .replace(/`(.*?)`/g, '$1')
                        .replace(/\[(.*?)\]\(.*?\)/g, '$1')
                        .replace(/^>\s+/gm, '')
                        .replace(/^[-*+]\s+/gm, 'â€¢ ')
                        .replace(/^\d+\.\s+/gm, (match, offset, string) => {
                            const lineStart = string.lastIndexOf('\n', offset) + 1;
                            const lineNum = string.substring(0, offset).split('\n').length;
                            return `${lineNum}. `;
                        });
                    
                    txtContent += markdownToText + '\n\n';
                } else {
                    txtContent += '[Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº]\n\n';
                }
            });
            
            const blob = new Blob([txtContent], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sectionName}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… "${sectionName}" ÙƒÙ…Ù„Ù Ù†ØµÙŠ`);
        }

        function printSection(sectionIndex) {
            if (!bookData || !bookData.sections[sectionIndex]) {
                alert('Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            const section = bookData.sections[sectionIndex];
            const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
            
            let printContent = `<html dir="rtl"><head><meta charset="UTF-8"><title>${sectionName}</title>`;
            printContent += `<style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.8; margin: 20px; color: #333; }
                h1 { color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px; margin-bottom: 30px; }
                h2 { color: #1e40af; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; margin-top: 30px; margin-bottom: 15px; }
                h3, h4, h5, h6 { color: #374151; margin-top: 20px; margin-bottom: 10px; }
                p { margin-bottom: 12px; text-align: justify; }
                blockquote { border-right: 4px solid #3b82f6; padding: 15px 20px; margin: 20px 0; background: #f8fafc; border-radius: 5px; }
                code { background: #f1f5f9; padding: 3px 6px; border-radius: 4px; font-family: 'Consolas', monospace; }
                pre { background: #f8fafc; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #e2e8f0; white-space: pre-wrap; }
                .chapter { margin-bottom: 50px; page-break-inside: avoid; }
                .chapter-title { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; color: #1e40af; }
                ul, ol { margin: 15px 0; padding-right: 20px; }
                li { margin-bottom: 5px; }
                strong { font-weight: bold; }
                em { font-style: italic; }
                @media print { 
                    body { margin: 0; font-size: 12pt; } 
                    .chapter { page-break-after: auto; } 
                    h1 { page-break-after: avoid; }
                    h2 { page-break-after: avoid; }
                }
            </style></head><body>`;
            
            printContent += `<h1>${sectionName}</h1>`;
            
            section.Chapters.forEach((chapter, index) => {
                const title = getLocalizedTitle(chapter, currentLanguage || 'ar');
                const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                
                printContent += `<div class="chapter">`;
                printContent += `<h2 class="chapter-title">${index + 1}. ${title}</h2>`;
                
                if (content) {
                    let processedContent = content.replace(/\[\[(\d+(?::\d+)?)\]\]/g, (match, range) => {
                        return st(match) || match;
                    });
                    
                    processedContent = processedContent
                        .replace(/\\n/g, '\n')  // ØªØ­ÙˆÙŠÙ„ \n Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©
                        .replace(/\r\n/g, '\n')
                        .replace(/\r/g, '\n')
                        .replace(/\n\s*\n\s*\n/g, '\n\n');
                    
                    try {
                        if (typeof marked !== 'undefined') {
                            processedContent = marked.parse(processedContent, { breaks: true });
                        } else {
                            processedContent = processedContent
                                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                .replace(/`(.*?)`/g, '<code>$1</code>')
                                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
                                .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
                                .replace(/^\* (.*$)/gm, '<li>$1</li>')
                                .replace(/^- (.*$)/gm, '<li>$1</li>')
                                .replace(/^\+ (.*$)/gm, '<li>$1</li>')
                                .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
                                .replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>')
                                .replace(/\n/g, '<br>\n')
                                .replace(/<br>\s*<\/blockquote>/g, '</blockquote>')
                                .replace(/<br>\s*<\/h[1-6]>/g, '')
                                .replace(/<br>\s*<h[1-6]>/g, '<h')
                                .replace(/<br>\s*<ul>/g, '<ul>')
                                .replace(/<\/ul>\s*<br>/g, '</ul>');
                            
                            processedContent = processedContent.split('\n').map(line => {
                                line = line.trim();
                                if (line && !line.startsWith('<') && !line.endsWith('>')) {
                                    return `<p>${line}</p>`;
                                }
                                return line;
                            }).join('\n');
                        }
                    } catch (e) {
                        processedContent = processedContent.replace(/\n/g, '<br>\n');
                    }
                    
                    printContent += processedContent;
                } else {
                    printContent += '<p><em>[Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº]</em></p>';
                }
                
                printContent += `</div>`;
            });
            
            printContent += `</body></html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }
		function printEntireBook() {
            if (!bookData) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØªØ§Ø¨ Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡');
                return;
            }

            const bookTitleTxt = getLocalizedBookName(bookData, currentLanguage || 'ar') || 'Ù…Ø­Ø±Ø± Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…';
            
            let printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨: ${bookTitleTxt}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.8; margin: 20px; color: #333; }
                        h1.book-title { 
                            font-size: 2.5em; 
                            color: #2563eb; 
                            border-bottom: 3px solid #2563eb; 
                            padding-bottom: 10px; 
                            margin-bottom: 30px; 
                            text-align: center; 
                            page-break-after: always; /* ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
                        }
                        .book-bio {
                            font-style: italic;
                            background: #f8fafc;
                            border-right: 5px solid #e2e8f0;
                            padding: 20px;
                            margin-bottom: 30px;
                            page-break-after: always; /* ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© */
                        }
                        h2.section-title { 
                            font-size: 2em;
                            color: #1e40af; 
                            border-bottom: 1px solid #cbd5e1; 
                            padding-bottom: 5px; 
                            margin-top: 40px; 
                            margin-bottom: 15px; 
                            page-break-before: always; /* ÙƒÙ„ Ù‚Ø³Ù… ÙŠØ¨Ø¯Ø£ ÙÙŠ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© */
                        }
                        h3.chapter-title { 
                            font-size: 1.5em; 
                            font-weight: bold; 
                            margin-bottom: 20px; 
                            color: #374151; 
                        }
                        .chapter { 
                            margin-bottom: 30px; 
                            page-break-inside: avoid; 
                        }
                        p { margin-bottom: 12px; text-align: justify; }
                        blockquote { border-right: 4px solid #3b82f6; padding: 15px 20px; margin: 20px 0; background: #f8fafc; border-radius: 5px; }
                        code { background: #f1f5f9; padding: 3px 6px; border-radius: 4px; font-family: 'Consolas', monospace; }
                        pre { background: #f8fafc; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #e2e8f0; white-space: pre-wrap; }
                        ul, ol { margin: 15px 0; padding-right: 20px; }
                        li { margin-bottom: 5px; }
                        
                        @media print { 
                            body { margin: 1in; font-size: 12pt; } 
                            h1.book-title, h2.section-title, .book-bio { page-break-after: always; }
                            h2.section-title { page-break-before: always; }
                            .chapter { page-break-inside: avoid; }
                            h3.chapter-title { page-break-after: avoid; }
                        }
                    </style>
                </head>
                <body>
            `;
            
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨
            printContent += `<h1 class="book-title">${bookTitleTxt}</h1>`;

            // Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„ÙƒØªØ§Ø¨ (Bio)
            if (bookData.bio) {
                const bioHtml = marked.parse(getFromLangArray(bookData.bio, currentLanguage || 'ar'), { breaks: true });
                printContent += `<div class="book-bio">${bioHtml}</div>`;
            }
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø±ØªØ¨Ø©
            const sortedSections = [...bookData.sections].sort((a, b) => (a.sort || 0) - (b.sort || 0));

            // Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„
            sortedSections.forEach((section, sIndex) => {
                const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
                printContent += `<h2 class="section-title">${sectionName}</h2>`;
                
                section.Chapters.forEach((chapter, cIndex) => {
                    const title = getLocalizedTitle(chapter, currentLanguage || 'ar');
                    const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                    
                    printContent += `<div class="chapter">`;
                    printContent += `<h3 class="chapter-title">${sIndex + 1}.${cIndex + 1} ${title}</h3>`;
                    
                    if (content) {
                        let processedContent = content.replace(/\[\[(\d+(?::\d+)?)\]\]/g, (match, range) => {
                            return st(match) || match;
                        });
                        
                        processedContent = processedContent
                            .replace(/\\n/g, '\n')
                            .replace(/\r\n/g, '\n')
                            .replace(/\r/g, '\n')
                            .replace(/\n\s*\n\s*\n/g, '\n\n');
                        
                        try {
                            if (typeof marked !== 'undefined') {
                                processedContent = marked.parse(processedContent, { breaks: true });
                            } else {
                                processedContent = processedContent.replace(/\n/g, '<br>\n');
                            }
                        } catch (e) {
                            processedContent = processedContent.replace(/\n/g, '<br>\n');
                        }
                        
                        printContent += processedContent;
                    } else {
                        printContent += '<p><em>[Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº]</em></p>';
                    }
                    
                    printContent += `</div>`;
                });
            });
            
            printContent += `</body></html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }

        function showSectionSortDialog() {
            if (!bookData || !bookData.sections.length) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§.');
                return;
            }

            const contentDiv = document.getElementById('section-sort-content');
            contentDiv.innerHTML = '';

            bookData.sections.forEach((section, index) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-sort-item';
                sectionDiv.draggable = true;
                sectionDiv.dataset.sectionIndex = index;
                
                sectionDiv.innerHTML = `
                    <div class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <input type="number" value="${index + 1}" min="1" max="${bookData.sections.length}" 
                           class="section-sort-input" data-section-index="${index}">
                    <input type="text" value="${getLocalizedSectionName(section, currentLanguage || 'ar')}" 
                           class="section-sort-name" data-section-index="${index}">
                `;

                sectionDiv.addEventListener('dragstart', handleSectionDragStart);
                sectionDiv.addEventListener('dragover', handleSectionDragOver);
                sectionDiv.addEventListener('drop', handleSectionDrop);
                sectionDiv.addEventListener('dragend', handleSectionDragEnd);

                contentDiv.appendChild(sectionDiv);
            });

            document.getElementById('section-sort-modal').classList.remove('hidden');
        }

        let draggedSectionElement = null;

        function handleSectionDragStart(e) {
            draggedSectionElement = e.target.closest('.section-sort-item');
            draggedSectionElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleSectionDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            document.querySelectorAll('.section-sort-item').forEach(item => {
                if (item !== draggedSectionElement) {
                    item.classList.remove('drag-over');
                }
            });
            
            const targetElement = e.target.closest('.section-sort-item');
            if (targetElement && targetElement !== draggedSectionElement) {
                targetElement.classList.add('drag-over');
            }
        }

        function handleSectionDrop(e) {
            e.preventDefault();
            
            const targetElement = e.target.closest('.section-sort-item');
            if (!targetElement || targetElement === draggedSectionElement) {
                return;
            }

            const draggedIndex = parseInt(draggedSectionElement.dataset.sectionIndex);
            const targetIndex = parseInt(targetElement.dataset.sectionIndex);

            const draggedSection = bookData.sections[draggedIndex];
            bookData.sections.splice(draggedIndex, 1);
            bookData.sections.splice(targetIndex, 0, draggedSection);

            showSectionSortDialog();
        }

        function handleSectionDragEnd(e) {
            e.target.closest('.section-sort-item').classList.remove('dragging');
            document.querySelectorAll('.section-sort-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedSectionElement = null;
        }

        function saveSectionSort() {
            const sortInputs = document.querySelectorAll('.section-sort-input');
            const nameInputs = document.querySelectorAll('.section-sort-name');
            const newSections = [];

            sortInputs.forEach((input, index) => {
                const sectionIndex = parseInt(input.dataset.sectionIndex);
                const newPosition = parseInt(input.value) - 1;
                const newName = nameInputs[index].value.trim();
                
                if (newName) {
                    const section = { ...bookData.sections[sectionIndex] };
                    setLocalizedSectionName(section, currentLanguage || 'ar', newName);
                    section.sort = newPosition;
                    newSections.push({ section, newPosition });
                }
            });

            newSections.sort((a, b) => a.newPosition - b.newPosition);
            bookData.sections = newSections.map(item => item.section);

            bookData.sections.forEach((section, index) => {
                section.sort = index;
            });

            document.getElementById('section-sort-modal').classList.add('hidden');
            renderApp();
            alert('ØªÙ… Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function addSection() {
            const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
            if (name) {
bookData.sections.push({ id: generateUniqueID(), section_name: [{ ar: name }], sort: bookData.sections.length, Chapters: [] });
                renderApp();
            }
        }

        function addChapter(sectionIndex) {
            const title = prompt("Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
            if (title) {
bookData.sections[sectionIndex].Chapters.push({ id: generateUniqueID(),
 title: [{ ar: title }] ,
  Is_Audit: false,      
  reviewLogs: []
 , content: [{type: 'paragraph', data: [{ ar: '' }] }] });
                renderApp();
            }
        }
function normalizeAuditDefaults(book) {
  if (!book || !Array.isArray(book.sections)) return;
  book.sections.forEach(sec => {
    (sec.Chapters || []).forEach(ch => {
      if (ch.is_audit != null && ch.Is_Audit == null) ch.Is_Audit = !!ch.is_audit, delete ch.is_audit;
      if (ch.Is_Audit == null) ch.Is_Audit = true;
      if (!Array.isArray(ch.reviewLogs)) ch.reviewLogs = [];
    });
  });
}

function ensureChangeLogs(ch){if(!Array.isArray(ch.changeLogs))ch.changeLogs=[]}
function addChangeLog(ch,entry){ensureChangeLogs(ch);ch.changeLogs.push(Object.assign({id:generateUniqueID(),at:new Date().toISOString()},entry))}
function ensureTrash(){if(!bookData.__trash){bookData.__trash={sections:[],chapters:[]}}}


       function deleteSection(sectionIndex){
  const sectionNameConfirm=getLocalizedSectionName(bookData.sections[sectionIndex],currentLanguage||'ar');
  if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… "${sectionNameConfirm}" ÙˆÙƒÙ„ ÙØµÙˆÙ„Ù‡ØŸ`))return;
  ensureTrash();
  const sec=bookData.sections[sectionIndex];
  bookData.__trash.sections.push({at:new Date().toISOString(),section:sec,index:sectionIndex});
  bookData.sections.splice(sectionIndex,1);
  if(activePath.section===sectionIndex){activePath={section:null,chapter:null}}
  renderApp();saveBookToIndexedDB&&saveBookToIndexedDB();
}
function deleteChapter(sectionIndex,chapterIndex){
  const chapterTitle=getLocalizedTitle(bookData.sections[sectionIndex].Chapters[chapterIndex],currentLanguage||'ar');
  if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØµÙ„ "${chapterTitle}"ØŸ`))return;
  ensureTrash();
  const ch=bookData.sections[sectionIndex].Chapters[chapterIndex];
  bookData.__trash.chapters.push({at:new Date().toISOString(),sectionIndex,chapterIndex,chapter:ch});
  bookData.sections[sectionIndex].Chapters.splice(chapterIndex,1);
  if(activePath.section==sectionIndex&&activePath.chapter==chapterIndex){activePath={section:null,chapter:null}}
  renderApp();saveBookToIndexedDB&&saveBookToIndexedDB();
}
function restoreFromTrash(kind,idx){
  ensureTrash();
  if(kind==='section'){
    const t=bookData.__trash.sections.splice(idx,1)[0];if(!t)return;
    const pos=Math.min(t.index,bookData.sections.length);
    bookData.sections.splice(pos,0,t.section);
  }else{
    const t=bookData.__trash.chapters.splice(idx,1)[0];if(!t)return;
    const s=bookData.sections[t.sectionIndex];if(!s)return;
    const pos=Math.min(t.chapterIndex,(s.Chapters||[]).length);
    s.Chapters.splice(pos,0,t.chapter);
  }
  renderApp();saveBookToIndexedDB&&saveBookToIndexedDB();
}
function deletePermanently(kind,idx){
  ensureTrash();
  if(kind==='section'){bookData.__trash.sections.splice(idx,1)}else{bookData.__trash.chapters.splice(idx,1)}
  saveBookToIndexedDB&&saveBookToIndexedDB();
}
function openTrash(){
  ensureTrash();
  let modal=document.getElementById('trash-modal');
  if(!modal){
    modal=document.createElement('div');
    modal.id='trash-modal';
    modal.className='fixed inset-0 z-50 flex items-center justify-center';
    modal.innerHTML='<div class="absolute inset-0 bg-black/50"></div><div class="relative bg-white text-black rounded p-4 max-w-3xl w-full"><h3 class="font-bold mb-3">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h3><div id="trash-list" class="space-y-2"></div><div class="mt-4 text-end"><button id="trash-close" class="btn">Ø¥ØºÙ„Ø§Ù‚</button></div></div>';
    document.body.appendChild(modal);
    modal.querySelector('#trash-close').onclick=()=>modal.classList.add('hidden');
  }
  const items=[];
  (bookData.__trash.sections||[]).forEach((t,i)=>items.push({kind:'section',i,name:getLocalizedSectionName(t.section,currentLanguage||'ar'),at:t.at}));
  (bookData.__trash.chapters||[]).forEach((t,i)=>items.push({kind:'chapter',i,name:getLocalizedTitle(t.chapter,currentLanguage||'ar'),at:t.at}));
  const list=modal.querySelector('#trash-list');
  list.innerHTML=items.map(it=>`<div class="flex items-center justify-between gap-2 border p-2 rounded"><div><div>${it.kind==='section'?'[Ù‚Ø³Ù…]':'[ÙØµÙ„]'} ${it.name}</div><div class="text-sm text-gray-500">${it.at}</div></div><div class="flex gap-2"><button data-restore="${it.kind}:${it.i}" class="btn">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button><button data-delete="${it.kind}:${it.i}" class="btn btn-danger">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></div></div>`).join('')||'<div class="text-gray-500">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙØ§Ø±ØºØ©</div>';
  list.onclick=e=>{const r=e.target.getAttribute('data-restore');const d=e.target.getAttribute('data-delete');if(r){const[k,x]=r.split(':');restoreFromTrash(k,parseInt(x));openTrash()}if(d){const[k,x]=d.split(':');deletePermanently(k,parseInt(x));openTrash()}}
  modal.classList.remove('hidden');
}


        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        let draggedElement = null;
        let draggedData = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            draggedData = {
                type: e.target.dataset.type,
                sectionIndex: parseInt(e.target.dataset.sectionIndex),
                chapterIndex: parseInt(e.target.dataset.chapterIndex)
            };
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø£ÙˆÙ„Ø§Ù‹
            document.querySelectorAll('.tree-item').forEach(item => {
                if (item !== draggedElement) {
                    item.classList.remove('drag-over');
                }
            });
            
            const targetElement = e.target.closest('.tree-item');
            if (targetElement && targetElement !== draggedElement && 
                (targetElement.dataset.type === 'chapter' || targetElement.dataset.type === 'section')) {
                targetElement.classList.add('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            const targetElement = e.target.closest('.tree-item');
            if (!targetElement || targetElement === draggedElement) {
                return;
            }
            
            const targetType = targetElement.dataset.type;
            
            if (draggedData.type === 'chapter' && targetType === 'chapter') {
                const targetData = {
                    sectionIndex: parseInt(targetElement.dataset.sectionIndex),
                    chapterIndex: parseInt(targetElement.dataset.chapterIndex)
                };
                moveChapter(draggedData, targetData);
            } else if (draggedData.type === 'chapter' && targetType === 'section') {
                moveChapterToSectionFromDrop(draggedElement, targetElement);
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙØ¦Ø§Øª
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('drag-over', 'dragging');
            });
            
            renderApp();
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedElement = null;
            draggedData = null;
        }

        function moveChapter(source, target) {
            if (!bookData || source.sectionIndex === target.sectionIndex && source.chapterIndex === target.chapterIndex) {
                return;
            }
            
            // Ø§Ø­ÙØ¸ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ù‚Ù„Ù‡
            const chapterToMove = bookData.sections[source.sectionIndex].Chapters[source.chapterIndex];
            
            // Ø§Ø­Ø°Ù Ø§Ù„ÙØµÙ„ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠ
            bookData.sections[source.sectionIndex].Chapters.splice(source.chapterIndex, 1);
            
            // Ø£Ø¶Ù Ø§Ù„ÙØµÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            let insertIndex = target.chapterIndex;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ù„ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ù… ÙˆÙƒØ§Ù† Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ù‡Ø¯ÙØŒ Ù‚Ù„Ù„ Ø§Ù„ÙÙ‡Ø±Ø³
            if (source.sectionIndex === target.sectionIndex && source.chapterIndex < target.chapterIndex) {
                insertIndex--;
            }
            
            bookData.sections[target.sectionIndex].Chapters.splice(insertIndex + 1, 0, chapterToMove);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø´Ø· Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            if (activePath.section === source.sectionIndex && activePath.chapter === source.chapterIndex) {
                activePath = {
                    section: target.sectionIndex,
                    chapter: insertIndex + 1
                };
            }
        }

        function moveChapterToPosition(draggedChapter, targetChapter) {
            const draggedSectionIndex = parseInt(draggedChapter.dataset.sectionIndex);
            const draggedChapterIndex = parseInt(draggedChapter.dataset.chapterIndex);
            const targetSectionIndex = parseInt(targetChapter.dataset.sectionIndex);
            const targetChapterIndex = parseInt(targetChapter.dataset.chapterIndex);
            
            const chapter = bookData.sections[draggedSectionIndex].Chapters.splice(draggedChapterIndex, 1)[0];
            bookData.sections[targetSectionIndex].Chapters.splice(targetChapterIndex, 0, chapter);
            
            renderApp();
        }

        function updateEditorControls() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const sectionSelect = document.getElementById('chapter-section-select');
            const sortInput = document.getElementById('chapter-sort-input');
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            sectionSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¨</option>';
            bookData.sections.forEach((section, index) => {
                if (index !== activePath.section) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = getLocalizedSectionName(section, currentLanguage || 'ar');
                    sectionSelect.appendChild(option);
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
            sortInput.value = activePath.chapter + 1;
        }
        function moveChapterFromControls() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const sectionSelect = document.getElementById('chapter-section-select');
            const targetSectionIndex = parseInt(sectionSelect.value);
            
            if (isNaN(targetSectionIndex) || targetSectionIndex === activePath.section) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ù…Ø®ØªÙ„Ù Ù„Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„ Ø¥Ù„ÙŠÙ‡.');
                return;
            }
            
            const chapterTitle = getLocalizedTitle(bookData.sections[activePath.section].Chapters[activePath.chapter], currentLanguage || 'ar');
            const targetSectionName = getLocalizedSectionName(bookData.sections[targetSectionIndex], currentLanguage || 'ar');
            
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„ "${chapterTitle}" Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… "${targetSectionName}"ØŸ`)) {
                const chapterToMove = bookData.sections[activePath.section].Chapters[activePath.chapter];
                
                bookData.sections[activePath.section].Chapters.splice(activePath.chapter, 1);
                
                bookData.sections[targetSectionIndex].Chapters.push(chapterToMove);
                
                activePath = {
                    section: targetSectionIndex,
                    chapter: bookData.sections[targetSectionIndex].Chapters.length - 1
                };
                
                renderApp();
                alert(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„ "${chapterTitle}" Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… "${targetSectionName}" Ø¨Ù†Ø¬Ø§Ø­!`);
            }
        }
        function updateChapterSort() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const sortInput = document.getElementById('chapter-sort-input');
            const newPosition = parseInt(sortInput.value) - 1;
            
            if (isNaN(newPosition) || newPosition < 0 || newPosition >= bookData.sections[activePath.section].Chapters.length) {
                alert('Ø±Ù‚Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ ØºÙŠØ± ØµØ­ÙŠØ­.');
                return;
            }
            
            if (newPosition === activePath.chapter) {
                alert('Ø§Ù„ÙØµÙ„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙØ¹Ù„.');
                return;
            }
            
            const currentSection = bookData.sections[activePath.section];
            const chapterToMove = currentSection.Chapters[activePath.chapter];
            
            // Ø§Ø­Ø°Ù Ø§Ù„ÙØµÙ„ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠ
            currentSection.Chapters.splice(activePath.chapter, 1);
            
            // Ø£Ø¯Ø±Ø¬ Ø§Ù„ÙØµÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            currentSection.Chapters.splice(newPosition, 0, chapterToMove);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø´Ø·
            activePath.chapter = newPosition;
            
            renderApp();
            alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØµÙ„ "${getLocalizedTitle(chapterToMove, currentLanguage || 'ar')}" Ø¨Ù†Ø¬Ø§Ø­!`);
        }

        function showMoveChapterDialog(sectionIndex, chapterIndex) {
            const chapterTitle = getLocalizedTitle(bookData.sections[sectionIndex].Chapters[chapterIndex], currentLanguage || 'ar');
            let options = '';
            
            bookData.sections.forEach((section, index) => {
                if (index !== sectionIndex) {
                    options += `<option value="${index}">${getLocalizedSectionName(section, currentLanguage || 'ar')}</option>`;
                }
            });
            
            if (options === '') {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø£Ø®Ø±Ù‰ Ù„Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„ Ø¥Ù„ÙŠÙ‡Ø§.');
                return;
            }
            
            const targetSectionIndex = prompt(`Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„ "${chapterTitle}" Ø¥Ù„ÙŠÙ‡:\n\n` + 
                bookData.sections.map((section, index) => 
                    index !== sectionIndex ? `${index}: ${getLocalizedSectionName(section, currentLanguage || 'ar')}` : ''
                ).filter(Boolean).join('\n') + 
                '\n\nØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ù…:');
            
            if (targetSectionIndex !== null && targetSectionIndex !== '') {
                const targetIndex = parseInt(targetSectionIndex);
                if (targetIndex >= 0 && targetIndex < bookData.sections.length && targetIndex !== sectionIndex) {
                    moveChapterToSection(sectionIndex, chapterIndex, targetIndex);
                } else {
                    alert('Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± ØµØ­ÙŠØ­.');
                }
            }
        }
        function moveChapterToSection(sourceSectionIndex, chapterIndex, targetSectionIndex) {
            const chapterToMove = bookData.sections[sourceSectionIndex].Chapters[chapterIndex];
            
            bookData.sections[sourceSectionIndex].Chapters.splice(chapterIndex, 1);
            
            bookData.sections[targetSectionIndex].Chapters.push(chapterToMove);
            
            if (activePath.section === sourceSectionIndex && activePath.chapter === chapterIndex) {
                activePath = {
                    section: targetSectionIndex,
                    chapter: bookData.sections[targetSectionIndex].Chapters.length - 1
                };
            }
            
            renderApp();
            alert(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ÙØµÙ„ "${getLocalizedTitle(chapterToMove, currentLanguage || 'ar')}" Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… "${getLocalizedSectionName(bookData.sections[targetSectionIndex], currentLanguage || 'ar')}" Ø¨Ù†Ø¬Ø§Ø­!`);
        }

        function moveChapterToSectionFromDrop(draggedChapter, targetSection) {
            const draggedSectionIndex = parseInt(draggedChapter.dataset.sectionIndex);
            const draggedChapterIndex = parseInt(draggedChapter.dataset.chapterIndex);
            const targetSectionIndex = parseInt(targetSection.dataset.sectionIndex);
            
            const chapter = bookData.sections[draggedSectionIndex].Chapters.splice(draggedChapterIndex, 1)[0];
            bookData.sections[targetSectionIndex].Chapters.push(chapter);
            
            renderApp();
        }

        function calculateStats() {
            if (!bookData) return null;
            let totalChapters = 0;
            let totalWords = 0;
            let totalChars = 0;

            const bioContent = bookData.bio || '';
            const bioStats = {
                words: getWordCount(bioContent),
                chars: getCharCount(bioContent)
            };
            totalWords += bioStats.words;
            totalChars += bioStats.chars;

            const sectionStats = bookData.sections.map(section => {
                let sectionWords = 0;
                let sectionChars = 0;
                let sectionLines = 0;
                section.Chapters.forEach(chapter => {
                    const chapterContent = (chapter.content || []).map(b => (typeof b.data === 'string' ? b.data : (b.data.csv || ''))).join('\n');
                    sectionWords += getWordCount(chapterContent);
                    sectionChars += getCharCount(chapterContent);
                    sectionLines += (chapterContent.match(/\n/g) || []).length + 1;
                });
                totalChapters += section.Chapters.length;
                totalWords += sectionWords;
                totalChars += sectionChars;
                return {
                    name: section.section_name,
                    chapters: section.Chapters.length,
                    words: sectionWords,
                    chars: sectionChars,
                    lines: sectionLines
                };
            });

            return {
                totalLines: allLines.length,
                totalSections: bookData.sections.length,
                totalChapters,
                totalWords,
                totalChars,
                bioStats,
                sectionStats
            };
        }

        function displayStats() {
            const stats = calculateStats();
            if (!stats) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙƒØªØ§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            
            const contentDiv = document.getElementById('stats-content');
            contentDiv.innerHTML = `
                <div class="mb-6 p-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg">
                    <h3 class="text-2xl font-bold mb-4 text-yellow-300">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h3>
                    <div class="mb-6 p-4 bg-gray-800 rounded-lg text-center">
                        <h2 class="text-3xl font-bold text-orange-400 mb-2">${getLocalizedBookName(bookData, currentLanguage || 'ar') || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</h2>
                        <p class="text-gray-400 text-sm">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø·Ø±</p>
                            <p class="text-3xl font-bold text-blue-400">${stats.totalLines}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</p>
                            <p class="text-3xl font-bold text-green-400">${stats.totalSections}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØµÙˆÙ„</p>
                            <p class="text-3xl font-bold text-purple-400">${stats.totalChapters}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</p>
                            <p class="text-3xl font-bold text-yellow-400">${stats.totalWords}</p>
                        </div>
                    </div>
                </div>
                <div class="mb-6 p-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg">
                     <h3 class="text-xl font-bold mb-3 text-yellow-300">Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„ÙƒØªØ§Ø¨</h3>
                     <div class="prose prose-invert max-w-none bg-gray-800 p-4 rounded-lg">${bookData.bio ? bookData.bio.replace(/\r\n/g, '\n').replace(/\n/g, '<br>') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø¯Ù…Ø© Ù„Ù„ÙƒØªØ§Ø¨'}</div>
                     <p class="text-sm text-gray-400 mt-3">(${stats.bioStats.words} ÙƒÙ„Ù…Ø©, ${stats.bioStats.chars} Ø­Ø±Ù)</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4 text-yellow-300">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
                    <div class="space-y-4">
                        ${stats.sectionStats.map((s, i) => `
                            <div class="p-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg">
                                <h4 class="font-bold text-lg text-blue-300 mb-3">${i + 1}. ${getLocalizedSectionName(bookData.sections[i], currentLanguage || 'ar')}</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">Ø§Ù„ÙØµÙˆÙ„</span>
                                        <span class="block text-lg font-bold text-blue-400">${s.chapters}</span>
                                    </div>
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">Ø§Ù„Ø£Ø³Ø·Ø±</span>
                                        <span class="block text-lg font-bold text-green-400">${s.lines}</span>
                                    </div>
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">Ø§Ù„ÙƒÙ„Ù…Ø§Øª</span>
                                        <span class="block text-lg font-bold text-purple-400">${s.words}</span>
                                    </div>
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">Ø§Ù„Ø£Ø­Ø±Ù</span>
                                        <span class="block text-lg font-bold text-yellow-400">${s.chars}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('stats-modal').classList.remove('hidden');
        }

        function exportChaptersMap() {
            if (!bookData) {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØªØ§Ø¨ Ù„ØªØµØ¯ÙŠØ± Ù…Ø®Ø·Ø·Ù‡.");
                return;
            }
            let mapContent = `Ù…Ø®Ø·Ø· ÙƒØªØ§Ø¨: ${getLocalizedBookName(bookData, currentLanguage || 'ar')}\n\n`;
            bookData.sections.forEach((section, sIndex) => {
                mapContent += `${sIndex + 1}. ${getLocalizedSectionName(section, currentLanguage || 'ar')}\n`;
                section.Chapters.forEach((chapter, cIndex) => {
                    mapContent += `    ${sIndex + 1}.${cIndex + 1} ${getLocalizedTitle(chapter, currentLanguage || 'ar')}\n`;
                });
                mapContent += '\n';
            });

            const blob = new Blob([mapContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const bookName = (getLocalizedBookName(bookData, currentLanguage || 'ar') || 'book').replace(/[\\\/:*?"<>|]/g, '_');
            a.href = url;
            a.download = `Ù…Ø®Ø·Ø·_${bookName}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function openAdvancedSearch() {
            document.getElementById('advanced-search-modal').classList.remove('hidden');
            document.getElementById('search-input').focus();
        }

        function closeAdvancedSearch() {
            document.getElementById('advanced-search-modal').classList.add('hidden');
            document.getElementById('search-results').innerHTML = '<p class="text-gray-400 text-center">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø¨Ø¯Ø¡</p>';
        }

        function normalizeText(v) {
            if (v == null) return '';
            if (Array.isArray(v)) return v.map(normalizeText).join(' ');
            if (typeof v === 'object') {
                if (Object.prototype.hasOwnProperty.call(v, 'text')) return String(v.text || '');
                if (Object.prototype.hasOwnProperty.call(v, 'content')) return String(v.content || '');
                if (Object.prototype.hasOwnProperty.call(v, 'title') && typeof v.title !== 'object') return String(v.title || '');
                try { return JSON.stringify(v); } catch (e) { return String(v); }
            }
            return String(v);
        }
        function performAdvancedSearch() {
            const rawInput = document.getElementById('search-input').value;
            const searchTitles = document.getElementById('search-titles').checked;
            const searchContent = document.getElementById('search-content').checked;
            const caseSensitive = document.getElementById('case-sensitive').checked;
            const searchTerm = normalizeText(rawInput).trim();
            if (!searchTerm || !bookData) {
                document.getElementById('search-results').innerHTML = '<p class="text-gray-400 text-center">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«</p>';
                return;
            }
            const results = [];
            const searchTermProcessed = caseSensitive ? searchTerm : searchTerm.toLowerCase();
            bookData.sections.forEach((section, sectionIndex) => {
                section.Chapters.forEach((chapter, chapterIndex) => {
                    const rawTitle = normalizeText(getLocalizedTitle(chapter, currentLanguage || 'ar'));
                    const titleToSearch = caseSensitive ? rawTitle : rawTitle.toLowerCase();
                    if (searchTitles && titleToSearch.includes(searchTermProcessed)) {
                        results.push({
                            type: 'title',
                            sectionIndex,
                            chapterIndex,
                            sectionName: getLocalizedSectionName(section, currentLanguage || 'ar'),
                            chapterTitle: rawTitle,
                            match: rawTitle
                        });
                    }
                    if (searchContent && chapter.content) {
                        chapter.content.forEach((block, blockIndex) => {
                            let contentToSearch = '';
                            if (block.type === 'paragraph') {
                                contentToSearch = normalizeText(block.data);
                            } else if (block.type === 'table') {
                                const t = normalizeText(block.data && block.data.title);
                                const csv = block.data && block.data.csv;
                                let csvText = '';
                                if (Array.isArray(csv)) {
                                    if (csv.length > 0 && Array.isArray(csv[0])) {
                                        csvText = csv.map(row => row.map(normalizeText).join(' ')).join(' ');
                                    } else {
                                        csvText = csv.map(normalizeText).join(' ');
                                    }
                                } else {
                                    csvText = normalizeText(csv);
                                }
                                contentToSearch = t + ' ' + csvText;
                            } else if (block.type === 'image') {
                                const t = normalizeText(block.data && block.data.title);
                                const c = normalizeText(block.data && block.data.caption);
                                contentToSearch = t + ' ' + c;
                            } else {
                                contentToSearch = normalizeText(block.data);
                            }
                            const baseContent = normalizeText(contentToSearch);
                            const processedContent = caseSensitive ? baseContent : baseContent.toLowerCase();
                            if (processedContent.includes(searchTermProcessed)) {
                                const matchIndex = processedContent.indexOf(searchTermProcessed);
                                const start = Math.max(0, matchIndex - 50);
                                const end = Math.min(baseContent.length, matchIndex + searchTermProcessed.length + 50);
                                const preview = baseContent.substring(start, end);
                                results.push({
                                    type: 'content',
                                    sectionIndex,
                                    chapterIndex,
                                    blockIndex,
                                    sectionName: getLocalizedSectionName(section, currentLanguage || 'ar'),
                                    chapterTitle: getLocalizedTitle(chapter, currentLanguage || 'ar'),
                                    match: preview,
                                    blockType: block.type
                                });
                            }
                        });
                    }
                });
            });
            displaySearchResults(results, searchTermProcessed);
        }
        
        function highlightText(text, searchTerm, caseSensitive) {
            if (!searchTerm) return text;
            
            const flags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, flags);
            return text.replace(regex, '<mark class="bg-yellow-300 text-black px-1 rounded">$1</mark>');
        }
        
        function getContentPreview(content, searchTerm, caseSensitive, contextLength = 100) {
            const contentSafe = normalizeText(content);
            const searchTermSafe = normalizeText(searchTerm);
            const searchTermProcessed = caseSensitive ? searchTermSafe : searchTermSafe.toLowerCase();
            const contentProcessed = caseSensitive ? contentSafe : contentSafe.toLowerCase();
            const index = contentProcessed.indexOf(searchTermProcessed);
            if (index === -1) return { text: contentSafe.substring(0, contextLength) + '...', highlight: contentSafe.substring(0, contextLength) + '...' };
            const start = Math.max(0, index - contextLength / 2);
            const end = Math.min(contentSafe.length, index + searchTermSafe.length + contextLength / 2);
            let preview = contentSafe.substring(start, end);
            if (start > 0) preview = '...' + preview;
            if (end < contentSafe.length) preview = preview + '...';
            return {
                text: preview,
                highlight: highlightText(preview, searchTermSafe, caseSensitive)
            };
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function displaySearchResults(results, searchTerm) {
            const resultsContainer = document.getElementById('search-results');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬</p>';
                return;
            }
            
            let html = `<div class="mb-4"><span class="text-green-400 font-bold">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${results.length} Ù†ØªÙŠØ¬Ø©</span></div>`;
            
            results.forEach((result, index) => {
                const highlightedMatch = result.match.replace(
                    new RegExp(searchTerm, 'gi'),
                    `<mark class="bg-yellow-400 text-black">$&</mark>`
                );
                
                html += `
                    <div class="bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors" onclick="goToSearchResult(${result.sectionIndex}, ${result.chapterIndex})">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-white font-semibold">${result.chapterTitle}</h4>
                            <span class="text-xs text-gray-400">${result.sectionName}</span>
                        </div>
                        <div class="text-sm text-gray-300">
                            <span class="text-xs text-blue-400">${result.type === 'title' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰'}</span>
                            <p class="mt-1">${highlightedMatch}</p>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function goToSearchResult(sectionIndex, chapterIndex) {
            activePath.section = sectionIndex;
            activePath.chapter = chapterIndex;
            closeAdvancedSearch();
            switchView('viewer');
            renderApp();
        }

        function makeContentEditable() {
            const viewerContent = document.getElementById('viewer-content');
            if (!viewerContent) return;
            
            viewerContent.querySelectorAll('.content-block-viewer').forEach((block, index) => {
                if (block.querySelector('p, h1, h2, h3, h4, h5, h6')) {
                    block.contentEditable = true;
                    block.classList.add('editable-content');
                    block.style.border = '1px dashed transparent';
                    block.style.padding = '8px';
                    block.style.borderRadius = '4px';
                    
                    block.addEventListener('focus', function() {
                        this.style.border = '1px dashed #3b82f6';
                        this.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    });
                    
                    block.addEventListener('blur', function() {
                        this.style.border = '1px dashed transparent';
                        this.style.backgroundColor = 'transparent';
                        saveEditableContent(index, this.innerHTML);
                    });
                    
                    block.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && e.ctrlKey) {
                            this.blur();
                        }
                    });
                }
            });
        }

        function saveEditableContent(blockIndex, newContent) {
    if (!bookData || activePath.section === null || activePath.chapter === null) return;
    const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
    if (!chapter.content) {
        chapter.content = [{ type: 'paragraph', data: [{ ar: '' }] }];
    }
    if (chapter.content[blockIndex]) {
        let v = '';
        if (markdownEditor && typeof markdownEditor.value === 'string') {
            v = markdownEditor.value;
        } else {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newContent;
            v = tempDiv.textContent || tempDiv.innerText || '';
        }
        const block = chapter.content[blockIndex];
        if (typeof block.data === 'string') {
            block.data = setInLangArray([], currentLanguage, v);
        } else {
            block.data = setInLangArray(block.data, currentLanguage, v);
        }
        block.text = v;
        saveBookToIndexedDB();
    }
}


        let dbName = 'BookEditorDB';
        let dbVersion = 1;
        let db = null;
        let autoSaveInterval = null;
        let lastSavedBook = null;
function clearAllBooksFromIndexedDB(cb){
    if(!db){ if(cb) cb(); return; }
    const tx = db.transaction(['books'], 'readwrite');
    const store = tx.objectStore('books');
    store.clear();
    tx.oncomplete = function(){ if(cb) cb(); };
    tx.onerror = function(){ if(cb) cb(); };
}

        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('books')) {
                        const store = db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('lastModified', 'lastModified', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

            function saveBookToIndexedDB() {
            if (!db || !bookData) return;

            ensureBookSchema(bookData);

            const transaction = db.transaction(['books'], 'readwrite');
            const store = transaction.objectStore('books');

            const bookToSave = {
                id: currentBookId || (lastSavedBook && lastSavedBook.id) || undefined,
                name: bookData.name || 'ÙƒØªØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
                sections: bookData.sections || [],
                bio: bookData.bio || '',
                alias: bookData.alias || '',
                icon: bookData.icon || 'ğŸ“˜',
                color: bookData.color || '#2563eb',
                subjectId: bookData.subjectId || slugify(getLocalizedBookName(bookData, 'en') || getLocalizedBookName(bookData, 'ar') || ''),
                cover: bookData.cover || '',
                lastModified: new Date().toISOString()
            };

            if (bookToSave.id) {
                const request = store.put(bookToSave);
                request.onsuccess = () => {
                    currentBookId = bookToSave.id;
                    lastSavedBook = { ...bookToSave };
                    populateBookSwitcher(currentBookId);
                };
                request.onerror = (e) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØªØ§Ø¨:', e);
                };
            } else {
                const request = store.add(bookToSave);
                request.onsuccess = () => {
                    const newId = request.result;
                    currentBookId = newId;
                    lastSavedBook = { ...bookToSave, id: newId };
                    populateBookSwitcher(currentBookId);
                };
                request.onerror = (e) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒØªØ§Ø¨:', e);
                };
            }
        }
        function loadLastBookFromIndexedDB() {
            if (!db) return;

            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const index = store.index('lastModified');

            const request = index.openCursor(null, 'prev');
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const savedBook = cursor.value;
                    currentBookId = savedBook.id;
                    bookData = { ...savedBook };
                    ensureBookSchema(bookData);
                    lastSavedBook = { ...savedBook };
                    normalizeAuditDefaults(bookData);
                    populateBookSwitcher(currentBookId);
                    renderApp();
                } else {
                    currentBookId = null;
                    bookData = {
                        name: [{ ar: 'ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯' }],
                        sections: [],
                        bio: [{ ar: '' }],
                        icon: 'ğŸ“˜',
                        color: '#2563eb'
                    };
                    ensureBookSchema(bookData);
                    renderApp();
                    populateBookSwitcher(currentBookId);
                }
            };
        }

        function loadBookById(bookId) {
            if (!db || bookId == null) return;
            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.get(Number(bookId));
            request.onsuccess = (event) => {
                const savedBook = event.target.result;
                if (savedBook) {
                    currentBookId = savedBook.id;
                    bookData = { ...savedBook };
                    ensureBookSchema(bookData);
                    lastSavedBook = { ...savedBook };
                    normalizeAuditDefaults(bookData);
                    renderApp();
                    populateBookSwitcher(currentBookId);
                }
            };
        }

        function populateBookSwitcher(selectedId) {
            const switcher = document.getElementById('book-switcher');
            if (!switcher) return;
            if (!db) {
                switcher.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>';
                switcher.disabled = true;
                return;
            }

            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.getAll();
            request.onsuccess = (event) => {
                const books = event.target.result || [];
                bookLibrary = books;
                switcher.innerHTML = '';
                if (books.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø­ÙÙˆØ¸Ø©';
                    switcher.appendChild(option);
                    switcher.disabled = true;
                    return;
                }

                switcher.disabled = false;
                books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = getFromLangArray(book.name, currentLanguage) || getFromLangArray(book.name, 'ar') || `ÙƒØªØ§Ø¨ ${book.id}`;
                    if (book.id === selectedId) option.selected = true;
                    switcher.appendChild(option);
                });

                if (selectedId == null && currentBookId != null) {
                    switcher.value = currentBookId;
                }
                populateBookLibraryList();
            };
        }

        function toggleBookLibrary(show = true) {
            const modal = document.getElementById('book-library-modal');
            if (!modal) return;
            if (!show) {
                modal.classList.add('hidden');
                return;
            }
            populateBookLibraryList();
            modal.classList.remove('hidden');
        }

        function populateBookLibraryList() {
            const list = document.getElementById('book-library-list');
            if (!list) return;
            list.innerHTML = '';
            if (!bookLibrary || bookLibrary.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-300">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            bookLibrary
                .slice()
                .sort((a, b) => new Date(b.lastModified || 0) - new Date(a.lastModified || 0))
                .forEach(book => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-700 rounded-lg flex flex-col md:flex-row md:items-center md:justify-between gap-3';

                    const info = document.createElement('div');
                    info.className = 'text-sm text-gray-200';
                    const title = getFromLangArray(book.name, currentLanguage || 'ar') || `ÙƒØªØ§Ø¨ ${book.id}`;
                    const subjectKey = book.subjectId || book.alias || '';
                    info.innerHTML = `<div class="font-semibold">${title}</div><div class="text-xs text-gray-400">${subjectKey}</div>`;

                    const actions = document.createElement('div');
                    actions.className = 'flex flex-wrap gap-2';

                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'btn btn-secondary text-sm';
                    loadBtn.textContent = 'ØªØ­Ù…ÙŠÙ„';
                    loadBtn.onclick = () => {
                        toggleBookLibrary(false);
                        loadBookById(book.id);
                    };

                    const exportBtn = document.createElement('button');
                    exportBtn.className = 'btn btn-info text-sm';
                    exportBtn.textContent = 'ØªØµØ¯ÙŠØ± ÙÙ‚Ø·';
                    exportBtn.onclick = () => {
                        const subjectData = {};
                        const clone = JSON.parse(JSON.stringify(book));
                        ensureBookSchema(clone);
                        const subjectId = clone.subjectId || slugify(getFromLangArray(clone.name, 'en') || getFromLangArray(clone.name, 'ar') || `subject-${clone.id || generateUniqueID()}`);
                        subjectData[subjectId || generateUniqueID()] = convertBookToSubject(clone);
                        const content = 'const SUBJECT_DATA = ' + JSON.stringify(subjectData, null, 4) + ';';
                        downloadBundle(content, `${subjectId || 'subject'}.js`);
                    };

                    actions.appendChild(loadBtn);
                    actions.appendChild(exportBtn);

                    item.appendChild(info);
                    item.appendChild(actions);
                    list.appendChild(item);
                });
        }

        function createEmptyBook(overrides = {}) {
            const baseTitle = overrides.titleAr || 'ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯';
            const subjectId = overrides.subjectId || slugify(overrides.alias || baseTitle);
            return {
                name: setInLangArray([], 'ar', baseTitle),
                sections: [],
                bio: setInLangArray([], 'ar', overrides.bioAr || ''),
                alias: overrides.alias || subjectId,
                icon: overrides.icon || 'ğŸ“˜',
                color: overrides.color || '#2563eb',
                subjectId: subjectId || generateUniqueID(),
                cover: overrides.cover || '',
                lastModified: new Date().toISOString()
            };
        }

        function promptCreateNewBook() {
            if (!db) return;
            const titleAr = prompt('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©):', 'ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯');
            if (titleAr === null) return;
            const titleEn = prompt('Enter book title (English):', titleAr || 'New Book');
            if (titleEn === null) return;
            const subjectId = prompt('Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø§Ø¯Ø© (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª):', slugify(titleEn || titleAr || 'subject'));
            if (subjectId === null) return;

            bookData = createEmptyBook({ titleAr, alias: subjectId, subjectId });
            bookData.name = setInLangArray(bookData.name, 'en', titleEn || titleAr || 'New Book');
            ensureBookSchema(bookData);
            currentBookId = null;
            lastSavedBook = null;
            renderApp();
            saveBookToIndexedDB();
        }

        function cloneCurrentBook() {
            if (!db || !bookData) return;
            const alias = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±ÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø³Ø®Ø©:', `${bookData.subjectId || bookData.alias || 'book'}-copy`);
            if (alias === null || alias.trim() === '') return;
            const cloned = JSON.parse(JSON.stringify(bookData));
            cloned.alias = alias.trim();
            cloned.subjectId = slugify(alias.trim());
            cloned.lastModified = new Date().toISOString();
            delete cloned.id;
            ensureBookSchema(cloned);

            const transaction = db.transaction(['books'], 'readwrite');
            const store = transaction.objectStore('books');
            const request = store.add(cloned);
            request.onsuccess = () => {
                currentBookId = request.result;
                lastSavedBook = { ...cloned, id: currentBookId };
                bookData = { ...cloned, id: currentBookId };
                renderApp();
                populateBookSwitcher(currentBookId);
            };
        }

        function renameCurrentBook() {
            if (!bookData) return;
            const newTitleAr = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©):', getLocalizedBookName(bookData, 'ar') || '');
            if (newTitleAr === null) return;
            const newTitleEn = prompt('Book title (English):', getLocalizedBookName(bookData, 'en') || newTitleAr);
            if (newTitleEn === null) return;
            const newSubjectId = prompt('Ø§Ù„Ù…Ø¹Ø±Ù (Subject ID):', bookData.subjectId || bookData.alias || slugify(newTitleEn || newTitleAr));
            if (newSubjectId === null) return;

            bookData.name = setInLangArray(bookData.name, 'ar', newTitleAr.trim());
            bookData.name = setInLangArray(bookData.name, 'en', newTitleEn.trim());
            bookData.subjectId = slugify(newSubjectId.trim()) || bookData.subjectId;
            bookData.alias = bookData.subjectId;
            ensureBookSchema(bookData);
            renderApp();
            saveBookToIndexedDB();
        }

        function deleteCurrentBook() {
            if (!db || currentBookId == null) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØªØ§Ø¨ Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø­Ø°Ù.');
                return;
            }
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;

            const transaction = db.transaction(['books'], 'readwrite');
            const store = transaction.objectStore('books');
            const request = store.delete(currentBookId);
            request.onsuccess = () => {
                currentBookId = null;
                lastSavedBook = null;
                loadLastBookFromIndexedDB();
            };
        }

        function toggleSectionResources(show) {
            const modal = document.getElementById('section-resources-modal');
            if (!modal) return;
            if (!show) {
                modal.classList.add('hidden');
                return;
            }
            modal.classList.remove('hidden');
        }

        function toggleChapterResources(show) {
            const modal = document.getElementById('chapter-resources-modal');
            if (!modal) return;
            if (!show) {
                modal.classList.add('hidden');
                return;
            }
            modal.classList.remove('hidden');
        }
        function evaluateQuizScript(script, fallback = []) {
            if (script && script.trim()) {
                try {
                    const fn = new Function(`return (${script})`);
                    const result = fn();
                    if (Array.isArray(result)) {
                        return result;
                    }
                    throw new Error('Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„ÙŠØ³Øª Ù…ØµÙÙˆÙØ©');
                } catch (error) {
                    console.warn('Ø®Ø·Ø£ ÙÙŠ ØªÙØ³ÙŠØ± ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                    if (Array.isArray(fallback)) return fallback;
                    throw error;
                }
            }
            return Array.isArray(fallback) ? fallback : [];
        }
        function openSectionResources(sectionIndex) {
            if (!bookData || !bookData.sections || !bookData.sections[sectionIndex]) return;
            activeSectionResourcesIndex = sectionIndex;
            const section = bookData.sections[sectionIndex];
            ensureSectionSchema(section);

            const titleEl = document.getElementById('section-resources-title');
            if (titleEl) {
                titleEl.textContent = `Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø©: ${getLocalizedSectionName(section, currentLanguage || 'ar') || ''}`;
            }
            const langLabel = document.getElementById('section-brief-lang');
            if (langLabel) langLabel.textContent = (currentLanguage || 'ar').toUpperCase();

            const briefInput = document.getElementById('section-brief-input');
            if (briefInput) {
                briefInput.value = getFromLangArray(section.brief, currentLanguage || 'ar') || '';
                briefInput.oninput = (e) => {
                    section.brief = setInLangArray(section.brief, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };
            }

            const quizInput = document.getElementById('section-quiz-input');
            if (quizInput) {
                quizInput.value = section.resources.quizScript || '';
                quizInput.oninput = (e) => {
                    section.resources.quizScript = e.target.value;
                    saveBookToIndexedDB();
                };
            }
            const statusEl = document.getElementById('section-quiz-status');
            if (statusEl) statusEl.textContent = '';

            renderSectionResourcesUI();
            toggleSectionResources(true);
        }

        function renderSectionResourcesUI() {
            if (activeSectionResourcesIndex == null || !bookData) return;
            const section = bookData.sections[activeSectionResourcesIndex];
            if (!section) return;
            ensureSectionSchema(section);

            const pdfContainer = document.getElementById('section-pdfs-list');
            const videoContainer = document.getElementById('section-videos-list');

            const buildRow = (item, index, type, container, removeCallback) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-gray-700 p-3 rounded-lg space-y-2 md:space-y-0 md:flex md:items-center md:gap-3';

                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                titleInput.placeholder = type === 'pdf' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ù' : 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ';
                titleInput.value = getFromLangArray(item.title, currentLanguage || 'ar') || '';
                titleInput.oninput = (e) => {
                    item.title = setInLangArray(item.title, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };

                const urlInput = document.createElement('input');
                urlInput.type = 'text';
                urlInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                urlInput.placeholder = 'https://...';
                urlInput.value = item.url || '';
                urlInput.oninput = (e) => {
                    item.url = e.target.value.trim();
                    saveBookToIndexedDB();
                };

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger text-sm';
                removeBtn.textContent = 'Ø­Ø°Ù';
                removeBtn.onclick = () => {
                    removeCallback(index);
                    saveBookToIndexedDB();
                };

                wrapper.appendChild(titleInput);
                wrapper.appendChild(urlInput);
                wrapper.appendChild(removeBtn);
                container.appendChild(wrapper);
            };

            if (pdfContainer) {
                pdfContainer.innerHTML = '';
                if (!section.resources.pdfs.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª PDF.';
                    pdfContainer.appendChild(empty);
                } else {
                    section.resources.pdfs.forEach((pdf, index) => {
                        buildRow(pdf, index, 'pdf', pdfContainer, (idx) => {
                            section.resources.pdfs.splice(idx, 1);
                            renderSectionResourcesUI();
                        });
                    });
                }
            }

            if (videoContainer) {
                videoContainer.innerHTML = '';
                if (!section.resources.videos.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.';
                    videoContainer.appendChild(empty);
                } else {
                    section.resources.videos.forEach((video, index) => {
                        buildRow(video, index, 'video', videoContainer, (idx) => {
                            section.resources.videos.splice(idx, 1);
                            renderSectionResourcesUI();
                        });
                    });
                }
            }
        }

        function addSectionResource(type) {
            if (activeSectionResourcesIndex == null || !bookData) return;
            const section = bookData.sections[activeSectionResourcesIndex];
            if (!section) return;
            ensureSectionSchema(section);
            const target = type === 'pdf' ? section.resources.pdfs : section.resources.videos;
            target.push(ensureResourceItem({ title: setInLangArray([], currentLanguage || 'ar', ''), url: '' }));
            renderSectionResourcesUI();
            saveBookToIndexedDB();
        }

        function testSectionQuizScript() {
            if (activeSectionResourcesIndex == null || !bookData) return;
            const section = bookData.sections[activeSectionResourcesIndex];
            if (!section) return;
            const input = document.getElementById('section-quiz-input');
            const status = document.getElementById('section-quiz-status');
            if (!input || !status) return;
            try {
                const result = evaluateQuizScript(input.value, section.resources.quizPreview);
                status.textContent = `âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ ${result.length} Ø³Ø¤Ø§Ù„Ø§Ù‹`;
                status.className = 'text-green-400 text-sm';
            } catch (error) {
                status.textContent = `âŒ ${error.message}`;
                status.className = 'text-red-400 text-sm';
            }
        }
        function openChapterResources(sectionIndex, chapterIndex) {
            if (!bookData || !bookData.sections || !bookData.sections[sectionIndex]) return;
            const section = bookData.sections[sectionIndex];
            if (!section.Chapters || !section.Chapters[chapterIndex]) return;
            activeChapterResourcesPath = { section: sectionIndex, chapter: chapterIndex };
            const chapter = section.Chapters[chapterIndex];
            ensureChapterSchema(chapter);

            const titleEl = document.getElementById('chapter-resources-title');
            if (titleEl) {
                titleEl.textContent = `Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¯Ø±Ø³: ${getLocalizedTitle(chapter, currentLanguage || 'ar') || ''}`;
            }
            const langLabel = document.getElementById('chapter-brief-lang');
            if (langLabel) langLabel.textContent = (currentLanguage || 'ar').toUpperCase();

            const briefInput = document.getElementById('chapter-brief-input');
            if (briefInput) {
                briefInput.value = getFromLangArray(chapter.brief, currentLanguage || 'ar') || '';
                briefInput.oninput = (e) => {
                    chapter.brief = setInLangArray(chapter.brief, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };
            }

            const quizInput = document.getElementById('chapter-quiz-input');
            if (quizInput) {
                quizInput.value = chapter.resources.quizScript || '';
                quizInput.oninput = (e) => {
                    chapter.resources.quizScript = e.target.value;
                    saveBookToIndexedDB();
                };
            }
            const statusEl = document.getElementById('chapter-quiz-status');
            if (statusEl) statusEl.textContent = '';

            renderChapterResourcesUI();
            toggleChapterResources(true);
        }

        function openActiveChapterResources() {
            if (activePath.section == null || activePath.chapter == null) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            openChapterResources(activePath.section, activePath.chapter);
        }

        function renderChapterResourcesUI() {
            if (!bookData) return;
            const { section, chapter } = activeChapterResourcesPath || {};
            if (section == null || chapter == null) return;
            const sec = bookData.sections[section];
            if (!sec || !sec.Chapters || !sec.Chapters[chapter]) return;
            const ch = sec.Chapters[chapter];
            ensureChapterSchema(ch);

            const pdfContainer = document.getElementById('chapter-pdfs-list');
            const videoContainer = document.getElementById('chapter-videos-list');

            const buildRow = (item, index, type, container, removeCallback) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-gray-700 p-3 rounded-lg space-y-2 md:space-y-0 md:flex md:items-center md:gap-3';

                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                titleInput.placeholder = type === 'pdf' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ù' : 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ';
                titleInput.value = getFromLangArray(item.title, currentLanguage || 'ar') || '';
                titleInput.oninput = (e) => {
                    item.title = setInLangArray(item.title, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };

                const urlInput = document.createElement('input');
                urlInput.type = 'text';
                urlInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                urlInput.placeholder = 'https://...';
                urlInput.value = item.url || '';
                urlInput.oninput = (e) => {
                    item.url = e.target.value.trim();
                    saveBookToIndexedDB();
                };

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger text-sm';
                removeBtn.textContent = 'Ø­Ø°Ù';
                removeBtn.onclick = () => {
                    removeCallback(index);
                    saveBookToIndexedDB();
                };

                wrapper.appendChild(titleInput);
                wrapper.appendChild(urlInput);
                wrapper.appendChild(removeBtn);
                container.appendChild(wrapper);
            };

            if (pdfContainer) {
                pdfContainer.innerHTML = '';
                if (!ch.resources.pdfs.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª PDF.';
                    pdfContainer.appendChild(empty);
                } else {
                    ch.resources.pdfs.forEach((pdf, index) => {
                        buildRow(pdf, index, 'pdf', pdfContainer, (idx) => {
                            ch.resources.pdfs.splice(idx, 1);
                            renderChapterResourcesUI();
                        });
                    });
                }
            }

            if (videoContainer) {
                videoContainer.innerHTML = '';
                if (!ch.resources.videos.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.';
                    videoContainer.appendChild(empty);
                } else {
                    ch.resources.videos.forEach((video, index) => {
                        buildRow(video, index, 'video', videoContainer, (idx) => {
                            ch.resources.videos.splice(idx, 1);
                            renderChapterResourcesUI();
                        });
                    });
                }
            }
        }

        function addChapterResource(type) {
            const { section, chapter } = activeChapterResourcesPath || {};
            if (section == null || chapter == null || !bookData) return;
            const sec = bookData.sections[section];
            if (!sec || !sec.Chapters || !sec.Chapters[chapter]) return;
            const ch = sec.Chapters[chapter];
            ensureChapterSchema(ch);
            const target = type === 'pdf' ? ch.resources.pdfs : ch.resources.videos;
            target.push(ensureResourceItem({ title: setInLangArray([], currentLanguage || 'ar', ''), url: '' }));
            renderChapterResourcesUI();
            saveBookToIndexedDB();
        }

        function testChapterQuizScript() {
            const { section, chapter } = activeChapterResourcesPath || {};
            if (section == null || chapter == null || !bookData) return;
            const sec = bookData.sections[section];
            if (!sec || !sec.Chapters || !sec.Chapters[chapter]) return;
            const ch = sec.Chapters[chapter];
            const input = document.getElementById('chapter-quiz-input');
            const status = document.getElementById('chapter-quiz-status');
            if (!input || !status) return;
            try {
                const result = evaluateQuizScript(input.value, ch.resources.quizPreview);
                status.textContent = `âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ ${result.length} Ø³Ø¤Ø§Ù„Ø§Ù‹`;
                status.className = 'text-green-400 text-sm';
            } catch (error) {
                status.textContent = `âŒ ${error.message}`;
                status.className = 'text-red-400 text-sm';
            }
        }

        function extractTheoryContent(chapter) {
            if (!chapter || !Array.isArray(chapter.content) || !chapter.content.length) return {};
            const block = chapter.content[0];
            if (!block) return {};
            const data = block.data;
            if (typeof data === 'string') {
                return { ar: data };
            }
            if (Array.isArray(data)) {
                return langArrayToObject(data);
            }
            return {};
        }

        function convertResourcesForExport(resources) {
            if (!resources) return {};
            const output = {};
            if (Array.isArray(resources.pdfs) && resources.pdfs.length) {
                const pdfs = resources.pdfs
                    .filter(item => item && item.url)
                    .map(item => ({
                        id: item.id,
                        name: langArrayToObject(item.title || []),
                        url: item.url
                    }));
                if (pdfs.length) output.pdfs = pdfs;
            }
            if (Array.isArray(resources.videos) && resources.videos.length) {
                const videos = resources.videos
                    .filter(item => item && item.url)
                    .map(item => ({
                        id: item.id,
                        title: langArrayToObject(item.title || []),
                        url: item.url
                    }));
                if (videos.length) output.videos = videos;
            }
            const quiz = evaluateQuizScript(resources.quizScript || '', resources.quizPreview || resources.quiz || []);
            if (quiz.length) output.quiz = quiz;
            if (resources.quizScript && resources.quizScript.trim()) {
                output.quizScript = resources.quizScript.trim();
            }
            return output;
        }

        function convertBookToSubject(book) {
            ensureBookSchema(book);
            const subject = {
                icon: book.icon || 'ğŸ“˜',
                color: book.color || '#2563eb',
                title: langArrayToObject(book.name),
                description: langArrayToObject(book.bio),
                blocks: []
            };
            if (book.cover) subject.cover = book.cover;

            const sections = (book.sections || []).slice().sort((a, b) => (a.sort ?? 0) - (b.sort ?? 0));
            sections.forEach((section, index) => {
                ensureSectionSchema(section);
                const block = {
                    id: section.id || index + 1,
                    title: langArrayToObject(section.section_name),
                    brief: langArrayToObject(section.brief),
                    lessons: []
                };
                const sectionResources = convertResourcesForExport(section.resources);
                if (Object.keys(sectionResources).length) {
                    block.block_resources = sectionResources;
                }

                (section.Chapters || []).forEach((chapter, chapterIndex) => {
                    ensureChapterSchema(chapter);
                    const lessonResources = convertResourcesForExport(chapter.resources);
                    const lesson = {
                        id: chapter.id || `${block.id}-${chapterIndex + 1}`,
                        title: langArrayToObject(chapter.title),
                        brief: langArrayToObject(chapter.brief),
                        content: {
                            theory: extractTheoryContent(chapter),
                            exercises: Array.isArray(chapter.exercises) ? chapter.exercises : (chapter.content && chapter.content.exercises) || []
                        }
                    };
                    if (Object.keys(lessonResources).length) {
                        lesson.resources = lessonResources;
                    }
                    block.lessons.push(lesson);
                });

                subject.blocks.push(block);
            });

            return subject;
        }

        function downloadBundle(content, filename = 's-data.js') {
            const blob = new Blob([content], { type: 'application/javascript;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                URL.revokeObjectURL(link.href);
                link.remove();
            }, 500);
        }

        function exportAllBooksBundle() {
            if (!db) {
                alert('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯.');
                return;
            }
            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.getAll();
            request.onsuccess = (event) => {
                const books = event.target.result || [];
                if (!books.length) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ØªØµØ¯ÙŠØ±.');
                    return;
                }
                const payload = {};
                books.forEach(book => {
                    const clone = JSON.parse(JSON.stringify(book));
                    ensureBookSchema(clone);
                    const subjectId = clone.subjectId || slugify(getFromLangArray(clone.name, 'en') || getFromLangArray(clone.name, 'ar') || `subject-${clone.id || generateUniqueID()}`);
                    payload[subjectId || generateUniqueID()] = convertBookToSubject(clone);
                });
                const content = 'const SUBJECT_DATA = ' + JSON.stringify(payload, null, 4) + ';';
                downloadBundle(content, 's-data.js');
            };
        }
        
function destroyCurrentBook() {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) return;
    if (autoSaveInterval) { clearInterval(autoSaveInterval); autoSaveInterval = null; }
    bookData = null;
    lastSavedBook = null;
    activePath = { section: null, chapter: null };
    clearAllBooksFromIndexedDB(function(){ renderApp(); });
}


               function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            autoSaveInterval = setInterval(() => {
                if (bookData && bookData.sections) {
                    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    protectContentFromLoss();
                    if (currentView === 'editor') {
                        saveCurrentEditorContent();
                    }
                    saveBookToIndexedDB();
                }
            }, 5000);
        }

     
        function updateBioPreview() {
            const bioText = document.getElementById('book-bio-input-ar').value;
            const bioPreview = document.getElementById('bio-preview');
            
            if (bioText.trim()) {
                const processedBio = bioText.replace(/\r\n/g, '\n').replace(/\n/g, '<br>');
                bioPreview.innerHTML = processedBio;
            } else {
                bioPreview.innerHTML = '<p class="text-gray-500 italic">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø¯Ù…Ø©...</p>';
            }
        }

        

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
            
            localStorage.setItem('editorTheme', theme);
        }

        function increaseFontSize() {
            if (editorSettings.fontSize < 24) {
                editorSettings.fontSize += 2;
                updateFontSize();
                saveUserPreferences();
            }
        }

        function decreaseFontSize() {
            if (editorSettings.fontSize > 10) {
                editorSettings.fontSize -= 2;
                updateFontSize();
                saveUserPreferences();
            }
        }

        function updateFontSize() {
            document.documentElement.style.setProperty('--editor-font-size', editorSettings.fontSize + 'px');
            const fontSizeDisplay = document.getElementById('font-size-display');
            if (fontSizeDisplay) fontSizeDisplay.textContent = editorSettings.fontSize + 'px';
        }

        function changeFontFamily() {
            const fontSelect = document.getElementById('font-family-select');
            editorSettings.fontFamily = fontSelect.value;
            document.documentElement.style.setProperty('--editor-font', editorSettings.fontFamily);
            saveUserPreferences();
        }

        function changeEditorBg() {
            const bgColorPicker = document.getElementById('bg-color-picker');
            editorSettings.bgColor = bgColorPicker.value;
            document.documentElement.style.setProperty('--editor-bg', editorSettings.bgColor);
            saveUserPreferences();
        }

        function changeEditorText() {
            const textColorPicker = document.getElementById('text-color-picker');
            editorSettings.textColor = textColorPicker.value;
            document.documentElement.style.setProperty('--editor-text', editorSettings.textColor);
            saveUserPreferences();
        }

        function toggleLayout() {
            const splitView = document.getElementById('main-split-view');
            const layoutToggle = document.getElementById('layout-toggle');
            const isFullEditor = splitView.classList.contains('full-editor');
            
            if (isFullEditor) {
                splitView.classList.remove('full-editor');
                layoutToggle.innerHTML = '<i class="fas fa-columns"></i>';
                layoutToggle.title = 'ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„';
            } else {
                splitView.classList.add('full-editor');
                layoutToggle.innerHTML = '<i class="fas fa-expand"></i>';
                layoutToggle.title = 'ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø³Ù…';
            }
            saveUserPreferences();
        }



        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initIndexedDB();
                loadLastBookFromIndexedDB();
                migrateOldDataStructure();
                renderLanguageSelector();


                startAutoSave();
            } catch (error) {
                console.error('Failed to initialize IndexedDB:', error);
            }
            
            const controls = document.getElementById('controls-panel') || document.body;
            if (!document.getElementById('manual-save-btn')) {
                const btn = document.createElement('button');
                btn.id = 'manual-save-btn';
                btn.className = 'btn btn-success';
                btn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
                btn.addEventListener('click', () => {
                    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠ
                    protectContentFromLoss();
                    if (currentView === 'editor') saveCurrentEditorContent();
                    saveBookToIndexedDB();
                });
                controls.prepend(btn);
            }
			
			

const trashBtn=document.createElement('button');
trashBtn.id='open-trash-btn';trashBtn.className='btn';trashBtn.textContent='Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª';
trashBtn.onclick=openTrash;
controls.appendChild(trashBtn);

             document.getElementById('txt-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        allLines = e.target.result.split('\n');
                        initializeJsonFromTxt();
                      //  startAutoSave();
                    };
                    reader.readAsText(file, 'utf-8');
                }
            });
document.getElementById('approve-all-btn').addEventListener('click', approveAllChapters);
            document.getElementById('json-upload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        clearAllBooksFromIndexedDB(() => {
            try {
                const data = JSON.parse(ev.target.result);
                ensureUniqueIDs(data);
                normalizeAuditDefaults(data);
                bookData = data;
                lastSavedBook = null;
                activePath = { section: null, chapter: null };
                migrateOldDataStructure();
                renderApp();
            } catch (error) {
                alert('Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­');
            }
        });
    };
    reader.readAsText(file, 'utf-8');
});


            document.getElementById('search-btn').addEventListener('click', openAdvancedSearch);

            // Allow pressing Enter in advanced search input to trigger search
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performAdvancedSearch();
                }
            });

            // ... Ø¯Ø§Ø®Ù„ document.addEventListener('DOMContentLoaded', ...)
document.getElementById('save-json').addEventListener('click', () => {
    // ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚) ...
    const blob = new Blob([JSON.stringify(bookData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    // â¬‡ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    // a.download = `${bookData.name || 'ÙƒØªØ§Ø¨'}.json`;
    
    // â¬‡ï¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯
    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const bookName = bookData.alias ? bookData.alias.trim() : (getLocalizedBookName(bookData, currentLanguage || 'ar') || 'ÙƒØªØ§Ø¨');
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø© ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
    const safeAlias = bookName.replace(/[\\\/:*?"<>|]/g, '_');
    a.download = `${safeAlias}.json`;
    // â¬†ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

    a.click();
    URL.revokeObjectURL(url);
});

            document.getElementById('search-chapters').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const treeItems = treeContainer.querySelectorAll('[data-type="chapter"]');
                treeItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.style.display = 'block';
                        item.style.backgroundColor = searchTerm ? '#374151' : '';
                    } else {
                        item.style.display = searchTerm ? 'none' : 'block';
                        item.style.backgroundColor = '';
                    }
                });
            });

            settingsToggle.addEventListener('click', () => {
                controlsPanel.classList.toggle('controls-hidden');
                controlsPanel.classList.toggle('controls-visible');
            });
            
            document.addEventListener('click', (e) => {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.classList.add('hidden');
                }
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
            document.addEventListener('click', (e) => {
                const modal = document.getElementById('section-sort-modal');
                if (modal && e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                // Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
                if (!e.target.closest('.tree-item')) {
                    document.querySelectorAll('.tree-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                }
            });
            
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                // ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø³Ø­Ø¨
                document.querySelectorAll('.tree-item').forEach(item => {
                    item.classList.remove('drag-over', 'dragging');
                });
            });

            editorTitleInput.addEventListener('input', (e) => {
                if (activePath.section !== null && activePath.chapter !== null) {
                    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                    protectContentFromLoss();
                    const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
                    setLocalizedTitle(ch, currentLanguage || 'ar', e.target.value || '');
                    const inlineTitle = document.getElementById('editor-title-inline');
                    if (inlineTitle) inlineTitle.value = e.target.value || '';
                    renderTreeView();
                }
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ù…Ø¬
            document.addEventListener('input', (e) => {
                if (e.target.id === 'editor-title-inline') {
                    if (activePath.section !== null && activePath.chapter !== null) {
                        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ù…Ø¬
                        protectContentFromLoss();
                        const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
                        setLocalizedTitle(ch, currentLanguage || 'ar', e.target.value || '');
                        editorTitleInput.value = e.target.value || '';
                        renderTreeView();
                    }
                }
            });


viewTabBtn.addEventListener('click', () => switchView('viewer'));
            editTabBtn.addEventListener('click', () => switchView('editor'));
            showStatsBtn.addEventListener('click', displayStats);
            exportMapBtn.addEventListener('click', exportChaptersMap);

            document.getElementById('edit-book-info-btn').addEventListener('click', editBookInfo);
            document.getElementById('book-bio-input-ar').addEventListener('input', updateBioPreview);

            document.getElementById('new-book-btn')?.addEventListener('click', promptCreateNewBook);
            document.getElementById('clone-book-btn')?.addEventListener('click', cloneCurrentBook);
            document.getElementById('rename-book-btn')?.addEventListener('click', renameCurrentBook);
            document.getElementById('delete-book-btn')?.addEventListener('click', deleteCurrentBook);
            document.getElementById('export-bundle-btn')?.addEventListener('click', exportAllBooksBundle);

            const switcherEl = document.getElementById('book-switcher');
            if (switcherEl) {
                switcherEl.addEventListener('change', (e) => {
                    const id = parseInt(e.target.value, 10);
                    if (!isNaN(id)) {
                        loadBookById(id);
                    }
                });
                switcherEl.addEventListener('dblclick', () => toggleBookLibrary(true));
            }

            document.getElementById('library-create-btn')?.addEventListener('click', () => {
                toggleBookLibrary(false);
                promptCreateNewBook();
            });

            document.getElementById('chapter-section-select').addEventListener('change', saveUserPreferences);
            document.getElementById('chapter-sort-input').addEventListener('input', saveUserPreferences);
            loadUserPreferences();
            renderLanguageSelector();
            // Keyboard shortcut: Save (Ctrl/Cmd + S)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
                    e.preventDefault();
                    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
                    protectContentFromLoss();
                    if (currentView === 'editor') saveCurrentEditorContent();
                    saveBookToIndexedDB();
                }
            });
			const contextMenu = document.getElementById('context-menu');

            if (contextMenu) {
                
                document.addEventListener('click', function() {
                    contextMenu.classList.add('hidden'); // Ø£Ùˆ Ø£ÙŠ class ØªØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ù„Ø¥Ø®ÙØ§Ø¡
                });
            }
			document.getElementById('revlog-open-btn')?.addEventListener('click',openRevLogModal);
document.getElementById('revlog-close')?.addEventListener('click',closeRevLogModal);

            switchView('viewer');
        });

        let editorSettings = {
            fontSize: 14,
            fontFamily: 'Consolas',
            bgColor: '#1e293b',
            textColor: '#f8fafc'
        };

// Ensure viewer content is freshly rendered before printing
window.addEventListener('beforeprint', function(){
    if (typeof renderViewerContentOnly === 'function') renderViewerContentOnly();
	
            
           
});
function getActiveChapter() {
  if (activePath.section == null || activePath.chapter == null) return null;
  return bookData.sections[activePath.section].Chapters[activePath.chapter] || null;
}
        function approveAllChapters() {
    if (!bookData || !bookData.sections) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙƒØªØ§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨ØŸ`)) {
        return;
    }

    try {
        let chaptersAffected = 0;
        // 3. Iterate through sections and chapters to update the flag
        if (bookData.sections && Array.isArray(bookData.sections)) {
            bookData.sections.forEach(section => {
                if (section.Chapters && Array.isArray(section.Chapters)) {
                    section.Chapters.forEach(chapter => {
                        chapter.Is_Audit = true;
                        chaptersAffected++;
                    });
                }
            });
        }

        // 5. Save changes and refresh UI
        saveBookToIndexedDB(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        renderApp(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø´Ø§Ø±Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙØµÙ„ Ù†Ø´Ø·)
        
        alert(`ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!
Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§: ${chaptersAffected}`);

    } catch (error) {
        console.error("An error occurred while approving all chapters:", error.message);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„.");
    }
}
function renderAuditBadge() {
  const badge = document.getElementById('audit-badge');
  if (!badge) return;
  const ch = getActiveChapter();
  if (!ch) { badge.textContent = ''; badge.className = 'hidden'; return; }
  const ok = !!ch.Is_Audit;
  badge.className = 'mr-2 inline-flex items-center px-2 py-1 rounded text-xs font-bold ' + (ok ? 'bg-green-600 text-white' : 'bg-red-600 text-white');
  badge.textContent = ok ? 'Ù…Ø¹ØªÙ…Ø¯' : 'ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯';
}

function openAuditModal() {
  const ch = getActiveChapter();
  if (!ch) { alert('Ø§Ø®ØªØ± ÙØµÙ„Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  if (ch.Is_Audit == null) ch.Is_Audit = true;
  if (!Array.isArray(ch.reviewLogs)) ch.reviewLogs = [];

  document.getElementById('audit-status-select').value = String(!!ch.Is_Audit);
  document.getElementById('audit-reviewer-select').value = 'admin';
  document.getElementById('audit-notes').value = '';

  renderAuditLogs(ch);
  document.getElementById('audit-modal').classList.remove('hidden');
}

function closeAuditModal() {
  document.getElementById('audit-modal').classList.add('hidden');
}

function renderAuditLogs(ch) {
  const tbody = document.getElementById('audit-logs-tbody');
  if (!tbody) return;
  tbody.innerHTML = (ch.reviewLogs || []).slice().reverse().map(log => {
    const statusTxt = log.approved ? 'Ù…Ø¹ØªÙ…Ø¯' : 'ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯';
    return `
      <tr class="border-b border-gray-700">
        <td class="p-2">${statusTxt}</td>
        <td class="p-2">${log.reviewer || ''}</td>
        <td class="p-2">${(log.notes || '').replace(/</g,'&lt;')}</td>
        <td class="p-2">${new Date(log.at).toLocaleString()}</td>
      </tr>`;
  }).join('');
}

function preserveContentOnAudit() {
  if (currentView === 'editor' && markdownEditor && markdownEditor.value.trim() !== '') {
    saveCurrentEditorContent();
  }
}

function preserveContentOnAudit() {
    if (currentView === 'editor' && markdownEditor) {
        saveCurrentEditorContent();
    }
}

function addAuditLog() {
  // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
  preserveContentOnAudit();
  
  const ch = getActiveChapter();
  if (!ch) {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØµÙ„ Ù†Ø´Ø· Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ù‡');
    return;
  }

  const approved = document.getElementById('audit-status-select').value === 'true';
  const reviewer = document.getElementById('audit-reviewer-select').value || 'admin';
  const notes = document.getElementById('audit-notes').value.trim();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (!reviewer) {
    alert('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…ÙØ±Ø§Ø¬Ø¹');
    return;
  }

  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµÙÙˆÙØ© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
  if (!Array.isArray(ch.reviewLogs)) {
    ch.reviewLogs = [];
  }

  // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
  const newLog = {
    approved: approved,
    reviewer: reviewer,
    notes: notes,
    at: new Date().toISOString()
  };
  
  ch.reviewLogs.push(newLog);
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
  ch.Is_Audit = approved;

  // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (typeof saveBookToIndexedDB === 'function') {
    saveBookToIndexedDB();
  }
  
  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  renderAuditLogs(ch);
  renderAuditBadge();
  
  // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  document.getElementById('audit-notes').value = '';
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  const statusText = approved ? 'Ù…Ø¹ØªÙ…Ø¯' : 'ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯';
  alert(`ØªÙ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯: ${statusText}\nØ§Ù„Ù…ÙØ±Ø§Ø¬Ø¹: ${reviewer}\nØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: ${notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}`);
}

const AI_MODELS={gemini:[{v:"gemini-1.5-flash",n:"Gemini 1.5 Flash"},{v:"gemini-1.5-pro",n:"Gemini 1.5 Pro"}],deepseek:[{v:"deepseek-chat",n:"DeepSeek Chat"},{v:"deepseek-coder",n:"DeepSeek Coder"}]};
function ensureChapterAIBar(){
  const anchor=document.getElementById('audit-open-btn'); if(!anchor) return;
  let slot=document.getElementById('ai-tools-slot'); if(!slot){slot=document.createElement('div');slot.id='ai-tools-slot';anchor.insertAdjacentElement('afterend',slot)}
  if(slot.dataset.ready==='1') return;
  slot.innerHTML=
  '<div id="ai-bar" class="ai-bar">'+
    '<select id="ai-provider" class="select"><option value="gemini">Gemini</option><option value="deepseek">DeepSeek</option></select>'+
    '<select id="ai-model" class="select"></select>'+
    '<input id="ai-key" type="password" placeholder="API Key">'+
    '<select id="ai-target-lang" class="select"><option value="ar">ar</option><option value="en">en</option></select>'+
    '<div id="ai-kind" class="group">'+
      '<label><input type="checkbox" data-kind="format">ØªÙ†Ø³ÙŠÙ‚</label>'+
      '<label><input type="checkbox" data-kind="proof">ØªØ¯Ù‚ÙŠÙ‚</label>'+
      '<label><input type="checkbox" data-kind="translate">ØªØ±Ø¬Ù…Ø©</label>'+
      '<label><input type="checkbox" data-kind="custom">Prompt</label>'+
    '</div>'+
    '<textarea id="ai-custom-prompt" placeholder="Prompt"></textarea>'+
    '<label class="ml-2"><input type="checkbox" id="ai-log">Ø³Ø¬Ù„</label>'+
    '<button id="ai-run" class="btn btn-primary">ØªØ´ØºÙŠÙ„</button>'+
  '</div>';
  slot.dataset.ready='1';
  const prov=slot.querySelector('#ai-provider'), model=slot.querySelector('#ai-model'), key=slot.querySelector('#ai-key');
  const lang=slot.querySelector('#ai-target-lang'), run=slot.querySelector('#ai-run');
  const kindBox=slot.querySelector('#ai-kind'), custom=slot.querySelector('#ai-custom-prompt');
  function fillModels(){
    const p=prov.value; model.innerHTML=AI_MODELS[p].map(m=>'<option value="'+m.v+'">'+m.n+'</option>').join('');
    const saved=localStorage.getItem('ai.model.'+p); if(saved) model.value=saved;
  }
  prov.addEventListener('change',()=>{fillModels();localStorage.setItem('ai.provider',prov.value)});
  model.addEventListener('change',()=>localStorage.setItem('ai.model.'+prov.value,model.value));
  key.addEventListener('input',()=>localStorage.setItem('ai.key',key.value));
  lang.addEventListener('change',()=>localStorage.setItem('ai.lang',lang.value));
  prov.value=localStorage.getItem('ai.provider')||'gemini'; fillModels();
  key.value=localStorage.getItem('ai.key')||''; lang.value=localStorage.getItem('ai.lang')||'ar';
  kindBox.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change',e=>{
      if(e.target.checked){ kindBox.querySelectorAll('input').forEach(x=>{if(x!==e.target) x.checked=false}); }
      custom.style.display=(e.target.dataset.kind==='custom'&&e.target.checked)?'block':'none';
    });
  });
  slot.querySelector('#revlog-open-btn')?.addEventListener('click',openRevLogModal);
  document.getElementById('revlog-open-btn')?.addEventListener('click',openRevLogModal);
  run.addEventListener('click',async()=>{
    const ch=getActiveChapter(); if(!ch||!window.markdownEditor) return;
    const kind=(Array.from(kindBox.querySelectorAll('input')).find(x=>x.checked)?.dataset.kind)||'format';
    const before=markdownEditor.value||'';
    const prompt=(kind==='custom'?(custom.value+'\n\n---\n'+before):buildAIPrompt(kind,before,lang.value));
    const out=await callAI({provider:prov.value,model:model.value,apiKey:key.value,prompt});
    if(!out) return;
    markdownEditor.value=out;
    setLocalizedContent(ch,currentLanguage||'ar',out);
    if(typeof updateMarkdownPreview==='function') updateMarkdownPreview();
    if(slot.querySelector('#ai-log').checked){ pushRevLog({kind,provider:prov.value,model:model.value,note:(kind==='custom'?custom.value:'')},before,out); }
  });
}
function buildAIPrompt(kind,text,targetLang){
  if(kind==='format') return 'Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ Markdown Ù…Ù†Ø¸Ù… Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªØµØ§Ø± Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ©.\n\n---\n'+text;
  if(kind==='proof') return 'Ø¯Ù‚Ù‘Ù‚ Ù„ØºÙˆÙŠÙ‹Ø§ ÙˆØ¥Ù…Ù„Ø§Ø¦ÙŠÙ‹Ø§ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù†Ù‰ ÙˆØ£Ø¹Ø¯Ù‡ Ø¨ØµÙŠØºØ© Markdown ÙÙ‚Ø·.\n\n---\n'+text;
  if(kind==='translate') return 'ØªØ±Ø¬Ù… ØªØ±Ø¬Ù…Ø© Ù…ÙˆØ¶ÙˆØ¹ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ù„Ù‰ Ù„ØºØ© '+targetLang+' Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Markdown Ø¯ÙˆÙ† ØªÙ„Ø®ÙŠØµ.\n\n---\n'+text;
  return text;
}
async function callAI({provider,model,apiKey,prompt,endpoint}){
  if(provider==='gemini'){
    const url=(endpoint||('https://generativelanguage.googleapis.com/v1beta/models/'+encodeURIComponent(model)+':generateContent?key='+encodeURIComponent(apiKey)));
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}]})});
    const j=await r.json(); return (j.candidates&&j.candidates[0]&&j.candidates[0].content&&j.candidates[0].content.parts?j.candidates[0].content.parts.map(p=>p.text||'').join(''):'')||'';
  }
  if(provider==='deepseek'){
    const url=endpoint||'https://api.deepseek.com/chat/completions';
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify({model,temperature:0,messages:[{role:'user',content:prompt}]})});
    const j=await r.json(); return (j.choices&&j.choices[0]&&j.choices[0].message&&j.choices[0].message.content)||'';
  }
  return '';
}
function pushRevLog(meta,before,after){
  const ch=getActiveChapter(); if(!ch) return;
  if(!Array.isArray(ch.changeLogs)) ch.changeLogs=[];
  ch.changeLogs.push({id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())),lang:currentLanguage||'ar',kind:meta.kind,provider:meta.provider,model:meta.model,at:new Date().toISOString(),note:meta.note||'',beforeLen:(before||'').length,afterLen:(after||'').length});
  if(typeof saveBookToIndexedDB==='function') saveBookToIndexedDB();
}
function openRevLogModal(){
  const m=document.getElementById('revlog-modal'); if(!m) return;
  const list=document.getElementById('revlog-list');
  const ch=getActiveChapter(); const logs=(ch&&ch.changeLogs)||[];
  list.innerHTML=logs.slice().reverse().map(l=>'<div class="p-2 border border-gray-700 rounded text-sm text-gray-200"><div class="flex gap-2 flex-wrap"><span class="px-2 py-0.5 rounded bg-gray-700">'+l.kind+'</span><span class="px-2 py-0.5 rounded bg-gray-700">'+l.provider+'/'+l.model+'</span><span class="px-2 py-0.5 rounded bg-gray-700">'+l.lang+'</span><span class="px-2 py-0.5 rounded bg-gray-700">'+new Date(l.at).toLocaleString()+'</span></div>'+(l.note?'<div class="mt-1 text-gray-300">'+l.note.replace(/</g,'&lt;')+'</div>':'')+'</div>').join('')||'<div class="text-gray-400 text-center">Ù„Ø§ Ø³Ø¬Ù„Ø§Øª</div>';
  m.classList.remove('hidden');
}
function closeRevLogModal(){const m=document.getElementById('revlog-modal');if(m)m.classList.add('hidden')}


function findEmptyArContent() {
    if (!bookData || !bookData.sections) {
        console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØªØ§Ø¨');
        return [];
    }
    
    const emptyContent = [];
    
    bookData.sections.forEach((section, sectionIndex) => {
        if (section.Chapters && Array.isArray(section.Chapters)) {
            section.Chapters.forEach((chapter, chapterIndex) => {
                if (chapter.content && Array.isArray(chapter.content)) {
                    chapter.content.forEach((block, blockIndex) => {
                        if (block.data) {
                            if (typeof block.data === 'string' && block.data === '') {
                                emptyContent.push({
                                    sectionIndex,
                                    chapterIndex,
                                    blockIndex,
                                    sectionName: getLocalizedSectionName(section, 'ar'),
                                    chapterTitle: getLocalizedTitle(chapter, 'ar'),
                                    blockType: block.type,
                                    path: `Ø§Ù„Ù‚Ø³Ù… ${sectionIndex} - Ø§Ù„ÙØµÙ„ ${chapterIndex} - Ø§Ù„Ø¨Ù„ÙˆÙƒ ${blockIndex}`
                                });
                            } else if (Array.isArray(block.data)) {
                                const arData = block.data.find(item => item.ar !== undefined);
                                if (arData && arData.ar === '') {
                                    emptyContent.push({
                                        sectionIndex,
                                        chapterIndex,
                                        blockIndex,
                                        sectionName: getLocalizedSectionName(section, 'ar'),
                                        chapterTitle: getLocalizedTitle(chapter, 'ar'),
                                        blockType: block.type,
                                        path: `Ø§Ù„Ù‚Ø³Ù… ${sectionIndex} - Ø§Ù„ÙØµÙ„ ${chapterIndex} - Ø§Ù„Ø¨Ù„ÙˆÙƒ ${blockIndex}`
                                    });
                                }
                            }
                        }
                    });
                }
            });
        }
    });
    
    console.log('Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ§Ø±Øº ÙÙŠ data.ar:', emptyContent);
    console.table(emptyContent);
    return emptyContent;
}

function findEmptyArContentDetailed() {
    if (!bookData || !bookData.sections) {
        console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØªØ§Ø¨');
        return [];
    }
    
    const results = [];
    
    bookData.sections.forEach((section, sectionIndex) => {
        if (section.Chapters && Array.isArray(section.Chapters)) {
            section.Chapters.forEach((chapter, chapterIndex) => {
                if (chapter.content && Array.isArray(chapter.content)) {
                    chapter.content.forEach((block, blockIndex) => {
                        if (block.data) {
                            let isEmpty = false;
                            let dataValue = '';
                            
                            if (typeof block.data === 'string') {
                                isEmpty = block.data === '';
                                dataValue = block.data;
                            } else if (Array.isArray(block.data)) {
                                const arData = block.data.find(item => item.ar !== undefined);
                                if (arData) {
                                    isEmpty = arData.ar === '';
                                    dataValue = arData.ar;
                                }
                            }
                            
                            if (isEmpty) {
                                results.push({
                                    Ø§Ù„Ù‚Ø³Ù…: sectionIndex,
                                    Ø§Ù„ÙØµÙ„: chapterIndex,
                                    Ø§Ù„Ø¨Ù„ÙˆÙƒ: blockIndex,
                                    'Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…': getLocalizedSectionName(section, 'ar'),
                                    'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„': getLocalizedTitle(chapter, 'ar'),
                                    'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„ÙˆÙƒ': block.type,
                                    'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª': `"${dataValue}"`,
                                    'Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„': `sections[${sectionIndex}].Chapters[${chapterIndex}].content[${blockIndex}]`
                                });
                            }
                        }
                    });
                }
            });
        }
    });
    
    console.log(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${results.length} Ø¹Ù†ØµØ± Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº:`);
    console.table(results);
    return results;
}

function fillEmptyContent(chapters, options) {
    const opts = options || {};
    let hasChanges = false;
    let list = [];
    if (!chapters || !Array.isArray(chapters)) {
        if (!bookData || !bookData.sections) return [];
        bookData.sections.forEach(section => {
            if (section.Chapters) list.push(...section.Chapters);
        });
    } else {
        list = chapters;
    }
    const normalize = s => {
        if (!s || typeof s !== 'string') return '';
        return s.replace(/\s+/g, ' ').trim().toLowerCase();
    };
    let idMap = null;
    let titleMap = null;
    if (bookData && bookData.sections) {
        idMap = new Map();
        titleMap = new Map();
        bookData.sections.forEach(section => {
            if (section.Chapters) {
                section.Chapters.forEach(ch => {
                    idMap.set(ch.id, ch);
                    const t = ch.title && ch.title[0] ? (ch.title[0].ar || ch.title[0].en || '') : '';
                    const nt = normalize(t);
                    if (nt && !titleMap.has(nt)) titleMap.set(nt, ch);
                });
            }
        });
    }
    let willPersist = false;
    list.forEach(chapter => {
        let target = chapter;
        let matchedFromBook = false;
        if (idMap && chapter && chapter.id && idMap.has(chapter.id)) {
            target = idMap.get(chapter.id);
            matchedFromBook = true;
        } else if (titleMap) {
            const t = chapter && chapter.title && chapter.title[0] ? (chapter.title[0].ar || chapter.title[0].en || '') : '';
            const nt = normalize(t);
            if (nt && titleMap.has(nt)) {
                target = titleMap.get(nt);
                matchedFromBook = true;
            }
        }
        if (target && target.content) {
            target.content.forEach(contentItem => {
                if (contentItem && contentItem.data && contentItem.data[0]) {
                    const data = contentItem.data[0];
                    const arTitle = target.title && target.title[0] ? (target.title[0].ar || target.title[0].en || '') : '';
                    if (!data.ar || data.ar === '' || data.ar === '""') {
                        data.ar = `Ù…Ø­ØªÙˆÙ‰ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ÙØµÙ„: ${arTitle} - ID: ${target.id || ''}`;
                        hasChanges = true;
                    }
                    if (!data.en || data.en === '' || data.en === '""') {
                        data.en = `Content added for chapter: ${arTitle} - ID: ${target.id || ''}`;
                        hasChanges = true;
                    }
                }
            });
        }
        if (matchedFromBook && target !== chapter) {
            if (target && target.content) {
                chapter.content = target.content;
            }
            willPersist = true;
        }
    });
    if (hasChanges) {
        const persistAllowed = opts.persist !== false;
        const rerenderAllowed = opts.rerender !== false;
        if (persistAllowed && (willPersist || (!chapters || !Array.isArray(chapters)))) {
            if (typeof saveBookToIndexedDB === 'function') {
                saveBookToIndexedDB();
            }
        }
        if (rerenderAllowed) {
            if (typeof renderApp === 'function') {
                renderApp();
            }
        }
    }
    return list;
}

    </script>
    <script src="mishkah-core.js"></script>
    <script src="mishkah-static-exporter.js"></script>
    <script src="template/default/tpl-engine.js"></script>

  

    <script src="mishkah-templates.js"></script>
	<script>
const MishkahAI=(()=>{let settings={provider:'gemini',model:'gemini-1.5-pro',endpoint:'',apiKey:''};async function load(){try{if(!db)return{};const tx=db.transaction(['settings'],'readonly');const st=tx.objectStore('settings');const req=st.get('ai');return await new Promise(res=>{req.onsuccess=()=>res(req.result?req.result.value:{});req.onerror=()=>res({});});}catch(e){return{}}}async function save(v){if(!db)return;const tx=db.transaction(['settings'],'readwrite');const st=tx.objectStore('settings');st.put({key:'ai',value:v});settings=v;}function configure(v){settings={...settings,...v};return save(settings)}async function runTask(kind,{text,from='ar',to='ar',prompt=''}={}){const s=settings;if(!s.apiKey)throw new Error('no api key');const sys=kind==='format'?'Ø£Ø¹Ø¯ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Markdown Ù…Ù†Ø¸Ù… ÙˆÙ†Ø¸ÙŠÙ Ø¨Ù„Ø§ ØªÙ„Ø®ÙŠØµ ÙˆÙ„Ø§ Ø­Ø°Ù. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙƒØ§Ù…Ù„Ø§Ù‹.':kind==='proof'?'Ù†Ù‚Ù‘Ø­ Ø§Ù„Ù†Øµ Ù„ØºÙˆÙŠØ§Ù‹ ÙˆØ¥Ù…Ù„Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ£Ø³Ù„ÙˆØ¨ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø§Ù„ØªØ§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù†Ù‰ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ¹Ø¯Ù… Ø§Ù„Ø§Ø®ØªØµØ§Ø±.':kind==='translate'?`ØªØ±Ø¬Ù… Ø§Ù„Ù†Øµ ØªØ±Ø¬Ù…Ø© Ù…ÙˆØ¶ÙˆØ¹ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to} Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø­ Ø¥Ø¶Ø§ÙÙŠ.`:prompt||'Ù†ÙÙ‘Ø° Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø¨Ø¯Ù‚Ø©.';const user=text;if(s.provider==='gemini'){const url=s.endpoint||`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(s.model)}:generateContent?key=${encodeURIComponent(s.apiKey)}`;const body={contents:[{role:'user',parts:[{text:sys+'\n\n---\n\n'+user}]}]};const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const j=await r.json();const out=(j.candidates&&j.candidates[0]&&j.candidates[0].content&&j.candidates[0].content.parts&&j.candidates[0].content.parts[0]&&j.candidates[0].content.parts[0].text)||'';return out.trim()}else{const url=s.endpoint||'https://api.deepseek.com/v1/chat/completions';const body={model:s.model||'deepseek-chat',messages:[{role:'system',content:sys},{role:'user',content:user}],temperature:0};const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+s.apiKey},body:JSON.stringify(body)});const j=await r.json();const out=(j.choices&&j.choices[0]&&j.choices[0].message&&j.choices[0].message.content)||'';return out.trim()}}async function formatMarkdown(t){return runTask('format',{text:t})}async function proofread(t){return runTask('proof',{text:t})}async function translate(t,from,to){return runTask('translate',{text:t,from,to})}async function custom(t,prompt){return runTask('custom',{text:t,prompt})}return{configure,load,runTask,formatMarkdown,proofread,translate,custom};})();
</script>

    <script>
document.addEventListener('DOMContentLoaded', () => {
  MishkahTemplates.init({ basePath: 'template/default/' }).then(() => {
    MishkahTemplates.patchExporter();
  });

  document.getElementById('export-static-site-btn').addEventListener('click', async ()=>{
    if (!bookData) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØªØ§Ø¨'); return; }
    await MishkahStaticExporter.downloadAllDynamic(bookData, { defaultLang:'ar', archiveName:'site.tar.gz' });
  });

  document.getElementById('audit-open-btn').addEventListener('click', openAuditModal);
  document.getElementById('audit-close-btn').addEventListener('click', closeAuditModal);
  document.getElementById('audit-add-btn').addEventListener('click', addAuditLog);
});
    </script>
<script>
const MishkahOnePage=(()=>{"use strict";
const isArr=Array.isArray,isStr=v=>typeof v==="string",isObj=v=>v&&typeof v==="object";
const esc=v=>String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
const fromLang=(v,lang)=>{if(!v)return"";if(isStr(v))return v;if(isArr(v)){const o=v.find(x=>isObj(x)&&(x[lang]!=null||x.value!=null||x.name!=null))||v[0]||{};return o[lang]??o.value??o.name??""}return isObj(v)?(v[lang]??v.value??v.name??""):String(v)};
const jsonSafe=s=>JSON.stringify(s).replace(/</g,"\\u003C").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029").replace(/-->/g,"--\\>");
const scriptSafe=s=>String(s).replace(/<\/script/gi,"<\\/script"),styleSafe=s=>String(s).replace(/<\/style/gi,"<\\/sty"+"le>");
function cssTheme(userCss){
  if(isStr(userCss)&&userCss.trim()) return userCss;
  if(typeof window!="undefined"&&typeof window.css=="function"){try{return String(window.css()??"")}catch{}}
  return "\
:root{--bg:#0b0f19;--paper:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--br:#1f2937;--brand:#60a5fa;--w:1024px;--gap:16px}\
:root[data-theme=\"light\"]{--bg:#ffffff;--paper:#f6f7fb;--ink:#0b1220;--muted:#647089;--br:#e5e7eb;--brand:#2563eb}\
*{box-sizing:border-box}html,body{margin:0;padding:0}html{scroll-behavior:smooth}\
body{background:var(--bg);color:var(--ink);line-height:1.7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\"Noto Sans\",\"Noto Naskh Arabic\",Tahoma,Arial,sans-serif;overflow-x:hidden}\
a{color:var(--brand);text-decoration:none}a:hover{text-decoration:underline}\
.topbar{position:sticky;top:0;z-index:50;background:rgba(15,23,42,.7);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid #0003}\
:root[data-theme=\"light\"] .topbar{background:rgba(246,247,251,.85);border-bottom:1px solid #0001}\
.topbar .bar{max-width:var(--w);margin:auto;display:flex;gap:8px;align-items:center;padding:10px 16px}\
#toc-toggle,#theme-toggle,#lang-switch{border:1px solid var(--br);background:var(--paper);color:var(--ink)!important;border-radius:12px}\
#toc-toggle,#theme-toggle{padding:8px 10px}#toc-toggle{display:none}\
.topbar .brand{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}\
#global-search{flex:1 1 auto;min-width:120px;padding:9px 12px;border-radius:12px;border:1px solid var(--br);background:var(--paper);color:var(--ink)}\
#global-search::placeholder{color:color-mix(in oklab,var(--ink) 60%,transparent)}\
.wrapper{max-width:var(--w);margin:16px auto;display:grid;grid-template-columns:280px 1fr;gap:var(--gap);padding:0 16px}\
aside{background:var(--paper);border:1px solid var(--br);border-radius:14px;padding:10px;max-height:calc(100svh - 110px);overflow:auto}\
.reader{min-height:50vh}\
.card{background:var(--paper);border:1px solid var(--br);border-radius:16px;padding:16px;margin-bottom:14px}\
details.mk-sec{border:1px solid var(--br);border-radius:12px;margin:6px 0;background:var(--paper)}\
details.mk-sec>summary{cursor:pointer;list-style:none;padding:.8rem 1rem;font-weight:700}\
details.mk-sec[open]>summary{background:rgba(96,165,250,.08)}\
.mk-list{margin:0;padding:.2rem 1rem 1rem;display:grid;gap:.25rem}\
.mk-link{display:block;width:100%;text-align:start;border:1px dashed #293447;border-radius:.7rem;padding:.55rem .7rem;background:transparent;color:var(--ink)}\
.mk-link:hover{background:rgba(96,165,250,.08)}\
.muted{opacity:.72}.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--br);background:var(--paper);color:var(--ink)}\
.mk-article h1,.mk-article h2,.mk-article h3{margin:.2rem 0 .6rem}\
.mk-article p{margin:.55rem 0;line-height:1.95;overflow-wrap:anywhere}\
.mk-article img{max-width:100%;height:auto;display:block;border-radius:.6rem}\
.mk-article table{border-collapse:collapse;display:block;max-width:100%;overflow:auto}\
.mk-article td,.mk-article th{border:1px solid var(--br);padding:.5rem .6rem}\
.mk-code{display:block;background:color-mix(in oklab,var(--paper) 92%, black 8%);border:1px solid var(--br);border-radius:.6rem;padding:.7rem;overflow:auto}\
.mk-inline{padding:.05rem .35rem;border-radius:.35rem;background:color-mix(in oklab,var(--paper) 88%, black 12%);border:1px solid var(--br)}\
#toc-scrim{display:none}\
@media (max-width:980px){\
  .wrapper{grid-template-columns:1fr}\
  #toc-toggle{display:inline-flex}\
  aside{position:fixed;top:58px;bottom:0;right:0;width:min(86vw,360px);max-width:100%;z-index:60;transform:translateX(105%);transition:transform .25s ease;overflow:auto;border-radius:0 0 0 14px}\
  aside.open{transform:translateX(0)}\
  #toc-scrim{display:block;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:55;opacity:0;pointer-events:none;transition:opacity .2s ease}\
  #toc-scrim.show{opacity:1;pointer-events:auto}\
}";}

function runtime(){
  const out=[];
  out.push("(function(){'use strict'");
  out.push("var $=function(id){return document.getElementById(id)}");
  out.push("var el={title:$('book-title'),search:$('global-search'),lang:$('lang-switch'),theme:$('theme-toggle'),aside:$('toc'),main:$('reader'),scrim:$('toc-scrim'),tocToggle:$('toc-toggle')}");
  out.push("function isA(a){return Array.isArray(a)}function isS(s){return typeof s==='string'}function isO(o){return o&&typeof o==='object'}");
  out.push("function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;')}");
  out.push("function fromLang(v,lang){if(!v)return'';if(isS(v))return v;if(isA(v)){var o=v.find(function(x){return isO(x)&&(x[lang]!=null||x.value!=null||x.name!=null)})||v[0]||{};return o[lang]??o.value??o.name??''}if(isO(v))return v[lang]??v.value??v.name??'';return String(v)}");
  out.push("function mdInline(t){return String(t).replace(/!\\[([^\\]]*)\\]\\(([^)]+)\\)/g,function(_m,a,s){return '<img src=\"'+esc(s)+'\" alt=\"'+esc(a)+'\">'}).replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g,function(_m,txt,href){return '<a href=\"'+esc(href)+'\">'+esc(txt)+'</a>'}).replace(/`([^`]+)`/g,function(_m,c){return '<code class=\"mk-inline\">'+esc(c)+'</code>'}).replace(/\\*\\*([^*]+)\\*\\*/g,'<strong>$1</strong>').replace(/\\*([^*]+)\\*/g,'<em>$1</em>')}");
  out.push("function mdToHtml(src){if(!src)return'';var s=String(src).replace(/\\r\\n?/g,'\\n');s=s.replace(/```(\\w+)?\\n([\\s\\S]*?)```/g,function(_m,lang,code){return '\\n<pre class=\"mk-code\"><code data-lang=\"'+esc(lang||'')+'\">'+esc(code)+'</code></pre>\\n'});s=s.replace(/^(?:>\\s?.*(?:\\n>\\s?.*)*)/gm,function(block){var inner=block.replace(/^>\\s?/gm,'');return '<blockquote>'+mdInline(inner)+'</blockquote>'});for(var i=6;i>=1;i--){var re=new RegExp('^'+'#'.repeat(i)+'\\\\s+(.+)$','gm');s=s.replace(re,function(_,_t){return '<h'+i+'>'+mdInline(_t)+'</h'+i+'>'})}s=s.replace(/^\\s*[-*_]{3,}\\s*$/gm,'<hr/>');s=s.replace(/^(?:\\s*[-+*]\\s+.*(?:\\n\\s*[-+*]\\s+.*)*)/gm,function(blk){var items=blk.split('\\n').map(function(l){return l.replace(/^\\s*[-+*]\\s+/,'').trim()}).map(function(t){return '<li>'+mdInline(t)+'</li>'}).join('');return '<ul>'+items+'</ul>'});s=s.replace(/^(?:\\s*\\d+\\.\\s+.*(?:\\n\\s*\\d+\\.\\s+.*)*)/gm,function(blk){var items=blk.split('\\n').map(function(l){return l.replace(/^\\s*\\d+\\.\\s+/,'').trim()}).map(function(t){return '<li>'+mdInline(t)+'</li>'}).join('');return '<ol>'+items+'</ol>'});var blocks=s.split(/\\n{2,}/).map(function(b){b=b.trim();if(!b)return'';if(/^<(?:h\\d|ul|ol|pre|blockquote|hr)\\b/.test(b))return b;var inl=mdInline(b);return '<p>'+inl.replace(/\\n/g,'<br>')+'</p>'}).filter(Boolean);return blocks.join('\\n')}");
  out.push("function project(book,lang){return{name:fromLang(book&&book.name,lang),bio:fromLang(book&&book.bio,lang),sections:(book&&book.sections||[]).map(function(sec){return{id:sec.id||('s_'+Math.random().toString(36).slice(2,8)),title:fromLang(sec.section_name,lang),items:(sec.Chapters||[]).map(function(ch){return{id:ch.id||('t_'+Math.random().toString(36).slice(2,8)),title:fromLang(ch.title,lang),blocks:(ch.content||[]).map(function(x){if(x&&x.type==='paragraph')return{type:'p',text:fromLang(x.data,lang)};if(x&&x.type==='image')return{type:'img',src:fromLang(x.data,lang)||x.src};if(x&&x.type==='table')return{type:'table',rows:Array.isArray(x.rows)?x.rows:[]};return null}).filter(Boolean)}})}}).filter(function(s){return !!s.title})}}");
  out.push("function htmlOfChapter(ch){var out='';(ch.blocks||[]).forEach(function(b){if(b.type==='p'&&b.text)out+=mdToHtml(b.text);else if(b.type==='img'&&b.src)out+='<figure><img src=\"'+esc(b.src)+'\" alt=\"\"></figure>';else if(b.type==='table'&&Array.isArray(b.rows)){var rows=b.rows.map(function(r){return '<tr>'+r.map(function(c){return '<td>'+esc(c)+'</td>'}).join('')+'</tr>'}).join('');out+='<div style=\"overflow:auto\"><table>'+rows+'</table></div>'}});return out}");
  out.push("function buildTOC(book,open){var aside=document.getElementById('toc');aside.innerHTML='';if(book.bio){var bio=document.createElement('div');bio.className='pill muted';bio.textContent=book.bio;aside.appendChild(bio)}(book.sections||[]).forEach(function(sec){var d=document.createElement('details');d.className='mk-sec';if(open&&open[sec.id])d.setAttribute('open','');var s=document.createElement('summary');s.textContent=sec.title||'';d.appendChild(s);var ul=document.createElement('ul');ul.className='mk-list';(sec.items||[]).forEach(function(ch){var li=document.createElement('li');var b=document.createElement('button');b.type='button';b.className='mk-link';b.setAttribute('data-s',sec.id);b.setAttribute('data-c',ch.id);b.textContent=ch.title||'';li.appendChild(b);ul.appendChild(li)});d.appendChild(ul);aside.appendChild(d)})}");
  out.push("function renderArticle(book,active){var main=document.getElementById('reader');main.innerHTML='';if(!active||!active.s||!active.c){var card=document.createElement('section');card.className='card';card.innerHTML='<p class=\"muted\">Ø§Ø®ØªØ± ÙØµÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø¬Ø±Ø© Ù„Ø¹Ø±Ø¶Ù‡</p>';main.appendChild(card);return}var sec=(book.sections||[]).find(function(x){return x.id===active.s});if(!sec){renderArticle(book,null);return}var ch=(sec.items||[]).find(function(x){return x.id===active.c});if(!ch){renderArticle(book,null);return}var art=document.createElement('article');art.className='card mk-article';var h=document.createElement('h1');h.textContent=ch.title||'';art.appendChild(h);var body=document.createElement('div');body.innerHTML=htmlOfChapter(ch);art.appendChild(body);main.appendChild(art)}");
  out.push("function norm(s){return String(s||'').normalize('NFKD').replace(/[\\u064B-\\u0652\\u0670\\u0640]/g,'').replace(/[^\\p{L}\\p{N}\\s]+/gu,' ').toLowerCase().trim()}");
  out.push("function filterTOC(q){var qn=norm(q),btns=document.getElementById('toc').querySelectorAll('.mk-link');btns.forEach(function(b){var ok=!qn||norm(b.textContent).indexOf(qn)!==-1;b.parentElement.style.display=ok?'':'none'})}");
  out.push("function toggleToc(v){var a=document.getElementById('toc'),s=document.getElementById('toc-scrim');var on=v==null?!a.classList.contains('open'):v;a.classList.toggle('open',on);s&&s.classList.toggle('show',on);document.body.style.overflow=on&&window.innerWidth<981?'hidden':''}");
  out.push("function parseHash(){var h=location.hash.replace(/^#/,'');if(!h)return null;var p=h.split('-');if(p.length<3)return null;return{lang:p[0],s:p[1],c:p[2]}}");
  out.push("function setHash(lang,s,c){try{history.replaceState(null,'','#'+lang+'-'+s+'-'+c)}catch{location.hash='#'+lang+'-'+s+'-'+c}}");
  out.push("var state={lang:'ar',theme:(localStorage.getItem('theme')||'light'),book:null,open:{},active:{s:null,c:null}}");
  out.push("document.documentElement.dataset.theme=state.theme");
  out.push("var raw='{}';try{raw=document.getElementById('bk-data').textContent}catch(e){};var src={};try{src=JSON.parse(raw)}catch(e){src={name:'',sections:[]}}");
  out.push("var initial=parseHash();if(initial&&initial.lang)state.lang=initial.lang");
  out.push("function boot(){document.documentElement.dir=(state.lang==='ar'?'rtl':'ltr');state.book=project(src,state.lang);var t=document.getElementById('book-title');if(t)t.textContent=state.book.name||'';buildTOC(state.book,state.open);renderArticle(state.book,state.active)}");
  out.push("boot()");
  out.push("var lg=$('lang-switch');if(lg)lg.addEventListener('change',function(e){state.lang=e.target.value;state.open={};state.active={s:null,c:null};boot();toggleToc(false)})");
  out.push("var th=$('theme-toggle');if(th)th.addEventListener('click',function(){state.theme=(state.theme==='dark'?'light':'dark');document.documentElement.dataset.theme=state.theme;localStorage.setItem('theme',state.theme)})");
  out.push("var se=$('global-search');if(se)se.addEventListener('input',function(e){filterTOC(e.target.value)})");
  out.push("var tc=$('toc');if(tc)tc.addEventListener('click',function(ev){var b=ev.target.closest('.mk-link');if(!b)return;state.open[b.getAttribute('data-s')]=true;state.active={s:b.getAttribute('data-s'),c:b.getAttribute('data-c')};renderArticle(state.book,state.active);setHash(state.lang,state.active.s,state.active.c);if(window.innerWidth<981)toggleToc(false)})");
  out.push("if(el.tocToggle)el.tocToggle.addEventListener('click',function(){toggleToc()})");
  out.push("if(el.scrim)el.scrim.addEventListener('click',function(){toggleToc(false)})");
  out.push("window.addEventListener('resize',function(){if(matchMedia('(min-width:981px)').matches){var a=$('toc');var s=$('toc-scrim');a&&a.classList.remove('open');s&&s.classList.remove('show');document.body.style.overflow=''}})");
  out.push("if(initial&&initial.s&&initial.c){state.open[initial.s]=true;state.active={s:initial.s,c:initial.c};boot()}");
  out.push("})();");
  return out.join("\n");
}

function buildHTML(book,opt={}){
  const title=esc(fromLang(book&&book.name,"ar")||"ÙƒØªØ§Ø¨ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
  const css=cssTheme(opt.cssText);
  const json=jsonSafe(book);
  const rt=scriptSafe(runtime());
  const head=[
    "<!doctype html>",
    '<html lang="ar" dir="rtl" data-theme="light">',
    '<meta charset="utf-8">',
    '<meta name="viewport" content="width=device-width, initial-scale=1">',
    "<title>"+title+" â€” ÙƒØªØ§Ø¨ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</title>",
    "<style>"+styleSafe(css)+"</style>"
  ].join("\n");
  const top='<header class="topbar"><div class="bar"><button id="toc-toggle" title="TOC">â˜°</button><div class="brand" id="book-title">'+title+'</div><input id="global-search" type="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†â€¦" aria-label="Ø¨Ø­Ø« Ø´Ø§Ù…Ù„"><select id="lang-switch" aria-label="Language"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select><button id="theme-toggle" title="Light/Dark">ğŸŒ“</button></div></header>';
  const layout='<div class="wrapper"><aside id="toc"></aside><main id="reader" class="reader"></main></div>';
  const scrim='<div id="toc-scrim"></div>';
  const scripts='<script type="application/json" id="bk-data">'+json+'</scr'+'ipt><script>'+rt+'</scr'+'ipt></html>';
  return [head,top,layout,scrim,scripts].join("\n");
}

function download(name,text){
  const b=new Blob([text],{type:"text/html;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download=name;document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},600);
}

function exportOneFile(book,{filename="book-single.html",cssText}={}){download(filename,buildHTML(book,{cssText}))}

return{exportOneFile,buildHTML};
})();
</script>

	<script>



 document.getElementById("export-onepage-btn")?.addEventListener("click", ()=>{
    const book = window.editorState?.book || window.currentBook || window.book  || bookData || {};
    MishkahOnePage.exportOneFile(book, { filename: "book-single.html" });
  });

	</script>
<script>
// ===== Helpers =====
const __safeName = s => String(s ?? '').replace(/[\\\/:*?"<>|]/g, '_').trim() || 'untitled';
const __pad2 = n => String(n).padStart(2,'0');
function __ts() {
  const d = new Date();
  return d.getFullYear() + __pad2(d.getMonth()+1) + __pad2(d.getDate()) + '-' + __pad2(d.getHours()) + __pad2(d.getMinutes());
}
function __getLocalizedSectionName(section, lang) {
  if (typeof getLocalizedSectionName === 'function') return getLocalizedSectionName(section, lang);
  return section?.section_name || '';
}
function __ensureJSZip() {
  if (window.JSZip) return Promise.resolve();
  return new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";
    s.onload = () => res();
    s.onerror = () => rej(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ JSZip'));
    document.head.appendChild(s);
  });
}

// ===== Main: export all sections as ZIP of JSON files =====
async function exportAllSectionsAsZip() {
    const book = window.editorState?.book || window.currentBook || window.book  || bookData || {};

  if (!book || !Array.isArray(book.sections) || !book.sections.length) {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØªØ§Ø¨/Ø£Ù‚Ø³Ø§Ù… Ù„Ù„ØªØµØ¯ÙŠØ±.');
    return;
  }

  try {
    // ØªØ­Ù…ÙŠÙ„ JSZip Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
    if (!window.JSZip) {
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";
      await new Promise((res, rej) => { s.onload = res; s.onerror = () => rej(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ JSZip')); document.head.appendChild(s); });
    }

    const zip = new JSZip();
    const folder = zip.folder('sections');

    const lang = window.currentLanguage || 'ar';
    const __safeName = s => String(s ?? '').replace(/[\\\/:*?"<>|]/g, '_').trim() || 'untitled';
    const __pad2 = n => String(n).padStart(2,'0');
    const secNameFn = (section) => (typeof getLocalizedSectionName === 'function' ? getLocalizedSectionName(section, lang) : section?.section_name) || '';

    // Ù…Ù„Ù ÙÙ‡Ø±Ø³ Ø¯Ø§Ø®Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…ÙÙŠØ¯)
    const manifest = {
      exported_at: new Date().toISOString(),
      book: { name: (typeof getLocalizedBookName === 'function' ? getLocalizedBookName(book, lang) : (book.name || 'book')) },
      sections: []
    };

    book.sections.forEach((sec, idx) => {
      const secName = secNameFn(sec) || `section-${idx+1}`;
      const fileName = `${__pad2(idx+1)}_${__safeName(secName)}.json`;

      const payload = {
        meta: {
          exported_at: new Date().toISOString(),
          section_index: idx,
          section_name: secName
        },
        section: sec // ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù€ Chapters ÙƒÙ…Ø§ Ù‡ÙŠ
      };

      folder.file(fileName, JSON.stringify(payload, null, 2));
      manifest.sections.push({ index: idx, name: secName, file: `sections/${fileName}` });
    });

    zip.file('manifest.json', JSON.stringify(manifest, null, 2));

    const blob = await zip.generateAsync({
      type: 'blob',
      compression: 'DEFLATE',
      compressionOptions: { level: 6 }
    });

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `book_sections_${new Date().toISOString().slice(0,10)}.zip`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 700);
  } catch (err) {
    console.error(err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP.');
  }
}

// ===== Bind the button =====
(function bindExportAllSectionsZipBtn(){
  const btn = document.getElementById('export-all-sections-zip-btn');
  if (!btn) return;
  btn.addEventListener('click', exportAllSectionsAsZip);
})();
</script>





</body>
</html>