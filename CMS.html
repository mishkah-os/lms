<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖÿ≠ÿ±ÿ± ÿßŸÑŸÉÿ™ÿ®  ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-bg: #334155;
            --hover-bg: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --editor-font-size: 14px;
            --inline-shift: -2px;
            --inline-strong-shift: -4px;
            color-scheme: dark;
        }

        [data-theme="standard"] {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-bg: #334155;
            --hover-bg: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            color-scheme: dark;
        }

        [data-theme="light"] {
            --primary-bg: #ffffff;
            --secondary-bg: #f8fafc;
            --accent-bg: #e2e8f0;
            --hover-bg: #cbd5e1;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
            color-scheme: light;
        }

        [data-theme="dark"] {
            --primary-bg: #000000;
            --secondary-bg: #111827;
            --accent-bg: #1f2937;
            --hover-bg: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            color-scheme: dark;
        }

        html[dir="ltr"] {
            --inline-shift: 2px;
            --inline-strong-shift: 4px;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-bg) var(--secondary-bg);
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb {
            background: var(--accent-bg);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: var(--hover-bg);
        }

        body {
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
        }

        body, html {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
#viewer{

    overflow: auto;
}
#editor{

    overflow: auto;
}
        .tree-item {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 2px 0;
            cursor: grab;
        }

        .tree-item-chapter {
            background: linear-gradient(135deg, #1e3a8a, #000000);
            border-inline-start: 4px solid #3b82f6;
            color: #e0e7ff;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tree-item-chapter:hover {
            background: linear-gradient(135deg, #1e40af, #2563eb);
            transform: translateX(var(--inline-strong-shift));
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .tree-item-section {
            background: linear-gradient(135deg, #374151, #4b5563);
            border-inline-start: 4px solid #6b7280;
            color: #f3f4f6;
            font-weight: 600;
            position: relative;
        }

        .tree-item-section::before {
            content: '‚ñº';
            position: absolute;
            inset-inline-start: 8px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .tree-item-section.collapsed::before {
            transform: translateY(-50%) rotate(-90deg);
        }

        .tree-item-section:hover {
            background: linear-gradient(135deg, #4b5563, #6b7280);
            transform: translateX(var(--inline-shift));
        }

        .chapters-container {
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chapters-container.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .chapters-container.expanded {
         
            opacity: 1;
        }

        .tree-item:active {
            cursor: grabbing;
        }

        .tree-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .tree-item.drag-over {
            border: 2px dashed var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
        }

        .tree-item[draggable="true"] {
            cursor: grab;
        }

        .tree-item[draggable="true"]:hover {
            background: var(--hover-bg);
            transform: translateX(var(--inline-shift));
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .drop-indicator {
            height: 2px;
            background: var(--accent-color);
            margin: 2px 0;
            border-radius: 1px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .drop-indicator.active {
            opacity: 1;
        }

        .chapter-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .chapter-controls select,
        .chapter-controls input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .chapter-controls label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chapter-controls-section {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .chapter-select {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            min-width: 120px;
            flex: 1;
        }

        .chapter-select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .chapter-sort-input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            width: 60px;
            text-align: center;
        }

        .chapter-sort-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .move-chapter-btn {
            background: var(--accent-color);
            border: 1px solid var(--accent-color);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 32px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .move-chapter-btn:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .move-chapter-btn:active {
            transform: translateY(0);
        }

        .tree-item:hover {
            background: var(--hover-bg);
            transform: translateX(var(--inline-shift));
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .tree-item-active {
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .editor-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1px;
            background: var(--border-color);
        }

        .sidebar {
            background: var(--secondary-bg);
            border-inline-end: 1px solid var(--border-color);
        }

        .main-content {
            background: var(--primary-bg);
            overflow: hidden;
        }

        .controls-panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
           
        }

        .controls-hidden {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            display: none;
        }

        .controls-visible {
            opacity: 1;
        }

        .tab-button {
            color: var(--text-muted);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            inset-inline-start: 0;
            inset-inline-end: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .tab-button:hover {
            color: var(--text-primary);
            background: var(--hover-bg);
        }

        .tab-active-main {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: var(--accent-bg);
        }

        .tab-active-main::before {
            opacity: 0.1;
        }

        .markdown-editor {
            background: var(--editor-bg, var(--secondary-bg));
            color: var(--editor-text, var(--text-primary));
            border: none;
            border-radius: 0;
            transition: all 0.3s ease;
            font-family: var(--editor-font, 'Consolas'), 'Monaco', 'Courier New', monospace;
            line-height: 1.6;
            resize: none;
            font-size: var(--editor-font-size, 14px);
            padding: 12px;
            flex: 1;
            min-height: 0;
            outline: none;
        }

        .markdown-editor:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .markdown-toolbar {
            background: linear-gradient(135deg, var(--accent-bg), var(--secondary-bg));
            border-bottom: 1px solid var(--border-color);
            padding: 6px 8px;
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            min-height: 40px;
        }

        .toolbar-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0);
        }

        .split-view {
            display: flex;
            flex-direction: row;
            gap: 16px;
            height: calc(100vh - 120px);
            width: 100%;
        }

        .editor-panel {
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            min-width: 0;
        }

        .preview-panel {
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            min-width: 0;
        }

        .editor-toolbar-combined {
            background: linear-gradient(135deg, var(--accent-bg), var(--secondary-bg));
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 60px;
            border-radius: 8px 8px 0 0;
        }

        .chapter-controls-section {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-color);
            border-radius: 6px;
            flex-shrink: 0;
            min-width: 200px;
        }

        .chapter-select {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            min-width: 100px;
            flex: 1;
        }

        .chapter-select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .chapter-sort-input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            width: 50px;
            text-align: center;
        }

        .chapter-sort-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .move-chapter-btn {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .move-chapter-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .editor-title-section {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 350px;
        }

        .editor-title-input {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
            min-width: 300px;
        }

        .editor-title-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .font-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            background: rgba(34, 197, 94, 0.1);
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .font-select {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 11px;
            min-width: 90px;
        }

        .control-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .font-size-display {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }

        .color-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            background: rgba(168, 85, 247, 0.1);
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-direction: column;
        }

        .color-picker {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            padding: 0;
        }

        .color-label {
            font-size: 9px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: bold;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--accent-bg), var(--secondary-bg));
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .viewer-content-prose {
            line-height: 1.8;
            color: var(--text-primary);
        }

        .viewer-content-prose h1,
        .viewer-content-prose h2,
        .viewer-content-prose h3,
        .viewer-content-prose h4,
        .viewer-content-prose h5,
        .viewer-content-prose h6 {
            color: var(--text-primary);
            margin-top: 2em;
            margin-bottom: 1em;
            font-weight: 700;
            line-height: 1.3;
        }

        .viewer-content-prose h1 {
            font-size: 2.25em;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 0.5em;
        }

        .viewer-content-prose h2 {
            font-size: 1.875em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        .viewer-content-prose h3 {
            font-size: 1.5em;
            color: var(--accent-color);
        }

        .viewer-content-prose blockquote {
            border-inline-start: 4px solid var(--accent-color);
            padding: 16px 20px;
            margin: 20px 0;
            background: var(--accent-bg);
            border-radius: 8px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .viewer-content-prose code {
            background: var(--accent-bg);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--warning-color);
        }

        .viewer-content-prose pre {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            margin: 20px 0;
        }

        .viewer-content-prose pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .viewer-content-prose ul,
        .viewer-content-prose ol {
            padding-inline-start: 24px;
            margin: 16px 0;
        }

        .viewer-content-prose li {
            margin: 8px 0;
        }

        .viewer-content-prose a {
            color: var(--accent-color);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .viewer-content-prose a:hover {
            border-bottom-color: var(--accent-color);
        }

        .viewer-content-prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--secondary-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .viewer-content-prose th,
        .viewer-content-prose td {
            padding: 12px 16px;
            text-align: start;
            border-bottom: 1px solid var(--border-color);
        }

        .viewer-content-prose th {
            background: var(--accent-bg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .viewer-content-prose tr:hover {
            background: var(--hover-bg);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #0891b2, #0e7490);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
        }

        .content-editor-block {
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
        }

        .content-editor-block:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
        }

        .block-header {
            background: var(--accent-bg);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            border-radius: 10px 10px 0 0;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-block-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-block-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .search-input {
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .section-sort-item {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-sort-item:active {
            cursor: grabbing;
        }

        .section-sort-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .section-sort-item.drag-over {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
        }

        .section-sort-item:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .section-sort-input {
            width: 60px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }

        .section-sort-name {
            flex: 1;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
        }

        .drag-handle {
            color: var(--text-muted);
            cursor: grab;
            padding: 4px;
        }

        .drag-handle:hover {
            color: var(--text-primary);
        }

        .theme-controls {
            display: flex;
            gap: 4px;
            margin-inline-start: auto;
        }

        .locale-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .direction-controls {
            display: flex;
            gap: 6px;
            justify-content: center;
            background: var(--accent-bg);
            padding: 6px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .direction-btn {
            flex: 1;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .direction-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .direction-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: #fff;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.35);
        }

        .theme-controls-sidebar {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 16px;
            padding: 8px;
            background: var(--accent-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .theme-controls-sidebar .theme-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .theme-controls-sidebar .theme-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .theme-controls-sidebar .theme-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .theme-controls-sidebar .theme-btn i {
            font-size: 14px;
        }

        .theme-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .theme-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .theme-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .editable-content {
            transition: all 0.2s ease;
        }
        
        .editable-content:hover {
            background-color: rgba(59, 130, 246, 0.05) !important;
        }
        
        .editable-content:focus {
            outline: none;
        }
        
        mark {
            background-color: #fbbf24;
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .editor-controls {
            background: var(--accent-bg);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }



        .layout-controls {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            background: rgba(245, 158, 11, 0.1);
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .full-editor .split-view {
            grid-template-columns: 1fr;
        }

        .full-editor .preview-panel {
            display: none;
        }

        .full-editor .editor-panel {
            width: 100%;
        }



        @media (max-width: 1024px) {
            .editor-toolbar-combined {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
                padding: 8px;
            }
            
            .chapter-controls-section,
            .editor-title-section,
            .font-controls,
            .color-controls,
            .layout-controls {
                justify-content: center;
                min-width: auto;
            }
            
            .editor-title-input {
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .split-view {
                flex-direction: column;
                height: calc(100vh - 140px);
            }
            
            .chapter-controls-section {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            
            .chapter-select {
                min-width: auto;
            }
            
            .chapter-sort-input {
                width: 100%;
            }
        }

        /* Theme-specific styles for language selector */
        [data-theme="light"] select#language-select{background-color:#ffffff;color:#111827;border:1px solid #d1d5db;}
        [data-theme="light"] select#language-select option{background-color:#ffffff;color:#111827;}
        [data-theme="standard"] select#language-select{background-color:#1f2937;color:#e5e7eb;border:1px solid #374151;}
        [data-theme="standard"] select#language-select option{background-color:#1f2937;color:#e5e7eb;}
        [data-theme="dark"] select#language-select{background-color:#111827;color:#e5e7eb;border:1px solid #374151;}
        [data-theme="dark"] select#language-select option{background-color:#111827;color:#e5e7eb;}
    
	#ai-tools-slot{margin-inline-start:8px}
.ai-bar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;background:var(--secondary-bg);border:1px solid var(--border-color);border-radius:8px;padding:6px 8px}
.ai-bar .select,.ai-bar input,.ai-bar textarea{background:var(--secondary-bg);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;padding:6px 8px}
.ai-bar input[type="password"]{min-width:160px}
.ai-bar textarea{min-width:220px;min-height:38px;display:none}
.ai-bar .group{display:flex;gap:8px;align-items:center}
.ai-bar label{color:var(--text-secondary);font-size:12px;display:inline-flex;align-items:center;gap:4px}
.ai-bar .btn{height:32px}
[data-theme="light"] .ai-bar{background:var(--secondary-bg);border-color:var(--border-color)}

	</style>
</head>
<body>
    <div class="editor-container">
        <div class="sidebar p-4 flex flex-col overflow-y-auto">
            <div class="locale-controls">
                <div class="theme-controls-sidebar" role="group" aria-label="Theme selector">
                    <button class="theme-btn active" data-theme="light" onclick="setTheme('light')" title="Light mode">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button class="theme-btn" data-theme="standard" onclick="setTheme('standard')" title="Standard mode">
                        <i class="fas fa-adjust"></i>
                    </button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')" title="Dark mode">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
                <div class="direction-controls" role="group" aria-label="Language selector">
                    <button class="direction-btn" data-dir="rtl" data-lang="ar" onclick="setLanguage('ar')" title="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">
                        <i class="fas fa-language"></i>
                        <span>AR</span>
                    </button>
                    <button class="direction-btn" data-dir="ltr" data-lang="en" onclick="setLanguage('en')" title="English">
                        <i class="fas fa-language"></i>
                        <span>EN</span>
                    </button>
                </div>
            </div>

            <div class="mb-4 space-y-3">
                <div>
                    <label for="book-switcher" class="block text-sm font-semibold text-gray-300 mb-1">
                        <span data-i18n-key="bookManager.label">üìö ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÉÿ™ÿ®</span>
                    </label>
                    <select id="book-switcher" class="w-full search-input bg-gray-800 border-gray-700"></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="new-book-btn" class="btn btn-secondary text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-plus"></i> <span data-i18n-key="bookManager.newBook">ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ</span>
                    </button>
                    <button id="clone-book-btn" class="btn btn-secondary text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-copy"></i> <span data-i18n-key="bookManager.cloneBook">ÿßÿ≥ÿ™ŸÜÿ≥ÿßÿÆ</span>
                    </button>
                    <button id="rename-book-btn" class="btn btn-warning text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-pen"></i> <span data-i18n-key="bookManager.renameBook">ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≥ŸÖŸäÿ©</span>
                    </button>
                    <button id="delete-book-btn" class="btn btn-danger text-sm flex items-center justify-center gap-1">
                        <i class="fas fa-trash"></i> <span data-i18n-key="bookManager.deleteBook">ÿ≠ÿ∞ŸÅ</span>
                    </button>
                </div>
                <button id="export-bundle-btn" class="w-full btn btn-success flex items-center justify-center gap-2">
                    <i class="fas fa-file-export"></i> <span data-i18n-key="bookManager.exportBundle">ÿ™ÿµÿØŸäÿ± ŸÉŸÑ ÿßŸÑŸÖŸàÿßÿØ (s-data.js)</span>
                </button>
            </div>

            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-400"><span data-i18n-key="bookManager.tocTitle">ŸÅŸáÿ±ÿ≥ ÿßŸÑŸÉÿ™ÿßÿ®</span></h2>

            <div class="mb-4 space-y-3">
                <input type="text" id="search-chapters" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅÿµŸàŸÑ..." class="w-full search-input" data-i18n-placeholder="bookManager.searchPlaceholder">
                <button id="settings-toggle" class="w-full btn btn-primary">
                    <i class="fas fa-cog"></i> <span data-i18n-key="settings.toggle">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span>
                </button>
            </div>

            <div id="controls-panel" class="controls-panel mb-4 space-y-3 p-4 bg-gray-800 rounded-lg controls-hidden">
                <select id="language-select" class="p-2 border rounded">
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="tr">T√ºrk√ße</option>
                    <option value="nl">Nederlands</option>
                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    <option value="ms">Bahasa Melayu</option>
                    <option value="zh">‰∏≠Êñá</option>
                </select>
                <select id="import-method" class="w-full search-input">
                    <option value="auto" data-i18n-key="settings.autoSplit">ÿ™ŸÇÿ≥ŸäŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä</option>
                    <option value="suggested" data-i18n-key="settings.suggestedSplit">ÿ™ŸÇÿ≥ŸäŸÖ ŸÖŸàÿ∂ŸàÿπŸä ŸÖŸÇÿ™ÿ±ÿ≠</option>
                </select>
                <input type="file" id="txt-upload" accept=".txt" class="hidden">
                <button onclick="document.getElementById('txt-upload').click()" class="w-full btn btn-primary">
                    <i class="fas fa-file-import"></i><span data-i18n-key="settings.importText">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÜÿµ</span>
                </button>
<input type="file" id="json-upload" accept=".json" class="hidden">
<button onclick="document.getElementById('json-upload').click()" class="w-full btn btn-success"><span data-i18n-key="settings.uploadJson">ÿ™ÿ≠ŸÖŸäŸÑ JSON</span></button>
<button id="export-txt-btn" onclick="exportPlainText()" class="w-full btn btn-warning"><span data-i18n-key="settings.exportSummary">ÿ™ÿµÿØŸäÿ± ŸÜÿµ ŸÖÿÆÿ™ÿµÿ±</span></button>
<button id="migrate-data-btn" onclick="migrateOldDataStructure()" class="w-full btn btn-secondary"><span data-i18n-key="settings.migrateData">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸÜŸäÿ© ŸÑŸÑÿ∫ÿßÿ™</span></button>
                <button id="save-json" class="w-full btn btn-warning">
                    <i class="fas fa-save"></i><span data-i18n-key="settings.saveProject">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</span>
                </button>
                                <button id="export-static-site-btn" class="w-full btn btn-success">
    <i class="fas fa-globe"></i> <span data-i18n-key="settings.exportStatic">ÿ™ÿµÿØŸäÿ± ŸÖŸàŸÇÿπ ÿ≥ÿ™ÿßÿ™ŸäŸÉŸä</span>
</button>
<button id="export-all-sections-zip-btn" class="w-full btn btn-success">
  <i class="fas fa-file-archive"></i> <span data-i18n-key="settings.exportSections">ÿ™ÿµÿØŸäÿ± ÿßŸÑÿßŸÇÿ≥ÿßŸÖ JSON</span>
</button>



    <button id="export-map-btn" class="w-full btn btn-success">
                        <i class="fas fa-map"></i> <span data-i18n-key="settings.exportMap">ÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÅÿµŸàŸÑ</span>
                    </button>

<button id="export-onepage-btn" class="w-full btn btn-info">üìÑ <span data-i18n-key="settings.exportOnePage">ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© OnePage</span></button>

<style>
.side-btns .btn{
min-width :48%;
}
</style>

                <div class="flex gap-2 side-btns" >
                    <button id="search-btn" onclick="openAdvancedSearch()" class="btn btn-info" title="ÿ®ÿ≠ÿ´ ŸÖÿ™ŸÇÿØŸÖ" data-i18n-title="bookManager.advancedSearch">
                        <i class="fas fa-search"></i> <span data-i18n-key="bookManager.advancedSearch">ÿ®ÿ≠ÿ´ ŸÖÿ™ŸÇÿØŸÖ</span>
                    </button>
                    <button id="destroy-book-btn" onclick="destroyCurrentBook()" class="btn btn-danger" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑÿ≠ÿßŸÑŸä" data-i18n-title="bookManager.deleteCurrentBookTitle">
                        <i class="fas fa-trash"></i> <span data-i18n-key="bookManager.deleteCurrentBook">ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉÿ™ÿßÿ®</span>
                    </button>
                </div>
                <div class="flex gap-2 side-btns">

                    <button id="edit-book-info-btn" onclick="editBookInfo()" class="btn btn-secondary">
                        <i class="fas fa-info-circle"></i>  <span data-i18n-key="bookManager.bookInfo">ŸÖÿπŸÑŸàŸÖÿßÿ™</span>
                    </button>
                    <button id="show-stats-btn" class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> <span data-i18n-key="bookManager.stats">ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</span>
                    </button>
                </div>
                                 <div class="flex gap-2 side-btns">

                                <button id="approve-all-btn" class="w-full btn btn-success">
    <i class="fas fa-check-double"></i> <span data-i18n-key="bookManager.approveAll">ÿßÿπÿ™ŸÖÿßÿØ ÿßŸÑÿ¨ŸÖŸäÿπ</span>
</button>
</div>
                
            </div>
            
            <div id="tree-container" class="space-y-1 flex-grow"></div>
			<div class="mt-3 p-3 bg-gray-700 rounded-lg text-sm">
                    <p class="text-gray-300 mb-2"><i class="fas fa-info-circle text-blue-400"></i> ŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ≥ÿ≠ÿ® ŸàÿßŸÑÿ•ŸÅŸÑÿßÿ™:</p>
                    <ul class="text-gray-400 text-xs space-y-1">
                        <li>‚Ä¢ ÿßÿ≥ÿ≠ÿ® ÿßŸÑŸÅÿµŸàŸÑ ŸÑÿ•ÿπÿßÿØÿ© ÿ™ÿ±ÿ™Ÿäÿ®Ÿáÿß</li>
                        <li>‚Ä¢ ÿßÿ≥ÿ≠ÿ® ŸÅÿµŸÑ ÿ•ŸÑŸâ ŸÇÿ≥ŸÖ ÿ¢ÿÆÿ± ŸÑŸÜŸÇŸÑŸá</li>
                        <li>‚Ä¢ ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ŸÑŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™</li>
                    </ul>
                </div>
        </div>

        <div id="main-content-area" class="main-content p-6 flex flex-col">
            <div class="flex border-b border-gray-600 mb-6">
                <button id="view-tab-btn" class="tab-button px-6 py-3 text-lg font-semibold">
                    <i class="fas fa-eye mr-2"></i>ÿπÿ±ÿ∂
                </button>
                <button id="edit-tab-btn" class="tab-button px-6 py-3 text-lg font-semibold">
                    <i class="fas fa-edit mr-2"></i>ÿ™ÿ≠ÿ±Ÿäÿ±
                </button>
            </div>

            <div id="viewer" class="flex-1 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 id="viewer-title" class="text-3xl font-bold text-yellow-400 border-b-2 border-yellow-500 pb-2">ÿßÿÆÿ™ÿ± ŸÅÿµŸÑÿßŸã ŸÑÿπÿ±ÿ∂Ÿá</h1>
                    <button onclick="printCurrentChapter()" class="btn btn-info" id="print-btn" style="display: none;">
                        <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ©
                    </button>
                </div>
                <div id="viewer-content" class="text-lg leading-relaxed space-y-4 viewer-content-prose">
                    <p>ŸäŸÖŸÉŸÜŸÉ ÿ™ÿµŸÅÿ≠ ÿßŸÑŸÉÿ™ÿßÿ® ŸÖŸÜ ÿßŸÑŸÅŸáÿ±ÿ≥ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä. ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÅÿµŸÑ ŸÑÿπÿ±ÿ∂ ŸÖÿ≠ÿ™ŸàÿßŸá ŸáŸÜÿß ÿ£Ÿà ÿ™ÿ≠ÿ±Ÿäÿ±Ÿá.</p>
                </div>
            </div>

            <div id="editor" class="hidden flex-1 flex flex-col fade-in">
                <div class="space-y-6 flex-1 flex flex-col">
                   
                    
                  
                    
                              <div class="flex-1 split-view" id="main-split-view">
                        <div class="editor-panel">
                            <div class="editor-toolbar-combined">
                                <div class="chapter-controls-section">
                                    <select id="chapter-section-select" class="chapter-select">
                                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ÿßÿ®</option>
                                    </select>
                                    <input id="chapter-sort-input" class="chapter-sort-input" type="number" placeholder="ÿ™ÿ±ÿ™Ÿäÿ®" />
                                    <button onclick="moveChapterFromControls()" class="move-chapter-btn" title="ŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button onclick="openActiveChapterResources()" class="move-chapter-btn" title="ÿÆÿµÿßÿ¶ÿµ ÿßŸÑÿØÿ±ÿ≥">
                                        <i class="fas fa-sliders-h"></i>
                                    </button>
                                </div>
 
                                <div class="editor-title-section">
                                    <i class="fas fa-edit"></i>
                                    <input id="editor-title" type="text" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅÿµŸÑ" class="editor-title-input">
                                    <span id="audit-badge" class="mr-2 inline-flex items-center px-2 py-1 rounded text-xs font-bold"></span>

                                </div>
                                
                                <div class="font-controls">
                                    <select id="font-family-select" class="font-select" onchange="changeFontFamily()">
                                        <option value="Consolas">Consolas</option>
                                        <option value="Arial">Arial</option>
                                        <option value="Tahoma">Tahoma</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Georgia">Georgia</option>
                                    </select>
                                    <button class="control-btn" onclick="decreaseFontSize()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <div class="font-size-display" id="font-size-display">14px</div>
                                    <button class="control-btn" onclick="increaseFontSize()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>

                                <div class="color-controls">
                                    <div class="color-picker-wrapper">
                                        <span class="color-label">ÿÆŸÑŸÅŸäÿ©</span>
                                        <input type="color" id="bg-color-picker" class="color-picker" value="#1e293b" onchange="changeEditorBg()">
                                    </div>
                                    <div class="color-picker-wrapper">
                                        <span class="color-label">ŸÜÿµ</span>
                                        <input type="color" id="text-color-picker" class="color-picker" value="#f8fafc" onchange="changeEditorText()">
                                    </div>
                                </div>

                                <div class="layout-controls">
                                    <button class="control-btn" onclick="toggleLayout()" id="layout-toggle" title="ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿπÿ±ÿ∂">
                                        <i class="fas fa-columns"></i>
                                    </button>
                                </div>
                                <button id="audit-open-btn" class="btn btn-secondary">
  <i class="fas fa-shield-halved"></i> ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑÿßÿπÿ™ŸÖÿßÿØÿßÿ™
</button>
<button id="revlog-open-btn" class="btn btn-warning">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</button>
<div id="ai-tools-slot"></div>

                            </div>
                            
                            <div id="markdown-toolbar" class="markdown-toolbar">
                                <button class="toolbar-btn" title="ÿπÿ±Ÿäÿ∂" data-action="bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="toolbar-btn" title="ŸÖÿßÿ¶ŸÑ" data-action="italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="toolbar-btn" title="ÿπŸÜŸàÿßŸÜ ÿ±ÿ¶Ÿäÿ≥Ÿä" data-action="h1">
                                    H1
                                </button>
                                <button class="toolbar-btn" title="ÿπŸÜŸàÿßŸÜ ŸÅÿ±ÿπŸä" data-action="h2">
                                    H2
                                </button>
                                <button class="toolbar-btn" title="ÿπŸÜŸàÿßŸÜ ÿµÿ∫Ÿäÿ±" data-action="h3">
                                    H3
                                </button>
                                <button class="toolbar-btn" title="ÿßŸÇÿ™ÿ®ÿßÿ≥" data-action="quote">
                                    <i class="fas fa-quote-right"></i>
                                </button>
                                <button class="toolbar-btn" title="ŸÉŸàÿØ" data-action="code">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button class="toolbar-btn" title="ŸÇÿßÿ¶ŸÖÿ©" data-action="list">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button class="toolbar-btn" title="ŸÇÿßÿ¶ŸÖÿ© ŸÖÿ±ŸÇŸÖÿ©" data-action="ordered-list">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button class="toolbar-btn" title="ÿ±ÿßÿ®ÿ∑" data-action="link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="toolbar-btn" title="ÿµŸàÿ±ÿ©" data-action="image">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="toolbar-btn" title="ÿ¨ÿØŸàŸÑ" data-action="table">
                                    <i class="fas fa-table"></i>
                                </button>
                            </div>
                            
                            <div class="panel-content p-0" style="flex: 1;">
                                <textarea id="markdown-editor" class="markdown-editor w-full h-full border-0 resize-none" placeholder="ÿßŸÉÿ™ÿ® ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÅÿµŸÑ ŸáŸÜÿß ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Markdown..."></textarea>
                            </div>
                        </div>

                        <div class="preview-panel">
                            <div class="panel-header">
                                <i class="fas fa-eye"></i>
                                ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
                            </div>
                            <div id="markdown-preview" class="panel-content viewer-content-prose">
                                <p class="text-gray-400">ÿ≥ÿ™ÿ∏Ÿáÿ± ÿßŸÑŸÖÿπÿßŸäŸÜÿ© ŸáŸÜÿß...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="content-buttons-container" class="flex justify-center gap-4 mt-4">
                        <button onclick="addContentBlock('paragraph')" class="btn btn-success">
                            <i class="fas fa-paragraph"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÅŸÇÿ±ÿ©
                        </button>
                        <button onclick="addContentBlock('image')" class="btn" style="background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white;">
                            <i class="fas fa-image"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ©
                        </button>
                        <button onclick="addContentBlock('table')" class="btn btn-warning">
                            <i class="fas fa-table"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿØŸàŸÑ
                        </button>
                    </div>
                </div>
            </div>

            </div>
        </div>
    </div>

<div id="context-menu" class="hidden absolute w-56 rounded-md shadow-lg bg-slate-800 border border-slate-600 text-white text-sm p-1">
	
	</div>
    
    <div id="stats-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-gray-800 text-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-teal-400">ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÉÿ™ÿßÿ®</h2>
                <button onclick="document.getElementById('stats-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="stats-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <div id="book-info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300">ÿ™ÿπÿØŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ®</h2>
                <button onclick="document.getElementById('book-info-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            
            <div class="space-y-4">
               <div>
    <label class="block text-sm font-medium text-gray-300 mb-2">ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿ™ÿßÿ® (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</label>
    <input type="text" id="book-title-input-ar" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿ™ÿßÿ®">
</div>
<div>
    <label class="block text-sm font-medium text-gray-300 mb-2">Book Title (English)</label>
    <input type="text" id="book-title-input-en" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter book title">
</div>

<div class="grid md:grid-cols-2 gap-4">
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">ÿßŸÑŸÖÿπÿ±ŸÅ (Subject ID)</label>
        <input type="text" id="book-id-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ŸÖÿ´ÿßŸÑ: math">
        <p class="text-xs text-gray-400 mt-1">ŸäŸèÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÖŸÅÿ™ÿßÿ≠ ÿØÿßÿÆŸÑ ŸÖŸÑŸÅ s-data.js (ÿ®ÿØŸàŸÜ ŸÖÿ≥ÿßŸÅÿßÿ™).</p>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ™ÿπÿ®Ÿäÿ±Ÿäÿ©</label>
        <input type="text" id="book-icon-input" maxlength="2" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ŸÖÿ´ÿßŸÑ: üìò">
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">ŸÑŸàŸÜ ÿßŸÑŸÖÿßÿØÿ©</label>
        <input type="color" id="book-color-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="#2563eb">
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ∫ŸÑÿßŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
        <input type="text" id="book-cover-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://...">
    </div>
</div>

               <div>
    <label class="block text-sm font-medium text-gray-300 mb-2">ŸÖŸÇÿØŸÖÿ© ÿßŸÑŸÉÿ™ÿßÿ® (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</label>
    <textarea id="book-bio-input-ar" rows="10" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical" placeholder="ÿ£ÿØÿÆŸÑ ŸÖŸÇÿØŸÖÿ© ÿßŸÑŸÉÿ™ÿßÿ®..."></textarea>
</div>
<div>
    <label class="block text-sm font-medium text-gray-300 mb-2">Book Bio (English)</label>
    <textarea id="book-bio-input-en" rows="10" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical" placeholder="Enter book bio..."></textarea>
</div>
<div>
    <label class="block text-sm font-medium text-gray-300 mb-2">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿπÿßÿ± (ŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖŸÑŸÅÿßÿ™)</label>
    <input type="text" id="book-alias-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="my-book-name">
</div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©</h3>
                    <div id="bio-preview" class="prose prose-invert max-w-none bg-gray-800 p-4 rounded-lg min-h-[100px]"></div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="document.getElementById('book-info-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button onclick="saveBookInfo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ÿ≠ŸÅÿ∏</button>
            </div>
        </div>
    </div>

    <div id="book-library-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300">ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÉÿ™ÿ®</h2>
                <button onclick="toggleBookLibrary(false)" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div id="book-library-list" class="space-y-3"></div>
            <div class="mt-6 flex flex-wrap gap-2 justify-end">
                <button id="library-create-btn" class="btn btn-secondary"><i class="fas fa-plus"></i> ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ</button>
                <button onclick="toggleBookLibrary(false)" class="btn btn-secondary">ÿ•ÿ∫ŸÑÿßŸÇ</button>
            </div>
        </div>
    </div>

    <div id="section-resources-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300" id="section-resources-title">ŸÖŸàÿßÿ±ÿØ ÿßŸÑŸàÿ≠ÿØÿ©</h2>
                <button onclick="toggleSectionResources(false)" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm text-gray-300 mb-2">ŸÜÿ®ÿ∞ÿ© ÿπŸÜ ÿßŸÑŸàÿ≠ÿØÿ© (<span id="section-brief-lang">AR</span>)</label>
                    <textarea id="section-brief-input" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">ŸÖŸÑŸÅÿßÿ™ PDF</h3>
                        <button class="btn btn-secondary text-sm" onclick="addSectionResource('pdf')"><i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑŸÅ</button>
                    </div>
                    <div id="section-pdfs-list" class="space-y-3"></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">ŸÅŸäÿØŸäŸàŸáÿßÿ™</h3>
                        <button class="btn btn-secondary text-sm" onclick="addSectionResource('video')"><i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÅŸäÿØŸäŸà</button>
                    </div>
                    <div id="section-videos-list" class="space-y-3"></div>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-2">ŸÉŸàÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± (JavaScript / JSON)</label>
                    <textarea id="section-quiz-input" rows="6" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono text-sm" placeholder="ŸÖÿ´ÿßŸÑ: [ { id: 1, ... } ]"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button class="btn btn-primary text-sm" onclick="testSectionQuizScript()"><i class="fas fa-play"></i> ÿ™ÿ¨ÿ±ÿ®ÿ©</button>
                        <span id="section-quiz-status" class="text-sm"></span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="btn btn-secondary" onclick="toggleSectionResources(false)">ÿ•ÿ∫ŸÑÿßŸÇ</button>
            </div>
        </div>
    </div>

    <div id="chapter-resources-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-300" id="chapter-resources-title">ŸÖŸàÿßÿ±ÿØ ÿßŸÑÿØÿ±ÿ≥</h2>
                <button onclick="toggleChapterResources(false)" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm text-gray-300 mb-2">ŸÖŸÑÿÆÿµ ÿßŸÑÿØÿ±ÿ≥ (<span id="chapter-brief-lang">AR</span>)</label>
                    <textarea id="chapter-brief-input" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">ŸÖŸÑŸÅÿßÿ™ PDF</h3>
                        <button class="btn btn-secondary text-sm" onclick="addChapterResource('pdf')"><i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑŸÅ</button>
                    </div>
                    <div id="chapter-pdfs-list" class="space-y-3"></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-200">ŸÅŸäÿØŸäŸàŸáÿßÿ™</h3>
                        <button class="btn btn-secondary text-sm" onclick="addChapterResource('video')"><i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÅŸäÿØŸäŸà</button>
                    </div>
                    <div id="chapter-videos-list" class="space-y-3"></div>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-2">ŸÉŸàÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± (JavaScript / JSON)</label>
                    <textarea id="chapter-quiz-input" rows="6" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono text-sm" placeholder="ŸÖÿ´ÿßŸÑ: [ { id: 1, ... } ]"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button class="btn btn-primary text-sm" onclick="testChapterQuizScript()"><i class="fas fa-play"></i> ÿ™ÿ¨ÿ±ÿ®ÿ©</button>
                        <span id="chapter-quiz-status" class="text-sm"></span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="btn btn-secondary" onclick="toggleChapterResources(false)">ÿ•ÿ∫ŸÑÿßŸÇ</button>
            </div>
        </div>
    </div>

    <div id="section-sort-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">ÿ™ÿ≠ÿ±Ÿäÿ± ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</h2>
                <button onclick="document.getElementById('section-sort-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="section-sort-content" class="space-y-3">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="document.getElementById('section-sort-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                    ÿ•ŸÑÿ∫ÿßÿ°
                </button>
                <button onclick="saveSectionSort()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®
                </button>
            </div>
        </div>
    </div>

    <div id="advanced-search-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</h2>
                <button onclick="closeAdvancedSearch()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex gap-4">
                    <input type="text" id="search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ..." class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                    <button onclick="performAdvancedSearch()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-search"></i> ÿ®ÿ≠ÿ´
                    </button>
                </div>
                
                <div class="flex gap-4">
                    <label class="flex items-center text-white">
                        <input type="checkbox" id="search-titles" checked class="mr-2">
                        ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπŸÜÿßŸàŸäŸÜ
                    </label>
                    <label class="flex items-center text-white">
                        <input type="checkbox" id="search-content" checked class="mr-2">
                        ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
                    </label>
                    <label class="flex items-center text-white">
                        <input type="checkbox" id="case-sensitive" class="mr-2">
                        ÿ≠ÿ≥ÿßÿ≥ ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ
                    </label>
                </div>
            </div>
            
            <div id="search-results" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-center">ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿ®ÿØÿ°</p>
            </div>
        </div>
    </div>
<div id="audit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-white">ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑÿßÿπÿ™ŸÖÿßÿØÿßÿ™</h2>
      <button id="audit-close-btn" class="text-gray-400 hover:text-white">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="grid md:grid-cols-3 gap-3 mb-4">
      <div>
        <label class="block text-sm mb-1 text-gray-300">ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ</label>
        <select id="audit-status-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white">
          <option value="true">ÿ™ŸÖ ÿßÿπÿ™ŸÖÿßÿØ ÿßŸÑŸÜÿ¥ÿ±</option>
          <option value="false">Ÿäÿ≠ÿ™ÿßÿ¨ ŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1 text-gray-300">ÿßÿ≥ŸÖ ÿßŸÑŸÖŸèÿ±ÿßÿ¨ÿπ</label>
        <select id="audit-reviewer-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white">
          <option value="admin">admin</option>
          <option value="supervisor">supervisor</option>
        </select>
      </div>
      <div class="md:col-span-3">
        <label class="block text-sm mb-1 text-gray-300">ŸÖŸÑÿßÿ≠ÿ∏ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
        <textarea id="audit-notes" rows="3" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white"></textarea>
      </div>
    </div>

    <div class="flex justify-end mb-6">
      <button id="audit-add-btn" class="btn btn-success">
        <i class="fas fa-plus"></i> ÿ£ÿ∂ŸÅ ÿßŸÑÿ™ÿπŸÑŸäŸÇ / ÿßÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ÿßŸÑÿ©
      </button>
    </div>

    <div class="overflow-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-gray-700">
            <th class="text-right p-2">ÿßŸÑÿ≠ÿßŸÑÿ©</th>
            <th class="text-right p-2">ÿßŸÑŸÖŸèÿ±ÿßÿ¨ÿπ</th>
            <th class="text-right p-2">ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©</th>
            <th class="text-right p-2">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ/ÿßŸÑŸàŸÇÿ™</th>
          </tr>
        </thead>
        <tbody id="audit-logs-tbody"></tbody>
      </table>
    </div>
  </div>
</div>



<div id="revlog-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-bold text-white">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</h3>
      <button id="revlog-close" class="text-gray-400 hover:text-white">‚úï</button>
    </div>
    <div id="revlog-list" class="space-y-2 max-h-[65vh] overflow-y-auto"></div>
  </div>
</div>

    <script>

        let bookData = null;
        let currentBookId = null;
        let bookLibrary = [];
        let activeSectionResourcesIndex = null;
        let activeChapterResourcesPath = { section: null, chapter: null };
        let allLines = [];
        let activePath = { section: null, chapter: null };
        let currentView = 'viewer';
        let markdownEditor = null;
        let markdownPreview = null;
        let currentTheme = 'light';
        let currentFontSize = 14;
        let isFullEditor = false;

        const treeContainer = document.getElementById('tree-container');
        const viewerTitle = document.getElementById('viewer-title');
        const viewerContent = document.getElementById('viewer-content');
        const editorTitleInput = document.getElementById('editor-title');
        const viewerDiv = document.getElementById('viewer');
        const editorDiv = document.getElementById('editor');
        const settingsToggle = document.getElementById('settings-toggle');
        const controlsPanel = document.getElementById('controls-panel');
        const contextMenu = document.getElementById('context-menu');
        const viewTabBtn = document.getElementById('view-tab-btn');
        const editTabBtn = document.getElementById('edit-tab-btn');
        const showStatsBtn = document.getElementById('show-stats-btn');
        const exportMapBtn = document.getElementById('export-map-btn');

let currentLanguage = (localStorage.getItem('preferredLang') || 'ar').toLowerCase();
const RTL_LANGS = ['ar', 'he', 'fa', 'ur'];
let directionMode = localStorage.getItem('preferredDirMode') || 'auto';
let storedDirection = localStorage.getItem('preferredDir');
let currentDirection = (storedDirection || '').toLowerCase();
if (!['rtl', 'ltr'].includes(currentDirection)) {
    currentDirection = RTL_LANGS.includes(currentLanguage) ? 'rtl' : 'ltr';
}

function isLanguageRTL(lang) {
    return RTL_LANGS.includes((lang || '').toLowerCase());
}

function applyDocumentDirection() {
    const dir = currentDirection === 'rtl' ? 'rtl' : 'ltr';
    document.documentElement.setAttribute('dir', dir);
    document.documentElement.setAttribute('data-dir', dir);
    if (document.body) {
        document.body.setAttribute('data-dir', dir);
    }
}

function updateDirectionUI() {
    document.querySelectorAll('.direction-btn').forEach(btn => {
        const isActive = btn.dataset.dir === currentDirection;
        btn.classList.toggle('active', isActive);
    });
}

function setDirection(dir, { manual = false, persist = true } = {}) {
    const normalized = dir === 'rtl' ? 'rtl' : 'ltr';
    currentDirection = normalized;
    if (persist) {
        localStorage.setItem('preferredDir', currentDirection);
        directionMode = manual ? 'manual' : 'auto';
        localStorage.setItem('preferredDirMode', directionMode);
    }
    applyDocumentDirection();
    updateDirectionUI();
}

function syncDirectionWithLanguage(force = false) {
    if (directionMode === 'manual' && !force) {
        applyDocumentDirection();
        updateDirectionUI();
        return;
    }
    const targetDir = isLanguageRTL(currentLanguage) ? 'rtl' : 'ltr';
    setDirection(targetDir, { manual: false, persist: true });
}

function applyDocumentLanguage() {
    document.documentElement.lang = currentLanguage;
}

const UI_TRANSLATIONS = {
    ar: {
        settings: {
            toggle: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
            importText: 'ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÜÿµ',
            uploadJson: 'ÿ™ÿ≠ŸÖŸäŸÑ JSON',
            exportSummary: 'ÿ™ÿµÿØŸäÿ± ŸÜÿµ ŸÖÿÆÿ™ÿµÿ±',
            migrateData: 'ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸÜŸäÿ© ŸÑŸÑÿ∫ÿßÿ™',
            saveProject: 'ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ',
            exportStatic: 'ÿ™ÿµÿØŸäÿ± ŸÖŸàŸÇÿπ ÿ≥ÿ™ÿßÿ™ŸäŸÉŸä',
            exportSections: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑÿßŸÇÿ≥ÿßŸÖ JSON',
            exportMap: 'ÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÅÿµŸàŸÑ',
            exportOnePage: 'ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© OnePage',
            autoSplit: 'ÿ™ŸÇÿ≥ŸäŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä',
            suggestedSplit: 'ÿ™ŸÇÿ≥ŸäŸÖ ŸÖŸàÿ∂ŸàÿπŸä ŸÖŸÇÿ™ÿ±ÿ≠'
        },
        bookManager: {
            label: 'üìö ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÉÿ™ÿ®',
            newBook: 'ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ',
            cloneBook: 'ÿßÿ≥ÿ™ŸÜÿ≥ÿßÿÆ',
            renameBook: 'ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≥ŸÖŸäÿ©',
            deleteBook: 'ÿ≠ÿ∞ŸÅ',
            exportBundle: 'ÿ™ÿµÿØŸäÿ± ŸÉŸÑ ÿßŸÑŸÖŸàÿßÿØ (s-data.js)',
            tocTitle: 'ŸÅŸáÿ±ÿ≥ ÿßŸÑŸÉÿ™ÿßÿ®',
            searchPlaceholder: 'ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅÿµŸàŸÑ...',
            advancedSearch: 'ÿ®ÿ≠ÿ´ ŸÖÿ™ŸÇÿØŸÖ',
            deleteCurrentBook: 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉÿ™ÿßÿ®',
            deleteCurrentBookTitle: 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑÿ≠ÿßŸÑŸä',
            bookInfo: 'ŸÖÿπŸÑŸàŸÖÿßÿ™',
            stats: 'ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™',
            approveAll: 'ÿßÿπÿ™ŸÖÿßÿØ ÿßŸÑÿ¨ŸÖŸäÿπ'
        },
        contextMenu: {
            separator: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
            book: {
                addSection: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ',
                reorderSections: 'ÿ™ÿ≠ÿ±Ÿäÿ± ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ',
                printBook: 'ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÉÿ™ÿßÿ® ŸÉŸÑŸá',
                exportSectionsZip: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ JSON'
            },
            section: {
                addChapter: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿµŸÑ ÿ¨ÿØŸäÿØ',
                deleteSection: 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ',
                sectionResources: 'ÿÆÿµÿßÿ¶ÿµ ÿßŸÑŸàÿ≠ÿØÿ©',
                exportJson: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸÉŸÄ JSON',
                exportTxt: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸÉŸÄ TXT',
                printSection: 'ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÇÿ≥ŸÖ'
            },
            chapter: {
                moveChapter: 'ŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ ÿ•ŸÑŸâ ŸÇÿ≥ŸÖ ÿ¢ÿÆÿ±',
                deleteChapter: 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿµŸÑ',
                chapterResources: 'ÿÆÿµÿßÿ¶ÿµ ÿßŸÑÿØÿ±ÿ≥'
            }
        }
    },
    en: {
        settings: {
            toggle: 'Settings',
            importText: 'Import Text',
            uploadJson: 'Upload JSON',
            exportSummary: 'Export Summary Text',
            migrateData: 'Update Language Structure',
            saveProject: 'Save Project',
            exportStatic: 'Export Static Site',
            exportSections: 'Export Sections JSON',
            exportMap: 'Chapters Map',
            exportOnePage: 'Export OnePage Version',
            autoSplit: 'Auto Split',
            suggestedSplit: 'Suggested Thematic Split'
        },
        bookManager: {
            label: 'üìö Book Management',
            newBook: 'New Book',
            cloneBook: 'Clone',
            renameBook: 'Rename',
            deleteBook: 'Delete',
            exportBundle: 'Export All Materials (s-data.js)',
            tocTitle: 'Book Table of Contents',
            searchPlaceholder: 'Search chapters...',
            advancedSearch: 'Advanced Search',
            deleteCurrentBook: 'Delete Book',
            deleteCurrentBookTitle: 'Delete Current Book',
            bookInfo: 'Info',
            stats: 'Statistics',
            approveAll: 'Approve All'
        },
        contextMenu: {
            separator: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
            book: {
                addSection: 'Add New Section',
                reorderSections: 'Reorder Sections',
                printBook: 'Print Entire Book',
                exportSectionsZip: 'Export Sections JSON'
            },
            section: {
                addChapter: 'Add New Chapter',
                deleteSection: 'Delete Section',
                sectionResources: 'Unit Properties',
                exportJson: 'Export Section as JSON',
                exportTxt: 'Export Section as TXT',
                printSection: 'Print Section'
            },
            chapter: {
                moveChapter: 'Move Chapter to Another Section',
                deleteChapter: 'Delete Chapter',
                chapterResources: 'Lesson Properties'
            }
        }
    }
};

function getTranslation(key, lang) {
    if (!key) return '';
    const normalized = (lang || '').toLowerCase();
    const fallbacks = [];
    if (UI_TRANSLATIONS[normalized]) fallbacks.push(normalized);
    if (!fallbacks.includes('en') && UI_TRANSLATIONS.en) fallbacks.push('en');

    const parts = key.split('.');

    for (const code of fallbacks) {
        let value = UI_TRANSLATIONS[code];
        for (const part of parts) {
            if (value && Object.prototype.hasOwnProperty.call(value, part)) {
                value = value[part];
            } else {
                value = undefined;
                break;
            }
        }
        if (typeof value === 'string') {
            return value;
        }
    }

    return '';
}

function applyTranslations(lang = currentLanguage) {
    const normalized = (lang || '').toLowerCase();

    document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        if (!key) return;
        const translated = getTranslation(key, normalized);
        if (translated) {
            el.textContent = translated;
        }
    });

    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (!key) return;
        const translated = getTranslation(key, normalized);
        if (translated) {
            el.setAttribute('placeholder', translated);
        }
    });

    document.querySelectorAll('[data-i18n-title]').forEach(el => {
        const key = el.getAttribute('data-i18n-title');
        if (!key) return;
        const translated = getTranslation(key, normalized);
        if (translated) {
            el.setAttribute('title', translated);
        }
    });
}

const SETTINGS_TRANSLATIONS = {
    ar: {
        toggle: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
        importText: 'ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÜÿµ',
        uploadJson: 'ÿ™ÿ≠ŸÖŸäŸÑ JSON',
        exportSummary: 'ÿ™ÿµÿØŸäÿ± ŸÜÿµ ŸÖÿÆÿ™ÿµÿ±',
        migrateData: 'ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸÜŸäÿ© ŸÑŸÑÿ∫ÿßÿ™',
        saveProject: 'ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ',
        exportStatic: 'ÿ™ÿµÿØŸäÿ± ŸÖŸàŸÇÿπ ÿ≥ÿ™ÿßÿ™ŸäŸÉŸä',
        exportSections: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑÿßŸÇÿ≥ÿßŸÖ JSON',
        exportMap: 'ÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÅÿµŸàŸÑ',
        exportOnePage: 'ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© OnePage',
        autoSplit: 'ÿ™ŸÇÿ≥ŸäŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä',
        suggestedSplit: 'ÿ™ŸÇÿ≥ŸäŸÖ ŸÖŸàÿ∂ŸàÿπŸä ŸÖŸÇÿ™ÿ±ÿ≠'
    },
    en: {
        toggle: 'Settings',
        importText: 'Import Text',
        uploadJson: 'Upload JSON',
        exportSummary: 'Export Summary Text',
        migrateData: 'Update Language Structure',
        saveProject: 'Save Project',
        exportStatic: 'Export Static Site',
        exportSections: 'Export Sections JSON',
        exportMap: 'Chapters Map',
        exportOnePage: 'Export OnePage Version',
        autoSplit: 'Auto Split',
        suggestedSplit: 'Suggested Thematic Split'
    }
};

function getSettingsTranslation(key, lang) {
    const normalized = (lang || '').toLowerCase();
    const safeLang = SETTINGS_TRANSLATIONS[normalized] ? normalized : 'en';
    return SETTINGS_TRANSLATIONS[safeLang][key] || SETTINGS_TRANSLATIONS.en[key] || '';
}

function applySettingsTranslations(lang = currentLanguage) {
    const elements = document.querySelectorAll('[data-i18n-key]');
    elements.forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        if (!key) return;
        const segments = key.split('.');
        const lookupKey = segments.length > 1 ? segments[1] : segments[0];
        el.textContent = getSettingsTranslation(lookupKey, lang);
    });
}

applyDocumentLanguage();
applyDocumentDirection();
updateDirectionUI();
applyTranslations();
applySettingsTranslations();
function generateUniqueID() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 10; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}
function ensureUniqueIDs(book) {
    if (!book) return;
    if (!book.id) book.id = generateUniqueID();
    if (book.sections && Array.isArray(book.sections)) {
        book.sections.forEach(section => {
            if (!section.id) section.id = generateUniqueID();
            if (section.Chapters && Array.isArray(section.Chapters)) {
                section.Chapters.forEach(chapter => {
                    if (!chapter.id) chapter.id = generateUniqueID();
                });
            }
        });
    }
}
function getLocalizedSectionName(section,lang){return getFromLangArray(section.section_name,lang)}
function setLocalizedSectionName(section,lang,text){section.section_name=setInLangArray(section.section_name,lang,text)}
function getLocalizedBookName(book,lang){return getFromLangArray(book.name,lang)}
function setLocalizedBookName(book,lang,text){book.name=setInLangArray(book.name,lang,text)}

const bookTitleInputEl=document.getElementById('book-title-input');
if(bookTitleInputEl){bookTitleInputEl.addEventListener('input',e=>{if(bookData)setLocalizedBookName(bookData,currentLanguage||'ar',(e.target.value||'').trim())})}


function toLangArray(value) {
    if (Array.isArray(value)) return value;
    if (typeof value === 'string') return [{ ar: value }];
    if (value && typeof value === 'object') {
        const entries = [];
        Object.keys(value).forEach(key => {
            if (typeof value[key] === 'string') {
                entries.push({ [key]: value[key] });
            }
        });
        return entries.length ? entries : [{ ar: '' }];
    }
    return [{ ar: '' }];
}

function langArrayToObject(arr) {
    const obj = {};
    (arr || []).forEach(item => {
        if (item && typeof item === 'object') {
            const key = Object.keys(item)[0];
            if (key) obj[key] = item[key];
        }
    });
    return obj;
}

function slugify(text) {
    if (!text) return '';
    return text
        .toString()
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .toLowerCase();
}

function ensureResourceItem(item) {
    const normalized = item && typeof item === 'object' ? { ...item } : {};
    if (!normalized.id) normalized.id = generateUniqueID();
    if (!normalized.url) normalized.url = normalized.link || '';
    normalized.title = toLangArray(normalized.title || normalized.name || normalized.label || '');
    return normalized;
}

function ensureSectionSchema(section) {
    if (!section) return;
    section.section_name = toLangArray(section.section_name);
    section.brief = toLangArray(section.brief || section.description || '');
    if (!Array.isArray(section.Chapters)) section.Chapters = [];
    if (!section.resources) section.resources = {};
    const res = section.resources;

    if (!Array.isArray(res.pdfs)) {
        if (Array.isArray(res.pdfs)) {
            res.pdfs = res.pdfs.map(ensureResourceItem);
        } else if (section.block_resources && section.block_resources.pdfs) {
            const legacy = section.block_resources.pdfs;
            if (Array.isArray(legacy)) {
                res.pdfs = legacy.map(ensureResourceItem);
            } else {
                res.pdfs = Object.keys(legacy || {}).map(key => ensureResourceItem({
                    id: key,
                    title: toLangArray({ ar: key, en: key }),
                    url: legacy[key]
                }));
            }
        } else {
            res.pdfs = [];
        }
    } else {
        res.pdfs = res.pdfs.map(ensureResourceItem);
    }

    if (!Array.isArray(res.videos)) {
        if (Array.isArray(res.videos)) {
            res.videos = res.videos.map(ensureResourceItem);
        } else if (section.block_resources && section.block_resources.video) {
            const legacyVideo = section.block_resources.video;
            if (Array.isArray(legacyVideo)) {
                res.videos = legacyVideo.map(ensureResourceItem);
            } else {
                res.videos = [ensureResourceItem({
                    id: 'video',
                    title: toLangArray({ ar: 'ŸÅŸäÿØŸäŸà', en: 'Video' }),
                    url: legacyVideo
                })];
            }
        } else {
            res.videos = [];
        }
    } else {
        res.videos = res.videos.map(ensureResourceItem);
    }

    if (typeof res.quizScript !== 'string') {
        if (res.quizScript && typeof res.quizScript === 'object') {
            try {
                res.quizScript = JSON.stringify(res.quizScript, null, 2);
            } catch (e) {
                res.quizScript = '';
            }
        } else if (section.block_resources && section.block_resources.quiz) {
            try {
                res.quizScript = JSON.stringify(section.block_resources.quiz, null, 2);
            } catch (e) {
                res.quizScript = '';
            }
        } else {
            res.quizScript = res.quizScript || '';
        }
    }

    if (!Array.isArray(res.quizPreview) && Array.isArray(res.quiz)) {
        res.quizPreview = res.quiz;
    }

    section.resources = res;
    section.Chapters.forEach(ensureChapterSchema);
}

function ensureChapterSchema(chapter) {
    if (!chapter) return;
    chapter.title = toLangArray(chapter.title);
    chapter.brief = toLangArray(chapter.brief || chapter.summary || '');
    if (!Array.isArray(chapter.content)) {
        chapter.content = [{ type: 'paragraph', data: toLangArray('') }];
    }
    if (!chapter.resources) chapter.resources = {};
    const res = chapter.resources;
    res.pdfs = Array.isArray(res.pdfs) ? res.pdfs.map(ensureResourceItem) : [];
    res.videos = Array.isArray(res.videos) ? res.videos.map(ensureResourceItem) : [];
    if (typeof res.quizScript !== 'string') {
        if (Array.isArray(res.quiz)) {
            try {
                res.quizScript = JSON.stringify(res.quiz, null, 2);
            } catch (e) {
                res.quizScript = '';
            }
        } else {
            res.quizScript = res.quizScript || '';
        }
    }
    if (!Array.isArray(res.quizPreview) && Array.isArray(res.quiz)) {
        res.quizPreview = res.quiz;
    }
    chapter.resources = res;
}

function ensureBookSchema(book) {
    if (!book) return;
    book.name = toLangArray(book.name || '');
    book.bio = toLangArray(book.bio || '');
    book.icon = book.icon || 'üìò';
    book.color = book.color || '#2563eb';
    if (!book.cover) book.cover = book.cover || '';
    if (!book.subjectId) {
        const arName = getFromLangArray(book.name, 'ar') || '';
        const enName = getFromLangArray(book.name, 'en') || arName;
        const generated = slugify(book.alias || enName || arName || 'subject');
        book.subjectId = generated || generateUniqueID();
    }
    if (!Array.isArray(book.sections)) book.sections = [];
    ensureUniqueIDs(book);
    book.sections.forEach(ensureSectionSchema);
}


function normalizeLangArray(v){if(Array.isArray(v))return v;if(typeof v==='string')return[{ar:v}];if(v&&typeof v==='object'){const a=[];Object.keys(v).forEach(k=>a.push({[k]:v[k]}));return a;}return[{ar:''}];}
function getFromLangArray(arr,lang){const a=normalizeLangArray(arr);let val='';for(const o of a){if(Object.prototype.hasOwnProperty.call(o,lang)){val=o[lang];break;}}if(!val){for(const o of a){if(Object.prototype.hasOwnProperty.call(o,'ar')){val=o['ar'];break;}}}if(!val&&a.length>0){const k=Object.keys(a[0])[0];val=a[0][k];}return typeof val==='string'?val:'';}
function setInLangArray(arr,lang,text){let a=normalizeLangArray(arr);let f=false;a=a.map(o=>{const k=Object.keys(o)[0];if(k===lang){f=true;return{[lang]:text};}return o;});if(!f)a.push({[lang]:text});return a;}

function getLocalizedTitle(chapter,lang){return getFromLangArray(chapter.title,lang);}
function setLocalizedTitle(chapter,lang,text){chapter.title=setInLangArray(chapter.title,lang,text);}

function getLocalizedContent(chapter,lang){if(!chapter||!chapter.content||!Array.isArray(chapter.content)||chapter.content.length===0)return'';const block=chapter.content[0];if(!block||typeof block!=='object')return'';const data=block.data;if(typeof data==='string')return data;return getFromLangArray(data,lang);}
function setLocalizedContent(chapter,lang,text){
  if(!chapter.content||!Array.isArray(chapter.content)||chapter.content.length===0){
    chapter.content=[{type:'paragraph',data:setInLangArray([],lang,text||'')}];
    return;
  }
  const block=chapter.content[0];
  if(typeof block.data==='string'){
    const existingText = block.data;
    block.data=setInLangArray([],lang,existingText);
  }
  // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸàÿ¨ŸàÿØ - ŸÅŸÇÿ∑ ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿµ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ∫Ÿäÿ± ŸÅÿßÿ±ÿ∫ ŸàŸÑŸäÿ≥ ŸÖÿ¨ÿ±ÿØ ŸÖÿ≥ÿßŸÅÿßÿ™
  // Ÿàÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿÆÿ™ŸÑŸÅÿßŸã ÿπŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ≠ÿßŸÑŸä
  if(text !== undefined && text !== null && text.trim() !== ''){
    const currentContent = getFromLangArray(block.data, lang);
    if(text.trim() !== currentContent.trim()){
      block.data=setInLangArray(block.data,lang,text);
    }
  }
}

// ÿØÿßŸÑÿ© ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÇÿµŸàÿØ
function protectContentFromLoss() {
  if (!bookData || activePath.section === null || activePath.chapter === null) return;
  
  const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
  if (!chapter || !chapter.content) return;
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ±ÿ±
  if (markdownEditor && markdownEditor.value && markdownEditor.value.trim() !== '') {
    const editorContent = markdownEditor.value.trim();
    const currentContent = getLocalizedContent(chapter, currentLanguage || 'ar');
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ±ÿ± ŸÖÿÆÿ™ŸÑŸÅ ÿπŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿå ÿßÿ≠ŸÅÿ∏Ÿá
    if (editorContent !== currentContent.trim()) {
      setLocalizedContent(chapter, currentLanguage || 'ar', editorContent);
      console.log('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑÿ≠ŸÖÿßŸäÿ™Ÿá ŸÖŸÜ ÿßŸÑŸÅŸÇÿØÿßŸÜ');
    }
  }
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿπŸÜŸàÿßŸÜ ŸÅŸä ÿ≠ŸÇŸÑ ÿßŸÑÿπŸÜŸàÿßŸÜ
  if (editorTitleInput && editorTitleInput.value && editorTitleInput.value.trim() !== '') {
    const editorTitle = editorTitleInput.value.trim();
    const currentTitle = getLocalizedTitle(chapter, currentLanguage || 'ar');
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿπŸÜŸàÿßŸÜ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ±ÿ± ŸÖÿÆÿ™ŸÑŸÅ ÿπŸÜ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿå ÿßÿ≠ŸÅÿ∏Ÿá
    if (editorTitle !== currentTitle.trim()) {
      setLocalizedTitle(chapter, currentLanguage || 'ar', editorTitle);
      console.log('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑÿ≠ŸÖÿßŸäÿ™Ÿá ŸÖŸÜ ÿßŸÑŸÅŸÇÿØÿßŸÜ');
    }
  }
}

// ÿØÿßŸÑÿ© ÿ≠ŸÖÿßŸäÿ© ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑŸÖÿ≠ÿ™ŸàŸâ ÿπŸÜÿØ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿßŸÑŸÅÿµŸàŸÑ
function protectContentBeforeSwitch() {
  if (!bookData || activePath.section === null || activePath.chapter === null) return;
  
  const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
  if (!chapter) return;
  
  // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ±ÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
  if (currentView === 'editor' && markdownEditor) {
    const editorContent = markdownEditor.value || '';
    const currentContent = getLocalizedContent(chapter, currentLanguage || 'ar') || '';
    
    if (editorContent.trim() !== currentContent.trim()) {
      setLocalizedContent(chapter, currentLanguage || 'ar', editorContent);
      console.log('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ');
    }
  }
  
  // ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
  if (editorTitleInput) {
    const editorTitle = editorTitleInput.value || '';
    const currentTitle = getLocalizedTitle(chapter, currentLanguage || 'ar') || '';
    
    if (editorTitle.trim() !== currentTitle.trim()) {
      setLocalizedTitle(chapter, currentLanguage || 'ar', editorTitle);
      console.log('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÜŸàÿßŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ');
    }
  }
}
        function st(range) {
            if (typeof range !== 'string' || !allLines || allLines.length === 0) return '';
            const match = range.match(/\[\[(\d+)(?::(\d+))?\]\]/);
            if (match) {
                const start = parseInt(match[1]);
                const end = match[2] ? parseInt(match[2]) : start;
                if (start < allLines.length && end < allLines.length) {
                   return allLines.slice(start, end + 1).join('\n');
                }
            }
            return '';
        }
        
        function normalizeValueToString(value, lang = currentLanguage || 'ar') {
            if (value == null) return '';
            if (typeof value === 'string') return value;

            if (Array.isArray(value)) {
                if (!value.length) return '';
                const isLangArray = value.every(item => {
                    if (!item || typeof item !== 'object') return false;
                    const keys = Object.keys(item);
                    return keys.length === 1 && typeof item[keys[0]] === 'string';
                });
                if (isLangArray) {
                    return getFromLangArray(value, lang) || '';
                }
                return value.map(entry => normalizeValueToString(entry, lang)).filter(Boolean).join('\n');
            }

            if (typeof value === 'object') {
                if (Object.prototype.hasOwnProperty.call(value, lang)) {
                    return normalizeValueToString(value[lang], lang);
                }

                const prioritizedKeys = ['text', 'content', 'value', 'title', 'caption', 'description', 'body', 'html', 'markdown'];
                for (const key of prioritizedKeys) {
                    if (value[key] != null) {
                        const normalized = normalizeValueToString(value[key], lang);
                        if (normalized) return normalized;
                    }
                }

                if (value.csv) {
                    return normalizeValueToString(value.csv, lang);
                }

                if (Array.isArray(value.items)) {
                    const normalizedItems = value.items
                        .map(item => normalizeValueToString(item, lang))
                        .filter(Boolean);
                    if (normalizedItems.length) return normalizedItems.join('\n');
                }

                if (Array.isArray(value.lines)) {
                    const normalizedLines = value.lines
                        .map(item => normalizeValueToString(item, lang))
                        .filter(Boolean);
                    if (normalizedLines.length) return normalizedLines.join('\n');
                }

                return Object.keys(value)
                    .filter(key => !['type', 'id', 'items', 'data', 'blocks', 'Chapters', 'resources', 'url', 'csv'].includes(key))
                    .map(key => normalizeValueToString(value[key], lang))
                    .filter(Boolean)
                    .join('\n');
            }

            return String(value);
        }

        function extractBlockText(block, lang = currentLanguage || 'ar') {
            if (!block) return '';
            if (typeof block === 'string') return block;
            if (Array.isArray(block)) {
                return block.map(item => extractBlockText(item, lang)).filter(Boolean).join('\n');
            }
            if (typeof block !== 'object') return String(block);

            if (block.type === 'table') {
                const data = block.data || block;
                if (typeof data === 'string') return data;
                if (data.csv) return normalizeValueToString(data.csv, lang);
                if (Array.isArray(data.rows)) {
                    return data.rows
                        .map(row => Array.isArray(row) ? row.join(', ') : normalizeValueToString(row, lang))
                        .join('\n');
                }
            }

            if (block.type === 'image') {
                const data = block.data || block;
                const parts = [data.title, data.caption]
                    .map(part => normalizeValueToString(part, lang))
                    .filter(Boolean);
                return parts.join(' - ');
            }

            if (block.type === 'list') {
                const data = block.data || {};
                const items = Array.isArray(data.items) ? data.items : Array.isArray(data) ? data : [];
                return items.map(item => normalizeValueToString(item, lang)).filter(Boolean).join('\n');
            }

            if (block.text != null) {
                const text = normalizeValueToString(block.text, lang);
                if (text) return text;
            }

            if (block.data != null) {
                return normalizeValueToString(block.data, lang);
            }

            if (block.content != null) {
                return normalizeValueToString(block.content, lang);
            }

            return '';
        }

        function extractChapterText(chapter, lang = currentLanguage || 'ar') {
            if (!chapter) return { text: '', lines: 0 };
            const parts = [];
            const briefText = normalizeValueToString(chapter.brief, lang);
            if (briefText) parts.push(briefText);

            if (Array.isArray(chapter.content)) {
                chapter.content
                    .forEach(block => {
                        const text = extractBlockText(block, lang);
                        if (text) parts.push(text);
                    });
            }

            const combined = parts.join('\n').trim();
            if (!combined) {
                return { text: '', lines: 0 };
            }
            const lineCount = combined.split(/\r?\n/).length;
            return { text: combined, lines: lineCount };
        }

        function getWordCount(str, lang = currentLanguage || 'ar') {
            const normalized = typeof str === 'string' ? str : normalizeValueToString(str, lang);
            const trimmed = normalized.trim();
            if (!trimmed) return 0;
            return trimmed.split(/\s+/).filter(Boolean).length;
        }
        function getCharCount(str, lang = currentLanguage || 'ar') {
            const normalized = typeof str === 'string' ? str : normalizeValueToString(str, lang);
            return normalized.length;
        }

        function initializeMarkdownEditor() {
            markdownEditor = document.getElementById('markdown-editor');
            markdownPreview = document.getElementById('markdown-preview');
            
            markdownEditor.addEventListener('input', debounce(updateMarkdownPreview, 300));
            markdownEditor.addEventListener('scroll', syncScroll);
            
            setTheme(currentTheme);
            updateFontSize();
            
            setupMarkdownToolbar();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }



function saveUserPreferences() {
    const layoutContainer = document.getElementById('main-split-view');
    const chapterSectionSelect = document.getElementById('chapter-section-select');
    const chapterSortInput = document.getElementById('chapter-sort-input');
    const preferences = {
        fontSize: editorSettings.fontSize,
        fontFamily: editorSettings.fontFamily,
        bgColor: editorSettings.bgColor,
        textColor: editorSettings.textColor,
        theme: currentTheme,
        layout: layoutContainer && layoutContainer.classList.contains('full-editor') ? 'full' : 'split',
        chapterSection: chapterSectionSelect ? chapterSectionSelect.value : '',
        chapterSort: chapterSortInput ? chapterSortInput.value : '',
        language: currentLanguage,
        direction: currentDirection,
        directionMode
    };
    localStorage.setItem('userPreferences', JSON.stringify(preferences));
    localStorage.setItem('preferredLang', currentLanguage);
}


function loadUserPreferences() {
    const saved = localStorage.getItem('userPreferences');
    if (saved) {
        const preferences = JSON.parse(saved);
        editorSettings.fontSize = preferences.fontSize || 14;
        editorSettings.fontFamily = preferences.fontFamily || 'Consolas';
        editorSettings.bgColor = preferences.bgColor || '#1e293b';
        editorSettings.textColor = preferences.textColor || '#f8fafc';
        currentTheme = preferences.theme || 'light';
        currentLanguage = (preferences.language || localStorage.getItem('preferredLang') || currentLanguage || 'ar').toLowerCase();
        directionMode = preferences.directionMode || localStorage.getItem('preferredDirMode') || directionMode || 'auto';
        if (preferences.direction) {
            currentDirection = preferences.direction;
        }
        applyDocumentLanguage();
        applyTranslations(currentLanguage);
        applySettingsTranslations(currentLanguage);
        if (directionMode === 'manual') {
            setDirection(currentDirection, { manual: true, persist: false });
        } else {
            syncDirectionWithLanguage(true);
        }
        setTheme(currentTheme);
    }
}

function setLanguage(lang) {
    currentLanguage = (lang || 'ar').toLowerCase();
    applyDocumentLanguage();
    applyTranslations(currentLanguage);
    applySettingsTranslations(currentLanguage);
    directionMode = 'auto';
    localStorage.setItem('preferredDirMode', directionMode);
    localStorage.setItem('preferredLang', currentLanguage);
    if (directionMode !== 'manual') {
        syncDirectionWithLanguage(true);
    } else {
        updateDirectionUI();
    }
    saveUserPreferences();
}
function renderLanguageSelector() {
    const container = document.getElementById('controls-panel') || document.body;
    let select = document.getElementById('language-select');
    if (!select) { 
        select = document.createElement('select');
        select.id = 'language-select';
        select.className = 'p-2 border rounded';
        const langs = [
            { v: 'ar', t: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' },
            { v: 'en', t: 'English' },
            { v: 'fr', t: 'Fran√ßais' },
            { v: 'tr', t: 'T√ºrk√ße' },
            { v: 'nl', t: 'Nederlands' },
            { v: 'hi', t: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' },
            { v: 'ms', t: 'Bahasa Melayu' },
            { v: 'zh', t: '‰∏≠Êñá' }
        ];
        langs.forEach(l => {
            const opt = document.createElement('option');
            opt.value = l.v;
            opt.textContent = l.t;
            select.appendChild(opt);
        });
        container.prepend(select);
    }
    select.value = currentLanguage || 'ar';
    select.onchange = () => {
        const nextLang = select.value || 'ar';
        setLanguage(nextLang);
        if (bookData && bookTitleInputEl) {
            bookTitleInputEl.value = getLocalizedBookName(bookData, currentLanguage) || '';
        }
        if (bookData && activePath.section !== null && activePath.chapter !== null) {
            const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
            if (editorTitleInput) editorTitleInput.value = getLocalizedTitle(ch, currentLanguage) || '';
            if (markdownEditor) {
                markdownEditor.value = getLocalizedContent(ch, currentLanguage) || '';
                updateMarkdownPreview();
            }
        }
        renderTreeView();
        if (typeof renderViewerContentOnly === 'function') renderViewerContentOnly();
    };
}
        function updateMarkdownPreview() {
            if (!markdownEditor || !markdownPreview) {
                console.warn('Markdown editor or preview not initialized');
                return;
            }
            
            const markdownText = markdownEditor.value || '';
            
            try {
                const htmlContent = marked.parse(markdownText, { 
                    breaks: true,
                    gfm: true,
                    sanitize: false,
                    smartLists: true,
                    smartypants: true
                });
                
                markdownPreview.innerHTML = htmlContent;
                
                markdownPreview.querySelectorAll('pre code').forEach((el) => {
                    hljs.highlightElement(el);
                });
                
                markdownPreview.querySelectorAll('table').forEach((table) => {
                    table.className = 'w-full text-sm text-right text-gray-400 bg-gray-800 rounded-lg border border-gray-600';
                    const thead = table.querySelector('thead');
                    if (thead) {
                        thead.className = 'text-xs text-gray-300 uppercase bg-gray-700';
                        thead.querySelectorAll('th').forEach(th => {
                            th.className = 'px-6 py-3 border border-gray-600';
                        });
                    }
                    const tbody = table.querySelector('tbody');
                    if (tbody) {
                        tbody.querySelectorAll('tr').forEach(tr => {
                            tr.className = 'border-b bg-gray-800 border-gray-700 hover:bg-gray-600';
                            tr.querySelectorAll('td').forEach(td => {
                                td.className = 'px-6 py-4 border border-gray-600';
                            });
                        });
                    }
                });
                
                markdownPreview.querySelectorAll('blockquote').forEach((quote) => {
                    quote.className = 'border-r-4 border-blue-500 bg-gray-800 p-4 my-4 italic text-gray-300';
                });
                
                markdownPreview.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach((heading) => {
                    heading.className = 'font-bold text-yellow-400 mb-3 mt-6';
                    if (heading.tagName === 'H1') heading.className += ' text-3xl';
                    else if (heading.tagName === 'H2') heading.className += ' text-2xl';
                    else if (heading.tagName === 'H3') heading.className += ' text-xl';
                });
                
                markdownPreview.querySelectorAll('ul, ol').forEach((list) => {
                    list.className = 'list-disc list-inside space-y-2 my-4 text-gray-300';
                    if (list.tagName === 'OL') {
                        list.className = 'list-decimal list-inside space-y-2 my-4 text-gray-300';
                    }
                });
                
                markdownPreview.querySelectorAll('p').forEach((p) => {
                    p.className = 'mb-4 leading-relaxed text-gray-300';
                });
                
                markdownPreview.querySelectorAll('code:not(pre code)').forEach((code) => {
                    code.className = 'bg-gray-700 text-yellow-300 px-2 py-1 rounded text-sm';
                });
                
                markdownPreview.querySelectorAll('a').forEach((link) => {
                    link.className = 'text-blue-400 hover:text-blue-300 underline';
                });
                
                markdownPreview.querySelectorAll('strong').forEach((strong) => {
                    strong.className = 'font-bold text-white';
                });
                
                markdownPreview.querySelectorAll('em').forEach((em) => {
                    em.className = 'italic text-yellow-300';
                });

                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ®ÿ≠ÿ∞ÿ± ŸÑÿ™ÿ¨ŸÜÿ® ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿØÿßŸÑÿ© ÿßŸÑÿ≠ŸÖÿßŸäÿ©
                if (activePath.section !== null && activePath.chapter !== null && bookData && markdownText.trim() !== '') {
                    protectContentFromLoss();
                    const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
                    setLocalizedContent(ch, currentLanguage || 'ar', markdownText);
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿßÿ±ÿ∂ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂
                    if (currentView === 'viewer') {
                        renderViewerContentOnly();
                    }
                }
                
            } catch (error) {
                console.error('Error parsing markdown:', error);
                markdownPreview.innerHTML = `<p class="text-red-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ Markdown: ${error.message}</p>`;
            }
        }
function migrateOldDataStructure(){
    if(!bookData||!Array.isArray(bookData.sections))return;
    if(typeof bookData.name==='string')bookData.name=[{ar:bookData.name}];else bookData.name=normalizeLangArray(bookData.name);
    for(const sec of bookData.sections){
        if(typeof sec.section_name==='string')sec.section_name=[{ar:sec.section_name}];else sec.section_name=normalizeLangArray(sec.section_name);
        if(Array.isArray(sec.Chapters)){
            for(const ch of sec.Chapters){
                if(typeof ch.title==='string')ch.title=[{ar:ch.title}];else ch.title=normalizeLangArray(ch.title);
                if(Array.isArray(ch.content)){
                    for(const b of ch.content){
                        if(b&&b.type==='paragraph'){
                            if(typeof b.data==='string')b.data=[{ar:b.data}];else b.data=normalizeLangArray(b.data);
                        }
                    }
                }
            }
        }
    }
}
        function syncScroll() {
            if (!markdownEditor || !markdownPreview) return;
            
            const scrollPercentage = markdownEditor.scrollTop / (markdownEditor.scrollHeight - markdownEditor.clientHeight);
            const targetScrollTop = scrollPercentage * (markdownPreview.scrollHeight - markdownPreview.clientHeight);
            markdownPreview.scrollTop = targetScrollTop;
        }

        function setupMarkdownToolbar() {
            const toolbar = document.getElementById('markdown-toolbar');
            
            toolbar.addEventListener('click', (e) => {
                const button = e.target.closest('.toolbar-btn');
                if (!button) return;
                
                const action = button.dataset.action;
                applyMarkdownAction(action);
            });
        }

        function applyMarkdownAction(action) {
            if (!markdownEditor) return;
            
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            const selectedText = markdownEditor.value.substring(start, end);
            const beforeText = markdownEditor.value.substring(0, start);
            const afterText = markdownEditor.value.substring(end);
            
            let newText = '';
            let cursorOffset = 0;
            
            function isAlreadyFormatted(text, prefix, suffix = prefix) {
                return text.startsWith(prefix) && text.endsWith(suffix);
            }
            
            function removeFormatting(text, prefix, suffix = prefix) {
                if (isAlreadyFormatted(text, prefix, suffix)) {
                    return text.substring(prefix.length, text.length - suffix.length);
                }
                return text;
            }
            
            switch (action) {
                case 'bold':
                    if (selectedText && isAlreadyFormatted(selectedText, '**')) {
                        newText = removeFormatting(selectedText, '**');
                        cursorOffset = 0;
                    } else {
                        newText = `**${selectedText}**`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'italic':
                    if (selectedText && isAlreadyFormatted(selectedText, '*') && !isAlreadyFormatted(selectedText, '**')) {
                        newText = removeFormatting(selectedText, '*');
                        cursorOffset = 0;
                    } else {
                        newText = `*${selectedText}*`;
                        cursorOffset = selectedText ? 0 : 1;
                    }
                    break;
                case 'h1':
                    if (selectedText && selectedText.startsWith('# ')) {
                        newText = selectedText.substring(2);
                        cursorOffset = 0;
                    } else {
                        newText = `# ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'h2':
                    if (selectedText && selectedText.startsWith('## ')) {
                        newText = selectedText.substring(3);
                        cursorOffset = 0;
                    } else {
                        newText = `## ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 3;
                    }
                    break;
                case 'h3':
                    if (selectedText && selectedText.startsWith('### ')) {
                        newText = selectedText.substring(4);
                        cursorOffset = 0;
                    } else {
                        newText = `### ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 4;
                    }
                    break;
                case 'quote':
                    if (selectedText && selectedText.startsWith('> ')) {
                        newText = selectedText.substring(2);
                        cursorOffset = 0;
                    } else {
                        newText = `> ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'code':
                    if (selectedText.includes('\n')) {
                        if (isAlreadyFormatted(selectedText, '```\n', '\n```')) {
                            newText = removeFormatting(selectedText, '```\n', '\n```');
                            cursorOffset = 0;
                        } else {
                            newText = `\`\`\`\n${selectedText}\n\`\`\``;
                            cursorOffset = selectedText ? 0 : 4;
                        }
                    } else {
                        if (isAlreadyFormatted(selectedText, '`')) {
                            newText = removeFormatting(selectedText, '`');
                            cursorOffset = 0;
                        } else {
                            newText = `\`${selectedText}\``;
                            cursorOffset = selectedText ? 0 : 1;
                        }
                    }
                    break;
                case 'list':
                    if (selectedText && selectedText.startsWith('- ')) {
                        newText = selectedText.substring(2);
                        cursorOffset = 0;
                    } else {
                        newText = `- ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 2;
                    }
                    break;
                case 'ordered-list':
                    if (selectedText && /^\d+\. /.test(selectedText)) {
                        newText = selectedText.replace(/^\d+\. /, '');
                        cursorOffset = 0;
                    } else {
                        newText = `1. ${selectedText}`;
                        cursorOffset = selectedText ? 0 : 3;
                    }
                    break;
                case 'link':
                    const linkPattern = /^\[([^\]]*)\]\([^)]*\)$/;
                    if (selectedText && linkPattern.test(selectedText)) {
                        const match = selectedText.match(/^\[([^\]]*)\]/);
                        newText = match ? match[1] : selectedText;
                        cursorOffset = 0;
                    } else {
                        newText = `[${selectedText || 'ŸÜÿµ ÿßŸÑÿ±ÿßÿ®ÿ∑'}](https://example.com)`;
                        cursorOffset = selectedText ? newText.length - 20 : 1;
                    }
                    break;
                case 'image':
                    const imagePattern = /^!\[([^\]]*)\]\([^)]*\)$/;
                    if (selectedText && imagePattern.test(selectedText)) {
                        const match = selectedText.match(/^!\[([^\]]*)\]/);
                        newText = match ? match[1] : selectedText;
                        cursorOffset = 0;
                    } else {
                        newText = `![${selectedText || 'ŸàÿµŸÅ ÿßŸÑÿµŸàÿ±ÿ©'}](https://example.com/image.jpg)`;
                        cursorOffset = selectedText ? newText.length - 30 : 2;
                    }
                    break;
                case 'table':
                    newText = `| ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ£ŸàŸÑ | ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ´ÿßŸÜŸä |\n|-------------|-------------|\n| ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ 1 | ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ 2 |`;
                    cursorOffset = 0;
                    break;
            }
            
            markdownEditor.value = beforeText + newText + afterText;
            
            const newCursorPos = start + newText.length - cursorOffset;
            markdownEditor.setSelectionRange(newCursorPos, newCursorPos);
            markdownEditor.focus();
            
            updateMarkdownPreview();
        }
function generateBookStructure(allLines, options = { thematic: true }) {
    const chapterStarts = allLines.reduce((acc, line, i) => {
        if (line.trim().startsWith("ŸÅÿµŸÑ")) acc.push(i);
        return acc;
    }, []);
    chapterStarts.push(allLines.length);

    const allChapters = [];
    for (let i = 0; i < chapterStarts.length - 1; i++) {
        const start = chapterStarts[i];
        const end = chapterStarts[i + 1];
        const title = (allLines[start] || "").replace(/^ŸÅÿµŸÑ\s*[:]?:?\s*/, "").trim();
        const contentString = allLines.slice(start + 1, end).join("\n");
        allChapters.push({
            title,
            content: [{ type: 'paragraph', data: contentString }]
        });
    }

    let finalSections = [];

    if (options.thematic) {
        const thematicMap = [
            {
                section_name: "ÿßŸÑÿ®ÿßÿ® ÿßŸÑÿ£ŸàŸÑ: ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿ™ŸäŸá",
                chapterIndices: [0, 1, 13, 11, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
            },
            {
                section_name: "ÿßŸÑÿ®ÿßÿ® ÿßŸÑÿ´ÿßŸÜŸä: ÿßŸÑŸÖŸÜŸáÿ¨ ÿßŸÑŸÇŸàŸäŸÖ.. ŸÉŸäŸÅ ŸÜŸÇÿ±ÿ£ ŸÉŸÑÿßŸÖ ÿ±ÿ®ŸÜÿßÿü",
                chapterIndices: [24, 25, 27, 65, 94, 95, 26, 49]
            },
            {
                section_name: "ÿßŸÑÿ®ÿßÿ® ÿßŸÑÿ´ÿßŸÑÿ´: ÿßŸÑÿßŸÜŸÇŸÑÿßÿ® ÿßŸÑÿπÿ∏ŸäŸÖ.. ŸÖÿ™Ÿâ ŸàŸÉŸäŸÅ ÿ∂ŸÑŸë ÿßŸÑÿ≤ŸÖÿßŸÜ ŸàÿßŸÑÿØŸäŸÜÿü",
                chapterIndices: [12, 28, 29, 30, 31, 32, 36, 33, 34, 35, 40, 37, 38, 39, 41, 42, 43, 48, 51, 52, 53, 55, 56, 57, 50, 44, 59, 58, 60, 61, 46, 45]
            },
            {
                section_name: "ÿßŸÑÿ®ÿßÿ® ÿßŸÑÿ±ÿßÿ®ÿπ: ŸäŸàÿ™Ÿàÿ®Ÿäÿß ÿßŸÑŸÖÿ§ŸÖŸÜŸäŸÜ.. ŸÉŸäŸÅ ŸäŸÉŸàŸÜ ÿ¥ŸÉŸÑ ÿßŸÑÿπÿßŸÑŸÖ ÿ≠ŸäŸÜ Ÿäÿ≠ŸÉŸÖ ÿßŸÑŸÑŸá Ÿàÿ≠ÿØŸáÿü",
                chapterIndices: [68, 69, 70, 67, 71, 87, 88, 47, 74, 75, 76, 72, 73, 90, 91, 89, 92, 93, 82, 83, 78, 79, 80, 81, 77]
            },
            {
                section_name: "ÿßŸÑÿ®ÿßÿ® ÿßŸÑÿÆÿßŸÖÿ≥: ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÑŸá.. ÿßŸÑÿÆÿßÿ™ŸÖÿ© ŸàÿßŸÑÿ®ÿØÿßŸäÿ©",
                chapterIndices: [97, 96, 95, 62, 63, 64, 84, 85, 86, 2, 3, 4, 5, 6, 7, 8, 9, 10]
            }
        ];

        thematicMap.forEach((part, index) => {
            const section = {
                section_name: part.section_name,
                sort: index,
                Chapters: []
            };
            part.chapterIndices.forEach(index => {
                if (allChapters[index]) {
                    section.Chapters.push(allChapters[index]);
                }
            });
            finalSections.push(section);
        });

    } else {
        finalSections = [{
            section_name: "ŸÅÿµŸàŸÑ ÿßŸÑŸÉÿ™ÿßÿ®",
            sort: 0,
            Chapters: allChapters
        }];
    }
    
    return {
        name: allLines[0] || "ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ",
        bio: allLines.slice(1, 15).join("\n"),
        sections: finalSections
    };
}


function initializeJsonFromTxt() {
            const importMethod = document.getElementById('import-method').value;
            if (importMethod === 'suggested' && allLines.length > 0) {
                bookData = generateBookStructure(allLines, { thematic: true });
                lastSavedBook = null;
                renderApp();
                return;
            }
            
            const chapterStarts = allLines.reduce((acc, line, i) => {
                if (line.trim().startsWith("ŸÅÿµŸÑ")) acc.push(i);
                return acc;
            }, []);
            chapterStarts.push(allLines.length);

            const chapters = [];
            for (let i = 0; i < chapterStarts.length - 1; i++) {
                const start = chapterStarts[i];
                const end = chapterStarts[i + 1];
                const title = (allLines[start] || "").replace(/^ŸÅÿµŸÑ\s*[:]?:?\s*/, "").trim();
                const contentString = allLines.slice(start + 1, end).join("\n");
                chapters.push({
                    title,
                    content: [{ type: 'paragraph', data: contentString }]
                });
            }
            
            bookData = {
                name: allLines[0] || "ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ",
                bio: allLines.slice(1, 15).join("\n"),
                sections: [{ section_name: "ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÉÿßŸÖŸÑ", sort: 0, Chapters: chapters }]
            };
            lastSavedBook = null;
			ensureUniqueIDs(bookData);
            normalizeAuditDefaults(bookData);
            renderApp();
        }

        function renderApp() {
            if (bookData) ensureBookSchema(bookData);
            renderTreeView();
            if (activePath.section !== null && activePath.chapter !== null) {
                renderContent();
                                ensureChapterAIBar();

            } else {
                switchView('viewer');
                viewerTitle.textContent = "ÿßÿÆÿ™ÿ± ŸÅÿµŸÑÿßŸã ŸÑÿπÿ±ÿ∂Ÿá";
                viewerContent.innerHTML = "<p>ŸäŸÖŸÉŸÜŸÉ ÿ™ÿµŸÅÿ≠ ÿßŸÑŸÉÿ™ÿßÿ® ŸÖŸÜ ÿßŸÑŸÅŸáÿ±ÿ≥ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä.</p>";
            }
            updateContentButtonsVisibility();
            renderAuditBadge();

            updatePrintButtonVisibility();
			
        }

        function renderTreeView() {
            if (!bookData) return;
            treeContainer.innerHTML = '';
            
            const bookTitle = document.createElement('div');
            bookTitle.className = 'tree-item p-3 rounded-lg cursor-pointer font-bold text-lg border-2 border-blue-500 bg-blue-900 slide-in';
            bookTitle.textContent = getLocalizedBookName(bookData, currentLanguage) || 'ŸÉÿ™ÿßÿ® ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ';
            bookTitle.dataset.type = 'book';
            bookTitle.addEventListener('click', () => {
                activePath = { section: null, chapter: null };
                updateContentButtonsVisibility();
                renderAuditBadge();

                renderApp();
            });
            bookTitle.addEventListener('contextmenu', handleContextMenu);
            treeContainer.appendChild(bookTitle);

            const sortedSections = [...bookData.sections].sort((a, b) => (a.sort || 0) - (b.sort || 0));

            sortedSections.forEach((section, sectionIndex) => {
                const originalIndex = bookData.sections.indexOf(section);
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'tree-item tree-item-section p-2 rounded-lg cursor-pointer mr-4 slide-in';
                sectionDiv.style.animationDelay = `${sectionIndex * 0.1}s`;
                sectionDiv.style.paddingLeft = '24px';
                sectionDiv.textContent = `${sectionIndex + 1}. ${getLocalizedSectionName(section, currentLanguage || 'ar')}`;
                sectionDiv.dataset.type = 'section';
                sectionDiv.dataset.sectionIndex = originalIndex;
                
                if (!section.collapsed) {
                    section.collapsed = false;
                }
                
                if (section.collapsed) {
                    sectionDiv.classList.add('collapsed');
                }
                
                sectionDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    section.collapsed = !section.collapsed;
                    renderTreeView();
                    if (!section.collapsed) {
                        activePath = { section: originalIndex, chapter: null };
                        updateContentButtonsVisibility();
                        renderAuditBadge();

                        renderApp();
                    }
                });
                
                sectionDiv.addEventListener('contextmenu', handleContextMenu);
                sectionDiv.draggable = true;
                sectionDiv.addEventListener('dragstart', handleDragStart);
                sectionDiv.addEventListener('dragover', handleDragOver);
                sectionDiv.addEventListener('drop', handleDrop);
                sectionDiv.addEventListener('dragend', handleDragEnd);
                treeContainer.appendChild(sectionDiv);

                const chaptersContainer = document.createElement('div');
                chaptersContainer.className = `chapters-container ${section.collapsed ? 'collapsed' : 'expanded'}`;
                
                section.Chapters.forEach((chapter, chapterIndex) => {
                    const chapterDiv = document.createElement('div');
                    chapterDiv.className = 'tree-item tree-item-chapter p-2 rounded-lg cursor-pointer mr-6 slide-in';
                    chapterDiv.style.animationDelay = `${(sectionIndex * section.Chapters.length + chapterIndex) * 0.05}s`;
                    chapterDiv.textContent = `${sectionIndex + 1}.${chapterIndex + 1} ${getLocalizedTitle(chapter, currentLanguage || 'ar')}`;
                    chapterDiv.dataset.type = 'chapter';
                    chapterDiv.dataset.sectionIndex = originalIndex;
                    chapterDiv.dataset.chapterIndex = chapterIndex;
                    chapterDiv.addEventListener('click', () => {
                        // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÇÿ®ŸÑ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÅÿµŸÑ
                        if (currentView === 'editor') {
                            protectContentFromLoss();
                            if (markdownEditor && markdownEditor.value.trim() !== '') {
                                saveCurrentEditorContent();
                            }
                        }
                        activePath = { section: originalIndex, chapter: chapterIndex };
                        
                        if (currentView === 'editor') {
                            renderContent();
                        } else {
                            switchView('viewer');
                            renderApp();
                        }
                    });
                    chapterDiv.addEventListener('contextmenu', handleContextMenu);
                    chapterDiv.draggable = true;
                    chapterDiv.addEventListener('dragstart', handleDragStart);
                    chapterDiv.addEventListener('dragover', handleDragOver);
                    chapterDiv.addEventListener('drop', handleDrop);
                    chapterDiv.addEventListener('dragend', handleDragEnd);
                    chaptersContainer.appendChild(chapterDiv);

                    if (activePath.section === originalIndex && activePath.chapter === chapterIndex) {
                        chapterDiv.classList.add('tree-item-active');
                    }
                });
                
                treeContainer.appendChild(chaptersContainer);

                if (activePath.section === originalIndex && activePath.chapter === null) {
                    sectionDiv.classList.add('tree-item-active');
                }
            });
            
            updateContentButtonsVisibility();
            renderAuditBadge();

        }
        
              function renderContent() {
            if (!bookData || activePath.section === null || activePath.chapter === null) {
                updateContentButtonsVisibility();
                renderAuditBadge();

                return;
            }
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            
            // Ensure content array exists
            if (!chapter.content) {
                chapter.content = [{ type: 'paragraph', data: [{ ar: '' }] }];
            }
            
            renderViewerContentOnly();
            
            editorTitleInput.value = getLocalizedTitle(chapter, currentLanguage || 'ar');
            
            const inlineTitle = document.getElementById('editor-title-inline');
            if (inlineTitle) inlineTitle.value = getLocalizedTitle(chapter, currentLanguage || 'ar');
            
            updateEditorControls();
            updateContentButtonsVisibility();
            renderAuditBadge();

            updatePrintButtonVisibility();
            
            if (markdownEditor) {
                const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                markdownEditor.value = content;
                updateMarkdownPreview();
            }
			
			
        }

        function renderViewerContentOnly() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            viewerTitle.textContent = getLocalizedTitle(chapter, currentLanguage || 'ar');
            viewerContent.innerHTML = '';
            (chapter.content || []).forEach(block => {
    viewerContent.appendChild(renderBlockForViewer(block));
});

        }

        function renderBlockForViewer(block) {
            const container = document.createElement('div');
            container.className = 'content-block-viewer mb-6';
            switch(block.type) {
                case 'paragraph':
                    container.innerHTML = marked.parse(getFromLangArray(block.data, currentLanguage) || '', { breaks: true });
                    container.querySelectorAll('pre code').forEach((el) => {
                        hljs.highlightElement(el);
                    });
                    break;
                case 'image':
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'my-6 text-center';
                    const img = document.createElement('img');
                    img.src = block.data.url;
                    img.alt = block.data.title;
                    img.className = 'max-w-full h-auto mx-auto rounded-lg shadow-lg';
                    imgContainer.appendChild(img);
                    if (block.data.title) {
                        const title = document.createElement('h3');
                        title.className = 'text-lg font-semibold mt-3 text-gray-300';
                        title.textContent = block.data.title;
                        imgContainer.appendChild(title);
                    }
                    if (block.data.caption) {
                        const caption = document.createElement('p');
                        caption.className = 'text-sm text-gray-400 italic mt-2';
                        caption.textContent = block.data.caption;
                        imgContainer.appendChild(caption);
                    }
                    container.appendChild(imgContainer);
                    break;
                case 'table':
                     const tableContainer = document.createElement('div');
                     tableContainer.className = 'overflow-x-auto my-6';
                     if (block.data.title) {
                        const title = document.createElement('h3');
                        title.className = 'text-xl font-bold mb-3 text-center text-gray-200';
                        title.textContent = block.data.title;
                        tableContainer.appendChild(title);
                     }
                     const table = document.createElement('table');
                     table.className = 'w-full text-sm text-right text-gray-400 bg-gray-800 rounded-lg';
                     const rows = (block.data.csv || '').split('\n').filter(row => row.trim() !== '');
                     if (rows.length > 0) {
                        const thead = document.createElement('thead');
                        thead.className = 'text-xs text-gray-300 uppercase bg-gray-700';
                        const headerRow = document.createElement('tr');
                        rows[0].split(',').forEach(headerText => {
                            const th = document.createElement('th');
                            th.scope = 'col';
                            th.className = 'px-6 py-3';
                            th.textContent = headerText.trim();
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        rows.slice(1).forEach(rowText => {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b bg-gray-800 border-gray-700 hover:bg-gray-600';
                            rowText.split(',').forEach(cellText => {
                                const td = document.createElement('td');
                                td.className = 'px-6 py-4';
                                td.textContent = cellText.trim();
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                     }
                     tableContainer.appendChild(table);
                     container.appendChild(tableContainer);
                    break;
            }
            return container;
        }

              function addContentBlock(type) {
            if (activePath.section === null || activePath.chapter === null) {
                alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÅÿµŸÑ ÿ£ŸàŸÑÿßŸã ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿ™ŸàŸâ ÿ•ŸÑŸäŸá.");
                return;
            }
            
            if (!bookData.sections[activePath.section].Chapters[activePath.chapter].content) {
                bookData.sections[activePath.section].Chapters[activePath.chapter].content = [];
            }
            
            let newBlock;
            switch(type) {
                case 'paragraph':
                    newBlock = { type: 'paragraph', data: 'ŸÜÿµ ÿ¨ÿØŸäÿØ...' };
                    break;
                case 'image':
                    newBlock = { type: 'image', data: { url: '', title: '', caption: '' } };
                    break;
                case 'table':
                    newBlock = { type: 'table', data: { title: '', csv: 'ÿπŸÖŸàÿØ1,ÿπŸÖŸàÿØ2\nÿ®ŸäÿßŸÜÿßÿ™1,ÿ®ŸäÿßŸÜÿßÿ™2' } };
                    break;
            }
            
            bookData.sections[activePath.section].Chapters[activePath.chapter].content.push(newBlock);
            
            if (currentView === 'viewer') {
                renderViewerContentOnly();
                const newBlockIndex = bookData.sections[activePath.section].Chapters[activePath.chapter].content.length - 1;
                setTimeout(() => {
                    createInlineEditor(newBlockIndex, type);
                }, 100);
            } else {
                renderContent();
            }
            
            setTimeout(() => {
                saveBookToIndexedDB();
            }, 100);
        }

        function createInlineEditor(blockIndex, blockType) {
            const viewerContent = document.getElementById('viewer-content');
            const blocks = viewerContent.children;
            
            if (blockIndex >= blocks.length) return;
            
            const block = blocks[blockIndex];
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            const contentBlock = chapter.content[blockIndex];
            
            if (blockType === 'paragraph') {
                createParagraphEditor(block, blockIndex, contentBlock);
            } else if (blockType === 'image') {
                createImageEditor(block, blockIndex, contentBlock);
            } else if (blockType === 'table') {
                createTableEditor(block, blockIndex, contentBlock);
            }
        }

        function createParagraphEditor(element, blockIndex, contentBlock) {
    const textarea = document.createElement('textarea');
    let localizedText = '';
    // Use getFromLangArray for compatibility
    if (Array.isArray(contentBlock.data)) {
        localizedText = getFromLangArray(contentBlock.data, currentLanguage);
    } else if (typeof contentBlock.data === 'string') {
        localizedText = contentBlock.data;
    } else {
        localizedText = contentBlock.text || '';
    }
    textarea.value = localizedText;
    textarea.className = 'w-full p-3 border rounded-lg resize-none';
    textarea.style.minHeight = '100px';
    textarea.style.fontFamily = 'inherit';
    textarea.style.fontSize = 'inherit';
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex gap-2 mt-2';
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'ÿ≠ŸÅÿ∏';
    saveBtn.className = 'btn btn-success';
    saveBtn.onclick = () => {
        const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
        const blockToUpdate = chapter.content[blockIndex];
        // Use setInLangArray for compatibility
        if (typeof blockToUpdate.data === 'string') {
            blockToUpdate.data = setInLangArray([], currentLanguage, textarea.value);
        } else {
            blockToUpdate.data = setInLangArray(blockToUpdate.data, currentLanguage, textarea.value);
        }
        blockToUpdate.text = textarea.value;
        saveBlockAndRefresh(blockIndex, blockToUpdate);
    };
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'ÿ•ŸÑÿ∫ÿßÿ°';
    cancelBtn.className = 'btn btn-secondary';
    cancelBtn.onclick = () => renderViewerContentOnly();
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'ÿ≠ÿ∞ŸÅ';
    deleteBtn.className = 'btn btn-danger';
    deleteBtn.onclick = () => deleteContentBlock(blockIndex);
    buttonContainer.appendChild(saveBtn);
    buttonContainer.appendChild(cancelBtn);
    buttonContainer.appendChild(deleteBtn);
    element.innerHTML = '';
    element.appendChild(textarea);
    element.appendChild(buttonContainer);
    textarea.focus();
}

        function createImageEditor(element, blockIndex, contentBlock) {
            const container = document.createElement('div');
            container.className = 'space-y-3';
            // Support both {url, title, caption} and {data: {url, title, caption}}
            let url = contentBlock.url || (contentBlock.data && contentBlock.data.url) || '';
            let title = contentBlock.title || (contentBlock.data && contentBlock.data.title) || '';
            let caption = contentBlock.caption || (contentBlock.data && contentBlock.data.caption) || '';

            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.placeholder = 'ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©';
            urlInput.value = url;
            urlInput.className = 'w-full p-2 border rounded';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.placeholder = 'ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸàÿ±ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)';
            titleInput.value = title;
            titleInput.className = 'w-full p-2 border rounded';

            const captionInput = document.createElement('textarea');
            captionInput.placeholder = 'ŸàÿµŸÅ ÿßŸÑÿµŸàÿ±ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)';
            captionInput.value = caption;
            captionInput.className = 'w-full p-2 border rounded resize-none';
            captionInput.rows = 2;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex gap-2';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ÿ≠ŸÅÿ∏';
            saveBtn.className = 'btn btn-success';
            saveBtn.onclick = () => saveBlockAndRefresh(blockIndex, {
                type: 'image',
                data: {
                    url: urlInput.value,
                    title: titleInput.value,
                    caption: captionInput.value
                }
            });

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'ÿ•ŸÑÿ∫ÿßÿ°';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.onclick = () => renderViewerContentOnly();

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'ÿ≠ÿ∞ŸÅ';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.onclick = () => deleteContentBlock(blockIndex);

            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(deleteBtn);

            container.appendChild(urlInput);
            container.appendChild(titleInput);
            container.appendChild(captionInput);
            container.appendChild(buttonContainer);

            element.innerHTML = '';
            element.appendChild(container);

            urlInput.focus();
        }

        function createTableEditor(element, blockIndex, contentBlock) {
            const container = document.createElement('div');
            container.className = 'space-y-3';
            // Support both {title, csv} and {data: {title, csv}}
            let title = contentBlock.title || (contentBlock.data && contentBlock.data.title) || '';
            let csv = contentBlock.csv || (contentBlock.data && contentBlock.data.csv) || '';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.placeholder = 'ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)';
            titleInput.value = title;
            titleInput.className = 'w-full p-2 border rounded';

            const csvTextarea = document.createElement('textarea');
            csvTextarea.placeholder = 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸàŸÑ (CSV - ŸÅÿßÿµŸÑÿ© ÿ®ŸäŸÜ ÿßŸÑÿ£ÿπŸÖÿØÿ©ÿå ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ ÿ®ŸäŸÜ ÿßŸÑÿµŸÅŸàŸÅ)';
            csvTextarea.value = csv;
            csvTextarea.className = 'w-full p-2 border rounded resize-none';
            csvTextarea.rows = 6;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex gap-2';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ÿ≠ŸÅÿ∏';
            saveBtn.className = 'btn btn-success';
            saveBtn.onclick = () => {
                const csvData = csvTextarea.value.trim();
                saveBlockAndRefresh(blockIndex, {
                    type: 'table',
                    data: {
                        title: titleInput.value,
                        csv: csvData
                    }
                });
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'ÿ•ŸÑÿ∫ÿßÿ°';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.onclick = () => renderViewerContentOnly();

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'ÿ≠ÿ∞ŸÅ';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.onclick = () => deleteContentBlock(blockIndex);

            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(deleteBtn);

            container.appendChild(titleInput);
            container.appendChild(csvTextarea);
            container.appendChild(buttonContainer);

            element.innerHTML = '';
            element.appendChild(container);

            titleInput.focus();
        }

        function saveBlockAndRefresh(blockIndex, newBlock) {
    if (activePath.section !== null && activePath.chapter !== null) {
        const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
        if (newBlock.type === 'paragraph') {
            const oldBlock = chapter.content[blockIndex];
            // Use setInLangArray for compatibility
            if (typeof oldBlock.data === 'string') {
                oldBlock.data = setInLangArray([], currentLanguage, newBlock.text);
            } else {
                oldBlock.data = setInLangArray(oldBlock.data, currentLanguage, newBlock.text);
            }
            oldBlock.text = newBlock.text;
        } else {
            chapter.content[blockIndex] = newBlock;
        }
        saveBookToIndexedDB();
        renderViewerContentOnly();
    }
}

        function deleteContentBlock(blockIndex) {
            if (activePath.section !== null && activePath.chapter !== null) {
                if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ÿ™ŸàŸâÿü')) {
                    bookData.sections[activePath.section].Chapters[activePath.chapter].content.splice(blockIndex, 1);
                    saveBookToIndexedDB();
                    renderViewerContentOnly();
                }
            }
        }

        function updateContentButtonsVisibility() {
            const contentButtons = document.getElementById('content-buttons-container');
            const printBtn = document.getElementById('print-btn');
            const hasActiveChapter = activePath.section !== null && activePath.chapter !== null;
            
            if (contentButtons) {
                contentButtons.style.display = hasActiveChapter ? 'block' : 'none';
            }
            
            if (printBtn) {
                printBtn.style.display = hasActiveChapter ? 'inline-block' : 'none';
            }
        }

        function updatePrintButtonVisibility() {
            const printBtn = document.getElementById('print-btn');
            if (printBtn) {
                if (activePath.section !== null && activePath.chapter !== null) {
                    printBtn.style.display = 'block';
                } else {
                    printBtn.style.display = 'none';
                }
            }
        }

// ‚¨áÔ∏è ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿßŸÑÿØÿßŸÑÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
function editBookInfo() {
    if (!bookData) {
        alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ŸÉÿ™ÿßÿ® ÿ£ŸàŸÑÿßŸã.");
        return;
    }

    // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑŸÑÿ∫ÿßÿ™ ŸÑŸÑÿßÿ≥ŸÖ
    document.getElementById('book-title-input-ar').value = getLocalizedBookName(bookData, 'ar') || '';
    document.getElementById('book-title-input-en').value = getLocalizedBookName(bookData, 'en') || '';

    // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑŸÑÿ∫ÿßÿ™ ŸÑŸÑŸÖŸÇÿØŸÖÿ©
    // ŸÜÿ≥ÿ™ÿÆÿØŸÖ getFromLangArray ŸÑÿ£ŸÜ bio ÿ£ÿµÿ®ÿ≠ ÿßŸÑÿ¢ŸÜ ÿ®ŸÜŸäÿ© ÿ®ŸäÿßŸÜÿßÿ™
    document.getElementById('book-bio-input-ar').value = getFromLangArray(bookData.bio, 'ar') || '';
    document.getElementById('book-bio-input-en').value = getFromLangArray(bookData.bio, 'en') || '';

    // ÿ¨ŸÑÿ® ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿπÿßÿ±
    document.getElementById('book-alias-input').value = bookData.alias || '';
    document.getElementById('book-id-input').value = bookData.subjectId || bookData.alias || '';
    document.getElementById('book-icon-input').value = bookData.icon || 'üìò';
    document.getElementById('book-color-input').value = bookData.color || '#2563eb';
    document.getElementById('book-cover-input').value = bookData.cover || '';

    updateBioPreview(); // ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿßŸäŸÜÿ© (ÿ≥ÿ™ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)
    document.getElementById('book-info-modal').classList.remove('hidden');
}

// ‚¨áÔ∏è ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿßŸÑÿØÿßŸÑÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
function saveBookInfo() {
    if (!bookData) return;

    // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
    const newTitleAr = document.getElementById('book-title-input-ar').value.trim();
    const newTitleEn = document.getElementById('book-title-input-en').value.trim();
    const newBioAr = document.getElementById('book-bio-input-ar').value;
    const newBioEn = document.getElementById('book-bio-input-en').value;
    // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿπÿßÿ± (ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ÿ®ŸÄ -)
    const newAlias = document.getElementById('book-alias-input').value.trim().replace(/\s+/g, '-');
    const newSubjectId = document.getElementById('book-id-input').value.trim();
    const newIcon = document.getElementById('book-icon-input').value.trim() || 'üìò';
    const newColor = document.getElementById('book-color-input').value || '#2563eb';
    const newCover = document.getElementById('book-cover-input').value.trim();

    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ setInLangArray ŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÉÿßÿ¶ŸÜ ÿßŸÑÿßÿ≥ŸÖ
    bookData.name = setInLangArray(bookData.name, 'ar', newTitleAr);
    bookData.name = setInLangArray(bookData.name, 'en', newTitleEn);

    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ setInLangArray ŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÉÿßÿ¶ŸÜ ÿßŸÑŸÖŸÇÿØŸÖÿ©
    bookData.bio = setInLangArray(bookData.bio, 'ar', newBioAr);
    bookData.bio = setInLangArray(bookData.bio, 'en', newBioEn);

    // ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿπÿßÿ±
    bookData.alias = newAlias;
    bookData.subjectId = slugify(newSubjectId || newAlias || newTitleEn || newTitleAr || 'subject');
    bookData.icon = newIcon;
    bookData.color = newColor;
    bookData.cover = newCover;
    ensureBookSchema(bookData);

    document.getElementById('book-info-modal').classList.add('hidden');
    renderApp(); // ŸÑÿ•ÿπÿßÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
    alert("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠!");
}
function exportPlainText(){
    if(!bookData)return;
    let parts=[];
    const sectionsSorted=[...bookData.sections].sort((a,b)=>(a.sort||0)-(b.sort||0));
    sectionsSorted.forEach(sec=>{
        if(!Array.isArray(sec.Chapters))return;
        sec.Chapters.forEach(ch=>{
            const t=getLocalizedTitle(ch,currentLanguage||'ar')||'';
            let body='';
            if(Array.isArray(ch.content)){
                for(const block of ch.content){
                    if(block&&block.type==='paragraph'){
                        let v='';
                        if(Array.isArray(block.data))v=getFromLangArray(block.data,currentLanguage||'ar');
                        else if(typeof block.data==='string')v=block.data;
                        else v=getFromLangArray(block.data,currentLanguage||'ar');
                        if(v){
                            // ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÜÿµŸàÿµ ŸÑŸÑÿ™ÿµÿØŸäÿ±
                            v = v.replace(/\\n/g, '\n').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                            body+=v+"\n\n";
                        }
                    }
                }
            }
            const entry=((t?t+"\n":"")+(body||''));
            parts.push(entry.trim());
        });
    });
    const fileContent=parts.join("\n\n");
    const blob=new Blob([fileContent],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a');
    const bookName=(getLocalizedBookName(bookData,currentLanguage||'ar')||'book').replace(/[\\\/:*?"<>|]/g,'_');
    a.href=URL.createObjectURL(blob);
    a.download=bookName+"_plain.txt";
    document.body.appendChild(a);a.click();a.remove();
    URL.revokeObjectURL(a.href);
}
function openChangeLogs(){
  if(!bookData||activePath.section===null||activePath.chapter===null)return;
  const ch=bookData.sections[activePath.section].Chapters[activePath.chapter];
  const logs=Array.isArray(ch.changeLogs)?ch.changeLogs:[];
  let modal=document.getElementById('logs-modal');
  if(!modal){
    modal=document.createElement('div');
    modal.id='logs-modal';
    modal.className='fixed inset-0 z-50 flex items-center justify-center';
    modal.innerHTML='<div class="absolute inset-0 bg-black/50"></div><div class="relative bg-white text-black rounded p-4 max-w-4xl w-full"><h3 class="font-bold mb-3">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</h3><div id="logs-list" class="space-y-3"></div><div class="mt-4 text-end"><button id="logs-close" class="btn">ÿ•ÿ∫ŸÑÿßŸÇ</button></div></div>';
    document.body.appendChild(modal);
    modal.querySelector('#logs-close').onclick=()=>modal.classList.add('hidden');
  }
  const esc=s=>String(s||'').replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  const list=modal.querySelector('#logs-list');
  list.innerHTML=logs.map(l=>`<div class="border rounded p-2"><div class="flex items-center justify-between"><div><b>${l.type}</b> ‚Äî ${l.lang} ‚Äî ${l.provider||''} ${l.model||''}</div><div class="text-sm text-gray-500">${l.at}</div></div><details class="mt-2"><summary>ŸÇÿ®ŸÑ</summary><pre class="whitespace-pre-wrap">${esc(l.before)}</pre></details><details class="mt-2"><summary>ÿ®ÿπÿØ</summary><pre class="whitespace-pre-wrap">${esc(l.after)}</pre></details></div>`).join('')||'<div class="text-gray-500">ŸÑÿß ÿ≥ÿ¨ŸÑÿßÿ™</div>';
  modal.classList.remove('hidden');
}

function printCurrentChapter() {
    if (activePath.section === null || activePath.chapter === null) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÅÿµŸÑ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©');
        return;
    }
    
    const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
    const bookTitleTxt = getLocalizedBookName(bookData, currentLanguage || 'ar') || 'ŸÖÿ≠ÿ±ÿ± ÿßŸÑŸÉÿ™ÿ® ÿßŸÑŸÖÿ™ŸÇÿØŸÖ';
    const sectionName = getLocalizedSectionName(bookData.sections[activePath.section], currentLanguage || 'ar') || '';
    const chapterTitleTxt = getLocalizedTitle(chapter, currentLanguage || 'ar');
    const chapterNumber = activePath.chapter + 1;
    const printWindow = window.open('', '_blank');
    const docLang = currentLanguage || 'ar';
    const docDir = currentDirection === 'rtl' ? 'rtl' : 'ltr';

    let printContent = `
        <!DOCTYPE html>
        <html lang="${docLang}" dir="${docDir}">
        <head>
            <meta charset="UTF-8">
            <title>${chapterTitleTxt}</title>
            <style>
                @page {
                    size: A4;
                    margin: 2cm 1.5cm 2.5cm 1.5cm;
                    @top-center {
                        content: "${bookTitleTxt} - ${chapterTitleTxt}";
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 10pt;
                        color: #666;
                        border-bottom: 1px solid #ddd;
                        padding-bottom: 5px;
                    }
                    @bottom-center {
                        content: "ÿ∑Ÿèÿ®ÿπ ÿ®ŸÜÿ∏ÿßŸÖ ŸÖÿ≠ÿ±ÿ± ÿßŸÑŸÉÿ™ÿ® ÿßŸÑŸÖÿ™ŸÇÿØŸÖ";
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 8pt;
                        color: #999;
                        font-style: italic;
                        border-top: 1px solid #eee;
                        padding-top: 5px;
                    }
                    @bottom-right {
                        content: "ÿµŸÅÿ≠ÿ© " counter(page);
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 9pt;
                        color: #666;
                    }
                }

                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    direction: ${docDir};
                    margin: 0;
                    padding: 0;
                    line-height: 1.8;
                    color: #333;
                    background: white;
                }
                
                .print-header {
                    text-align: center;
                    border-bottom: 3px double #333;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                    page-break-inside: avoid;
                }
                
                .book-title {
                    font-size: 18pt;
                    font-weight: bold;
                    color: #2c3e50;
                    margin-bottom: 8px;
                    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                }
                
                .chapter-info {
                    font-size: 14pt;
                    color: #34495e;
                    margin-bottom: 5px;
                }
                
                .chapter-number {
                    font-size: 12pt;
                    color: #7f8c8d;
                    font-weight: normal;
                }
                
                .content {
                    margin: 0;
                    font-size: 12pt;
                    text-align: justify;
                }
                
                .content h1, .content h2, .content h3 {
                    color: #2c3e50;
                    margin: 25px 0 15px 0;
                    page-break-after: avoid;
                }
                
                .content h1 {
                    font-size: 16pt;
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 5px;
                }
                
                .content h2 {
                    font-size: 14pt;
                    border-bottom: 1px solid #bdc3c7;
                    padding-bottom: 3px;
                }
                
                .content h3 {
                    font-size: 13pt;
                }
                
                .image {
                    text-align: center;
                    margin: 25px 0;
                    page-break-inside: avoid;
                    border: 1px solid #ecf0f1;
                    padding: 15px;
                    background: #fafafa;
                }
                
                .image img {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #ddd;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                .image h3 {
                    margin: 10px 0 5px 0;
                    font-size: 11pt;
                    color: #2c3e50;
                }
                
                .image p {
                    margin: 5px 0;
                    font-size: 10pt;
                    color: #7f8c8d;
                    font-style: italic;
                }
                
                .table {
                    margin: 25px 0;
                    page-break-inside: avoid;
                }
                
                .table h3 {
                    margin-bottom: 10px;
                    font-size: 12pt;
                    color: #2c3e50;
                }
                
                .table table {
                    width: 100%;
                    border-collapse: collapse;
                    border: 2px solid #34495e;
                    background: white;
                }
                
                .table th {
                    background: linear-gradient(135deg, #34495e, #2c3e50);
                    color: white;
                    padding: 12px 8px;
                    text-align: center;
                    font-weight: bold;
                    border: 1px solid #2c3e50;
                }
                
                .table td {
                    border: 1px solid #bdc3c7;
                    padding: 10px 8px;
                    text-align: start;
                    background: #fdfdfd;
                }
                
                .table tr:nth-child(even) td {
                    background: #f8f9fa;
                }
                
                .table tr:hover td {
                    background: #e8f4fd;
                }
                
                .decorative-border {
                    border: 2px solid #3498db;
                    border-radius: 8px;
                    padding: 20px;
                    margin: 20px 0;
                    background: linear-gradient(135deg, #ffffff, #f8f9fa);
                    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
                }
                
                @media print {
                    body {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                    }
                    
                    .page-break {
                        page-break-before: always;
                    }
                    
                    .no-break {
                        page-break-inside: avoid;
                    }
                }
            </style>
        </head>
        <body>
            <div class="decorative-border">
                <div class="print-header">
                    <div class="book-title">${bookTitleTxt}</div>
                    <div class="chapter-info">${chapterTitleTxt}</div>
                    <div class="chapter-number">ÿßŸÑŸÅÿµŸÑ ÿ±ŸÇŸÖ ${chapterNumber} - ${sectionName}</div>
                </div>
                
                <div class="content">
    `;
    
    if (chapter.content && chapter.content.length > 0) {
        chapter.content.forEach(block => {
            if (block.type === 'paragraph') {
                let text = '';
                if (Array.isArray(block.data)) {
                    text = getFromLangArray(block.data, currentLanguage || 'ar');
                } else if (typeof block.data === 'string') {
                    text = block.data;
                } else {
                    text = block.text || '';
                }
                
                // ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÜÿµŸàÿµ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©
                if (text) {
                    // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿßŸÑÿÆÿßÿµÿ© Ÿàÿ™ÿ≠ŸàŸäŸÑ \n ÿ•ŸÑŸâ ÿ£ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØÿ©
                    text = text
                        .replace(/\\n/g, '\n')  // ÿ™ÿ≠ŸàŸäŸÑ \n ÿ•ŸÑŸâ ÿ£ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØÿ© ÿ≠ŸÇŸäŸÇŸäÿ©
                        .replace(/\r\n/g, '\n')
                        .replace(/\r/g, '\n')
                        .replace(/\n\s*\n\s*\n/g, '\n\n');
                    
                    // ÿ™ÿ≠ŸàŸäŸÑ Markdown ÿ•ŸÑŸâ HTML
                    try {
                        const html = marked.parse(text, { breaks: true });
                        printContent += html;
                    } catch (error) {
                        // ŸÅŸä ÿ≠ÿßŸÑÿ© ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸàŸäŸÑ Markdownÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿµ ÿßŸÑÿπÿßÿØŸä ŸÖÿπ ÿ™ÿ≠ŸàŸäŸÑ ÿ£ÿ≥ÿßÿ≥Ÿä
                        const simpleHtml = text
                            .replace(/\n/g, '<br>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>');
                        printContent += `<p>${simpleHtml}</p>`;
                    }
                } else {
                    printContent += '<p>[ŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ±ÿ∫]</p>';
                }
            } else if (block.type === 'image') {
                let url = block.url || (block.data && block.data.url) || '';
                let title = block.title || (block.data && block.data.title) || '';
                let caption = block.caption || (block.data && block.data.caption) || '';
                printContent += `
                    <div class="image no-break">
                        <img src="${url}" alt="${title || ''}" />
                        ${title ? `<h3>${title}</h3>` : ''}
                        ${caption ? `<p>${caption}</p>` : ''}
                    </div>
                `;
            } else if (block.type === 'table') {
                let title = block.title || (block.data && block.data.title) || '';
                let csv = block.csv || (block.data && block.data.csv) || '';
                let rows = csv.split('\n').filter(row => row.trim() !== '');
                printContent += `
                    <div class="table no-break">
                        ${title ? `<h3>${title}</h3>` : ''}
                        <table>
                            ${rows.length > 0 ?
                                rows.map((row, index) => {
                                    const cells = row.split(',');
                                    return `<tr>${cells.map(cell => index === 0 ? `<th>${cell.trim()}</th>` : `<td>${cell.trim()}</td>`).join('')}</tr>`;
                                }).join('') :
                                '<tr><td>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td></tr>'
                            }
                        </table>
                    </div>
                `;
            }
        });
    } else {
        printContent += '<p>ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÅÿµŸÑ.</p>';
    }
    
    printContent += `
                </div>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }, 500);
    };
}
        function switchView(viewName) {
            // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÇÿ®ŸÑ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿπÿ±ÿ∂
            if (currentView === 'editor' && viewName !== 'editor') {
                protectContentFromLoss();
                if (markdownEditor && markdownEditor.value.trim() !== '') {
                    saveCurrentEditorContent();
                }
            }
            currentView = viewName;

            viewTabBtn.classList.remove('tab-active-main');
            editTabBtn.classList.remove('tab-active-main');
            
            if (viewName === 'viewer') {
                viewerDiv.classList.remove('hidden');
                editorDiv.classList.add('hidden');
                viewTabBtn.classList.add('tab-active-main');
                if (activePath.section !== null && activePath.chapter !== null) renderContent();
            } else {
                if (activePath.section === null || activePath.chapter === null) {
                    alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÅÿµŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿ™ÿ≠ÿ±Ÿäÿ±.");
                    switchView('viewer');
                    return;
                }
                viewerDiv.classList.add('hidden');
                editorDiv.classList.remove('hidden');
                editTabBtn.classList.add('tab-active-main');
                
                if (!markdownEditor) {
                    setTimeout(() => {
                        initializeMarkdownEditor();
                        setTheme(currentTheme);
                        updateFontSize();
                        renderContent();
                    }, 100);
                } else {
                    renderContent();
                }
            }
        }
        
        function saveCurrentEditorContent() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
            if (!chapter) return;

            if (!chapter.content) {
                chapter.content = [{ type: 'paragraph', data: [{ ar: '' }] }];
            }

            // ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿ£ŸÖÿßŸÜ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
            if (editorTitleInput && editorTitleInput.value !== undefined) {
                const newTitle = (editorTitleInput.value || '').trim();
                const currentTitle = getLocalizedTitle(chapter, currentLanguage || 'ar') || '';
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÜŸàÿßŸÜ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿÆÿ™ŸÑŸÅÿßŸã ŸàŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿ≠ÿ±ŸÅ ÿÆÿßÿµÿ© ÿ∂ÿßÿ±ÿ©
                if (newTitle !== currentTitle && newTitle.length <= 500) {
                    try {
                        setLocalizedTitle(chapter, currentLanguage || 'ar', newTitle);
                        console.log('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠:', newTitle);
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÜŸàÿßŸÜ:', error);
                    }
                }
            }

            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ®ÿ£ŸÖÿßŸÜ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑÿ≠ÿ¨ŸÖ
            if (markdownEditor && markdownEditor.value !== undefined) {
                const newContent = markdownEditor.value || '';
                const currentContent = getLocalizedContent(chapter, currentLanguage || 'ar') || '';
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿÆÿ™ŸÑŸÅÿßŸã ŸàŸÑŸäÿ≥ ŸÅÿßÿ±ÿ∫ÿßŸã Ÿàÿ∂ŸÖŸÜ ÿ≠ÿØ ŸÖÿπŸÇŸàŸÑ
                if (newContent.trim() !== '' && 
                    newContent !== currentContent && 
                    newContent.length <= 1000000) { // ÿ≠ÿØ ÿ£ŸÇÿµŸâ 1 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™
                    try {
                        setLocalizedContent(chapter, currentLanguage || 'ar', newContent);
                        console.log('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ®ŸÜÿ¨ÿßÿ≠ÿå ÿßŸÑÿ≠ÿ¨ŸÖ:', newContent.length, 'ÿ≠ÿ±ŸÅ');
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ:', error);
                        // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ŸÖŸÇÿ™ÿ∑ÿπÿ©
                        try {
                            const truncatedContent = newContent.substring(0, 500000);
                            setLocalizedContent(chapter, currentLanguage || 'ar', truncatedContent);
                            console.warn('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ŸÖŸÇÿ™ÿ∑ÿπÿ© ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ');
                        } catch (fallbackError) {
                            console.error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ≠ÿ™Ÿâ ÿ®ÿπÿØ ÿßŸÑÿ™ŸÇÿ∑Ÿäÿπ:', fallbackError);
                        }
                    }
                }
            }

            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿ£ŸÖÿßŸÜ
            try {
                renderTreeView();
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
            }
        }

        function handleContextMenu(event) {
            event.preventDefault();
            contextMenu.innerHTML = '';
            const dataset = (event.target && event.target.dataset) || {};
            const { type, sectionIndex, chapterIndex } = dataset;
            const items = [];

            if (type === 'book') {
                items.push({ key: 'contextMenu.book.addSection', fallback: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ', action: addSection });
                items.push({ key: 'contextMenu.book.reorderSections', fallback: 'ÿ™ÿ≠ÿ±Ÿäÿ± ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ', action: showSectionSortDialog });
                items.push({ key: 'contextMenu.book.printBook', fallback: 'ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÉÿ™ÿßÿ® ŸÉŸÑŸá', action: printEntireBook });
                items.push({ key: 'contextMenu.book.exportSectionsZip', fallback: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ JSON', action: exportAllSectionsAsZip });

            } else if (type === 'section') {
                const secIndex = parseInt(sectionIndex, 10);
                items.push({ key: 'contextMenu.section.addChapter', fallback: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿµŸÑ ÿ¨ÿØŸäÿØ', action: () => addChapter(secIndex) });
                items.push({ key: 'contextMenu.section.deleteSection', fallback: 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ', action: () => deleteSection(secIndex) });
                items.push({ key: 'contextMenu.section.sectionResources', fallback: 'ÿÆÿµÿßÿ¶ÿµ ÿßŸÑŸàÿ≠ÿØÿ©', action: () => openSectionResources(secIndex) });
                items.push({ key: 'contextMenu.separator', fallback: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', separator: true });
                items.push({ key: 'contextMenu.section.exportJson', fallback: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸÉŸÄ JSON', action: () => exportSectionAsJSON(secIndex) });
                items.push({ key: 'contextMenu.section.exportTxt', fallback: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸÉŸÄ TXT', action: () => exportSectionAsTXT(secIndex) });
                items.push({ key: 'contextMenu.section.printSection', fallback: 'ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÇÿ≥ŸÖ', action: () => printSection(secIndex) });

            } else if (type === 'chapter') {
                const secIndex = parseInt(sectionIndex, 10);
                const chapIndex = parseInt(chapterIndex, 10);
                items.push({ key: 'contextMenu.chapter.moveChapter', fallback: 'ŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ ÿ•ŸÑŸâ ŸÇÿ≥ŸÖ ÿ¢ÿÆÿ±', action: () => showMoveChapterDialog(secIndex, chapIndex) });
                items.push({ key: 'contextMenu.chapter.deleteChapter', fallback: 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿµŸÑ', action: () => deleteChapter(secIndex, chapIndex) });
                items.push({ key: 'contextMenu.chapter.chapterResources', fallback: 'ÿÆÿµÿßÿ¶ÿµ ÿßŸÑÿØÿ±ÿ≥', action: () => openChapterResources(secIndex, chapIndex) });
            }

            items.forEach(item => {
                const menuItem = document.createElement('div');
                if (item.separator) {
                    menuItem.className = 'px-4 py-1 text-gray-400 text-center border-t border-gray-600 mt-1 pt-2';
                } else {
                    menuItem.className = 'px-4 py-2 hover:bg-gray-600 cursor-pointer rounded';
                }

                const translated = getTranslation(item.key, currentLanguage || 'ar');
                menuItem.textContent = translated || item.fallback || '';

                if (!item.separator && item.action) {
                    menuItem.onclick = () => {
                        item.action();
                        contextMenu.classList.add('hidden');
                    };
                }

                contextMenu.appendChild(menuItem);
            });

            if (items.length > 0) {
                // --- ‚¨áÔ∏è Ÿáÿ∞ÿß ŸáŸà ÿßŸÑŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ¨ÿØŸäÿØ ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿßŸÑŸÖŸàŸÇÿπ ‚¨áÔ∏è ---

                // 1. ÿßÿ¨ÿπŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑŸÇŸäÿßÿ≥ ŸàŸÑŸÉŸÜ ŸÖÿÆŸÅŸäÿ©
                contextMenu.style.visibility = 'hidden';
                contextMenu.classList.remove('hidden'); // Ÿäÿ∫Ÿäÿ± display ÿ•ŸÑŸâ block

                // 2. ŸÇŸÖ ÿ®ŸÇŸäÿßÿ≥ ÿ£ÿ®ÿπÿßÿØ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                const menuHeight = contextMenu.offsetHeight;
                const menuWidth = contextMenu.offsetWidth;

                // 3. ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ÿßŸÑŸÜŸÇÿ± (ÿ®ÿßŸÑŸÜÿ≥ÿ®ÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ŸÉÿßŸÖŸÑÿ©)
                const clickY = event.pageY;
                const clickX = event.pageX;

                // 4. ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿ¥ÿßÿ¥ÿ© (Viewport)
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;

                // 5. ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸàŸÇÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± (Scroll)
                const scrollY = window.scrollY;
                const scrollX = window.scrollX;

                // 6. ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿπŸÖŸàÿØŸä (Top)
                let finalTop = clickY;
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ£ÿ≥ŸÅŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ≥Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ¥ÿßÿ¥ÿ©
                if (clickY + menuHeight > scrollY + viewportHeight) {
                    finalTop = clickY - menuHeight; // ÿßÿπÿ±ÿ∂Ÿáÿß ÿ£ÿπŸÑŸâ ÿßŸÑŸÖÿ§ÿ¥ÿ±
                }
                // (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä) ÿßŸÑÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸáÿß ŸÑÿß ÿ™ÿÆÿ±ÿ¨ ÿ£ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ©
                if (finalTop < scrollY) {
                    finalTop = scrollY; // ÿ£ŸÑÿµŸÇŸáÿß ÿ®ÿ£ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ©
                }


                // 7. ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ£ŸÅŸÇŸä (Left)
                let finalLeft = clickX;
                 // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸäŸÖŸäŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ≥Ÿäÿ™ÿ¨ÿßŸàÿ≤ ŸäŸÖŸäŸÜ ÿßŸÑÿ¥ÿßÿ¥ÿ©
                if (clickX + menuWidth > scrollX + viewportWidth) {
                    finalLeft = clickX - menuWidth; // ÿßÿπÿ±ÿ∂Ÿáÿß Ÿäÿ≥ÿßÿ± ÿßŸÑŸÖÿ§ÿ¥ÿ±
                }
                // (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä) ÿßŸÑÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸáÿß ŸÑÿß ÿ™ÿÆÿ±ÿ¨ Ÿäÿ≥ÿßÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ©
                if (finalLeft < scrollX) {
                    finalLeft = scrollX;
                }

                // 8. ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© Ÿàÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                contextMenu.style.top = `${finalTop}px`;
                contextMenu.style.left = `${finalLeft}px`;
                contextMenu.style.right = 'auto'; // ÿ•ŸÑÿ∫ÿßÿ° ÿ£Ÿä ÿ™ÿ≠ÿØŸäÿØ ÿ≥ÿßÿ®ŸÇ
                contextMenu.style.visibility = 'visible'; // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ©

                // --- ‚¨ÜÔ∏è ŸÜŸáÿßŸäÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ¨ÿØŸäÿØ ‚¨ÜÔ∏è ---
            }
        }

        function exportSectionAsJSON(sectionIndex) {
            if (!bookData || !bookData.sections[sectionIndex]) {
                alert('ÿßŸÑŸÇÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }

            const section = bookData.sections[sectionIndex];
            const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
            
            const exportData = {
                section_name: section.section_name,
                sort: section.sort,
                chapters: section.Chapters.map(chapter => ({
                    title: chapter.title,
                    content: chapter.content
                }))
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sectionName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÇÿ≥ŸÖ "${sectionName}" ŸÉŸÖŸÑŸÅ JSON`);
        }

        function exportSectionAsTXT(sectionIndex) {
            if (!bookData || !bookData.sections[sectionIndex]) {
                alert('ÿßŸÑŸÇÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }

            const section = bookData.sections[sectionIndex];
            const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
            
            let txtContent = `${sectionName}\n`;
            txtContent += '='.repeat(sectionName.length) + '\n\n';
            
            section.Chapters.forEach((chapter, index) => {
                const title = getLocalizedTitle(chapter, currentLanguage || 'ar');
                const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                
                txtContent += `${index + 1}. ${title}\n`;
                txtContent += '-'.repeat(title.length + 3) + '\n';
                
                if (content) {
                    const processedContent = content.replace(/\[\[(\d+(?::\d+)?)\]\]/g, (match, range) => {
                        return st(match) || match;
                    });
                    
                    const markdownToText = processedContent
                        .replace(/\\n/g, '\n')  // ÿ™ÿ≠ŸàŸäŸÑ \n ÿ•ŸÑŸâ ÿ£ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØÿ© ÿ≠ŸÇŸäŸÇŸäÿ©
                        .replace(/#{1,6}\s+/g, '')
                        .replace(/\*\*(.*?)\*\*/g, '$1')
                        .replace(/\*(.*?)\*/g, '$1')
                        .replace(/`(.*?)`/g, '$1')
                        .replace(/\[(.*?)\]\(.*?\)/g, '$1')
                        .replace(/^>\s+/gm, '')
                        .replace(/^[-*+]\s+/gm, '‚Ä¢ ')
                        .replace(/^\d+\.\s+/gm, (match, offset, string) => {
                            const lineStart = string.lastIndexOf('\n', offset) + 1;
                            const lineNum = string.substring(0, offset).split('\n').length;
                            return `${lineNum}. `;
                        });
                    
                    txtContent += markdownToText + '\n\n';
                } else {
                    txtContent += '[ŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ±ÿ∫]\n\n';
                }
            });
            
            const blob = new Blob([txtContent], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sectionName}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÇÿ≥ŸÖ "${sectionName}" ŸÉŸÖŸÑŸÅ ŸÜÿµŸä`);
        }

        function printSection(sectionIndex) {
            if (!bookData || !bookData.sections[sectionIndex]) {
                alert('ÿßŸÑŸÇÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }

            const section = bookData.sections[sectionIndex];
            const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
            const docLang = currentLanguage || 'ar';
            const docDir = currentDirection === 'rtl' ? 'rtl' : 'ltr';

            let printContent = `<!DOCTYPE html><html lang="${docLang}" dir="${docDir}"><head><meta charset="UTF-8"><title>${sectionName}</title>`;
            printContent += `<style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.8; margin: 20px; color: #333; direction: ${docDir}; }
                h1 { color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px; margin-bottom: 30px; }
                h2 { color: #1e40af; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; margin-top: 30px; margin-bottom: 15px; }
                h3, h4, h5, h6 { color: #374151; margin-top: 20px; margin-bottom: 10px; }
                p { margin-bottom: 12px; text-align: justify; }
                blockquote { border-inline-start: 4px solid #3b82f6; padding: 15px 20px; margin: 20px 0; background: #f8fafc; border-radius: 5px; }
                code { background: #f1f5f9; padding: 3px 6px; border-radius: 4px; font-family: 'Consolas', monospace; }
                pre { background: #f8fafc; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #e2e8f0; white-space: pre-wrap; }
                .chapter { margin-bottom: 50px; page-break-inside: avoid; }
                .chapter-title { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; color: #1e40af; }
                ul, ol { margin: 15px 0; padding-inline-start: 20px; }
                li { margin-bottom: 5px; }
                strong { font-weight: bold; }
                em { font-style: italic; }
                @media print {
                    body { margin: 0; font-size: 12pt; } 
                    .chapter { page-break-after: auto; } 
                    h1 { page-break-after: avoid; }
                    h2 { page-break-after: avoid; }
                }
            </style></head><body>`;
            
            printContent += `<h1>${sectionName}</h1>`;
            
            section.Chapters.forEach((chapter, index) => {
                const title = getLocalizedTitle(chapter, currentLanguage || 'ar');
                const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                
                printContent += `<div class="chapter">`;
                printContent += `<h2 class="chapter-title">${index + 1}. ${title}</h2>`;
                
                if (content) {
                    let processedContent = content.replace(/\[\[(\d+(?::\d+)?)\]\]/g, (match, range) => {
                        return st(match) || match;
                    });
                    
                    processedContent = processedContent
                        .replace(/\\n/g, '\n')  // ÿ™ÿ≠ŸàŸäŸÑ \n ÿ•ŸÑŸâ ÿ£ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØÿ© ÿ≠ŸÇŸäŸÇŸäÿ©
                        .replace(/\r\n/g, '\n')
                        .replace(/\r/g, '\n')
                        .replace(/\n\s*\n\s*\n/g, '\n\n');
                    
                    try {
                        if (typeof marked !== 'undefined') {
                            processedContent = marked.parse(processedContent, { breaks: true });
                        } else {
                            processedContent = processedContent
                                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                .replace(/`(.*?)`/g, '<code>$1</code>')
                                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
                                .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
                                .replace(/^\* (.*$)/gm, '<li>$1</li>')
                                .replace(/^- (.*$)/gm, '<li>$1</li>')
                                .replace(/^\+ (.*$)/gm, '<li>$1</li>')
                                .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
                                .replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>')
                                .replace(/\n/g, '<br>\n')
                                .replace(/<br>\s*<\/blockquote>/g, '</blockquote>')
                                .replace(/<br>\s*<\/h[1-6]>/g, '')
                                .replace(/<br>\s*<h[1-6]>/g, '<h')
                                .replace(/<br>\s*<ul>/g, '<ul>')
                                .replace(/<\/ul>\s*<br>/g, '</ul>');
                            
                            processedContent = processedContent.split('\n').map(line => {
                                line = line.trim();
                                if (line && !line.startsWith('<') && !line.endsWith('>')) {
                                    return `<p>${line}</p>`;
                                }
                                return line;
                            }).join('\n');
                        }
                    } catch (e) {
                        processedContent = processedContent.replace(/\n/g, '<br>\n');
                    }
                    
                    printContent += processedContent;
                } else {
                    printContent += '<p><em>[ŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ±ÿ∫]</em></p>';
                }
                
                printContent += `</div>`;
            });
            
            printContent += `</body></html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }
		function printEntireBook() {
            if (!bookData) {
                alert('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉÿ™ÿßÿ® ŸÑÿ∑ÿ®ÿßÿπÿ™Ÿá');
                return;
            }

            const bookTitleTxt = getLocalizedBookName(bookData, currentLanguage || 'ar') || 'ŸÖÿ≠ÿ±ÿ± ÿßŸÑŸÉÿ™ÿ® ÿßŸÑŸÖÿ™ŸÇÿØŸÖ';
            const docLang = currentLanguage || 'ar';
            const docDir = currentDirection === 'rtl' ? 'rtl' : 'ltr';

            let printContent = `
                <!DOCTYPE html>
                <html lang="${docLang}" dir="${docDir}">
                <head>
                    <meta charset="UTF-8">
                    <title>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÉÿ™ÿßÿ®: ${bookTitleTxt}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.8; margin: 20px; color: #333; direction: ${docDir}; }
                        h1.book-title {
                            font-size: 2.5em;
                            color: #2563eb;
                            border-bottom: 3px solid #2563eb;
                            padding-bottom: 10px;
                            margin-bottom: 30px; 
                            text-align: center; 
                            page-break-after: always; /* ÿµŸÅÿ≠ÿ© ÿ¨ÿØŸäÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿπŸÜŸàÿßŸÜ */
                        }
                        .book-bio {
                            font-style: italic;
                            background: #f8fafc;
                            border-inline-start: 5px solid #e2e8f0;
                            padding: 20px;
                            margin-bottom: 30px;
                            page-break-after: always; /* ÿµŸÅÿ≠ÿ© ÿ¨ÿØŸäÿØÿ© ÿ®ÿπÿØ ÿßŸÑŸÖŸÇÿØŸÖÿ© */
                        }
                        h2.section-title { 
                            font-size: 2em;
                            color: #1e40af; 
                            border-bottom: 1px solid #cbd5e1; 
                            padding-bottom: 5px; 
                            margin-top: 40px; 
                            margin-bottom: 15px; 
                            page-break-before: always; /* ŸÉŸÑ ŸÇÿ≥ŸÖ Ÿäÿ®ÿØÿ£ ŸÅŸä ÿµŸÅÿ≠ÿ© ÿ¨ÿØŸäÿØÿ© */
                        }
                        h3.chapter-title { 
                            font-size: 1.5em; 
                            font-weight: bold; 
                            margin-bottom: 20px; 
                            color: #374151; 
                        }
                        .chapter { 
                            margin-bottom: 30px; 
                            page-break-inside: avoid; 
                        }
                        p { margin-bottom: 12px; text-align: justify; }
                        blockquote { border-inline-start: 4px solid #3b82f6; padding: 15px 20px; margin: 20px 0; background: #f8fafc; border-radius: 5px; }
                        code { background: #f1f5f9; padding: 3px 6px; border-radius: 4px; font-family: 'Consolas', monospace; }
                        pre { background: #f8fafc; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #e2e8f0; white-space: pre-wrap; }
                        ul, ol { margin: 15px 0; padding-inline-start: 20px; }
                        li { margin-bottom: 5px; }
                        
                        @media print { 
                            body { margin: 1in; font-size: 12pt; } 
                            h1.book-title, h2.section-title, .book-bio { page-break-after: always; }
                            h2.section-title { page-break-before: always; }
                            .chapter { page-break-inside: avoid; }
                            h3.chapter-title { page-break-after: avoid; }
                        }
                    </style>
                </head>
                <body>
            `;
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿ™ÿßÿ®
            printContent += `<h1 class="book-title">${bookTitleTxt}</h1>`;

            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÇÿØŸÖÿ© ÿßŸÑŸÉÿ™ÿßÿ® (Bio)
            if (bookData.bio) {
                const bioHtml = marked.parse(getFromLangArray(bookData.bio, currentLanguage || 'ar'), { breaks: true });
                printContent += `<div class="book-bio">${bioHtml}</div>`;
            }
            
            // ÿ¨ŸÑÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÖÿ±ÿ™ÿ®ÿ©
            const sortedSections = [...bookData.sections].sort((a, b) => (a.sort || 0) - (b.sort || 0));

            // ÿßŸÑŸÖÿ±Ÿàÿ± ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ Ÿàÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿµŸàŸÑ
            sortedSections.forEach((section, sIndex) => {
                const sectionName = getLocalizedSectionName(section, currentLanguage || 'ar');
                printContent += `<h2 class="section-title">${sectionName}</h2>`;
                
                section.Chapters.forEach((chapter, cIndex) => {
                    const title = getLocalizedTitle(chapter, currentLanguage || 'ar');
                    const content = getLocalizedContent(chapter, currentLanguage || 'ar');
                    
                    printContent += `<div class="chapter">`;
                    printContent += `<h3 class="chapter-title">${sIndex + 1}.${cIndex + 1} ${title}</h3>`;
                    
                    if (content) {
                        let processedContent = content.replace(/\[\[(\d+(?::\d+)?)\]\]/g, (match, range) => {
                            return st(match) || match;
                        });
                        
                        processedContent = processedContent
                            .replace(/\\n/g, '\n')
                            .replace(/\r\n/g, '\n')
                            .replace(/\r/g, '\n')
                            .replace(/\n\s*\n\s*\n/g, '\n\n');
                        
                        try {
                            if (typeof marked !== 'undefined') {
                                processedContent = marked.parse(processedContent, { breaks: true });
                            } else {
                                processedContent = processedContent.replace(/\n/g, '<br>\n');
                            }
                        } catch (e) {
                            processedContent = processedContent.replace(/\n/g, '<br>\n');
                        }
                        
                        printContent += processedContent;
                    } else {
                        printContent += '<p><em>[ŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ±ÿ∫]</em></p>';
                    }
                    
                    printContent += `</div>`;
                });
            });
            
            printContent += `</body></html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }

        function showSectionSortDialog() {
            if (!bookData || !bookData.sections.length) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ ŸÑÿ™ÿ±ÿ™Ÿäÿ®Ÿáÿß.');
                return;
            }

            const contentDiv = document.getElementById('section-sort-content');
            contentDiv.innerHTML = '';

            bookData.sections.forEach((section, index) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-sort-item';
                sectionDiv.draggable = true;
                sectionDiv.dataset.sectionIndex = index;
                
                sectionDiv.innerHTML = `
                    <div class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <input type="number" value="${index + 1}" min="1" max="${bookData.sections.length}" 
                           class="section-sort-input" data-section-index="${index}">
                    <input type="text" value="${getLocalizedSectionName(section, currentLanguage || 'ar')}" 
                           class="section-sort-name" data-section-index="${index}">
                `;

                sectionDiv.addEventListener('dragstart', handleSectionDragStart);
                sectionDiv.addEventListener('dragover', handleSectionDragOver);
                sectionDiv.addEventListener('drop', handleSectionDrop);
                sectionDiv.addEventListener('dragend', handleSectionDragEnd);

                contentDiv.appendChild(sectionDiv);
            });

            document.getElementById('section-sort-modal').classList.remove('hidden');
        }

        let draggedSectionElement = null;

        function handleSectionDragStart(e) {
            draggedSectionElement = e.target.closest('.section-sort-item');
            draggedSectionElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleSectionDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            document.querySelectorAll('.section-sort-item').forEach(item => {
                if (item !== draggedSectionElement) {
                    item.classList.remove('drag-over');
                }
            });
            
            const targetElement = e.target.closest('.section-sort-item');
            if (targetElement && targetElement !== draggedSectionElement) {
                targetElement.classList.add('drag-over');
            }
        }

        function handleSectionDrop(e) {
            e.preventDefault();
            
            const targetElement = e.target.closest('.section-sort-item');
            if (!targetElement || targetElement === draggedSectionElement) {
                return;
            }

            const draggedIndex = parseInt(draggedSectionElement.dataset.sectionIndex);
            const targetIndex = parseInt(targetElement.dataset.sectionIndex);

            const draggedSection = bookData.sections[draggedIndex];
            bookData.sections.splice(draggedIndex, 1);
            bookData.sections.splice(targetIndex, 0, draggedSection);

            showSectionSortDialog();
        }

        function handleSectionDragEnd(e) {
            e.target.closest('.section-sort-item').classList.remove('dragging');
            document.querySelectorAll('.section-sort-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedSectionElement = null;
        }

        function saveSectionSort() {
            const sortInputs = document.querySelectorAll('.section-sort-input');
            const nameInputs = document.querySelectorAll('.section-sort-name');
            const newSections = [];

            sortInputs.forEach((input, index) => {
                const sectionIndex = parseInt(input.dataset.sectionIndex);
                const newPosition = parseInt(input.value) - 1;
                const newName = nameInputs[index].value.trim();
                
                if (newName) {
                    const section = { ...bookData.sections[sectionIndex] };
                    setLocalizedSectionName(section, currentLanguage || 'ar', newName);
                    section.sort = newPosition;
                    newSections.push({ section, newPosition });
                }
            });

            newSections.sort((a, b) => a.newPosition - b.newPosition);
            bookData.sections = newSections.map(item => item.section);

            bookData.sections.forEach((section, index) => {
                section.sort = index;
            });

            document.getElementById('section-sort-modal').classList.add('hidden');
            renderApp();
            alert('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!');
        }

        function addSection() {
            const name = prompt("ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ:");
            if (name) {
bookData.sections.push({ id: generateUniqueID(), section_name: [{ ar: name }], sort: bookData.sections.length, Chapters: [] });
                renderApp();
            }
        }

        function addChapter(sectionIndex) {
            const title = prompt("ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅÿµŸÑ ÿßŸÑÿ¨ÿØŸäÿØ:");
            if (title) {
bookData.sections[sectionIndex].Chapters.push({ id: generateUniqueID(),
 title: [{ ar: title }] ,
  Is_Audit: false,      
  reviewLogs: []
 , content: [{type: 'paragraph', data: [{ ar: '' }] }] });
                renderApp();
            }
        }
function normalizeAuditDefaults(book) {
  if (!book || !Array.isArray(book.sections)) return;
  book.sections.forEach(sec => {
    (sec.Chapters || []).forEach(ch => {
      if (ch.is_audit != null && ch.Is_Audit == null) ch.Is_Audit = !!ch.is_audit, delete ch.is_audit;
      if (ch.Is_Audit == null) ch.Is_Audit = true;
      if (!Array.isArray(ch.reviewLogs)) ch.reviewLogs = [];
    });
  });
}

function ensureChangeLogs(ch){if(!Array.isArray(ch.changeLogs))ch.changeLogs=[]}
function addChangeLog(ch,entry){ensureChangeLogs(ch);ch.changeLogs.push(Object.assign({id:generateUniqueID(),at:new Date().toISOString()},entry))}
function ensureTrash(){if(!bookData.__trash){bookData.__trash={sections:[],chapters:[]}}}


       function deleteSection(sectionIndex){
  const sectionNameConfirm=getLocalizedSectionName(bookData.sections[sectionIndex],currentLanguage||'ar');
  if(!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ "${sectionNameConfirm}" ŸàŸÉŸÑ ŸÅÿµŸàŸÑŸáÿü`))return;
  ensureTrash();
  const sec=bookData.sections[sectionIndex];
  bookData.__trash.sections.push({at:new Date().toISOString(),section:sec,index:sectionIndex});
  bookData.sections.splice(sectionIndex,1);
  if(activePath.section===sectionIndex){activePath={section:null,chapter:null}}
  renderApp();saveBookToIndexedDB&&saveBookToIndexedDB();
}
function deleteChapter(sectionIndex,chapterIndex){
  const chapterTitle=getLocalizedTitle(bookData.sections[sectionIndex].Chapters[chapterIndex],currentLanguage||'ar');
  if(!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿµŸÑ "${chapterTitle}"ÿü`))return;
  ensureTrash();
  const ch=bookData.sections[sectionIndex].Chapters[chapterIndex];
  bookData.__trash.chapters.push({at:new Date().toISOString(),sectionIndex,chapterIndex,chapter:ch});
  bookData.sections[sectionIndex].Chapters.splice(chapterIndex,1);
  if(activePath.section==sectionIndex&&activePath.chapter==chapterIndex){activePath={section:null,chapter:null}}
  renderApp();saveBookToIndexedDB&&saveBookToIndexedDB();
}
function restoreFromTrash(kind,idx){
  ensureTrash();
  if(kind==='section'){
    const t=bookData.__trash.sections.splice(idx,1)[0];if(!t)return;
    const pos=Math.min(t.index,bookData.sections.length);
    bookData.sections.splice(pos,0,t.section);
  }else{
    const t=bookData.__trash.chapters.splice(idx,1)[0];if(!t)return;
    const s=bookData.sections[t.sectionIndex];if(!s)return;
    const pos=Math.min(t.chapterIndex,(s.Chapters||[]).length);
    s.Chapters.splice(pos,0,t.chapter);
  }
  renderApp();saveBookToIndexedDB&&saveBookToIndexedDB();
}
function deletePermanently(kind,idx){
  ensureTrash();
  if(kind==='section'){bookData.__trash.sections.splice(idx,1)}else{bookData.__trash.chapters.splice(idx,1)}
  saveBookToIndexedDB&&saveBookToIndexedDB();
}
function openTrash(){
  ensureTrash();
  let modal=document.getElementById('trash-modal');
  if(!modal){
    modal=document.createElement('div');
    modal.id='trash-modal';
    modal.className='fixed inset-0 z-50 flex items-center justify-center';
    modal.innerHTML='<div class="absolute inset-0 bg-black/50"></div><div class="relative bg-white text-black rounded p-4 max-w-3xl w-full"><h3 class="font-bold mb-3">ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∞ŸàŸÅÿßÿ™</h3><div id="trash-list" class="space-y-2"></div><div class="mt-4 text-end"><button id="trash-close" class="btn">ÿ•ÿ∫ŸÑÿßŸÇ</button></div></div>';
    document.body.appendChild(modal);
    modal.querySelector('#trash-close').onclick=()=>modal.classList.add('hidden');
  }
  const items=[];
  (bookData.__trash.sections||[]).forEach((t,i)=>items.push({kind:'section',i,name:getLocalizedSectionName(t.section,currentLanguage||'ar'),at:t.at}));
  (bookData.__trash.chapters||[]).forEach((t,i)=>items.push({kind:'chapter',i,name:getLocalizedTitle(t.chapter,currentLanguage||'ar'),at:t.at}));
  const list=modal.querySelector('#trash-list');
  list.innerHTML=items.map(it=>`<div class="flex items-center justify-between gap-2 border p-2 rounded"><div><div>${it.kind==='section'?'[ŸÇÿ≥ŸÖ]':'[ŸÅÿµŸÑ]'} ${it.name}</div><div class="text-sm text-gray-500">${it.at}</div></div><div class="flex gap-2"><button data-restore="${it.kind}:${it.i}" class="btn">ÿßÿ≥ÿ™ÿπÿßÿØÿ©</button><button data-delete="${it.kind}:${it.i}" class="btn btn-danger">ÿ≠ÿ∞ŸÅ ŸÜŸáÿßÿ¶Ÿä</button></div></div>`).join('')||'<div class="text-gray-500">ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∞ŸàŸÅÿßÿ™ ŸÅÿßÿ±ÿ∫ÿ©</div>';
  list.onclick=e=>{const r=e.target.getAttribute('data-restore');const d=e.target.getAttribute('data-delete');if(r){const[k,x]=r.split(':');restoreFromTrash(k,parseInt(x));openTrash()}if(d){const[k,x]=d.split(':');deletePermanently(k,parseInt(x));openTrash()}}
  modal.classList.remove('hidden');
}


        // Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ≥ÿ≠ÿ® ŸàÿßŸÑÿ•ŸÅŸÑÿßÿ™
        let draggedElement = null;
        let draggedData = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            draggedData = {
                type: e.target.dataset.type,
                sectionIndex: parseInt(e.target.dataset.sectionIndex),
                chapterIndex: parseInt(e.target.dataset.chapterIndex)
            };
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // ÿ•ÿ≤ÿßŸÑÿ© ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ≥ÿ≠ÿ® ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿ£ŸàŸÑÿßŸã
            document.querySelectorAll('.tree-item').forEach(item => {
                if (item !== draggedElement) {
                    item.classList.remove('drag-over');
                }
            });
            
            const targetElement = e.target.closest('.tree-item');
            if (targetElement && targetElement !== draggedElement && 
                (targetElement.dataset.type === 'chapter' || targetElement.dataset.type === 'section')) {
                targetElement.classList.add('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            const targetElement = e.target.closest('.tree-item');
            if (!targetElement || targetElement === draggedElement) {
                return;
            }
            
            const targetType = targetElement.dataset.type;
            
            if (draggedData.type === 'chapter' && targetType === 'chapter') {
                const targetData = {
                    sectionIndex: parseInt(targetElement.dataset.sectionIndex),
                    chapterIndex: parseInt(targetElement.dataset.chapterIndex)
                };
                moveChapter(draggedData, targetData);
            } else if (draggedData.type === 'chapter' && targetType === 'section') {
                moveChapterToSectionFromDrop(draggedElement, targetElement);
            }
            
            // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÅÿ¶ÿßÿ™
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('drag-over', 'dragging');
            });
            
            renderApp();
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedElement = null;
            draggedData = null;
        }

        function moveChapter(source, target) {
            if (!bookData || source.sectionIndex === target.sectionIndex && source.chapterIndex === target.chapterIndex) {
                return;
            }
            
            // ÿßÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿµŸÑ ÿßŸÑŸÖÿ±ÿßÿØ ŸÜŸÇŸÑŸá
            const chapterToMove = bookData.sections[source.sectionIndex].Chapters[source.chapterIndex];
            
            // ÿßÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿµŸÑ ŸÖŸÜ ŸÖŸàŸÇÿπŸá ÿßŸÑÿ£ÿµŸÑŸä
            bookData.sections[source.sectionIndex].Chapters.splice(source.chapterIndex, 1);
            
            // ÿ£ÿ∂ŸÅ ÿßŸÑŸÅÿµŸÑ ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ¨ÿØŸäÿØ
            let insertIndex = target.chapterIndex;
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÜŸÇŸÑ ÿØÿßÿÆŸÑ ŸÜŸÅÿ≥ ÿßŸÑŸÇÿ≥ŸÖ ŸàŸÉÿßŸÜ ÿßŸÑŸÅÿµŸÑ ÿßŸÑŸÖŸÜŸÇŸàŸÑ ŸÇÿ®ŸÑ ÿßŸÑŸáÿØŸÅÿå ŸÇŸÑŸÑ ÿßŸÑŸÅŸáÿ±ÿ≥
            if (source.sectionIndex === target.sectionIndex && source.chapterIndex < target.chapterIndex) {
                insertIndex--;
            }
            
            bookData.sections[target.sectionIndex].Chapters.splice(insertIndex + 1, 0, chapterToMove);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑŸÜÿ¥ÿ∑ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
            if (activePath.section === source.sectionIndex && activePath.chapter === source.chapterIndex) {
                activePath = {
                    section: target.sectionIndex,
                    chapter: insertIndex + 1
                };
            }
        }

        function moveChapterToPosition(draggedChapter, targetChapter) {
            const draggedSectionIndex = parseInt(draggedChapter.dataset.sectionIndex);
            const draggedChapterIndex = parseInt(draggedChapter.dataset.chapterIndex);
            const targetSectionIndex = parseInt(targetChapter.dataset.sectionIndex);
            const targetChapterIndex = parseInt(targetChapter.dataset.chapterIndex);
            
            const chapter = bookData.sections[draggedSectionIndex].Chapters.splice(draggedChapterIndex, 1)[0];
            bookData.sections[targetSectionIndex].Chapters.splice(targetChapterIndex, 0, chapter);
            
            renderApp();
        }

        function updateEditorControls() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const sectionSelect = document.getElementById('chapter-section-select');
            const sortInput = document.getElementById('chapter-sort-input');
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
            sectionSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ÿßÿ®</option>';
            bookData.sections.forEach((section, index) => {
                if (index !== activePath.section) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = getLocalizedSectionName(section, currentLanguage || 'ar');
                    sectionSelect.appendChild(option);
                }
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÅÿµŸÑ ÿßŸÑÿ≠ÿßŸÑŸä
            sortInput.value = activePath.chapter + 1;
        }
        function moveChapterFromControls() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const sectionSelect = document.getElementById('chapter-section-select');
            const targetSectionIndex = parseInt(sectionSelect.value);
            
            if (isNaN(targetSectionIndex) || targetSectionIndex === activePath.section) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÇÿ≥ŸÖ ŸÖÿÆÿ™ŸÑŸÅ ŸÑŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ ÿ•ŸÑŸäŸá.');
                return;
            }
            
            const chapterTitle = getLocalizedTitle(bookData.sections[activePath.section].Chapters[activePath.chapter], currentLanguage || 'ar');
            const targetSectionName = getLocalizedSectionName(bookData.sections[targetSectionIndex], currentLanguage || 'ar');
            
            if (confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ "${chapterTitle}" ÿ•ŸÑŸâ ÿßŸÑŸÇÿ≥ŸÖ "${targetSectionName}"ÿü`)) {
                const chapterToMove = bookData.sections[activePath.section].Chapters[activePath.chapter];
                
                bookData.sections[activePath.section].Chapters.splice(activePath.chapter, 1);
                
                bookData.sections[targetSectionIndex].Chapters.push(chapterToMove);
                
                activePath = {
                    section: targetSectionIndex,
                    chapter: bookData.sections[targetSectionIndex].Chapters.length - 1
                };
                
                renderApp();
                alert(`ÿ™ŸÖ ŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ "${chapterTitle}" ÿ•ŸÑŸâ ÿßŸÑŸÇÿ≥ŸÖ "${targetSectionName}" ÿ®ŸÜÿ¨ÿßÿ≠!`);
            }
        }
        function updateChapterSort() {
            if (!bookData || activePath.section === null || activePath.chapter === null) return;
            
            const sortInput = document.getElementById('chapter-sort-input');
            const newPosition = parseInt(sortInput.value) - 1;
            
            if (isNaN(newPosition) || newPosition < 0 || newPosition >= bookData.sections[activePath.section].Chapters.length) {
                alert('ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠.');
                return;
            }
            
            if (newPosition === activePath.chapter) {
                alert('ÿßŸÑŸÅÿµŸÑ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ÿßŸÑŸÅÿπŸÑ.');
                return;
            }
            
            const currentSection = bookData.sections[activePath.section];
            const chapterToMove = currentSection.Chapters[activePath.chapter];
            
            // ÿßÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿµŸÑ ŸÖŸÜ ŸÖŸàŸÇÿπŸá ÿßŸÑÿ≠ÿßŸÑŸä
            currentSection.Chapters.splice(activePath.chapter, 1);
            
            // ÿ£ÿØÿ±ÿ¨ ÿßŸÑŸÅÿµŸÑ ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ¨ÿØŸäÿØ
            currentSection.Chapters.splice(newPosition, 0, chapterToMove);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑŸÜÿ¥ÿ∑
            activePath.chapter = newPosition;
            
            renderApp();
            alert(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÅÿµŸÑ "${getLocalizedTitle(chapterToMove, currentLanguage || 'ar')}" ÿ®ŸÜÿ¨ÿßÿ≠!`);
        }

        function showMoveChapterDialog(sectionIndex, chapterIndex) {
            const chapterTitle = getLocalizedTitle(bookData.sections[sectionIndex].Chapters[chapterIndex], currentLanguage || 'ar');
            let options = '';
            
            bookData.sections.forEach((section, index) => {
                if (index !== sectionIndex) {
                    options += `<option value="${index}">${getLocalizedSectionName(section, currentLanguage || 'ar')}</option>`;
                }
            });
            
            if (options === '') {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ ÿ£ÿÆÿ±Ÿâ ŸÑŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ ÿ•ŸÑŸäŸáÿß.');
                return;
            }
            
            const targetSectionIndex = prompt(`ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ∞Ÿä ÿ™ÿ±ŸäÿØ ŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ "${chapterTitle}" ÿ•ŸÑŸäŸá:\n\n` + 
                bookData.sections.map((section, index) => 
                    index !== sectionIndex ? `${index}: ${getLocalizedSectionName(section, currentLanguage || 'ar')}` : ''
                ).filter(Boolean).join('\n') + 
                '\n\nÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸÇÿ≥ŸÖ:');
            
            if (targetSectionIndex !== null && targetSectionIndex !== '') {
                const targetIndex = parseInt(targetSectionIndex);
                if (targetIndex >= 0 && targetIndex < bookData.sections.length && targetIndex !== sectionIndex) {
                    moveChapterToSection(sectionIndex, chapterIndex, targetIndex);
                } else {
                    alert('ÿ±ŸÇŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠.');
                }
            }
        }
        function moveChapterToSection(sourceSectionIndex, chapterIndex, targetSectionIndex) {
            const chapterToMove = bookData.sections[sourceSectionIndex].Chapters[chapterIndex];
            
            bookData.sections[sourceSectionIndex].Chapters.splice(chapterIndex, 1);
            
            bookData.sections[targetSectionIndex].Chapters.push(chapterToMove);
            
            if (activePath.section === sourceSectionIndex && activePath.chapter === chapterIndex) {
                activePath = {
                    section: targetSectionIndex,
                    chapter: bookData.sections[targetSectionIndex].Chapters.length - 1
                };
            }
            
            renderApp();
            alert(`ÿ™ŸÖ ŸÜŸÇŸÑ ÿßŸÑŸÅÿµŸÑ "${getLocalizedTitle(chapterToMove, currentLanguage || 'ar')}" ÿ•ŸÑŸâ ÿßŸÑŸÇÿ≥ŸÖ "${getLocalizedSectionName(bookData.sections[targetSectionIndex], currentLanguage || 'ar')}" ÿ®ŸÜÿ¨ÿßÿ≠!`);
        }

        function moveChapterToSectionFromDrop(draggedChapter, targetSection) {
            const draggedSectionIndex = parseInt(draggedChapter.dataset.sectionIndex);
            const draggedChapterIndex = parseInt(draggedChapter.dataset.chapterIndex);
            const targetSectionIndex = parseInt(targetSection.dataset.sectionIndex);
            
            const chapter = bookData.sections[draggedSectionIndex].Chapters.splice(draggedChapterIndex, 1)[0];
            bookData.sections[targetSectionIndex].Chapters.push(chapter);
            
            renderApp();
        }

        function calculateStats() {
            if (!bookData) return null;
            const lang = currentLanguage || 'ar';
            let totalChapters = 0;
            let totalWords = 0;
            let totalChars = 0;
            let totalLines = 0;

            const bioContent = normalizeValueToString(bookData.bio, lang);
            const bioWords = getWordCount(bioContent, lang);
            const bioChars = getCharCount(bioContent, lang);
            const bioLines = bioContent ? bioContent.split(/\r?\n/).length : 0;

            totalWords += bioWords;
            totalChars += bioChars;
            totalLines += bioLines;

            const sectionStats = (bookData.sections || []).map(section => {
                let sectionWords = 0;
                let sectionChars = 0;
                let sectionLines = 0;

                (section.Chapters || []).forEach(chapter => {
                    const { text, lines } = extractChapterText(chapter, lang);
                    sectionWords += getWordCount(text, lang);
                    sectionChars += getCharCount(text, lang);
                    sectionLines += lines;
                });

                totalChapters += (section.Chapters || []).length;
                totalWords += sectionWords;
                totalChars += sectionChars;
                totalLines += sectionLines;

                return {
                    name: section.section_name,
                    chapters: (section.Chapters || []).length,
                    words: sectionWords,
                    chars: sectionChars,
                    lines: sectionLines
                };
            });

            return {
                totalLines,
                totalSections: (bookData.sections || []).length,
                totalChapters,
                totalWords,
                totalChars,
                bioStats: {
                    words: bioWords,
                    chars: bioChars,
                    lines: bioLines
                },
                sectionStats
            };
        }

        function displayStats() {
            const stats = calculateStats();
            if (!stats) {
                alert("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿπÿ±ÿ∂Ÿáÿß. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ŸÉÿ™ÿßÿ® ÿ£ŸàŸÑÿßŸã.");
                return;
            }
            
            const lang = currentLanguage || 'ar';
            const bioContent = normalizeValueToString(bookData.bio, lang);
            const formattedBio = bioContent
                ? bioContent.replace(/\r\n/g, '\n').replace(/\n/g, '<br>')
                : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÇÿØŸÖÿ© ŸÑŸÑŸÉÿ™ÿßÿ®';
            const bioMeta = `(${stats.bioStats.words} ŸÉŸÑŸÖÿ©, ${stats.bioStats.chars} ÿ≠ÿ±ŸÅ${stats.bioStats.lines ? `, ${stats.bioStats.lines} ÿ≥ÿ∑ÿ±` : ''})`;

            const contentDiv = document.getElementById('stats-content');
            contentDiv.innerHTML = `
                <div class="mb-6 p-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg">
                    <h3 class="text-2xl font-bold mb-4 text-yellow-300">ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ©</h3>
                    <div class="mb-6 p-4 bg-gray-800 rounded-lg text-center">
                        <h2 class="text-3xl font-bold text-orange-400 mb-2">${getLocalizedBookName(bookData, currentLanguage || 'ar') || 'ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ'}</h2>
                        <p class="text-gray-400 text-sm">ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿ™ÿßÿ®</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿ≥ÿ∑ÿ±</p>
                            <p class="text-3xl font-bold text-blue-400">${stats.totalLines}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</p>
                            <p class="text-3xl font-bold text-green-400">${stats.totalSections}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÅÿµŸàŸÑ</p>
                            <p class="text-3xl font-bold text-purple-400">${stats.totalChapters}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸÖÿßÿ™</p>
                            <p class="text-3xl font-bold text-yellow-400">${stats.totalWords}</p>
                        </div>
                    </div>
                </div>
                <div class="mb-6 p-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg">
                     <h3 class="text-xl font-bold mb-3 text-yellow-300">ŸÖŸÇÿØŸÖÿ© ÿßŸÑŸÉÿ™ÿßÿ®</h3>
                     <div class="prose prose-invert max-w-none bg-gray-800 p-4 rounded-lg">${formattedBio}</div>
                     <p class="text-sm text-gray-400 mt-3">${bioMeta}</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4 text-yellow-300">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</h3>
                    <div class="space-y-4">
                        ${stats.sectionStats.map((s, i) => `
                            <div class="p-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg">
                                <h4 class="font-bold text-lg text-blue-300 mb-3">${i + 1}. ${getLocalizedSectionName(bookData.sections[i], currentLanguage || 'ar')}</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">ÿßŸÑŸÅÿµŸàŸÑ</span>
                                        <span class="block text-lg font-bold text-blue-400">${s.chapters}</span>
                                    </div>
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">ÿßŸÑÿ£ÿ≥ÿ∑ÿ±</span>
                                        <span class="block text-lg font-bold text-green-400">${s.lines}</span>
                                    </div>
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">ÿßŸÑŸÉŸÑŸÖÿßÿ™</span>
                                        <span class="block text-lg font-bold text-purple-400">${s.words}</span>
                                    </div>
                                    <div class="bg-gray-800 p-3 rounded">
                                        <span class="block text-xs text-gray-400">ÿßŸÑÿ£ÿ≠ÿ±ŸÅ</span>
                                        <span class="block text-lg font-bold text-yellow-400">${s.chars}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('stats-modal').classList.remove('hidden');
        }

        function exportChaptersMap() {
            if (!bookData) {
                alert("ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉÿ™ÿßÿ® ŸÑÿ™ÿµÿØŸäÿ± ŸÖÿÆÿ∑ÿ∑Ÿá.");
                return;
            }
            let mapContent = `ŸÖÿÆÿ∑ÿ∑ ŸÉÿ™ÿßÿ®: ${getLocalizedBookName(bookData, currentLanguage || 'ar')}\n\n`;
            bookData.sections.forEach((section, sIndex) => {
                mapContent += `${sIndex + 1}. ${getLocalizedSectionName(section, currentLanguage || 'ar')}\n`;
                section.Chapters.forEach((chapter, cIndex) => {
                    mapContent += `    ${sIndex + 1}.${cIndex + 1} ${getLocalizedTitle(chapter, currentLanguage || 'ar')}\n`;
                });
                mapContent += '\n';
            });

            const blob = new Blob([mapContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const bookName = (getLocalizedBookName(bookData, currentLanguage || 'ar') || 'book').replace(/[\\\/:*?"<>|]/g, '_');
            a.href = url;
            a.download = `ŸÖÿÆÿ∑ÿ∑_${bookName}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function openAdvancedSearch() {
            document.getElementById('advanced-search-modal').classList.remove('hidden');
            document.getElementById('search-input').focus();
        }

        function closeAdvancedSearch() {
            document.getElementById('advanced-search-modal').classList.add('hidden');
            document.getElementById('search-results').innerHTML = '<p class="text-gray-400 text-center">ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿ®ÿØÿ°</p>';
        }

        function normalizeText(v) {
            if (v == null) return '';
            if (Array.isArray(v)) return v.map(normalizeText).join(' ');
            if (typeof v === 'object') {
                if (Object.prototype.hasOwnProperty.call(v, 'text')) return String(v.text || '');
                if (Object.prototype.hasOwnProperty.call(v, 'content')) return String(v.content || '');
                if (Object.prototype.hasOwnProperty.call(v, 'title') && typeof v.title !== 'object') return String(v.title || '');
                try { return JSON.stringify(v); } catch (e) { return String(v); }
            }
            return String(v);
        }
        function performAdvancedSearch() {
            const rawInput = document.getElementById('search-input').value;
            const searchTitles = document.getElementById('search-titles').checked;
            const searchContent = document.getElementById('search-content').checked;
            const caseSensitive = document.getElementById('case-sensitive').checked;
            const searchTerm = normalizeText(rawInput).trim();
            if (!searchTerm || !bookData) {
                document.getElementById('search-results').innerHTML = '<p class="text-gray-400 text-center">ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ®ÿ≠ÿ´</p>';
                return;
            }
            const results = [];
            const searchTermProcessed = caseSensitive ? searchTerm : searchTerm.toLowerCase();
            bookData.sections.forEach((section, sectionIndex) => {
                section.Chapters.forEach((chapter, chapterIndex) => {
                    const rawTitle = normalizeText(getLocalizedTitle(chapter, currentLanguage || 'ar'));
                    const titleToSearch = caseSensitive ? rawTitle : rawTitle.toLowerCase();
                    if (searchTitles && titleToSearch.includes(searchTermProcessed)) {
                        results.push({
                            type: 'title',
                            sectionIndex,
                            chapterIndex,
                            sectionName: getLocalizedSectionName(section, currentLanguage || 'ar'),
                            chapterTitle: rawTitle,
                            match: rawTitle
                        });
                    }
                    if (searchContent && chapter.content) {
                        chapter.content.forEach((block, blockIndex) => {
                            let contentToSearch = '';
                            if (block.type === 'paragraph') {
                                contentToSearch = normalizeText(block.data);
                            } else if (block.type === 'table') {
                                const t = normalizeText(block.data && block.data.title);
                                const csv = block.data && block.data.csv;
                                let csvText = '';
                                if (Array.isArray(csv)) {
                                    if (csv.length > 0 && Array.isArray(csv[0])) {
                                        csvText = csv.map(row => row.map(normalizeText).join(' ')).join(' ');
                                    } else {
                                        csvText = csv.map(normalizeText).join(' ');
                                    }
                                } else {
                                    csvText = normalizeText(csv);
                                }
                                contentToSearch = t + ' ' + csvText;
                            } else if (block.type === 'image') {
                                const t = normalizeText(block.data && block.data.title);
                                const c = normalizeText(block.data && block.data.caption);
                                contentToSearch = t + ' ' + c;
                            } else {
                                contentToSearch = normalizeText(block.data);
                            }
                            const baseContent = normalizeText(contentToSearch);
                            const processedContent = caseSensitive ? baseContent : baseContent.toLowerCase();
                            if (processedContent.includes(searchTermProcessed)) {
                                const matchIndex = processedContent.indexOf(searchTermProcessed);
                                const start = Math.max(0, matchIndex - 50);
                                const end = Math.min(baseContent.length, matchIndex + searchTermProcessed.length + 50);
                                const preview = baseContent.substring(start, end);
                                results.push({
                                    type: 'content',
                                    sectionIndex,
                                    chapterIndex,
                                    blockIndex,
                                    sectionName: getLocalizedSectionName(section, currentLanguage || 'ar'),
                                    chapterTitle: getLocalizedTitle(chapter, currentLanguage || 'ar'),
                                    match: preview,
                                    blockType: block.type
                                });
                            }
                        });
                    }
                });
            });
            displaySearchResults(results, searchTermProcessed);
        }
        
        function highlightText(text, searchTerm, caseSensitive) {
            if (!searchTerm) return text;
            
            const flags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, flags);
            return text.replace(regex, '<mark class="bg-yellow-300 text-black px-1 rounded">$1</mark>');
        }
        
        function getContentPreview(content, searchTerm, caseSensitive, contextLength = 100) {
            const contentSafe = normalizeText(content);
            const searchTermSafe = normalizeText(searchTerm);
            const searchTermProcessed = caseSensitive ? searchTermSafe : searchTermSafe.toLowerCase();
            const contentProcessed = caseSensitive ? contentSafe : contentSafe.toLowerCase();
            const index = contentProcessed.indexOf(searchTermProcessed);
            if (index === -1) return { text: contentSafe.substring(0, contextLength) + '...', highlight: contentSafe.substring(0, contextLength) + '...' };
            const start = Math.max(0, index - contextLength / 2);
            const end = Math.min(contentSafe.length, index + searchTermSafe.length + contextLength / 2);
            let preview = contentSafe.substring(start, end);
            if (start > 0) preview = '...' + preview;
            if (end < contentSafe.length) preview = preview + '...';
            return {
                text: preview,
                highlight: highlightText(preview, searchTermSafe, caseSensitive)
            };
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function displaySearchResults(results, searchTerm) {
            const resultsContainer = document.getElementById('search-results');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨</p>';
                return;
            }
            
            let html = `<div class="mb-4"><span class="text-green-400 font-bold">ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${results.length} ŸÜÿ™Ÿäÿ¨ÿ©</span></div>`;
            
            results.forEach((result, index) => {
                const highlightedMatch = result.match.replace(
                    new RegExp(searchTerm, 'gi'),
                    `<mark class="bg-yellow-400 text-black">$&</mark>`
                );
                
                html += `
                    <div class="bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors" onclick="goToSearchResult(${result.sectionIndex}, ${result.chapterIndex})">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-white font-semibold">${result.chapterTitle}</h4>
                            <span class="text-xs text-gray-400">${result.sectionName}</span>
                        </div>
                        <div class="text-sm text-gray-300">
                            <span class="text-xs text-blue-400">${result.type === 'title' ? 'ÿßŸÑÿπŸÜŸàÿßŸÜ' : 'ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ'}</span>
                            <p class="mt-1">${highlightedMatch}</p>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function goToSearchResult(sectionIndex, chapterIndex) {
            activePath.section = sectionIndex;
            activePath.chapter = chapterIndex;
            closeAdvancedSearch();
            switchView('viewer');
            renderApp();
        }

        function makeContentEditable() {
            const viewerContent = document.getElementById('viewer-content');
            if (!viewerContent) return;
            
            viewerContent.querySelectorAll('.content-block-viewer').forEach((block, index) => {
                if (block.querySelector('p, h1, h2, h3, h4, h5, h6')) {
                    block.contentEditable = true;
                    block.classList.add('editable-content');
                    block.style.border = '1px dashed transparent';
                    block.style.padding = '8px';
                    block.style.borderRadius = '4px';
                    
                    block.addEventListener('focus', function() {
                        this.style.border = '1px dashed #3b82f6';
                        this.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    });
                    
                    block.addEventListener('blur', function() {
                        this.style.border = '1px dashed transparent';
                        this.style.backgroundColor = 'transparent';
                        saveEditableContent(index, this.innerHTML);
                    });
                    
                    block.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && e.ctrlKey) {
                            this.blur();
                        }
                    });
                }
            });
        }

        function saveEditableContent(blockIndex, newContent) {
    if (!bookData || activePath.section === null || activePath.chapter === null) return;
    const chapter = bookData.sections[activePath.section].Chapters[activePath.chapter];
    if (!chapter.content) {
        chapter.content = [{ type: 'paragraph', data: [{ ar: '' }] }];
    }
    if (chapter.content[blockIndex]) {
        let v = '';
        if (markdownEditor && typeof markdownEditor.value === 'string') {
            v = markdownEditor.value;
        } else {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newContent;
            v = tempDiv.textContent || tempDiv.innerText || '';
        }
        const block = chapter.content[blockIndex];
        if (typeof block.data === 'string') {
            block.data = setInLangArray([], currentLanguage, v);
        } else {
            block.data = setInLangArray(block.data, currentLanguage, v);
        }
        block.text = v;
        saveBookToIndexedDB();
    }
}


        let dbName = 'BookEditorDB';
        let dbVersion = 1;
        let db = null;
        let autoSaveInterval = null;
        let lastSavedBook = null;
function clearAllBooksFromIndexedDB(cb){
    if(!db){ if(cb) cb(); return; }
    const tx = db.transaction(['books'], 'readwrite');
    const store = tx.objectStore('books');
    store.clear();
    tx.oncomplete = function(){ if(cb) cb(); };
    tx.onerror = function(){ if(cb) cb(); };
}

        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('books')) {
                        const store = db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('lastModified', 'lastModified', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

            function saveBookToIndexedDB() {
            if (!db || !bookData) return;

            ensureBookSchema(bookData);

            const transaction = db.transaction(['books'], 'readwrite');
            const store = transaction.objectStore('books');

            const bookToSave = {
                id: currentBookId || (lastSavedBook && lastSavedBook.id) || undefined,
                name: bookData.name || 'ŸÉÿ™ÿßÿ® ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ',
                sections: bookData.sections || [],
                bio: bookData.bio || '',
                alias: bookData.alias || '',
                icon: bookData.icon || 'üìò',
                color: bookData.color || '#2563eb',
                subjectId: bookData.subjectId || slugify(getLocalizedBookName(bookData, 'en') || getLocalizedBookName(bookData, 'ar') || ''),
                cover: bookData.cover || '',
                lastModified: new Date().toISOString()
            };

            if (bookToSave.id) {
                const request = store.put(bookToSave);
                request.onsuccess = () => {
                    currentBookId = bookToSave.id;
                    lastSavedBook = { ...bookToSave };
                    populateBookSwitcher(currentBookId);
                };
                request.onerror = (e) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉÿ™ÿßÿ®:', e);
                };
            } else {
                const request = store.add(bookToSave);
                request.onsuccess = () => {
                    const newId = request.result;
                    currentBookId = newId;
                    lastSavedBook = { ...bookToSave, id: newId };
                    populateBookSwitcher(currentBookId);
                };
                request.onerror = (e) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÉÿ™ÿßÿ®:', e);
                };
            }
        }
        function loadLastBookFromIndexedDB() {
            if (!db) return;

            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const index = store.index('lastModified');

            const request = index.openCursor(null, 'prev');
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const savedBook = cursor.value;
                    currentBookId = savedBook.id;
                    bookData = { ...savedBook };
                    ensureBookSchema(bookData);
                    lastSavedBook = { ...savedBook };
                    normalizeAuditDefaults(bookData);
                    populateBookSwitcher(currentBookId);
                    renderApp();
                } else {
                    currentBookId = null;
                    bookData = {
                        name: [{ ar: 'ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ' }],
                        sections: [],
                        bio: [{ ar: '' }],
                        icon: 'üìò',
                        color: '#2563eb'
                    };
                    ensureBookSchema(bookData);
                    renderApp();
                    populateBookSwitcher(currentBookId);
                }
            };
        }

        function loadBookById(bookId) {
            if (!db || bookId == null) return;
            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.get(Number(bookId));
            request.onsuccess = (event) => {
                const savedBook = event.target.result;
                if (savedBook) {
                    currentBookId = savedBook.id;
                    bookData = { ...savedBook };
                    ensureBookSchema(bookData);
                    lastSavedBook = { ...savedBook };
                    normalizeAuditDefaults(bookData);
                    renderApp();
                    populateBookSwitcher(currentBookId);
                }
            };
        }

        function populateBookSwitcher(selectedId) {
            const switcher = document.getElementById('book-switcher');
            if (!switcher) return;
            if (!db) {
                switcher.innerHTML = '<option value="">ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</option>';
                switcher.disabled = true;
                return;
            }

            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.getAll();
            request.onsuccess = (event) => {
                const books = event.target.result || [];
                bookLibrary = books;
                switcher.innerHTML = '';
                if (books.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÉÿ™ÿ® ŸÖÿ≠ŸÅŸàÿ∏ÿ©';
                    switcher.appendChild(option);
                    switcher.disabled = true;
                    return;
                }

                switcher.disabled = false;
                books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = getFromLangArray(book.name, currentLanguage) || getFromLangArray(book.name, 'ar') || `ŸÉÿ™ÿßÿ® ${book.id}`;
                    if (book.id === selectedId) option.selected = true;
                    switcher.appendChild(option);
                });

                if (selectedId == null && currentBookId != null) {
                    switcher.value = currentBookId;
                }
                populateBookLibraryList();
            };
        }

        function toggleBookLibrary(show = true) {
            const modal = document.getElementById('book-library-modal');
            if (!modal) return;
            if (!show) {
                modal.classList.add('hidden');
                return;
            }
            populateBookLibraryList();
            modal.classList.remove('hidden');
        }

        function populateBookLibraryList() {
            const list = document.getElementById('book-library-list');
            if (!list) return;
            list.innerHTML = '';
            if (!bookLibrary || bookLibrary.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-300">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÉÿ™ÿ® ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ≠ÿßŸÑŸäÿßŸã.</p>';
                return;
            }

            bookLibrary
                .slice()
                .sort((a, b) => new Date(b.lastModified || 0) - new Date(a.lastModified || 0))
                .forEach(book => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-700 rounded-lg flex flex-col md:flex-row md:items-center md:justify-between gap-3';

                    const info = document.createElement('div');
                    info.className = 'text-sm text-gray-200';
                    const title = getFromLangArray(book.name, currentLanguage || 'ar') || `ŸÉÿ™ÿßÿ® ${book.id}`;
                    const subjectKey = book.subjectId || book.alias || '';
                    info.innerHTML = `<div class="font-semibold">${title}</div><div class="text-xs text-gray-400">${subjectKey}</div>`;

                    const actions = document.createElement('div');
                    actions.className = 'flex flex-wrap gap-2';

                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'btn btn-secondary text-sm';
                    loadBtn.textContent = 'ÿ™ÿ≠ŸÖŸäŸÑ';
                    loadBtn.onclick = () => {
                        toggleBookLibrary(false);
                        loadBookById(book.id);
                    };

                    const exportBtn = document.createElement('button');
                    exportBtn.className = 'btn btn-info text-sm';
                    exportBtn.textContent = 'ÿ™ÿµÿØŸäÿ± ŸÅŸÇÿ∑';
                    exportBtn.onclick = () => {
                        const subjectData = {};
                        const clone = JSON.parse(JSON.stringify(book));
                        ensureBookSchema(clone);
                        const subjectId = clone.subjectId || slugify(getFromLangArray(clone.name, 'en') || getFromLangArray(clone.name, 'ar') || `subject-${clone.id || generateUniqueID()}`);
                        subjectData[subjectId || generateUniqueID()] = convertBookToSubject(clone);
                        const content = 'const SUBJECT_DATA = ' + JSON.stringify(subjectData, null, 4) + ';';
                        downloadBundle(content, `${subjectId || 'subject'}.js`);
                    };

                    actions.appendChild(loadBtn);
                    actions.appendChild(exportBtn);

                    item.appendChild(info);
                    item.appendChild(actions);
                    list.appendChild(item);
                });
        }

        function createEmptyBook(overrides = {}) {
            const baseTitle = overrides.titleAr || 'ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ';
            const subjectId = overrides.subjectId || slugify(overrides.alias || baseTitle);
            return {
                name: setInLangArray([], 'ar', baseTitle),
                sections: [],
                bio: setInLangArray([], 'ar', overrides.bioAr || ''),
                alias: overrides.alias || subjectId,
                icon: overrides.icon || 'üìò',
                color: overrides.color || '#2563eb',
                subjectId: subjectId || generateUniqueID(),
                cover: overrides.cover || '',
                lastModified: new Date().toISOString()
            };
        }

        function promptCreateNewBook() {
            if (!db) return;
            const titleAr = prompt('ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿ™ÿßÿ® (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©):', 'ŸÉÿ™ÿßÿ® ÿ¨ÿØŸäÿØ');
            if (titleAr === null) return;
            const titleEn = prompt('Enter book title (English):', titleAr || 'New Book');
            if (titleEn === null) return;
            const subjectId = prompt('ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÅÿ±ŸäÿØ ŸÑŸÑŸÖÿßÿØÿ© (ÿ®ÿØŸàŸÜ ŸÖÿ≥ÿßŸÅÿßÿ™):', slugify(titleEn || titleAr || 'subject'));
            if (subjectId === null) return;

            bookData = createEmptyBook({ titleAr, alias: subjectId, subjectId });
            bookData.name = setInLangArray(bookData.name, 'en', titleEn || titleAr || 'New Book');
            ensureBookSchema(bookData);
            currentBookId = null;
            lastSavedBook = null;
            renderApp();
            saveBookToIndexedDB();
        }

        function cloneCurrentBook() {
            if (!db || !bookData) return;
            const alias = prompt('ÿ£ÿØÿÆŸÑ ŸÖÿπÿ±ŸÅÿßŸã ÿ¨ÿØŸäÿØÿßŸã ŸÑŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÜÿ≥ÿÆÿ©:', `${bookData.subjectId || bookData.alias || 'book'}-copy`);
            if (alias === null || alias.trim() === '') return;
            const cloned = JSON.parse(JSON.stringify(bookData));
            cloned.alias = alias.trim();
            cloned.subjectId = slugify(alias.trim());
            cloned.lastModified = new Date().toISOString();
            delete cloned.id;
            ensureBookSchema(cloned);

            const transaction = db.transaction(['books'], 'readwrite');
            const store = transaction.objectStore('books');
            const request = store.add(cloned);
            request.onsuccess = () => {
                currentBookId = request.result;
                lastSavedBook = { ...cloned, id: currentBookId };
                bookData = { ...cloned, id: currentBookId };
                renderApp();
                populateBookSwitcher(currentBookId);
            };
        }

        function renameCurrentBook() {
            if (!bookData) return;
            const newTitleAr = prompt('ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿ™ÿßÿ® (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©):', getLocalizedBookName(bookData, 'ar') || '');
            if (newTitleAr === null) return;
            const newTitleEn = prompt('Book title (English):', getLocalizedBookName(bookData, 'en') || newTitleAr);
            if (newTitleEn === null) return;
            const newSubjectId = prompt('ÿßŸÑŸÖÿπÿ±ŸÅ (Subject ID):', bookData.subjectId || bookData.alias || slugify(newTitleEn || newTitleAr));
            if (newSubjectId === null) return;

            bookData.name = setInLangArray(bookData.name, 'ar', newTitleAr.trim());
            bookData.name = setInLangArray(bookData.name, 'en', newTitleEn.trim());
            bookData.subjectId = slugify(newSubjectId.trim()) || bookData.subjectId;
            bookData.alias = bookData.subjectId;
            ensureBookSchema(bookData);
            renderApp();
            saveBookToIndexedDB();
        }

        function deleteCurrentBook() {
            if (!db || currentBookId == null) {
                alert('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉÿ™ÿßÿ® ŸÖÿ≠ÿØÿØ ŸÑŸÑÿ≠ÿ∞ŸÅ.');
                return;
            }
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÉÿ™ÿßÿ® ŸÜŸáÿßÿ¶ŸäÿßŸãÿü')) return;

            const transaction = db.transaction(['books'], 'readwrite');
            const store = transaction.objectStore('books');
            const request = store.delete(currentBookId);
            request.onsuccess = () => {
                currentBookId = null;
                lastSavedBook = null;
                loadLastBookFromIndexedDB();
            };
        }

        function toggleSectionResources(show) {
            const modal = document.getElementById('section-resources-modal');
            if (!modal) return;
            if (!show) {
                modal.classList.add('hidden');
                return;
            }
            modal.classList.remove('hidden');
        }

        function toggleChapterResources(show) {
            const modal = document.getElementById('chapter-resources-modal');
            if (!modal) return;
            if (!show) {
                modal.classList.add('hidden');
                return;
            }
            modal.classList.remove('hidden');
        }
        function evaluateQuizScript(script, fallback = []) {
            if (script && script.trim()) {
                try {
                    const fn = new Function(`return (${script})`);
                    const result = fn();
                    if (Array.isArray(result)) {
                        return result;
                    }
                    throw new Error('ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ŸÑŸäÿ≥ÿ™ ŸÖÿµŸÅŸàŸÅÿ©');
                } catch (error) {
                    console.warn('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸÅÿ≥Ÿäÿ± ŸÉŸàÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±:', error);
                    if (Array.isArray(fallback)) return fallback;
                    throw error;
                }
            }
            return Array.isArray(fallback) ? fallback : [];
        }
        function openSectionResources(sectionIndex) {
            if (!bookData || !bookData.sections || !bookData.sections[sectionIndex]) return;
            activeSectionResourcesIndex = sectionIndex;
            const section = bookData.sections[sectionIndex];
            ensureSectionSchema(section);

            const titleEl = document.getElementById('section-resources-title');
            if (titleEl) {
                titleEl.textContent = `ŸÖŸàÿßÿ±ÿØ ÿßŸÑŸàÿ≠ÿØÿ©: ${getLocalizedSectionName(section, currentLanguage || 'ar') || ''}`;
            }
            const langLabel = document.getElementById('section-brief-lang');
            if (langLabel) langLabel.textContent = (currentLanguage || 'ar').toUpperCase();

            const briefInput = document.getElementById('section-brief-input');
            if (briefInput) {
                briefInput.value = getFromLangArray(section.brief, currentLanguage || 'ar') || '';
                briefInput.oninput = (e) => {
                    section.brief = setInLangArray(section.brief, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };
            }

            const quizInput = document.getElementById('section-quiz-input');
            if (quizInput) {
                quizInput.value = section.resources.quizScript || '';
                quizInput.oninput = (e) => {
                    section.resources.quizScript = e.target.value;
                    saveBookToIndexedDB();
                };
            }
            const statusEl = document.getElementById('section-quiz-status');
            if (statusEl) statusEl.textContent = '';

            renderSectionResourcesUI();
            toggleSectionResources(true);
        }

        function renderSectionResourcesUI() {
            if (activeSectionResourcesIndex == null || !bookData) return;
            const section = bookData.sections[activeSectionResourcesIndex];
            if (!section) return;
            ensureSectionSchema(section);

            const pdfContainer = document.getElementById('section-pdfs-list');
            const videoContainer = document.getElementById('section-videos-list');

            const buildRow = (item, index, type, container, removeCallback) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-gray-700 p-3 rounded-lg space-y-2 md:space-y-0 md:flex md:items-center md:gap-3';

                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                titleInput.placeholder = type === 'pdf' ? 'ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸÑŸÅ' : 'ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅŸäÿØŸäŸà';
                titleInput.value = getFromLangArray(item.title, currentLanguage || 'ar') || '';
                titleInput.oninput = (e) => {
                    item.title = setInLangArray(item.title, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };

                const urlInput = document.createElement('input');
                urlInput.type = 'text';
                urlInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                urlInput.placeholder = 'https://...';
                urlInput.value = item.url || '';
                urlInput.oninput = (e) => {
                    item.url = e.target.value.trim();
                    saveBookToIndexedDB();
                };

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger text-sm';
                removeBtn.textContent = 'ÿ≠ÿ∞ŸÅ';
                removeBtn.onclick = () => {
                    removeCallback(index);
                    saveBookToIndexedDB();
                };

                wrapper.appendChild(titleInput);
                wrapper.appendChild(urlInput);
                wrapper.appendChild(removeBtn);
                container.appendChild(wrapper);
            };

            if (pdfContainer) {
                pdfContainer.innerHTML = '';
                if (!section.resources.pdfs.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ PDF.';
                    pdfContainer.appendChild(empty);
                } else {
                    section.resources.pdfs.forEach((pdf, index) => {
                        buildRow(pdf, index, 'pdf', pdfContainer, (idx) => {
                            section.resources.pdfs.splice(idx, 1);
                            renderSectionResourcesUI();
                        });
                    });
                }
            }

            if (videoContainer) {
                videoContainer.innerHTML = '';
                if (!section.resources.videos.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸäÿØŸäŸàŸáÿßÿ™.';
                    videoContainer.appendChild(empty);
                } else {
                    section.resources.videos.forEach((video, index) => {
                        buildRow(video, index, 'video', videoContainer, (idx) => {
                            section.resources.videos.splice(idx, 1);
                            renderSectionResourcesUI();
                        });
                    });
                }
            }
        }

        function addSectionResource(type) {
            if (activeSectionResourcesIndex == null || !bookData) return;
            const section = bookData.sections[activeSectionResourcesIndex];
            if (!section) return;
            ensureSectionSchema(section);
            const target = type === 'pdf' ? section.resources.pdfs : section.resources.videos;
            target.push(ensureResourceItem({ title: setInLangArray([], currentLanguage || 'ar', ''), url: '' }));
            renderSectionResourcesUI();
            saveBookToIndexedDB();
        }

        function testSectionQuizScript() {
            if (activeSectionResourcesIndex == null || !bookData) return;
            const section = bookData.sections[activeSectionResourcesIndex];
            if (!section) return;
            const input = document.getElementById('section-quiz-input');
            const status = document.getElementById('section-quiz-status');
            if (!input || !status) return;
            try {
                const result = evaluateQuizScript(input.value, section.resources.quizPreview);
                status.textContent = `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${result.length} ÿ≥ÿ§ÿßŸÑÿßŸã`;
                status.className = 'text-green-400 text-sm';
            } catch (error) {
                status.textContent = `‚ùå ${error.message}`;
                status.className = 'text-red-400 text-sm';
            }
        }
        function openChapterResources(sectionIndex, chapterIndex) {
            if (!bookData || !bookData.sections || !bookData.sections[sectionIndex]) return;
            const section = bookData.sections[sectionIndex];
            if (!section.Chapters || !section.Chapters[chapterIndex]) return;
            activeChapterResourcesPath = { section: sectionIndex, chapter: chapterIndex };
            const chapter = section.Chapters[chapterIndex];
            ensureChapterSchema(chapter);

            const titleEl = document.getElementById('chapter-resources-title');
            if (titleEl) {
                titleEl.textContent = `ŸÖŸàÿßÿ±ÿØ ÿßŸÑÿØÿ±ÿ≥: ${getLocalizedTitle(chapter, currentLanguage || 'ar') || ''}`;
            }
            const langLabel = document.getElementById('chapter-brief-lang');
            if (langLabel) langLabel.textContent = (currentLanguage || 'ar').toUpperCase();

            const briefInput = document.getElementById('chapter-brief-input');
            if (briefInput) {
                briefInput.value = getFromLangArray(chapter.brief, currentLanguage || 'ar') || '';
                briefInput.oninput = (e) => {
                    chapter.brief = setInLangArray(chapter.brief, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };
            }

            const quizInput = document.getElementById('chapter-quiz-input');
            if (quizInput) {
                quizInput.value = chapter.resources.quizScript || '';
                quizInput.oninput = (e) => {
                    chapter.resources.quizScript = e.target.value;
                    saveBookToIndexedDB();
                };
            }
            const statusEl = document.getElementById('chapter-quiz-status');
            if (statusEl) statusEl.textContent = '';

            renderChapterResourcesUI();
            toggleChapterResources(true);
        }

        function openActiveChapterResources() {
            if (activePath.section == null || activePath.chapter == null) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÅÿµŸÑ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            openChapterResources(activePath.section, activePath.chapter);
        }

        function renderChapterResourcesUI() {
            if (!bookData) return;
            const { section, chapter } = activeChapterResourcesPath || {};
            if (section == null || chapter == null) return;
            const sec = bookData.sections[section];
            if (!sec || !sec.Chapters || !sec.Chapters[chapter]) return;
            const ch = sec.Chapters[chapter];
            ensureChapterSchema(ch);

            const pdfContainer = document.getElementById('chapter-pdfs-list');
            const videoContainer = document.getElementById('chapter-videos-list');

            const buildRow = (item, index, type, container, removeCallback) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-gray-700 p-3 rounded-lg space-y-2 md:space-y-0 md:flex md:items-center md:gap-3';

                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                titleInput.placeholder = type === 'pdf' ? 'ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸÑŸÅ' : 'ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅŸäÿØŸäŸà';
                titleInput.value = getFromLangArray(item.title, currentLanguage || 'ar') || '';
                titleInput.oninput = (e) => {
                    item.title = setInLangArray(item.title, currentLanguage || 'ar', e.target.value);
                    saveBookToIndexedDB();
                };

                const urlInput = document.createElement('input');
                urlInput.type = 'text';
                urlInput.className = 'flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white';
                urlInput.placeholder = 'https://...';
                urlInput.value = item.url || '';
                urlInput.oninput = (e) => {
                    item.url = e.target.value.trim();
                    saveBookToIndexedDB();
                };

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger text-sm';
                removeBtn.textContent = 'ÿ≠ÿ∞ŸÅ';
                removeBtn.onclick = () => {
                    removeCallback(index);
                    saveBookToIndexedDB();
                };

                wrapper.appendChild(titleInput);
                wrapper.appendChild(urlInput);
                wrapper.appendChild(removeBtn);
                container.appendChild(wrapper);
            };

            if (pdfContainer) {
                pdfContainer.innerHTML = '';
                if (!ch.resources.pdfs.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ PDF.';
                    pdfContainer.appendChild(empty);
                } else {
                    ch.resources.pdfs.forEach((pdf, index) => {
                        buildRow(pdf, index, 'pdf', pdfContainer, (idx) => {
                            ch.resources.pdfs.splice(idx, 1);
                            renderChapterResourcesUI();
                        });
                    });
                }
            }

            if (videoContainer) {
                videoContainer.innerHTML = '';
                if (!ch.resources.videos.length) {
                    const empty = document.createElement('p');
                    empty.className = 'text-sm text-gray-400';
                    empty.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸäÿØŸäŸàŸáÿßÿ™.';
                    videoContainer.appendChild(empty);
                } else {
                    ch.resources.videos.forEach((video, index) => {
                        buildRow(video, index, 'video', videoContainer, (idx) => {
                            ch.resources.videos.splice(idx, 1);
                            renderChapterResourcesUI();
                        });
                    });
                }
            }
        }

        function addChapterResource(type) {
            const { section, chapter } = activeChapterResourcesPath || {};
            if (section == null || chapter == null || !bookData) return;
            const sec = bookData.sections[section];
            if (!sec || !sec.Chapters || !sec.Chapters[chapter]) return;
            const ch = sec.Chapters[chapter];
            ensureChapterSchema(ch);
            const target = type === 'pdf' ? ch.resources.pdfs : ch.resources.videos;
            target.push(ensureResourceItem({ title: setInLangArray([], currentLanguage || 'ar', ''), url: '' }));
            renderChapterResourcesUI();
            saveBookToIndexedDB();
        }

        function testChapterQuizScript() {
            const { section, chapter } = activeChapterResourcesPath || {};
            if (section == null || chapter == null || !bookData) return;
            const sec = bookData.sections[section];
            if (!sec || !sec.Chapters || !sec.Chapters[chapter]) return;
            const ch = sec.Chapters[chapter];
            const input = document.getElementById('chapter-quiz-input');
            const status = document.getElementById('chapter-quiz-status');
            if (!input || !status) return;
            try {
                const result = evaluateQuizScript(input.value, ch.resources.quizPreview);
                status.textContent = `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${result.length} ÿ≥ÿ§ÿßŸÑÿßŸã`;
                status.className = 'text-green-400 text-sm';
            } catch (error) {
                status.textContent = `‚ùå ${error.message}`;
                status.className = 'text-red-400 text-sm';
            }
        }

        function extractTheoryContent(chapter) {
            if (!chapter || !Array.isArray(chapter.content) || !chapter.content.length) return {};
            const block = chapter.content[0];
            if (!block) return {};
            const data = block.data;
            if (typeof data === 'string') {
                return { ar: data };
            }
            if (Array.isArray(data)) {
                return langArrayToObject(data);
            }
            return {};
        }

        function convertResourcesForExport(resources) {
            if (!resources) return {};
            const output = {};
            if (Array.isArray(resources.pdfs) && resources.pdfs.length) {
                const pdfs = resources.pdfs
                    .filter(item => item && item.url)
                    .map(item => ({
                        id: item.id,
                        name: langArrayToObject(item.title || []),
                        url: item.url
                    }));
                if (pdfs.length) output.pdfs = pdfs;
            }
            if (Array.isArray(resources.videos) && resources.videos.length) {
                const videos = resources.videos
                    .filter(item => item && item.url)
                    .map(item => ({
                        id: item.id,
                        title: langArrayToObject(item.title || []),
                        url: item.url
                    }));
                if (videos.length) output.videos = videos;
            }
            const quiz = evaluateQuizScript(resources.quizScript || '', resources.quizPreview || resources.quiz || []);
            if (quiz.length) output.quiz = quiz;
            if (resources.quizScript && resources.quizScript.trim()) {
                output.quizScript = resources.quizScript.trim();
            }
            return output;
        }

        function convertBookToSubject(book) {
            ensureBookSchema(book);
            const subject = {
                icon: book.icon || 'üìò',
                color: book.color || '#2563eb',
                title: langArrayToObject(book.name),
                description: langArrayToObject(book.bio),
                blocks: []
            };
            if (book.cover) subject.cover = book.cover;

            const sections = (book.sections || []).slice().sort((a, b) => (a.sort ?? 0) - (b.sort ?? 0));
            sections.forEach((section, index) => {
                ensureSectionSchema(section);
                const block = {
                    id: section.id || index + 1,
                    title: langArrayToObject(section.section_name),
                    brief: langArrayToObject(section.brief),
                    lessons: []
                };
                const sectionResources = convertResourcesForExport(section.resources);
                if (Object.keys(sectionResources).length) {
                    block.block_resources = sectionResources;
                }

                (section.Chapters || []).forEach((chapter, chapterIndex) => {
                    ensureChapterSchema(chapter);
                    const lessonResources = convertResourcesForExport(chapter.resources);
                    const lesson = {
                        id: chapter.id || `${block.id}-${chapterIndex + 1}`,
                        title: langArrayToObject(chapter.title),
                        brief: langArrayToObject(chapter.brief),
                        content: {
                            theory: extractTheoryContent(chapter),
                            exercises: Array.isArray(chapter.exercises) ? chapter.exercises : (chapter.content && chapter.content.exercises) || []
                        }
                    };
                    if (Object.keys(lessonResources).length) {
                        lesson.resources = lessonResources;
                    }
                    block.lessons.push(lesson);
                });

                subject.blocks.push(block);
            });

            return subject;
        }

        function convertSubjectResourcesToBook(resources) {
            if (!resources || typeof resources !== 'object') return {};

            const pdfSource = resources.pdfs ?? resources.pdf;
            const videosSource = resources.videos ?? resources.video;
            const output = {};

            if (Array.isArray(pdfSource)) {
                const pdfs = pdfSource
                    .map((item, index) => {
                        if (!item) return null;
                        if (typeof item === 'string') {
                            return ensureResourceItem({
                                id: `pdf-${index + 1}`,
                                name: { en: `PDF ${index + 1}`, ar: `ŸÖŸÑŸÅ ${index + 1}` },
                                url: item
                            });
                        }
                        return ensureResourceItem({
                            id: item.id || `pdf-${index + 1}`,
                            name: item.name || item.title || {},
                            url: item.url || item.link || ''
                        });
                    })
                    .filter(item => item && item.url);
                if (pdfs.length) output.pdfs = pdfs;
            } else if (pdfSource && typeof pdfSource === 'object') {
                const pdfs = Object.entries(pdfSource)
                    .map(([key, value]) => {
                        if (!value) return null;
                        if (typeof value === 'string') {
                            return ensureResourceItem({
                                id: key,
                                name: { en: key.toUpperCase(), ar: key.toUpperCase() },
                                url: value
                            });
                        }
                        return ensureResourceItem({
                            id: value.id || key,
                            name: value.name || value.title || { en: key.toUpperCase(), ar: key.toUpperCase() },
                            url: value.url || value.link || ''
                        });
                    })
                    .filter(item => item && item.url);
                if (pdfs.length) output.pdfs = pdfs;
            } else if (typeof pdfSource === 'string' && pdfSource.trim()) {
                output.pdfs = [ensureResourceItem({
                    id: 'pdf-1',
                    name: { en: 'PDF', ar: 'ŸÖŸÑŸÅ PDF' },
                    url: pdfSource
                })];
            }

            if (Array.isArray(videosSource)) {
                const videos = videosSource
                    .map((item, index) => {
                        if (!item) return null;
                        if (typeof item === 'string') {
                            return ensureResourceItem({
                                id: `video-${index + 1}`,
                                title: { en: `Video ${index + 1}`, ar: `ŸÅŸäÿØŸäŸà ${index + 1}` },
                                url: item
                            });
                        }
                        return ensureResourceItem({
                            id: item.id || `video-${index + 1}`,
                            title: item.title || item.name || {},
                            url: item.url || item.link || ''
                        });
                    })
                    .filter(item => item && item.url);
                if (videos.length) output.videos = videos;
            } else if (videosSource && typeof videosSource === 'object' && !Array.isArray(videosSource)) {
                const item = videosSource;
                const normalized = ensureResourceItem({
                    id: item.id || 'video-1',
                    title: item.title || item.name || { en: 'Video', ar: 'ŸÅŸäÿØŸäŸà' },
                    url: item.url || item.link || ''
                });
                if (normalized.url) output.videos = [normalized];
            } else if (typeof videosSource === 'string' && videosSource.trim()) {
                output.videos = [ensureResourceItem({
                    id: 'video-1',
                    title: { en: 'Video', ar: 'ŸÅŸäÿØŸäŸà' },
                    url: videosSource
                })];
            }

            const quizArray = Array.isArray(resources.quiz)
                ? resources.quiz
                : Array.isArray(resources.quizPreview)
                    ? resources.quizPreview
                    : [];

            if (quizArray.length) {
                output.quiz = quizArray;
                output.quizScript = JSON.stringify(quizArray, null, 2);
            } else if (typeof resources.quizScript === 'string' && resources.quizScript.trim()) {
                output.quizScript = resources.quizScript.trim();
            }

            return output;
        }

        function convertSubjectToBook(subjectId, subject, index = 0) {
            const normalizedSubject = subject || {};
            const title = normalizedSubject.title || {};
            const fallback = title.en || title.ar || subjectId || 'subject';
            const normalizedId = normalizedSubject.subjectId || subjectId || slugify(fallback);
            const book = {
                name: toLangArray(title),
                bio: toLangArray(normalizedSubject.description || {}),
                icon: normalizedSubject.icon || 'üìò',
                color: normalizedSubject.color || '#2563eb',
                alias: normalizedSubject.alias || normalizedId,
                subjectId: normalizedId || generateUniqueID(),
                cover: normalizedSubject.cover || '',
                sections: []
            };

            const blocks = Array.isArray(normalizedSubject.blocks) ? normalizedSubject.blocks : [];
            blocks.forEach((block, blockIndex) => {
                const safeBlock = block || {};
                const section = {
                    id: safeBlock.id || blockIndex + 1,
                    section_name: toLangArray(safeBlock.title || {}),
                    brief: toLangArray(safeBlock.brief || {}),
                    sort: blockIndex,
                    resources: {},
                    Chapters: []
                };

                const sectionResources = convertSubjectResourcesToBook(safeBlock.block_resources || safeBlock.resources || {});
                if (Object.keys(sectionResources).length) {
                    section.resources = sectionResources;
                }

                const lessons = Array.isArray(safeBlock.lessons) ? safeBlock.lessons : [];
                lessons.forEach((lesson, lessonIndex) => {
                    const safeLesson = lesson || {};
                    const contentBlock = safeLesson.content || {};
                    const theoryContent = contentBlock.theory || '';
                    const exercisesContent = contentBlock.exercises || safeLesson.exercises || [];

                    const chapter = {
                        id: safeLesson.id || `${section.id}-${lessonIndex + 1}`,
                        title: toLangArray(safeLesson.title || {}),
                        brief: toLangArray(safeLesson.brief || {}),
                        content: [{ type: 'paragraph', data: toLangArray(theoryContent) }],
                        exercises: Array.isArray(exercisesContent) ? exercisesContent : []
                    };

                    const lessonResources = convertSubjectResourcesToBook(safeLesson.resources || {});
                    if (Object.keys(lessonResources).length) {
                        chapter.resources = lessonResources;
                    }

                    section.Chapters.push(chapter);
                });

                book.sections.push(section);
            });

            ensureBookSchema(book);
            normalizeAuditDefaults(book);
            return book;
        }

        function isSubjectBundlePayload(payload) {
            if (!payload || typeof payload !== 'object' || Array.isArray(payload)) return false;
            const values = Object.values(payload);
            if (!values.length) return false;
            return values.every(item => item && typeof item === 'object' && Array.isArray(item.blocks));
        }

        function clearBooksStore() {
            return new Promise(resolve => {
                clearAllBooksFromIndexedDB(() => resolve());
            });
        }

        function saveImportedBooks(books) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ© ÿ®ÿπÿØ'));
                    return;
                }
                if (!Array.isArray(books) || books.length === 0) {
                    resolve([]);
                    return;
                }

                const tx = db.transaction(['books'], 'readwrite');
                const store = tx.objectStore('books');
                const imported = [];

                books.forEach((book, index) => {
                    ensureBookSchema(book);
                    const record = {
                        name: book.name,
                        sections: book.sections,
                        bio: book.bio,
                        alias: book.alias || book.subjectId || '',
                        icon: book.icon || 'üìò',
                        color: book.color || '#2563eb',
                        subjectId: book.subjectId || slugify(getFromLangArray(book.name, 'en') || getFromLangArray(book.name, 'ar') || `subject-${generateUniqueID()}`),
                        cover: book.cover || '',
                        lastModified: new Date().toISOString()
                    };

                    const request = store.add(record);
                    request.onsuccess = (event) => {
                        imported.push({ id: event.target.result, index });
                    };
                    request.onerror = (event) => {
                        console.error('Import book failed', event.target.error);
                    };
                });

                tx.oncomplete = () => {
                    imported.sort((a, b) => a.index - b.index);
                    resolve(imported);
                };
                tx.onerror = () => {
                    reject(tx.error || new Error('ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿßŸÑŸÉÿ™ÿ® ÿßŸÑŸÖÿ≥ÿ™Ÿàÿ±ÿØÿ©'));
                };
            });
        }

        async function importSubjectBundleFromJSON(bundle) {
            const entries = Object.entries(bundle || {}).filter(([, subject]) => subject && typeof subject === 'object');
            if (!entries.length) {
                throw new Error('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸàÿßÿØ ÿµÿßŸÑÿ≠ÿ© ŸÅŸä ÿßŸÑŸÖŸÑŸÅ.');
            }

            const books = entries.map(([subjectId, subject], index) => convertSubjectToBook(subjectId, subject, index));
            await clearBooksStore();
            const imported = await saveImportedBooks(books);
            if (imported.length) {
                const firstId = imported[0].id;
                loadBookById(firstId);
            } else {
                currentBookId = null;
                bookData = null;
                renderApp();
                populateBookSwitcher(null);
            }
        }

        async function importSingleBookFromJSON(book) {
            await clearBooksStore();
            ensureUniqueIDs(book);
            normalizeAuditDefaults(book);
            bookData = book;
            lastSavedBook = null;
            activePath = { section: null, chapter: null };
            migrateOldDataStructure();
            ensureBookSchema(bookData);
            renderApp();
            saveBookToIndexedDB();
        }

        function downloadBundle(content, filename = 's-data.js') {
            const blob = new Blob([content], { type: 'application/javascript;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                URL.revokeObjectURL(link.href);
                link.remove();
            }, 500);
        }

        function exportAllBooksBundle() {
            if (!db) {
                alert('ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ© ÿ®ÿπÿØ.');
                return;
            }
            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.getAll();
            request.onsuccess = (event) => {
                const books = event.target.result || [];
                if (!books.length) {
                    alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÉÿ™ÿ® ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±.');
                    return;
                }
                const payload = {};
                books.forEach(book => {
                    const clone = JSON.parse(JSON.stringify(book));
                    ensureBookSchema(clone);
                    const subjectId = clone.subjectId || slugify(getFromLangArray(clone.name, 'en') || getFromLangArray(clone.name, 'ar') || `subject-${clone.id || generateUniqueID()}`);
                    payload[subjectId || generateUniqueID()] = convertBookToSubject(clone);
                });
                const content = 'const SUBJECT_DATA = ' + JSON.stringify(payload, null, 4) + ';';
                downloadBundle(content, 's-data.js');
            };
        }
        
function destroyCurrentBook() {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑÿ≠ÿßŸÑŸäÿü Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.')) return;
    if (autoSaveInterval) { clearInterval(autoSaveInterval); autoSaveInterval = null; }
    bookData = null;
    lastSavedBook = null;
    activePath = { section: null, chapter: null };
    clearAllBooksFromIndexedDB(function(){ renderApp(); });
}


               function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            autoSaveInterval = setInterval(() => {
                if (bookData && bookData.sections) {
                    // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
                    protectContentFromLoss();
                    if (currentView === 'editor') {
                        saveCurrentEditorContent();
                    }
                    saveBookToIndexedDB();
                }
            }, 5000);
        }

     
        function updateBioPreview() {
            const bioText = document.getElementById('book-bio-input-ar').value;
            const bioPreview = document.getElementById('bio-preview');
            
            if (bioText.trim()) {
                const processedBio = bioText.replace(/\r\n/g, '\n').replace(/\n/g, '<br>');
                bioPreview.innerHTML = processedBio;
            } else {
                bioPreview.innerHTML = '<p class="text-gray-500 italic">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÇÿØŸÖÿ©...</p>';
            }
        }

        

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });

            localStorage.setItem('editorTheme', theme);
            saveUserPreferences();
        }

        function increaseFontSize() {
            if (editorSettings.fontSize < 24) {
                editorSettings.fontSize += 2;
                updateFontSize();
                saveUserPreferences();
            }
        }

        function decreaseFontSize() {
            if (editorSettings.fontSize > 10) {
                editorSettings.fontSize -= 2;
                updateFontSize();
                saveUserPreferences();
            }
        }

        function updateFontSize() {
            document.documentElement.style.setProperty('--editor-font-size', editorSettings.fontSize + 'px');
            const fontSizeDisplay = document.getElementById('font-size-display');
            if (fontSizeDisplay) fontSizeDisplay.textContent = editorSettings.fontSize + 'px';
        }

        function changeFontFamily() {
            const fontSelect = document.getElementById('font-family-select');
            editorSettings.fontFamily = fontSelect.value;
            document.documentElement.style.setProperty('--editor-font', editorSettings.fontFamily);
            saveUserPreferences();
        }

        function changeEditorBg() {
            const bgColorPicker = document.getElementById('bg-color-picker');
            editorSettings.bgColor = bgColorPicker.value;
            document.documentElement.style.setProperty('--editor-bg', editorSettings.bgColor);
            saveUserPreferences();
        }

        function changeEditorText() {
            const textColorPicker = document.getElementById('text-color-picker');
            editorSettings.textColor = textColorPicker.value;
            document.documentElement.style.setProperty('--editor-text', editorSettings.textColor);
            saveUserPreferences();
        }

        function toggleLayout() {
            const splitView = document.getElementById('main-split-view');
            const layoutToggle = document.getElementById('layout-toggle');
            const isFullEditor = splitView.classList.contains('full-editor');
            
            if (isFullEditor) {
                splitView.classList.remove('full-editor');
                layoutToggle.innerHTML = '<i class="fas fa-columns"></i>';
                layoutToggle.title = 'ÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÉÿßŸÖŸÑ';
            } else {
                splitView.classList.add('full-editor');
                layoutToggle.innerHTML = '<i class="fas fa-expand"></i>';
                layoutToggle.title = 'ÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸÇÿ≥ŸÖ';
            }
            saveUserPreferences();
        }



        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initIndexedDB();
                loadLastBookFromIndexedDB();
                migrateOldDataStructure();
                renderLanguageSelector();


                startAutoSave();
            } catch (error) {
                console.error('Failed to initialize IndexedDB:', error);
            }
            
            const controls = document.getElementById('controls-panel') || document.body;
            if (!document.getElementById('manual-save-btn')) {
                const btn = document.createElement('button');
                btn.id = 'manual-save-btn';
                btn.className = 'btn btn-success';
                btn.textContent = 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™';
                btn.addEventListener('click', () => {
                    // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸäÿØŸàŸä
                    protectContentFromLoss();
                    if (currentView === 'editor') saveCurrentEditorContent();
                    saveBookToIndexedDB();
                });
                controls.prepend(btn);
            }
			
			

const trashBtn=document.createElement('button');
trashBtn.id='open-trash-btn';trashBtn.className='btn';trashBtn.textContent='ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∞ŸàŸÅÿßÿ™';
trashBtn.onclick=openTrash;
controls.appendChild(trashBtn);

             document.getElementById('txt-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        allLines = e.target.result.split('\n');
                        initializeJsonFromTxt();
                      //  startAutoSave();
                    };
                    reader.readAsText(file, 'utf-8');
                }
            });
document.getElementById('approve-all-btn').addEventListener('click', approveAllChapters);
            document.getElementById('json-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const text = await file.text();
                    const raw = JSON.parse(text);
                    const payload = raw && typeof raw === 'object' && !Array.isArray(raw) && raw.SUBJECT_DATA
                        ? raw.SUBJECT_DATA
                        : raw;

                    if (isSubjectBundlePayload(payload)) {
                        await importSubjectBundleFromJSON(payload);
                        alert('ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÉÿ™ÿ® ÿ®ŸÜÿ¨ÿßÿ≠.');
                    } else {
                        await importSingleBookFromJSON(raw);
                        alert('ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑŸÉÿ™ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠.');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    alert('ŸÖŸÑŸÅ JSON ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                } finally {
                    e.target.value = '';
                }
            });


            document.getElementById('search-btn').addEventListener('click', openAdvancedSearch);

            // Allow pressing Enter in advanced search input to trigger search
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performAdvancedSearch();
                }
            });

            // ... ÿØÿßÿÆŸÑ document.addEventListener('DOMContentLoaded', ...)
document.getElementById('save-json').addEventListener('click', () => {
    // ... (ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≥ÿßÿ®ŸÇ) ...
    const blob = new Blob([JSON.stringify(bookData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    // ‚¨áÔ∏è ÿßÿ≥ÿ™ÿ®ÿØŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±
    // a.download = `${bookData.name || 'ŸÉÿ™ÿßÿ®'}.json`;
    
    // ‚¨áÔ∏è ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ
    // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿπÿßÿ± ÿ•ÿ∞ÿß Ÿàÿ¨ÿØÿå Ÿàÿ•ŸÑÿß ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßÿ≥ŸÖ ÿßŸÑŸÉÿ™ÿßÿ® ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
    const bookName = bookData.alias ? bookData.alias.trim() : (getLocalizedBookName(bookData, currentLanguage || 'ar') || 'ŸÉÿ™ÿßÿ®');
    // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿßÿ≥ŸÖ ŸÖŸÜ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸÖŸÖŸÜŸàÿπÿ© ŸÅŸä ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖŸÑŸÅÿßÿ™
    const safeAlias = bookName.replace(/[\\\/:*?"<>|]/g, '_');
    a.download = `${safeAlias}.json`;
    // ‚¨ÜÔ∏è ŸÜŸáÿßŸäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ

    a.click();
    URL.revokeObjectURL(url);
});

            document.getElementById('search-chapters').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const treeItems = treeContainer.querySelectorAll('[data-type="chapter"]');
                treeItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.style.display = 'block';
                        item.style.backgroundColor = searchTerm ? '#374151' : '';
                    } else {
                        item.style.display = searchTerm ? 'none' : 'block';
                        item.style.backgroundColor = '';
                    }
                });
            });

            settingsToggle.addEventListener('click', () => {
                controlsPanel.classList.toggle('controls-hidden');
                controlsPanel.classList.toggle('controls-visible');
            });
            
            document.addEventListener('click', (e) => {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.classList.add('hidden');
                }
            });
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿØÿπŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
            document.addEventListener('click', (e) => {
                const modal = document.getElementById('section-sort-modal');
                if (modal && e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ŸÑŸÑÿ≥ÿ≠ÿ® ŸàÿßŸÑÿ•ŸÅŸÑÿßÿ™ ÿπŸÑŸâ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                // ÿ•ÿ≤ÿßŸÑÿ© ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿ® ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿπŸÜÿØ ÿßŸÑÿ≥ÿ≠ÿ® ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅÿ©
                if (!e.target.closest('.tree-item')) {
                    document.querySelectorAll('.tree-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                }
            });
            
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿ®
                document.querySelectorAll('.tree-item').forEach(item => {
                    item.classList.remove('drag-over', 'dragging');
                });
            });

            editorTitleInput.addEventListener('input', (e) => {
                if (activePath.section !== null && activePath.chapter !== null) {
                    // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÇÿ®ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜŸàÿßŸÜ
                    protectContentFromLoss();
                    const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
                    setLocalizedTitle(ch, currentLanguage || 'ar', e.target.value || '');
                    const inlineTitle = document.getElementById('editor-title-inline');
                    if (inlineTitle) inlineTitle.value = e.target.value || '';
                    renderTreeView();
                }
            });
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ŸÑŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿØŸÖÿ¨
            document.addEventListener('input', (e) => {
                if (e.target.id === 'editor-title-inline') {
                    if (activePath.section !== null && activePath.chapter !== null) {
                        // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÇÿ®ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿØŸÖÿ¨
                        protectContentFromLoss();
                        const ch = bookData.sections[activePath.section].Chapters[activePath.chapter];
                        setLocalizedTitle(ch, currentLanguage || 'ar', e.target.value || '');
                        editorTitleInput.value = e.target.value || '';
                        renderTreeView();
                    }
                }
            });


viewTabBtn.addEventListener('click', () => switchView('viewer'));
            editTabBtn.addEventListener('click', () => switchView('editor'));
            showStatsBtn.addEventListener('click', displayStats);
            exportMapBtn.addEventListener('click', exportChaptersMap);

            document.getElementById('edit-book-info-btn').addEventListener('click', editBookInfo);
            document.getElementById('book-bio-input-ar').addEventListener('input', updateBioPreview);

            document.getElementById('new-book-btn')?.addEventListener('click', promptCreateNewBook);
            document.getElementById('clone-book-btn')?.addEventListener('click', cloneCurrentBook);
            document.getElementById('rename-book-btn')?.addEventListener('click', renameCurrentBook);
            document.getElementById('delete-book-btn')?.addEventListener('click', deleteCurrentBook);
            document.getElementById('export-bundle-btn')?.addEventListener('click', exportAllBooksBundle);

            const switcherEl = document.getElementById('book-switcher');
            if (switcherEl) {
                switcherEl.addEventListener('change', (e) => {
                    const id = parseInt(e.target.value, 10);
                    if (!isNaN(id)) {
                        loadBookById(id);
                    }
                });
                switcherEl.addEventListener('dblclick', () => toggleBookLibrary(true));
            }

            document.getElementById('library-create-btn')?.addEventListener('click', () => {
                toggleBookLibrary(false);
                promptCreateNewBook();
            });

            document.getElementById('chapter-section-select').addEventListener('change', saveUserPreferences);
            document.getElementById('chapter-sort-input').addEventListener('input', saveUserPreferences);
            loadUserPreferences();
            renderLanguageSelector();
            // Keyboard shortcut: Save (Ctrl/Cmd + S)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
                    e.preventDefault();
                    // ÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
                    protectContentFromLoss();
                    if (currentView === 'editor') saveCurrentEditorContent();
                    saveBookToIndexedDB();
                }
            });
			const contextMenu = document.getElementById('context-menu');

            if (contextMenu) {
                
                document.addEventListener('click', function() {
                    contextMenu.classList.add('hidden'); // ÿ£Ÿà ÿ£Ÿä class ÿ™ÿ≥ÿ™ÿÆÿØŸÖŸá ŸÑŸÑÿ•ÿÆŸÅÿßÿ°
                });
            }
			document.getElementById('revlog-open-btn')?.addEventListener('click',openRevLogModal);
document.getElementById('revlog-close')?.addEventListener('click',closeRevLogModal);

            switchView('viewer');
        });

        let editorSettings = {
            fontSize: 14,
            fontFamily: 'Consolas',
            bgColor: '#1e293b',
            textColor: '#f8fafc'
        };

// Ensure viewer content is freshly rendered before printing
window.addEventListener('beforeprint', function(){
    if (typeof renderViewerContentOnly === 'function') renderViewerContentOnly();
	
            
           
});
function getActiveChapter() {
  if (activePath.section == null || activePath.chapter == null) return null;
  return bookData.sections[activePath.section].Chapters[activePath.chapter] || null;
}
        function approveAllChapters() {
    if (!bookData || !bookData.sections) {
        alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ŸÉÿ™ÿßÿ® ÿ£ŸàŸÑÿßŸã.");
        return;
    }

    if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿπÿ™ŸÖÿßÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿµŸàŸÑ ŸÅŸä ÿßŸÑŸÉÿ™ÿßÿ®ÿü`)) {
        return;
    }

    try {
        let chaptersAffected = 0;
        // 3. Iterate through sections and chapters to update the flag
        if (bookData.sections && Array.isArray(bookData.sections)) {
            bookData.sections.forEach(section => {
                if (section.Chapters && Array.isArray(section.Chapters)) {
                    section.Chapters.forEach(chapter => {
                        chapter.Is_Audit = true;
                        chaptersAffected++;
                    });
                }
            });
        }

        // 5. Save changes and refresh UI
        saveBookToIndexedDB(); // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
        renderApp(); // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© (ÿ®ŸÖÿß ŸÅŸä ÿ∞ŸÑŸÉ ÿ¥ÿßÿ±ÿ© ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÅÿµŸÑ ŸÜÿ¥ÿ∑)
        
        alert(`ÿ™ŸÖ ÿßÿπÿ™ŸÖÿßÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿµŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!
ÿπÿØÿØ ÿßŸÑŸÅÿµŸàŸÑ ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿáÿß: ${chaptersAffected}`);

    } catch (error) {
        console.error("An error occurred while approving all chapters:", error.message);
        alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿπÿ™ŸÖÿßÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿµŸàŸÑ.");
    }
}
function renderAuditBadge() {
  const badge = document.getElementById('audit-badge');
  if (!badge) return;
  const ch = getActiveChapter();
  if (!ch) { badge.textContent = ''; badge.className = 'hidden'; return; }
  const ok = !!ch.Is_Audit;
  badge.className = 'mr-2 inline-flex items-center px-2 py-1 rounded text-xs font-bold ' + (ok ? 'bg-green-600 text-white' : 'bg-red-600 text-white');
  badge.textContent = ok ? 'ŸÖÿπÿ™ŸÖÿØ' : 'ÿ∫Ÿäÿ± ŸÖÿπÿ™ŸÖÿØ';
}

function openAuditModal() {
  const ch = getActiveChapter();
  if (!ch) { alert('ÿßÿÆÿ™ÿ± ŸÅÿµŸÑŸãÿß ÿ£ŸàŸÑÿßŸã'); return; }
  if (ch.Is_Audit == null) ch.Is_Audit = true;
  if (!Array.isArray(ch.reviewLogs)) ch.reviewLogs = [];

  document.getElementById('audit-status-select').value = String(!!ch.Is_Audit);
  document.getElementById('audit-reviewer-select').value = 'admin';
  document.getElementById('audit-notes').value = '';

  renderAuditLogs(ch);
  document.getElementById('audit-modal').classList.remove('hidden');
}

function closeAuditModal() {
  document.getElementById('audit-modal').classList.add('hidden');
}

function renderAuditLogs(ch) {
  const tbody = document.getElementById('audit-logs-tbody');
  if (!tbody) return;
  tbody.innerHTML = (ch.reviewLogs || []).slice().reverse().map(log => {
    const statusTxt = log.approved ? 'ŸÖÿπÿ™ŸÖÿØ' : 'ÿ∫Ÿäÿ± ŸÖÿπÿ™ŸÖÿØ';
    return `
      <tr class="border-b border-gray-700">
        <td class="p-2">${statusTxt}</td>
        <td class="p-2">${log.reviewer || ''}</td>
        <td class="p-2">${(log.notes || '').replace(/</g,'&lt;')}</td>
        <td class="p-2">${new Date(log.at).toLocaleString()}</td>
      </tr>`;
  }).join('');
}

function preserveContentOnAudit() {
  if (currentView === 'editor' && markdownEditor && markdownEditor.value.trim() !== '') {
    saveCurrentEditorContent();
  }
}

function preserveContentOnAudit() {
    if (currentView === 'editor' && markdownEditor) {
        saveCurrentEditorContent();
    }
}

function addAuditLog() {
  // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ≠ÿßŸÑŸä ŸÇÿ®ŸÑ ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿπŸÑŸäŸÇ ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ
  preserveContentOnAudit();
  
  const ch = getActiveChapter();
  if (!ch) {
    alert('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÅÿµŸÑ ŸÜÿ¥ÿ∑ ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿπŸÑŸäŸÇ ÿßÿπÿ™ŸÖÿßÿØ ŸÑŸá');
    return;
  }

  const approved = document.getElementById('audit-status-select').value === 'true';
  const reviewer = document.getElementById('audit-reviewer-select').value || 'admin';
  const notes = document.getElementById('audit-notes').value.trim();

  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
  if (!reviewer) {
    alert('Ÿäÿ¨ÿ® ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸèÿ±ÿßÿ¨ÿπ');
    return;
  }

  // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿµŸÅŸàŸÅÿ© ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©
  if (!Array.isArray(ch.reviewLogs)) {
    ch.reviewLogs = [];
  }

  // ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ¨ÿØŸäÿØ
  const newLog = {
    approved: approved,
    reviewer: reviewer,
    notes: notes,
    at: new Date().toISOString()
  };
  
  ch.reviewLogs.push(newLog);
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ
  ch.Is_Audit = approved;

  // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
  if (typeof saveBookToIndexedDB === 'function') {
    saveBookToIndexedDB();
  }
  
  // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  renderAuditLogs(ch);
  renderAuditBadge();
  
  // ŸÖÿ≥ÿ≠ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
  document.getElementById('audit-notes').value = '';
  
  // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
  const statusText = approved ? 'ŸÖÿπÿ™ŸÖÿØ' : 'ÿ∫Ÿäÿ± ŸÖÿπÿ™ŸÖÿØ';
  alert(`ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ: ${statusText}\nÿßŸÑŸÖŸèÿ±ÿßÿ¨ÿπ: ${reviewer}\nÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©: ${notes || 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™'}`);
}

const AI_MODELS={gemini:[{v:"gemini-1.5-flash",n:"Gemini 1.5 Flash"},{v:"gemini-1.5-pro",n:"Gemini 1.5 Pro"}],deepseek:[{v:"deepseek-chat",n:"DeepSeek Chat"},{v:"deepseek-coder",n:"DeepSeek Coder"}]};
function ensureChapterAIBar(){
  const anchor=document.getElementById('audit-open-btn'); if(!anchor) return;
  let slot=document.getElementById('ai-tools-slot'); if(!slot){slot=document.createElement('div');slot.id='ai-tools-slot';anchor.insertAdjacentElement('afterend',slot)}
  if(slot.dataset.ready==='1') return;
  slot.innerHTML=
  '<div id="ai-bar" class="ai-bar">'+
    '<select id="ai-provider" class="select"><option value="gemini">Gemini</option><option value="deepseek">DeepSeek</option></select>'+
    '<select id="ai-model" class="select"></select>'+
    '<input id="ai-key" type="password" placeholder="API Key">'+
    '<select id="ai-target-lang" class="select"><option value="ar">ar</option><option value="en">en</option></select>'+
    '<div id="ai-kind" class="group">'+
      '<label><input type="checkbox" data-kind="format">ÿ™ŸÜÿ≥ŸäŸÇ</label>'+
      '<label><input type="checkbox" data-kind="proof">ÿ™ÿØŸÇŸäŸÇ</label>'+
      '<label><input type="checkbox" data-kind="translate">ÿ™ÿ±ÿ¨ŸÖÿ©</label>'+
      '<label><input type="checkbox" data-kind="custom">Prompt</label>'+
    '</div>'+
    '<textarea id="ai-custom-prompt" placeholder="Prompt"></textarea>'+
    '<label class="ml-2"><input type="checkbox" id="ai-log">ÿ≥ÿ¨ŸÑ</label>'+
    '<button id="ai-run" class="btn btn-primary">ÿ™ÿ¥ÿ∫ŸäŸÑ</button>'+
  '</div>';
  slot.dataset.ready='1';
  const prov=slot.querySelector('#ai-provider'), model=slot.querySelector('#ai-model'), key=slot.querySelector('#ai-key');
  const lang=slot.querySelector('#ai-target-lang'), run=slot.querySelector('#ai-run');
  const kindBox=slot.querySelector('#ai-kind'), custom=slot.querySelector('#ai-custom-prompt');
  function fillModels(){
    const p=prov.value; model.innerHTML=AI_MODELS[p].map(m=>'<option value="'+m.v+'">'+m.n+'</option>').join('');
    const saved=localStorage.getItem('ai.model.'+p); if(saved) model.value=saved;
  }
  prov.addEventListener('change',()=>{fillModels();localStorage.setItem('ai.provider',prov.value)});
  model.addEventListener('change',()=>localStorage.setItem('ai.model.'+prov.value,model.value));
  key.addEventListener('input',()=>localStorage.setItem('ai.key',key.value));
  lang.addEventListener('change',()=>localStorage.setItem('ai.lang',lang.value));
  prov.value=localStorage.getItem('ai.provider')||'gemini'; fillModels();
  key.value=localStorage.getItem('ai.key')||''; lang.value=localStorage.getItem('ai.lang')||'ar';
  kindBox.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change',e=>{
      if(e.target.checked){ kindBox.querySelectorAll('input').forEach(x=>{if(x!==e.target) x.checked=false}); }
      custom.style.display=(e.target.dataset.kind==='custom'&&e.target.checked)?'block':'none';
    });
  });
  slot.querySelector('#revlog-open-btn')?.addEventListener('click',openRevLogModal);
  document.getElementById('revlog-open-btn')?.addEventListener('click',openRevLogModal);
  run.addEventListener('click',async()=>{
    const ch=getActiveChapter(); if(!ch||!window.markdownEditor) return;
    const kind=(Array.from(kindBox.querySelectorAll('input')).find(x=>x.checked)?.dataset.kind)||'format';
    const before=markdownEditor.value||'';
    const prompt=(kind==='custom'?(custom.value+'\n\n---\n'+before):buildAIPrompt(kind,before,lang.value));
    const out=await callAI({provider:prov.value,model:model.value,apiKey:key.value,prompt});
    if(!out) return;
    markdownEditor.value=out;
    setLocalizedContent(ch,currentLanguage||'ar',out);
    if(typeof updateMarkdownPreview==='function') updateMarkdownPreview();
    if(slot.querySelector('#ai-log').checked){ pushRevLog({kind,provider:prov.value,model:model.value,note:(kind==='custom'?custom.value:'')},before,out); }
  });
}
function buildAIPrompt(kind,text,targetLang){
  if(kind==='format') return 'ÿ≠ŸàŸëŸÑ ÿßŸÑŸÜÿµ ÿßŸÑÿ™ÿßŸÑŸä ÿ•ŸÑŸâ Markdown ŸÖŸÜÿ∏ŸÖ ÿ®ÿØŸàŸÜ ÿßÿÆÿ™ÿµÿßÿ± ÿ£Ÿà ÿ•ÿπÿßÿØÿ© ÿµŸäÿßÿ∫ÿ©.\n\n---\n'+text;
  if(kind==='proof') return 'ÿØŸÇŸëŸÇ ŸÑÿ∫ŸàŸäŸãÿß Ÿàÿ•ŸÖŸÑÿßÿ¶ŸäŸãÿß ÿßŸÑŸÜÿµ ÿßŸÑÿ™ÿßŸÑŸä ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸÖÿπŸÜŸâ Ÿàÿ£ÿπÿØŸá ÿ®ÿµŸäÿ∫ÿ© Markdown ŸÅŸÇÿ∑.\n\n---\n'+text;
  if(kind==='translate') return 'ÿ™ÿ±ÿ¨ŸÖ ÿ™ÿ±ÿ¨ŸÖÿ© ŸÖŸàÿ∂ŸàÿπŸäÿ© ÿØŸÇŸäŸÇÿ© ÿ•ŸÑŸâ ŸÑÿ∫ÿ© '+targetLang+' ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ Markdown ÿØŸàŸÜ ÿ™ŸÑÿÆŸäÿµ.\n\n---\n'+text;
  return text;
}
async function callAI({provider,model,apiKey,prompt,endpoint}){
  if(provider==='gemini'){
    const url=(endpoint||('https://generativelanguage.googleapis.com/v1beta/models/'+encodeURIComponent(model)+':generateContent?key='+encodeURIComponent(apiKey)));
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}]})});
    const j=await r.json(); return (j.candidates&&j.candidates[0]&&j.candidates[0].content&&j.candidates[0].content.parts?j.candidates[0].content.parts.map(p=>p.text||'').join(''):'')||'';
  }
  if(provider==='deepseek'){
    const url=endpoint||'https://api.deepseek.com/chat/completions';
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify({model,temperature:0,messages:[{role:'user',content:prompt}]})});
    const j=await r.json(); return (j.choices&&j.choices[0]&&j.choices[0].message&&j.choices[0].message.content)||'';
  }
  return '';
}
function pushRevLog(meta,before,after){
  const ch=getActiveChapter(); if(!ch) return;
  if(!Array.isArray(ch.changeLogs)) ch.changeLogs=[];
  ch.changeLogs.push({id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())),lang:currentLanguage||'ar',kind:meta.kind,provider:meta.provider,model:meta.model,at:new Date().toISOString(),note:meta.note||'',beforeLen:(before||'').length,afterLen:(after||'').length});
  if(typeof saveBookToIndexedDB==='function') saveBookToIndexedDB();
}
function openRevLogModal(){
  const m=document.getElementById('revlog-modal'); if(!m) return;
  const list=document.getElementById('revlog-list');
  const ch=getActiveChapter(); const logs=(ch&&ch.changeLogs)||[];
  list.innerHTML=logs.slice().reverse().map(l=>'<div class="p-2 border border-gray-700 rounded text-sm text-gray-200"><div class="flex gap-2 flex-wrap"><span class="px-2 py-0.5 rounded bg-gray-700">'+l.kind+'</span><span class="px-2 py-0.5 rounded bg-gray-700">'+l.provider+'/'+l.model+'</span><span class="px-2 py-0.5 rounded bg-gray-700">'+l.lang+'</span><span class="px-2 py-0.5 rounded bg-gray-700">'+new Date(l.at).toLocaleString()+'</span></div>'+(l.note?'<div class="mt-1 text-gray-300">'+l.note.replace(/</g,'&lt;')+'</div>':'')+'</div>').join('')||'<div class="text-gray-400 text-center">ŸÑÿß ÿ≥ÿ¨ŸÑÿßÿ™</div>';
  m.classList.remove('hidden');
}
function closeRevLogModal(){const m=document.getElementById('revlog-modal');if(m)m.classList.add('hidden')}


function findEmptyArContent() {
    if (!bookData || !bookData.sections) {
        console.log('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿ™ÿßÿ®');
        return [];
    }
    
    const emptyContent = [];
    
    bookData.sections.forEach((section, sectionIndex) => {
        if (section.Chapters && Array.isArray(section.Chapters)) {
            section.Chapters.forEach((chapter, chapterIndex) => {
                if (chapter.content && Array.isArray(chapter.content)) {
                    chapter.content.forEach((block, blockIndex) => {
                        if (block.data) {
                            if (typeof block.data === 'string' && block.data === '') {
                                emptyContent.push({
                                    sectionIndex,
                                    chapterIndex,
                                    blockIndex,
                                    sectionName: getLocalizedSectionName(section, 'ar'),
                                    chapterTitle: getLocalizedTitle(chapter, 'ar'),
                                    blockType: block.type,
                                    path: `ÿßŸÑŸÇÿ≥ŸÖ ${sectionIndex} - ÿßŸÑŸÅÿµŸÑ ${chapterIndex} - ÿßŸÑÿ®ŸÑŸàŸÉ ${blockIndex}`
                                });
                            } else if (Array.isArray(block.data)) {
                                const arData = block.data.find(item => item.ar !== undefined);
                                if (arData && arData.ar === '') {
                                    emptyContent.push({
                                        sectionIndex,
                                        chapterIndex,
                                        blockIndex,
                                        sectionName: getLocalizedSectionName(section, 'ar'),
                                        chapterTitle: getLocalizedTitle(chapter, 'ar'),
                                        blockType: block.type,
                                        path: `ÿßŸÑŸÇÿ≥ŸÖ ${sectionIndex} - ÿßŸÑŸÅÿµŸÑ ${chapterIndex} - ÿßŸÑÿ®ŸÑŸàŸÉ ${blockIndex}`
                                    });
                                }
                            }
                        }
                    });
                }
            });
        }
    });
    
    console.log('ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÅÿßÿ±ÿ∫ ŸÅŸä data.ar:', emptyContent);
    console.table(emptyContent);
    return emptyContent;
}

function findEmptyArContentDetailed() {
    if (!bookData || !bookData.sections) {
        console.log('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿ™ÿßÿ®');
        return [];
    }
    
    const results = [];
    
    bookData.sections.forEach((section, sectionIndex) => {
        if (section.Chapters && Array.isArray(section.Chapters)) {
            section.Chapters.forEach((chapter, chapterIndex) => {
                if (chapter.content && Array.isArray(chapter.content)) {
                    chapter.content.forEach((block, blockIndex) => {
                        if (block.data) {
                            let isEmpty = false;
                            let dataValue = '';
                            
                            if (typeof block.data === 'string') {
                                isEmpty = block.data === '';
                                dataValue = block.data;
                            } else if (Array.isArray(block.data)) {
                                const arData = block.data.find(item => item.ar !== undefined);
                                if (arData) {
                                    isEmpty = arData.ar === '';
                                    dataValue = arData.ar;
                                }
                            }
                            
                            if (isEmpty) {
                                results.push({
                                    ÿßŸÑŸÇÿ≥ŸÖ: sectionIndex,
                                    ÿßŸÑŸÅÿµŸÑ: chapterIndex,
                                    ÿßŸÑÿ®ŸÑŸàŸÉ: blockIndex,
                                    'ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ': getLocalizedSectionName(section, 'ar'),
                                    'ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅÿµŸÑ': getLocalizedTitle(chapter, 'ar'),
                                    'ŸÜŸàÿπ ÿßŸÑÿ®ŸÑŸàŸÉ': block.type,
                                    'ŸÇŸäŸÖÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™': `"${dataValue}"`,
                                    'ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑŸÉÿßŸÖŸÑ': `sections[${sectionIndex}].Chapters[${chapterIndex}].content[${blockIndex}]`
                                });
                            }
                        }
                    });
                }
            });
        }
    });
    
    console.log(`ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${results.length} ÿπŸÜÿµÿ± ŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ±ÿ∫:`);
    console.table(results);
    return results;
}

function fillEmptyContent(chapters, options) {
    const opts = options || {};
    let hasChanges = false;
    let list = [];
    if (!chapters || !Array.isArray(chapters)) {
        if (!bookData || !bookData.sections) return [];
        bookData.sections.forEach(section => {
            if (section.Chapters) list.push(...section.Chapters);
        });
    } else {
        list = chapters;
    }
    const normalize = s => {
        if (!s || typeof s !== 'string') return '';
        return s.replace(/\s+/g, ' ').trim().toLowerCase();
    };
    let idMap = null;
    let titleMap = null;
    if (bookData && bookData.sections) {
        idMap = new Map();
        titleMap = new Map();
        bookData.sections.forEach(section => {
            if (section.Chapters) {
                section.Chapters.forEach(ch => {
                    idMap.set(ch.id, ch);
                    const t = ch.title && ch.title[0] ? (ch.title[0].ar || ch.title[0].en || '') : '';
                    const nt = normalize(t);
                    if (nt && !titleMap.has(nt)) titleMap.set(nt, ch);
                });
            }
        });
    }
    let willPersist = false;
    list.forEach(chapter => {
        let target = chapter;
        let matchedFromBook = false;
        if (idMap && chapter && chapter.id && idMap.has(chapter.id)) {
            target = idMap.get(chapter.id);
            matchedFromBook = true;
        } else if (titleMap) {
            const t = chapter && chapter.title && chapter.title[0] ? (chapter.title[0].ar || chapter.title[0].en || '') : '';
            const nt = normalize(t);
            if (nt && titleMap.has(nt)) {
                target = titleMap.get(nt);
                matchedFromBook = true;
            }
        }
        if (target && target.content) {
            target.content.forEach(contentItem => {
                if (contentItem && contentItem.data && contentItem.data[0]) {
                    const data = contentItem.data[0];
                    const arTitle = target.title && target.title[0] ? (target.title[0].ar || target.title[0].en || '') : '';
                    if (!data.ar || data.ar === '' || data.ar === '""') {
                        data.ar = `ŸÖÿ≠ÿ™ŸàŸâ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™Ÿá ŸÑŸÑŸÅÿµŸÑ: ${arTitle} - ID: ${target.id || ''}`;
                        hasChanges = true;
                    }
                    if (!data.en || data.en === '' || data.en === '""') {
                        data.en = `Content added for chapter: ${arTitle} - ID: ${target.id || ''}`;
                        hasChanges = true;
                    }
                }
            });
        }
        if (matchedFromBook && target !== chapter) {
            if (target && target.content) {
                chapter.content = target.content;
            }
            willPersist = true;
        }
    });
    if (hasChanges) {
        const persistAllowed = opts.persist !== false;
        const rerenderAllowed = opts.rerender !== false;
        if (persistAllowed && (willPersist || (!chapters || !Array.isArray(chapters)))) {
            if (typeof saveBookToIndexedDB === 'function') {
                saveBookToIndexedDB();
            }
        }
        if (rerenderAllowed) {
            if (typeof renderApp === 'function') {
                renderApp();
            }
        }
    }
    return list;
}

    </script>
    <script src="mishkah-core.js"></script>
    <script src="mishkah-static-exporter.js"></script>
    <script src="template/default/tpl-engine.js"></script>

  

    <script src="mishkah-templates.js"></script>
	<script>
const MishkahAI=(()=>{let settings={provider:'gemini',model:'gemini-1.5-pro',endpoint:'',apiKey:''};async function load(){try{if(!db)return{};const tx=db.transaction(['settings'],'readonly');const st=tx.objectStore('settings');const req=st.get('ai');return await new Promise(res=>{req.onsuccess=()=>res(req.result?req.result.value:{});req.onerror=()=>res({});});}catch(e){return{}}}async function save(v){if(!db)return;const tx=db.transaction(['settings'],'readwrite');const st=tx.objectStore('settings');st.put({key:'ai',value:v});settings=v;}function configure(v){settings={...settings,...v};return save(settings)}async function runTask(kind,{text,from='ar',to='ar',prompt=''}={}){const s=settings;if(!s.apiKey)throw new Error('no api key');const sys=kind==='format'?'ÿ£ÿπÿØ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÜÿµ ÿ•ŸÑŸâ Markdown ŸÖŸÜÿ∏ŸÖ ŸàŸÜÿ∏ŸäŸÅ ÿ®ŸÑÿß ÿ™ŸÑÿÆŸäÿµ ŸàŸÑÿß ÿ≠ÿ∞ŸÅ. ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÉÿßŸÖŸÑÿßŸã.':kind==='proof'?'ŸÜŸÇŸëÿ≠ ÿßŸÑŸÜÿµ ŸÑÿ∫ŸàŸäÿßŸã Ÿàÿ•ŸÖŸÑÿßÿ¶ŸäÿßŸã Ÿàÿ£ÿ≥ŸÑŸàÿ®ŸäÿßŸã ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿßŸÑÿ™ÿßŸÖ ÿπŸÑŸâ ÿßŸÑŸÖÿπŸÜŸâ ŸàÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸàÿπÿØŸÖ ÿßŸÑÿßÿÆÿ™ÿµÿßÿ±.':kind==='translate'?`ÿ™ÿ±ÿ¨ŸÖ ÿßŸÑŸÜÿµ ÿ™ÿ±ÿ¨ŸÖÿ© ŸÖŸàÿ∂ŸàÿπŸäÿ© ÿØŸÇŸäŸÇÿ© ŸÖŸÜ ${from} ÿ•ŸÑŸâ ${to} ÿ®ÿØŸàŸÜ ÿ¥ÿ±ÿ≠ ÿ•ÿ∂ÿßŸÅŸä.`:prompt||'ŸÜŸÅŸëÿ∞ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑÿ™ÿßŸÑŸä ÿπŸÑŸâ ÿßŸÑŸÜÿµ ÿ®ÿØŸÇÿ©.';const user=text;if(s.provider==='gemini'){const url=s.endpoint||`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(s.model)}:generateContent?key=${encodeURIComponent(s.apiKey)}`;const body={contents:[{role:'user',parts:[{text:sys+'\n\n---\n\n'+user}]}]};const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const j=await r.json();const out=(j.candidates&&j.candidates[0]&&j.candidates[0].content&&j.candidates[0].content.parts&&j.candidates[0].content.parts[0]&&j.candidates[0].content.parts[0].text)||'';return out.trim()}else{const url=s.endpoint||'https://api.deepseek.com/v1/chat/completions';const body={model:s.model||'deepseek-chat',messages:[{role:'system',content:sys},{role:'user',content:user}],temperature:0};const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+s.apiKey},body:JSON.stringify(body)});const j=await r.json();const out=(j.choices&&j.choices[0]&&j.choices[0].message&&j.choices[0].message.content)||'';return out.trim()}}async function formatMarkdown(t){return runTask('format',{text:t})}async function proofread(t){return runTask('proof',{text:t})}async function translate(t,from,to){return runTask('translate',{text:t,from,to})}async function custom(t,prompt){return runTask('custom',{text:t,prompt})}return{configure,load,runTask,formatMarkdown,proofread,translate,custom};})();
</script>

    <script>
document.addEventListener('DOMContentLoaded', () => {
  MishkahTemplates.init({ basePath: 'template/default/' }).then(() => {
    MishkahTemplates.patchExporter();
  });

  document.getElementById('export-static-site-btn').addEventListener('click', async ()=>{
    if (!bookData) { alert('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉÿ™ÿßÿ®'); return; }
    await MishkahStaticExporter.downloadAllDynamic(bookData, { defaultLang:'ar', archiveName:'site.tar.gz' });
  });

  document.getElementById('audit-open-btn').addEventListener('click', openAuditModal);
  document.getElementById('audit-close-btn').addEventListener('click', closeAuditModal);
  document.getElementById('audit-add-btn').addEventListener('click', addAuditLog);
});
    </script>
<script>
const MishkahOnePage=(()=>{"use strict";
const isArr=Array.isArray,isStr=v=>typeof v==="string",isObj=v=>v&&typeof v==="object";
const esc=v=>String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
const fromLang=(v,lang)=>{if(!v)return"";if(isStr(v))return v;if(isArr(v)){const o=v.find(x=>isObj(x)&&(x[lang]!=null||x.value!=null||x.name!=null))||v[0]||{};return o[lang]??o.value??o.name??""}return isObj(v)?(v[lang]??v.value??v.name??""):String(v)};
const jsonSafe=s=>JSON.stringify(s).replace(/</g,"\\u003C").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029").replace(/-->/g,"--\\>");
const scriptSafe=s=>String(s).replace(/<\/script/gi,"<\\/script"),styleSafe=s=>String(s).replace(/<\/style/gi,"<\\/sty"+"le>");
function cssTheme(userCss){
  if(isStr(userCss)&&userCss.trim()) return userCss;
  if(typeof window!="undefined"&&typeof window.css=="function"){try{return String(window.css()??"")}catch{}}
  return "\
:root{--bg:#0b0f19;--paper:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--br:#1f2937;--brand:#60a5fa;--w:1024px;--gap:16px}\
:root[data-theme=\"light\"]{--bg:#ffffff;--paper:#f6f7fb;--ink:#0b1220;--muted:#647089;--br:#e5e7eb;--brand:#2563eb}\
*{box-sizing:border-box}html,body{margin:0;padding:0}html{scroll-behavior:smooth}\
body{background:var(--bg);color:var(--ink);line-height:1.7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\"Noto Sans\",\"Noto Naskh Arabic\",Tahoma,Arial,sans-serif;overflow-x:hidden}\
a{color:var(--brand);text-decoration:none}a:hover{text-decoration:underline}\
.topbar{position:sticky;top:0;z-index:50;background:rgba(15,23,42,.7);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid #0003}\
:root[data-theme=\"light\"] .topbar{background:rgba(246,247,251,.85);border-bottom:1px solid #0001}\
.topbar .bar{max-width:var(--w);margin:auto;display:flex;gap:8px;align-items:center;padding:10px 16px}\
#toc-toggle,#theme-toggle,#lang-switch{border:1px solid var(--br);background:var(--paper);color:var(--ink)!important;border-radius:12px}\
#toc-toggle,#theme-toggle{padding:8px 10px}#toc-toggle{display:none}\
.topbar .brand{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}\
#global-search{flex:1 1 auto;min-width:120px;padding:9px 12px;border-radius:12px;border:1px solid var(--br);background:var(--paper);color:var(--ink)}\
#global-search::placeholder{color:color-mix(in oklab,var(--ink) 60%,transparent)}\
.wrapper{max-width:var(--w);margin:16px auto;display:grid;grid-template-columns:280px 1fr;gap:var(--gap);padding:0 16px}\
aside{background:var(--paper);border:1px solid var(--br);border-radius:14px;padding:10px;max-height:calc(100svh - 110px);overflow:auto}\
.reader{min-height:50vh}\
.card{background:var(--paper);border:1px solid var(--br);border-radius:16px;padding:16px;margin-bottom:14px}\
details.mk-sec{border:1px solid var(--br);border-radius:12px;margin:6px 0;background:var(--paper)}\
details.mk-sec>summary{cursor:pointer;list-style:none;padding:.8rem 1rem;font-weight:700}\
details.mk-sec[open]>summary{background:rgba(96,165,250,.08)}\
.mk-list{margin:0;padding:.2rem 1rem 1rem;display:grid;gap:.25rem}\
.mk-link{display:block;width:100%;text-align:start;border:1px dashed #293447;border-radius:.7rem;padding:.55rem .7rem;background:transparent;color:var(--ink)}\
.mk-link:hover{background:rgba(96,165,250,.08)}\
.muted{opacity:.72}.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--br);background:var(--paper);color:var(--ink)}\
.mk-article h1,.mk-article h2,.mk-article h3{margin:.2rem 0 .6rem}\
.mk-article p{margin:.55rem 0;line-height:1.95;overflow-wrap:anywhere}\
.mk-article img{max-width:100%;height:auto;display:block;border-radius:.6rem}\
.mk-article table{border-collapse:collapse;display:block;max-width:100%;overflow:auto}\
.mk-article td,.mk-article th{border:1px solid var(--br);padding:.5rem .6rem}\
.mk-code{display:block;background:color-mix(in oklab,var(--paper) 92%, black 8%);border:1px solid var(--br);border-radius:.6rem;padding:.7rem;overflow:auto}\
.mk-inline{padding:.05rem .35rem;border-radius:.35rem;background:color-mix(in oklab,var(--paper) 88%, black 12%);border:1px solid var(--br)}\
#toc-scrim{display:none}\
@media (max-width:980px){\
  .wrapper{grid-template-columns:1fr}\
  #toc-toggle{display:inline-flex}\
  aside{position:fixed;top:58px;bottom:0;right:0;width:min(86vw,360px);max-width:100%;z-index:60;transform:translateX(105%);transition:transform .25s ease;overflow:auto;border-radius:0 0 0 14px}\
  aside.open{transform:translateX(0)}\
  #toc-scrim{display:block;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:55;opacity:0;pointer-events:none;transition:opacity .2s ease}\
  #toc-scrim.show{opacity:1;pointer-events:auto}\
}";}

function runtime(){
  const out=[];
  out.push("(function(){'use strict'");
  out.push("var $=function(id){return document.getElementById(id)}");
  out.push("var el={title:$('book-title'),search:$('global-search'),lang:$('lang-switch'),theme:$('theme-toggle'),aside:$('toc'),main:$('reader'),scrim:$('toc-scrim'),tocToggle:$('toc-toggle')}");
  out.push("function isA(a){return Array.isArray(a)}function isS(s){return typeof s==='string'}function isO(o){return o&&typeof o==='object'}");
  out.push("function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;')}");
  out.push("function fromLang(v,lang){if(!v)return'';if(isS(v))return v;if(isA(v)){var o=v.find(function(x){return isO(x)&&(x[lang]!=null||x.value!=null||x.name!=null)})||v[0]||{};return o[lang]??o.value??o.name??''}if(isO(v))return v[lang]??v.value??v.name??'';return String(v)}");
  out.push("function mdInline(t){return String(t).replace(/!\\[([^\\]]*)\\]\\(([^)]+)\\)/g,function(_m,a,s){return '<img src=\"'+esc(s)+'\" alt=\"'+esc(a)+'\">'}).replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g,function(_m,txt,href){return '<a href=\"'+esc(href)+'\">'+esc(txt)+'</a>'}).replace(/`([^`]+)`/g,function(_m,c){return '<code class=\"mk-inline\">'+esc(c)+'</code>'}).replace(/\\*\\*([^*]+)\\*\\*/g,'<strong>$1</strong>').replace(/\\*([^*]+)\\*/g,'<em>$1</em>')}");
  out.push("function mdToHtml(src){if(!src)return'';var s=String(src).replace(/\\r\\n?/g,'\\n');s=s.replace(/```(\\w+)?\\n([\\s\\S]*?)```/g,function(_m,lang,code){return '\\n<pre class=\"mk-code\"><code data-lang=\"'+esc(lang||'')+'\">'+esc(code)+'</code></pre>\\n'});s=s.replace(/^(?:>\\s?.*(?:\\n>\\s?.*)*)/gm,function(block){var inner=block.replace(/^>\\s?/gm,'');return '<blockquote>'+mdInline(inner)+'</blockquote>'});for(var i=6;i>=1;i--){var re=new RegExp('^'+'#'.repeat(i)+'\\\\s+(.+)$','gm');s=s.replace(re,function(_,_t){return '<h'+i+'>'+mdInline(_t)+'</h'+i+'>'})}s=s.replace(/^\\s*[-*_]{3,}\\s*$/gm,'<hr/>');s=s.replace(/^(?:\\s*[-+*]\\s+.*(?:\\n\\s*[-+*]\\s+.*)*)/gm,function(blk){var items=blk.split('\\n').map(function(l){return l.replace(/^\\s*[-+*]\\s+/,'').trim()}).map(function(t){return '<li>'+mdInline(t)+'</li>'}).join('');return '<ul>'+items+'</ul>'});s=s.replace(/^(?:\\s*\\d+\\.\\s+.*(?:\\n\\s*\\d+\\.\\s+.*)*)/gm,function(blk){var items=blk.split('\\n').map(function(l){return l.replace(/^\\s*\\d+\\.\\s+/,'').trim()}).map(function(t){return '<li>'+mdInline(t)+'</li>'}).join('');return '<ol>'+items+'</ol>'});var blocks=s.split(/\\n{2,}/).map(function(b){b=b.trim();if(!b)return'';if(/^<(?:h\\d|ul|ol|pre|blockquote|hr)\\b/.test(b))return b;var inl=mdInline(b);return '<p>'+inl.replace(/\\n/g,'<br>')+'</p>'}).filter(Boolean);return blocks.join('\\n')}");
  out.push("function project(book,lang){return{name:fromLang(book&&book.name,lang),bio:fromLang(book&&book.bio,lang),sections:(book&&book.sections||[]).map(function(sec){return{id:sec.id||('s_'+Math.random().toString(36).slice(2,8)),title:fromLang(sec.section_name,lang),items:(sec.Chapters||[]).map(function(ch){return{id:ch.id||('t_'+Math.random().toString(36).slice(2,8)),title:fromLang(ch.title,lang),blocks:(ch.content||[]).map(function(x){if(x&&x.type==='paragraph')return{type:'p',text:fromLang(x.data,lang)};if(x&&x.type==='image')return{type:'img',src:fromLang(x.data,lang)||x.src};if(x&&x.type==='table')return{type:'table',rows:Array.isArray(x.rows)?x.rows:[]};return null}).filter(Boolean)}})}}).filter(function(s){return !!s.title})}}");
  out.push("function htmlOfChapter(ch){var out='';(ch.blocks||[]).forEach(function(b){if(b.type==='p'&&b.text)out+=mdToHtml(b.text);else if(b.type==='img'&&b.src)out+='<figure><img src=\"'+esc(b.src)+'\" alt=\"\"></figure>';else if(b.type==='table'&&Array.isArray(b.rows)){var rows=b.rows.map(function(r){return '<tr>'+r.map(function(c){return '<td>'+esc(c)+'</td>'}).join('')+'</tr>'}).join('');out+='<div style=\"overflow:auto\"><table>'+rows+'</table></div>'}});return out}");
  out.push("function buildTOC(book,open){var aside=document.getElementById('toc');aside.innerHTML='';if(book.bio){var bio=document.createElement('div');bio.className='pill muted';bio.textContent=book.bio;aside.appendChild(bio)}(book.sections||[]).forEach(function(sec){var d=document.createElement('details');d.className='mk-sec';if(open&&open[sec.id])d.setAttribute('open','');var s=document.createElement('summary');s.textContent=sec.title||'';d.appendChild(s);var ul=document.createElement('ul');ul.className='mk-list';(sec.items||[]).forEach(function(ch){var li=document.createElement('li');var b=document.createElement('button');b.type='button';b.className='mk-link';b.setAttribute('data-s',sec.id);b.setAttribute('data-c',ch.id);b.textContent=ch.title||'';li.appendChild(b);ul.appendChild(li)});d.appendChild(ul);aside.appendChild(d)})}");
  out.push("function renderArticle(book,active){var main=document.getElementById('reader');main.innerHTML='';if(!active||!active.s||!active.c){var card=document.createElement('section');card.className='card';card.innerHTML='<p class=\"muted\">ÿßÿÆÿ™ÿ± ŸÅÿµŸÑÿßŸã ŸÖŸÜ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ŸÑÿπÿ±ÿ∂Ÿá</p>';main.appendChild(card);return}var sec=(book.sections||[]).find(function(x){return x.id===active.s});if(!sec){renderArticle(book,null);return}var ch=(sec.items||[]).find(function(x){return x.id===active.c});if(!ch){renderArticle(book,null);return}var art=document.createElement('article');art.className='card mk-article';var h=document.createElement('h1');h.textContent=ch.title||'';art.appendChild(h);var body=document.createElement('div');body.innerHTML=htmlOfChapter(ch);art.appendChild(body);main.appendChild(art)}");
  out.push("function norm(s){return String(s||'').normalize('NFKD').replace(/[\\u064B-\\u0652\\u0670\\u0640]/g,'').replace(/[^\\p{L}\\p{N}\\s]+/gu,' ').toLowerCase().trim()}");
  out.push("function filterTOC(q){var qn=norm(q),btns=document.getElementById('toc').querySelectorAll('.mk-link');btns.forEach(function(b){var ok=!qn||norm(b.textContent).indexOf(qn)!==-1;b.parentElement.style.display=ok?'':'none'})}");
  out.push("function toggleToc(v){var a=document.getElementById('toc'),s=document.getElementById('toc-scrim');var on=v==null?!a.classList.contains('open'):v;a.classList.toggle('open',on);s&&s.classList.toggle('show',on);document.body.style.overflow=on&&window.innerWidth<981?'hidden':''}");
  out.push("function parseHash(){var h=location.hash.replace(/^#/,'');if(!h)return null;var p=h.split('-');if(p.length<3)return null;return{lang:p[0],s:p[1],c:p[2]}}");
  out.push("function setHash(lang,s,c){try{history.replaceState(null,'','#'+lang+'-'+s+'-'+c)}catch{location.hash='#'+lang+'-'+s+'-'+c}}");
  out.push("var initialLang=document.documentElement.lang||'ar'");
  out.push("var initialDir=document.documentElement.getAttribute('dir')||'rtl'");
  out.push("var rtlLangs=new Set(['ar','he','fa','ur'])");
  out.push("var state={lang:initialLang,dir:initialDir,theme:(localStorage.getItem('theme')||'light'),book:null,open:{},active:{s:null,c:null}}");
  out.push("document.documentElement.dataset.theme=state.theme");
  out.push("var raw='{}';try{raw=document.getElementById('bk-data').textContent}catch(e){};var src={};try{src=JSON.parse(raw)}catch(e){src={name:'',sections:[]}}");
  out.push("var initial=parseHash();if(initial&&initial.lang)state.lang=initial.lang");
  out.push("function boot(){var targetDir=rtlLangs.has(state.lang)?'rtl':'ltr';state.dir=(state.lang===initialLang?initialDir:targetDir);document.documentElement.dir=state.dir;state.book=project(src,state.lang);var t=document.getElementById('book-title');if(t)t.textContent=state.book.name||'';buildTOC(state.book,state.open);renderArticle(state.book,state.active)}");
  out.push("boot()");
  out.push("var lg=$('lang-switch');if(lg)lg.addEventListener('change',function(e){state.lang=e.target.value;state.open={};state.active={s:null,c:null};boot();toggleToc(false)})");
  out.push("var th=$('theme-toggle');if(th)th.addEventListener('click',function(){state.theme=(state.theme==='dark'?'light':'dark');document.documentElement.dataset.theme=state.theme;localStorage.setItem('theme',state.theme)})");
  out.push("var se=$('global-search');if(se)se.addEventListener('input',function(e){filterTOC(e.target.value)})");
  out.push("var tc=$('toc');if(tc)tc.addEventListener('click',function(ev){var b=ev.target.closest('.mk-link');if(!b)return;state.open[b.getAttribute('data-s')]=true;state.active={s:b.getAttribute('data-s'),c:b.getAttribute('data-c')};renderArticle(state.book,state.active);setHash(state.lang,state.active.s,state.active.c);if(window.innerWidth<981)toggleToc(false)})");
  out.push("if(el.tocToggle)el.tocToggle.addEventListener('click',function(){toggleToc()})");
  out.push("if(el.scrim)el.scrim.addEventListener('click',function(){toggleToc(false)})");
  out.push("window.addEventListener('resize',function(){if(matchMedia('(min-width:981px)').matches){var a=$('toc');var s=$('toc-scrim');a&&a.classList.remove('open');s&&s.classList.remove('show');document.body.style.overflow=''}})");
  out.push("if(initial&&initial.s&&initial.c){state.open[initial.s]=true;state.active={s:initial.s,c:initial.c};boot()}");
  out.push("})();");
  return out.join("\n");
}

function buildHTML(book,opt={}){
  const title=esc(fromLang(book&&book.name,"ar")||"ŸÉÿ™ÿßÿ® ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä");
  const css=cssTheme(opt.cssText);
  const json=jsonSafe(book);
  const rt=scriptSafe(runtime());
  const activeLang=(currentLanguage||'ar').toLowerCase();
  const activeDir=(currentDirection==='rtl'?'rtl':(isLanguageRTL(activeLang)?'rtl':'ltr'));
  const head=[
    "<!doctype html>",
    `<html lang="${activeLang}" dir="${activeDir}" data-theme="light">`,
    '<meta charset="utf-8">',
    '<meta name="viewport" content="width=device-width, initial-scale=1">',
    "<title>"+title+" ‚Äî ŸÉÿ™ÿßÿ® ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</title>",
    "<style>"+styleSafe(css)+"</style>"
  ].join("\n");
  const top='<header class="topbar"><div class="bar"><button id="toc-toggle" title="TOC">‚ò∞</button><div class="brand" id="book-title">'+title+'</div><input id="global-search" type="search" placeholder="üîé ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπŸÜÿßŸàŸäŸÜ‚Ä¶" aria-label="ÿ®ÿ≠ÿ´ ÿ¥ÿßŸÖŸÑ"><select id="lang-switch" aria-label="Language"><option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option><option value="en">English</option></select><button id="theme-toggle" title="Light/Dark">üåì</button></div></header>';
  const layout='<div class="wrapper"><aside id="toc"></aside><main id="reader" class="reader"></main></div>';
  const scrim='<div id="toc-scrim"></div>';
  const scripts='<script type="application/json" id="bk-data">'+json+'</scr'+'ipt><script>'+rt+'</scr'+'ipt></html>';
  return [head,top,layout,scrim,scripts].join("\n");
}

function download(name,text){
  const b=new Blob([text],{type:"text/html;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download=name;document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},600);
}

function exportOneFile(book,{filename="book-single.html",cssText}={}){download(filename,buildHTML(book,{cssText}))}

return{exportOneFile,buildHTML};
})();
</script>

        <script>
(function(){
  'use strict';

  const exportOnePageBtn = document.getElementById('export-onepage-btn');
  if (exportOnePageBtn && window.MishkahOnePage) {
    exportOnePageBtn.addEventListener('click', () => {
      const book = window.editorState?.book || window.currentBook || window.book || bookData || {};
      MishkahOnePage.exportOneFile(book, { filename: 'book-single.html' });
    });
  }

  const safeName = value => String(value ?? '').replace(/[\\/:*?"<>|]/g, '_').trim() || 'untitled';
  const pad2 = n => String(n).padStart(2, '0');
  const getSectionName = (section, lang) => {
    if (typeof getLocalizedSectionName === 'function') {
      return getLocalizedSectionName(section, lang) || '';
    }
    return section?.section_name || '';
  };

  const ensureJSZip = () => {
    if (window.JSZip) {
      return Promise.resolve();
    }
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ JSZip'));
      document.head.appendChild(script);
    });
  };

  async function exportAllSectionsAsZip() {
    const book = window.editorState?.book || window.currentBook || window.book || bookData || {};
    if (!book || !Array.isArray(book.sections) || !book.sections.length) {
      alert('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉÿ™ÿßÿ®/ÿ£ŸÇÿ≥ÿßŸÖ ŸÑŸÑÿ™ÿµÿØŸäÿ±.');
      return;
    }

    try {
      await ensureJSZip();

      const zip = new JSZip();
      const folder = zip.folder('sections');
      const lang = (window.currentLanguage || 'ar').toLowerCase();
      const manifest = {
        exported_at: new Date().toISOString(),
        book: {
          name: typeof getLocalizedBookName === 'function'
            ? (getLocalizedBookName(book, lang) || book.name || 'book')
            : (book.name || 'book')
        },
        sections: []
      };

      (book.sections || []).forEach((section, idx) => {
        const sectionName = getSectionName(section, lang) || `section-${idx + 1}`;
        const fileName = `${pad2(idx + 1)}_${safeName(sectionName)}.json`;

        const payload = {
          meta: {
            exported_at: new Date().toISOString(),
            section_index: idx,
            section_name: sectionName
          },
          section
        };

        folder.file(fileName, JSON.stringify(payload, null, 2));
        manifest.sections.push({ index: idx, name: sectionName, file: `sections/${fileName}` });
      });

      zip.file('manifest.json', JSON.stringify(manifest, null, 2));

      const blob = await zip.generateAsync({
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 6 }
      });

      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `book_sections_${new Date().toISOString().slice(0, 10)}.zip`;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        URL.revokeObjectURL(link.href);
        link.remove();
      }, 700);
    } catch (error) {
      console.error(error);
      alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ZIP.');
    }
  }

  const exportZipBtn = document.getElementById('export-all-sections-zip-btn');
  if (exportZipBtn) {
    exportZipBtn.addEventListener('click', exportAllSectionsAsZip);
  }
})();
</script>





</body>
</html>
